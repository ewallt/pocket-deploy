<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Threaded Reader</title>

  <!-- Theme Bootstrap (runs before page paint to prevent flicker) -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');
      const savedColor = localStorage.getItem('colorScheme');
      const isDark = savedTheme !== 'light'; // Default to dark if no preference is saved
      root.classList.toggle('dark', isDark);
      if (savedColor === 'emerald') {
        root.classList.add('emerald-theme');
      }
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: light dark; }
    html { scroll-behavior: smooth; }
    .font-newspaper { font-family: 'Lora', serif; }
    .hero { background: radial-gradient(50% 120% at 10% 10%, rgba(49,46,129,.12), transparent 60%),
                     radial-gradient(80% 140% at 90% 10%, rgba(234,88,12,.12), transparent 70%),
                     linear-gradient(180deg, rgba(14,165,233,.08), transparent 35%); }
    :where(h2,h3,h4){ scroll-margin-top: 84px; }
    mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
    @media (max-width: 380px){ .prose { font-size: .96rem; } }
    
    /* Default Blue Theme */
    .active-link { color: rgb(59,130,246); font-weight: 700; }
    
    /* Emerald Theme - Active links */
    .emerald-theme .active-link { 
      color: #10b981 !important; 
      font-weight: 700; 
    }
  </style>
</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">

  <!-- Header -->
  <header id="top" class="hero border-b border-slate-200/60 dark:border-slate-800/60">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="text-sm sm:text-base text-slate-600 dark:text-slate-400"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search‚Ä¶" class="hidden md:block w-56 rounded-xl border border-slate-300/70 dark:border-slate-700/70 bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-900">Clear</button>
        <button id="colorSchemeToggle" type="button" class="inline-flex items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-900" title="Change color scheme">
          <span class="inline md:hidden">Colors</span>
          <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
            <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
            <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
            <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 7.012 17.461 2 12 2z"/>
          </svg>
        </button>
        <button id="themeToggle" type="button" class="inline-flex items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-900" title="Toggle dark mode" aria-pressed="false">
          <span class="inline md:hidden">Theme</span>
          <svg aria-hidden="true" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg aria-hidden="true" class="w-5 h-5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </div>

    <!-- Timeline -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="text-slate-500 dark:text-slate-400">
        <ol id="timeline" class="grid grid-cols-3 sm:grid-cols-6 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl border border-slate-200 dark:border-slate-800 p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 border-slate-200 dark:border-slate-800" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-900">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-900">Collapse All</button>
      </nav>
    </aside>

    <!-- ============ CONTENT DROP ZONE ============ -->
    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- DROP ARTICLE HERE -->
      
<article class="rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
<meta name="doc-title" content="The Modern Guide to Eating for Healthy Aging">
<meta name="doc-subtitle" content="An evidence-based look at what to eat and what to avoid, from the dangers of ultra-processed foods to the proven benefits of the Mediterranean diet.">
<meta name="timeline-steps" content="ultra-processed-foods-the-modern-dietary-threat,additives-essentials-sugar-salt,macronutrients-carbs-protein-and-fat,lifestyle-habits-caffeine-alcohol,food-choices-meat-vs-plants,the-gold-standard-the-mediterranean-diet,eating-patterns-supplements">
<meta name="timeline-labels" content="UPFs,Additives,Macros,Habits,Choices,Med Diet,Patterns">

<h2>Ultra-Processed Foods: The Modern Dietary Threat</h2>
<p>The saying ‚ÄúYou are what you eat‚Äù has been around since 1826, and for good reason. A massive assessment across 195 countries concluded that a <strong>poor diet is linked to 22 percent of all deaths worldwide</strong>. That‚Äôs more than tobacco, cancer, or any other single health risk. What is clear is that the global epidemic of diabetes and obesity has been fueled, at least in part, by what we're eating, often under the heavy influence of "Big Food"‚Äîan oligopoly of multinational corporations.</p>
<p>Big Food makes a lot of these. <strong>Ultra-processed foods (UPFs)</strong> are like UFOs; they're alien, industrially produced substances that barely qualify as food. They're damaged by industrial processing in two main ways: chemically and physically.</p>
<p>First, they're loaded with chemical additives. Second, the physical manufacturing process‚Äîmolding, extrusion, and pre-frying‚Äîis designed to make these foods hyper-digestible. This causes sharp spikes in your blood glucose and insulin, which is the exact opposite of what dietary fiber does.</p>
<details class="mt-4">
<summary class="font-semibold cursor-pointer">Common UPF Additives & Ingredients to Avoid</summary>
<div class="pt-2">
<p>This is a partial list of common industrial ingredients found in UPFs: coloring agents, sweeteners such as maltodextrin, high-fructose corn syrup, fruit juice concentrates, dextrose, lactose, artificial sweeteners, hydrogenated oils, palm oil, calcium propionate, soy protein isolate, modified starches such as maltitol, calcium caseinate, hydrolyzed beef gelatin, and emulsifiers such as soy lecithin, xanthan gum, guar gum, and diacetyl tartaric acid esters of mono- and diglycerides.</p>
</div>
</details>
<details class="mt-4">
<summary class="font-semibold cursor-pointer">Understanding the NOVA Food Classification</summary>
<div class="pt-2">
<p>The NOVA food classification system is a helpful guide. It categorizes food into four groups:</p>
<ul>
<li><strong>Group 1:</strong> Unprocessed or minimally processed foods.</li>
<li><strong>Group 2:</strong> Processed culinary ingredients (like oils and salt).</li>
<li><strong>Group 3:</strong> Processed foods (canned fish, simple breads).</li>
<li><strong>Group 4:</strong> Ultra-processed foods.</li>
</ul>
</div>
</details>
<p class="mt-4">In a well-known randomized trial from the NIH, researchers let two groups eat as much as they wanted for two weeks. The UPF group ate an <strong>extra 500 calories a day</strong> and gained a significant amount of weight, likely because UPFs disrupt the gut-brain signals that tell you when you're full.</p>
<p>Eating a diet rich in these foods is linked to a shocking list of problems: an 80% higher risk of metabolic syndrome, a 40% higher risk of type 2 diabetes, and a 66% higher risk of death from cardiovascular disease. For healthy aging, you have to restrict UPFs as much as possible. It‚Äôs likely that in the future, UPFs will be viewed much like cigarettes are today.</p>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
<h2>Additives & Essentials: Sugar & Salt</h2>
<p>Sugar activates our brain's reward circuits, but too much is clearly bad. The biggest culprit is <strong>sugar-sweetened beverages</strong>. One large study found that high consumption of sugary drinks, including fruit juices, was associated with a 24% increased risk of death from any cause. üç≠</p>
<p>The story for <strong>artificial sweeteners</strong> is a bit more complicated. While some reviews find no compelling evidence of risk, other research shows some can impair how your body handles glucose, partly by altering your gut microbiome. Overall, the data on artificial sweeteners is unfavorable, though not as worrying as for high sugar.</p>
<p>The link between high <strong>sodium (salt)</strong> intake and hypertension is clear. üßÇ The average American eats about 3.5 grams of sodium per day, but studies suggest that cardiovascular risk increases significantly above 5 grams. An interesting alternative for those without kidney disease is a potassium chloride salt substitute, which one trial found reduced the incidence of hypertension by 40%.</p>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
<h2>Macronutrients: Carbs, Protein, and Fat</h2>
<p>The term <strong>carbotoxicity</strong> highlights the risks of eating too many carbohydrates. Both very low-carb and very high-carb diets are linked with increased mortality. The <strong>type of carb</strong> is what really matters. Good carbs come from dietary fiber, while bad carbs are fast-digesting sugars and refined grains.</p>
<h3>Protein</h3>
<p>When it comes to <strong>protein</strong>, the current recommended daily allowance (RDA) is likely too low, especially for older adults trying to prevent age-related muscle loss (sarcopenia). While higher intake is needed, high-protein diets, especially from leucine-rich animal sources, have been linked to promoting atherosclerosis. A reasonable goal might be up to 1.2 grams per kilogram of body weight.</p>
<h3>Fat</h3>
<p>For <strong>fat</strong>, the old advice to choose low-fat dairy is outdated. Recent studies found that people who ate more whole-fat dairy, especially yogurt and cheese, had a <em>lower</em> risk of cardiovascular disease. Like with other macronutrients, the <strong>quality of the fat</strong> matters more than the quantity. Shifting from saturated fats to plant-based unsaturated fats (found in olive oil and avocados) is key.</p>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
<h2>Lifestyle Habits: Caffeine & Alcohol</h2>
<p>Good news for coffee lovers. ‚òï Many large studies link coffee consumption‚Äîtypically around four cups a day‚Äîwith up to a <strong>30% reduced mortality</strong> and a lower risk of many diseases. While this is a correlation, not proven causation, the data is compelling. For decades, doctors warned patients to avoid coffee for fear of heart rhythm disturbances, but recent studies show this fear is largely unfounded. The totality of the data suggests coffee is not hazardous and may even offer health benefits.</p>
<p>The evidence on <strong>alcohol</strong> is less blurry: both moderate and heavy drinking do you no good. üç∑ The old myth about the health benefits of red wine has been largely refuted. Alcohol is classified as a carcinogen. Most studies show a J-curve relationship‚Äîa potential tiny benefit at very light intake (like two drinks per week), but the risk of high blood pressure and cardiovascular disease rises quickly beyond that.</p>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
<h2>Food Choices: Meat vs. Plants</h2>
<p>These two are at opposite ends of the health spectrum. <strong>Processed meats</strong> like hot dogs and bacon are classified as carcinogenic by the World Health Organization. <strong>Unprocessed red meats</strong> like beef and pork are labeled "probably carcinogenic." While some reviews argue the risk is small, the data consistently points in the wrong direction.</p>
<p>In contrast, <strong>plant-based foods</strong> are plainly healthier. They're linked to a 23% lower risk of type 2 diabetes and substantial protection from all-cause and cardiovascular mortality. In one fascinating randomized trial of identical twins, a plant-based diet was shown to slow the pace of epigenetic aging compared to an omnivore diet. The bottom line: the more red meat you eat, especially processed kinds, the less healthy you are likely to be.</p>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
<h2>The Gold Standard: The Mediterranean Diet</h2>
<p>So what does "healthy eating" actually mean? We know it includes fruits, vegetables, legumes, whole grains, nuts, seeds, healthy fats like olive oil, and fatty fish like salmon. The whole package of all these goodies is known as the <strong>Mediterranean diet</strong>. This is one of the few diets that has been rigorously tested in multiple randomized trials.</p>
<p>The data provides robust support for its benefits in reducing death from nearly every major cause. One of the largest nutrition trials in history found that the Mediterranean diet led to a <strong>30% lower risk of heart attack, stroke, or cardiovascular death</strong> compared to a low-fat diet. It also promotes a healthy gut microbiome in older adults, which is linked to less frailty and better cognitive function. While there may be healthier diets out there, the Mediterranean diet is the best we've validated so far.</p>
<details class="mt-4">
<summary class="font-semibold cursor-pointer">Intriguing (But Unproven) Nutrients: Taurine & Choline</summary>
<div class="pt-2">
<p>A couple of other nutrients deserve more attention. <strong>Taurine</strong> is an amino acid that decreases as we age. Supplementing it in aged monkeys led to notable health improvements. <strong>Choline</strong> is an essential nutrient important for brain function, found in eggs, beef, and fish. While both show promise, we need human randomized trials to confirm their benefits for healthy aging.</p>
</div>
</details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
<h2>Eating Patterns & Supplements</h2>
<p>There's been a lot of interest in whether eating less (<strong>caloric restriction</strong>) or eating within a specific time window (<strong>time-restricted eating</strong>) can promote longevity. While these approaches work in some animal models, the results in humans are contradictory. Some trials show benefits, while others show no difference. No fasting diet has been definitively proven to provide anti-aging properties in humans. A sensible piece of advice is simply to eat an early dinner and maintain a regular eating schedule from day to day.</p>
<p>Finally, a word on <strong>supplements</strong>. Despite heavy marketing, there's little to no hard evidence that taking most vitamins or supplements is beneficial, especially if you're already eating a healthy diet. In fact, some evidence suggests potential harm from certain supplements.</p>
<details class="mt-4">
<summary class="font-semibold cursor-pointer">A Look at the Evidence on Common Supplements</summary>
<div class="pt-2">
<p>Large, high-quality trials of Vitamin D and omega-3 fatty acids failed to show any benefit for preventing cardiovascular disease or cancer. The evidence for multivitamins slowing cognitive decline is weak and contested. Some evidence suggests an increased stroke risk from calcium plus vitamin D. For now, it's best to get your nutrients from real food and take any claims about "longevity vitamins" with a grain of salt.</p>
</div>
</details>
</article>

      <!-- DO NOT PASTE ANYTHING AFTER THIS POINT -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs text-slate-500 dark:text-slate-400">
    Threaded Reader ‚Äî a single-file template
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');
      
      // ===== Theme Definitions =====
      const themes = {
        slate: {
          body: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]',
          header: 'hero border-b border-slate-200/60 dark:border-slate-800/60',
          subtitle: 'text-sm sm:text-base text-slate-600 dark:text-slate-400',
          timeline: 'text-slate-500 dark:text-slate-400',
          searchInput: 'hidden md:block w-56 rounded-xl border border-slate-300/70 dark:border-slate-700/70 bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400',
          clearButton: 'hidden md:inline-flex text-xs px-2 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-900',
          colorButton: 'inline-flex items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-900',
          themeButton: 'inline-flex items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-900',
          sidebar: 'rounded-2xl border border-slate-200 dark:border-slate-800 p-4',
          sidebarHr: 'my-4 border-slate-200 dark:border-slate-800',
          expandButton: 'w-full text-xs px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-900',
          collapseButton: 'mt-2 w-full text-xs px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-900',
          prose: 'prose prose-slate dark:prose-invert max-w-none',
          footer: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs text-slate-500 dark:text-slate-400',
          tocHover: 'hover:bg-slate-50 dark:hover:bg-slate-900'
        },
        emerald: {
          body: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)] emerald-theme',
          header: 'hero border-b border-emerald-200/60 dark:border-emerald-800/60',
          subtitle: 'text-sm sm:text-base text-slate-700 dark:text-slate-300',
          timeline: 'text-sm sm:text-base text-slate-700 dark:text-slate-300',
          searchInput: 'hidden md:block w-56 rounded-xl border border-emerald-300/70 dark:border-emerald-700/70 bg-white/70 dark:bg-emerald-900/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400',
          clearButton: 'hidden md:inline-flex text-xs px-2 py-2 rounded-lg border border-emerald-200 dark:border-emerald-700 hover:bg-emerald-50 dark:hover:bg-emerald-900',
          colorButton: 'inline-flex items-center justify-center rounded-xl border border-emerald-200 dark:border-emerald-700 px-3 py-2 text-sm hover:bg-emerald-50 dark:hover:bg-emerald-900',
          themeButton: 'inline-flex items-center justify-center rounded-xl border border-emerald-200 dark:border-emerald-700 px-3 py-2 text-sm hover:bg-emerald-50 dark:hover:bg-emerald-900',
          sidebar: 'rounded-2xl border border-emerald-200 dark:border-emerald-800 p-4',
          sidebarHr: 'my-4 border-emerald-200 dark:border-emerald-800',
          expandButton: 'w-full text-xs px-3 py-2 rounded-lg border border-emerald-200 dark:border-emerald-700 hover:bg-emerald-50 dark:hover:bg-emerald-900',
          collapseButton: 'mt-2 w-full text-xs px-3 py-2 rounded-lg border border-emerald-200 dark:border-emerald-700 hover:bg-emerald-50 dark:hover:bg-emerald-900',
          prose: 'prose prose-emerald dark:prose-invert max-w-none',
          footer: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs text-emerald-500 dark:text-emerald-400',
          tocHover: 'hover:bg-emerald-50 dark:hover:bg-emerald-900'
        }
      };
      
      // ===== Apply Theme Classes =====
      function applyThemeClasses() {
        const currentTheme = document.documentElement.classList.contains('emerald-theme') ? 'emerald' : 'slate';
        const theme = themes[currentTheme];
        
        document.body.className = theme.body;
        document.querySelector('header').className = theme.header;
        document.getElementById('docSubtitle').className = theme.subtitle;
        document.getElementById('timelineNav').className = theme.timeline;
        document.getElementById('search').className = theme.searchInput;
        document.getElementById('clearSearch').className = theme.clearButton;
        document.getElementById('colorSchemeToggle').className = theme.colorButton;
        document.getElementById('themeToggle').className = theme.themeButton;
        document.querySelector('aside nav').className = theme.sidebar;
        document.querySelector('aside hr').className = theme.sidebarHr;
        document.getElementById('expandAll').className = theme.expandButton;
        document.getElementById('collapseAll').className = theme.collapseButton;
        document.getElementById('content').className = theme.prose;
        document.querySelector('footer').className = theme.footer;
      }
      
      // ===== Read Metadata from Content =====
      const firstArticle = document.querySelector('#content article');
      const docTitle = firstArticle?.querySelector('meta[name="doc-title"]')?.content || 'Untitled Document';
      const docSubtitle = firstArticle?.querySelector('meta[name="doc-subtitle"]')?.content || '';
      const timelineStepsData = firstArticle?.querySelector('meta[name="timeline-steps"]')?.content;
      const timelineLabelsData = firstArticle?.querySelector('meta[name="timeline-labels"]')?.content;
      
      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle; // Also update browser tab title
      
      // ===== Color Scheme Handling =====
      const availableThemes = Object.keys(themes);
      let currentThemeIndex = 0;
      
      // Initialize from localStorage
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && themes[saved]) {
          currentThemeIndex = availableThemes.indexOf(saved);
          if (currentThemeIndex === -1) currentThemeIndex = 0;
        }
      } catch (_) {}
      
      const colorBtn = document.getElementById('colorSchemeToggle');
      colorBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        
        // Cycle to next theme
        currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
        const newTheme = availableThemes[currentThemeIndex];
        
        // Update HTML class (for now, keeping the old logic for emerald)
        if (newTheme === 'emerald') {
          root.classList.add('emerald-theme');
        } else {
          root.classList.remove('emerald-theme');
        }
        
        // Save preference
        try { 
          localStorage.setItem('colorScheme', newTheme); 
        } catch(_) {}
        
        // Apply theme classes
        applyThemeClasses();
        
        // Rebuild TOC to apply new hover styles
        buildTOC();
      });
      
      // ===== Theme Handling =====
      const themeBtn = document.getElementById('themeToggle');
      if(themeBtn) {
        themeBtn.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')));
      }
      themeBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        const isDark = root.classList.toggle('dark');
        try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){ }
        themeBtn.setAttribute('aria-pressed', String(isDark));
      });
      try {
        const mq = matchMedia('(prefers-color-scheme: dark)');
        const onChange = (e) => {
          if (!localStorage.getItem('theme')) {
            const isDark = e.matches;
            document.documentElement.classList.toggle('dark', isDark);
            themeBtn?.setAttribute('aria-pressed', String(isDark));
          }
        };
        if (mq.addEventListener) {
          mq.addEventListener('change', onChange);
        } else if (mq.addListener) {
          mq.addListener(onChange); // Safari <14
        }
      } catch (_) {}

      // ===== Expand/Collapse Functionality =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');
      
      // Only show buttons if there are details elements
      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => {
          getDetails().forEach(d => { d.open = true; });
        });
        
        collapseBtn?.addEventListener('click', () => {
          getDetails().forEach(d => { d.open = false; });
        });
      }
      
      // ===== Add Back to Top Links =====
      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
            if (index === arr.length - 1) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'mt-6 flex justify-end';
            wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
            article.appendChild(wrapper);
        });
      })();

      // ===== Build Table of Contents =====
      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          if (!h.id) h.id = slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        const isEmerald = document.documentElement.classList.contains('emerald-theme');
        const hoverClasses = themes[isEmerald ? 'emerald' : 'slate'].tocHover;

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="block px-2 py-1.5 rounded ${hoverClasses}${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      buildTOC();

      // ===== Build Timeline from Metadata =====
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');
        
        // Check if timeline metadata exists
        if (!timelineStepsData || !wrap || !list) {
          if(wrap) wrap.hidden = true;
          return;
        }
        
        // Parse timeline data
        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];
        
        if (steps.length === 0) {
          wrap.hidden = true;
          return;
        }
        
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );
        
        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();
      
      // ===== Search Highlighter =====
      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        const content = document.getElementById('content');
        if (!input || !content) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            content.innerHTML = originalHTML; 
            buildTOC(); 
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = content.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          content.innerHTML = content.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();
      
      // ===== Apply initial theme classes =====
      applyThemeClasses();
    });
  </script>
</body>
</html>
