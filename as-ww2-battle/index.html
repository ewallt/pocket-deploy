<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Battle Analyzer (AI)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111833;
      --ink:#e6ecff;
      --muted:#a7b0cc;
      --brand:#8bb9ff;
      --accent:#c0ffe1;
      --border:#26325b;
      --chip:#1a2347;
      --bad:#ff6b6b;
      --shadow:0 8px 28px rgba(0,0,0,.35);
      --radius:12px;
      --radius-sm:8px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -5%, rgba(139,185,255,.20), transparent 55%),
        radial-gradient(1000px 400px at 95% 10%, rgba(192,255,225,.18), transparent 60%),
        var(--bg);
      line-height:1.6;
      min-height:100vh;
      padding-bottom:2rem;
    }
    .container{max-width:860px;margin:0 auto;padding:1rem}
    .breadcrumb{margin-bottom:1rem;font-size:.92rem}
    .breadcrumb a{color:var(--brand);text-decoration:none}
    .breadcrumb span{color:var(--muted);margin:0 .5rem}
    
    /* SEARCH HEADER */
    .search-box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .search-input {
        flex: 1;
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--ink);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-sm);
        font-size: 1rem;
    }
    .search-input:focus { outline: 2px solid var(--brand); border-color: transparent; }
    .search-btn {
        background: var(--brand);
        color: #0b1020;
        font-weight: bold;
        border: none;
        padding: 0 1.5rem;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: opacity 0.2s;
    }
    .search-btn:hover { opacity: 0.9; }
    .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    header{
      background:linear-gradient(180deg,color-mix(in oklab,var(--panel) 85%,transparent),var(--panel));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:2rem 1.5rem;
      margin-bottom:1.25rem;
      box-shadow:var(--shadow);
      text-align: center;
    }
    h1{font-size:1.75rem;color:var(--ink);margin-bottom:.4rem}
    .subtitle{color:var(--muted);font-size:.95rem;font-style:italic}
    
    .main-answer{
      background:var(--panel);border:1px solid var(--border);
      border-radius:var(--radius);padding:1.5rem;margin-bottom:1.25rem;
      box-shadow:var(--shadow);border-left:4px solid var(--brand);
    }
    .main-answer h2{color:var(--brand);font-size:1.25rem;margin-bottom:.8rem}
    .main-answer p{font-size:1.03rem;line-height:1.65;color:var(--muted)}
    
    .section{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:1rem;box-shadow:var(--shadow);overflow:hidden}
    .section-header{padding:1.05rem 1.25rem;background:linear-gradient(135deg,#1a2a6b 0%,#0f172a 100%);color:var(--ink);display:flex;justify-content:space-between;align-items:center;cursor:pointer;border-bottom:1px solid var(--border);user-select:none}
    .section-header h2{font-size:1.12rem;margin:0}
    .section-icon{font-size:1.35rem;transition:transform .28s ease}
    .section.active .section-icon{transform:rotate(180deg)}
    .section-content{max-height:0;overflow:hidden;transition:max-height .38s ease}
    .section.active .section-content{max-height:5000px}
    .section-inner{padding:1.25rem}
    
    .list-item{background:color-mix(in oklab,var(--chip) 75%,transparent);border-left:3px solid var(--brand);padding:1rem;margin-bottom:.75rem;border-radius:var(--radius-sm);border:1px solid var(--border);color:var(--muted)}
    
    .timeline{border-left:3px solid var(--brand);padding-left:1.25rem;margin-left:.5rem}
    .timeline-item{position:relative;margin-bottom:1.15rem;color:var(--muted)}
    .timeline-item::before{content:'';position:absolute;left:-1.65rem;top:.25rem;width:12px;height:12px;border-radius:50%;background:var(--brand);border:3px solid var(--panel);box-shadow:0 0 0 2px var(--brand)}
    .timeline-item strong{display:block;color:var(--brand);margin-bottom:.25rem}
    
    .source{background:color-mix(in oklab,var(--chip) 65%,transparent);border-radius:8px;padding:1rem;margin-top:1rem;font-size:.95rem;color:var(--muted);border:1px solid var(--border)}
    .source strong{color:var(--ink)}
    
    .back-to-top{position:fixed;right:1rem;bottom:1.5rem;width:50px;height:50px;border-radius:50%;background:var(--brand);color:#001;border:none;font-size:1.5rem;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);opacity:0;transition:opacity .3s ease;z-index:1000; cursor: pointer;}
    .back-to-top.visible{opacity:1}
    a{color:var(--brand)}

    /* Loading State */
    .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; opacity: .5; }
    @keyframes pulse { 0%, 100% { opacity: .5; } 50% { opacity: .2; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="breadcrumb">
      <a href="hub.html">WWII Command Center</a> <span>‚Ä∫</span> Battle Analyzer
    </div>

    <!-- Input Section -->
    <div class="search-box">
        <input type="text" id="battleInput" class="search-input" placeholder="Enter a battle (e.g. Stalingrad, Waterloo, Tet Offensive)..." value="Pearl Harbor (1941)">
        <button id="analyzeBtn" class="search-btn" onclick="handleRequest()">Request Intelligence</button>
    </div>

    <!-- Dynamic Content Container -->
    <div id="reportContainer">
        <!-- Header -->
        <header>
          <h1 id="r-title">Pearl Harbor (1941)</h1>
          <p class="subtitle" id="r-subtitle">The Surprise Attack that Brought the United States into World War II</p>
        </header>

        <!-- Core Summary -->
        <section class="main-answer">
          <h2>Core Summary</h2>
          <p id="r-summary">On December 7, 1941, Japan launched a surprise aerial attack on the U.S. Pacific Fleet at Pearl Harbor, Hawaii. In less than two hours, over 2,400 Americans were killed, eight battleships damaged or sunk, and numerous aircraft destroyed. The attack galvanized the United States, leading Congress to declare war on Japan the following day.</p>
        </section>

        <!-- Strategic Context -->
        <section class="section active">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üéØ Strategic Context</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-context">
              <div class="list-item"><strong>Japanese Objective:</strong> Cripple the U.S. Pacific Fleet long enough to secure dominance in Southeast Asia.</div>
              <div class="list-item"><strong>American Situation:</strong> The U.S. had imposed oil embargoes and demanded Japanese withdrawal from China.</div>
            </div>
          </div>
        </section>

        <!-- Overview -->
        <section class="section active">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>‚öîÔ∏è Combat Overview</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-overview">
               <div class="list-item"><strong>Japanese Force:</strong> Six carriers launched 353 aircraft in two waves.</div>
               <div class="list-item"><strong>Surprise Achieved:</strong> U.S. radar detected the attack too late; ships were caught at anchor.</div>
            </div>
          </div>
        </section>

        <!-- Timeline -->
        <section class="section active">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üìú Timeline of Events</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner">
              <div class="timeline" id="r-timeline">
                <div class="timeline-item"><strong>07:48 AM:</strong> First wave attacks Battleship Row.</div>
                <div class="timeline-item"><strong>08:55 AM:</strong> Second wave strikes airfields and ships.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Turning Points -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>‚ö° Turning Points / Key Factors</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-turning">
               <div class="list-item"><strong>Carrier Survival:</strong> U.S. aircraft carriers were at sea and survived.</div>
            </div>
          </div>
        </section>

        <!-- Outcomes -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üèÅ Outcomes & Consequences</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-outcomes">
               <div class="list-item"><strong>War Expansion:</strong> The U.S. fully entered World War II.</div>
            </div>
          </div>
        </section>

        <!-- Significance -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üè∞ Historical Significance</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-significance">
               <div class="list-item"><strong>Strategic Shift:</strong> Ended the era of the battleship; rose the era of the carrier.</div>
            </div>
          </div>
        </section>

        <!-- Sources -->
        <section class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üìö Sources</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner">
              <div class="source" id="r-sources">
                  <strong>Primary:</strong> Navy Action Reports.<br>
                  <strong>Secondary:</strong> "At Dawn We Slept" by Gordon Prange.
              </div>
            </div>
          </div>
        </section>
    </div>
  </div>

  <button id="backToTop" class="back-to-top" onclick="scrollToTop()" aria-label="Back to top">‚Üë</button>

  <script>
    // --- CONFIGURATION ---
    const API_KEY = "AIzaSyBjL7zhEjoBgqCaXCxID3hV9KZNaPm5M8A"; 
    
    // APP_ID Must Match the Hub
    const APP_ID = "as-ww2-battle-"; 

    // --- UI LOGIC ---
    function toggleSection(header){
      const section = header.parentElement;
      section.classList.toggle('active');
    }

    window.addEventListener('scroll',()=>{
      const btn=document.getElementById('backToTop');
      if(window.pageYOffset>300) btn.classList.add('visible');
      else btn.classList.remove('visible');
    });
    function scrollToTop(){window.scrollTo({top:0,behavior:'smooth'});}

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Check if Hub sent us an order (e.g. index.html?q=Midway)
        const urlParams = new URLSearchParams(window.location.search);
        const battleQuery = urlParams.get('q');
        
        if (battleQuery) {
            document.getElementById('battleInput').value = battleQuery;
            handleRequest(); // Auto-trigger
        }
    });

    // --- CORE LOGIC: CACHE + API ---
    
    async function handleRequest() {
        const input = document.getElementById('battleInput').value.trim();
        if(!input) return alert("Please enter a battle name.");
        
        const btn = document.getElementById('analyzeBtn');
        const container = document.getElementById('reportContainer');
        
        // 2. Create a cache key: "as-ww2-battle-PearlHarbor"
        // We replace non-alphanumeric chars with nothing, preserving case.
        const cacheKey = APP_ID + input.replace(/[^a-zA-Z0-9]/g, '');

        // 3. Check Local Storage First
        const cachedData = localStorage.getItem(cacheKey);
        
        if (cachedData) {
            console.log("Loaded from cache");
            renderReport(JSON.parse(cachedData));
            btn.innerText = "Intel Retrieved from Archives";
            btn.classList.add("bg-green-600", "text-white");
            setTimeout(() => { 
                btn.innerText = "Request Intelligence"; 
                btn.classList.remove("bg-green-600", "text-white");
            }, 3000);
            return;
        }

        // 4. If not in cache, call API
        btn.disabled = true;
        btn.innerText = "Gathering Intel from HQ...";
        container.classList.add('loading-pulse');

        try {
            const result = await fetchBattleData(input);
            
            // 5. Save to Local Storage
            try {
                localStorage.setItem(cacheKey, JSON.stringify(result));
            } catch (e) {
                console.warn("Cache full, could not save.");
            }

            renderReport(result);

        } catch (e) {
            alert("Mission Failed: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Request Intelligence";
            container.classList.remove('loading-pulse');
        }
    }

    async function fetchBattleData(query) {
        const prompt = `
            Role: Military Historian.
            Task: Analyze the World War II battle/event: "${query}".
            Format: STRICT JSON. No Markdown.
            Schema:
            {
                "title": "Formal Name of Battle",
                "subtitle": "A one-sentence thematic summary",
                "summary": "A paragraph overview (3-4 sentences).",
                "context": [{"label": "Bold Header", "text": "Description"}, {"label": "Bold Header", "text": "Description"}],
                "overview": [{"label": "Force A", "text": "Details"}, {"label": "Force B", "text": "Details"}, {"label": "Key Tactic", "text": "Details"}],
                "timeline": [{"time": "Date/Time", "event": "Description"}, {"time": "Date/Time", "event": "Description"}],
                "turning_points": [{"label": "Turning Point", "text": "Why it mattered"}],
                "outcomes": [{"label": "Outcome", "text": "Description"}],
                "significance": [{"label": "Legacy", "text": "Why it matters historically"}],
                "sources": {"primary": "List primary sources", "secondary": "List key books/historians"}
            }
        `;

        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            }
        );

        const data = await response.json();
        if(data.error) throw new Error(data.error.message);
        
        const rawText = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(rawText);
    }

    function renderReport(result) {
        document.getElementById('r-title').innerText = result.title;
        document.getElementById('r-subtitle').innerText = result.subtitle;
        document.getElementById('r-summary').innerText = result.summary;

        renderList('r-context', result.context);
        renderList('r-overview', result.overview);
        renderTimeline('r-timeline', result.timeline);
        renderList('r-turning', result.turning_points);
        renderList('r-outcomes', result.outcomes);
        renderList('r-significance', result.significance);

        document.getElementById('r-sources').innerHTML = `
            <strong>Primary:</strong> ${result.sources.primary}<br><br>
            <strong>Secondary:</strong> ${result.sources.secondary}
        `;
    }

    function renderList(id, items) {
        const el = document.getElementById(id);
        el.innerHTML = items.map(i => `
            <div class="list-item"><strong>${i.label}:</strong> ${i.text}</div>
        `).join('');
    }

    function renderTimeline(id, items) {
        const el = document.getElementById(id);
        el.innerHTML = items.map(i => `
            <div class="timeline-item"><strong>${i.time}:</strong> ${i.event}</div>
        `).join('');
    }
  </script>
</body>
</html>
