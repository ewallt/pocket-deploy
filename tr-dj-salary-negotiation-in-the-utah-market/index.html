<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Threaded Reader</title>

  <!-- Prepaint bootstrap: set dark + theme class before paint to avoid flicker -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');       // 'light' | 'dark' | null
      const savedColor = localStorage.getItem('colorScheme'); // 'slate' | 'emerald' | future
      const isDark = savedTheme !== 'light';                  // default to dark if unset
      root.classList.toggle('dark', isDark);
      // Apply colored theme classes ONLY in dark mode; light is always neutral slate
      root.classList.toggle('theme-emerald', isDark && savedColor === 'emerald');
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
  :root { color-scheme: light dark; }
  html { scroll-behavior: smooth; }
  .font-newspaper { font-family: 'Lora', serif; }
  :where(h2,h3,h4){ scroll-margin-top: 84px; }
  mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
  @media (max-width: 380px){ .prose { font-size: .96rem; } }

  /* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  /* give the header an explicit base fill so gradient blends to the right hue */
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.border-var { border-color: var(--border) !important; }
.surface { border-width: 1px; border-style: solid; border-color: var(--border); }
.hr-var { border-color: var(--border); }
.subtitle { color: var(--subtitle-fg); }
.timeline-fg { color: var(--timeline-fg); }
.footer-note { color: var(--footer-fg); }
.active-link { color: var(--active); font-weight: 700; }

.input-surface {
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
}
.btn-surface { border: 1px solid var(--btn-border); }
.btn-surface:hover { background: var(--btn-hover-bg); }
.toc-link:hover { background: var(--hover-bg); }

/* ---------- Slate (default) variables ---------- */
:root{
  /* accents / inks */
  --active: rgb(59,130,246);                      /* sky-500 */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(100,116,139);                /* slate-500 */
  --footer-fg: rgb(100,116,139);                  /* slate-500 */

  /* surfaces */
  --border: rgb(226,232,240);                     /* slate-200 */
  --hover-bg: rgb(248,250,252);                   /* slate-50 */
  --btn-border: rgb(203,213,225);                 /* slate-300 */
  --btn-hover-bg: rgb(248,250,252);               /* slate-50 */
  --input-border: rgba(203,213,225,0.7);          /* slate-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* hero base & gradient (light) */
  --hero-base: transparent;                       /* keep light header airy */
  --hero-r1: rgba(49,46,129,.12);                 /* indigo-700 */
  --hero-r2: rgba(234,88,12,.12);                 /* orange-600 hint */
  --hero-wash: rgba(14,165,233,.08);              /* sky-500 wash */
}
.dark{
  --subtitle-fg: rgb(203,213,225);                /* slate-300 */
  --timeline-fg: rgb(148,163,184);                /* slate-400 */
  --footer-fg: rgb(148,163,184);                  /* slate-400 */

  --border: rgb(30,41,59);                        /* slate-800 */
  --hover-bg: rgb(15,23,42);                      /* slate-900 */
  --btn-border: rgb(51,65,85);                    /* slate-700 */
  --btn-hover-bg: rgb(15,23,42);                  /* slate-900 */
  --input-border: rgba(51,65,85,0.7);             /* slate-700/70 */
  --input-bg: rgba(2,6,23,0.6);                   /* slate-950/60 */

  /* hero base & gradient (dark) */
  --hero-base: rgb(2,6,23);                       /* slate-950 */
  --hero-r1: rgba(49,46,129,.12);
  --hero-r2: rgba(234,88,12,.12);
  --hero-wash: rgba(14,165,233,.08);
}

/* ---------- Emerald theme overrides (light & dark) ---------- */
.theme-emerald{
  --active: #10b981;                              /* emerald-500 */

  --border: rgb(187,247,208);                     /* emerald-200 */
  --hover-bg: rgb(240,253,244);                   /* emerald-50 */
  --btn-border: rgb(187,247,208);                 /* emerald-200 */
  --btn-hover-bg: rgb(240,253,244);               /* emerald-50 */
  --input-border: rgba(110,231,183,0.7);          /* emerald-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* keep subtitles/timeline neutral for readability over hero */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(71,85,105);                  /* slate-600 */
  --footer-fg: rgb(16,185,129);                   /* emerald-500 */

  /* hero base & gradient (emerald light) */
  --hero-base: transparent;
  --hero-r1: rgba(16,185,129,.14);                /* emerald-500 */
  --hero-r2: rgba(163,230,53,.12);                /* lime-400 */
  --hero-wash: rgba(5,150,105,.10);               /* emerald-600 wash */
}
.dark.theme-emerald{
  /* ↑ Give borders enough contrast on dark emerald surfaces */
  --border: rgba(110,231,183,0.55);                /* emerald-300 @ 55% */
  --hover-bg: rgb(6,78,59);                        /* emerald-900 */
  --btn-border: rgba(110,231,183,0.45);            /* slightly softer than borders */
  --btn-hover-bg: rgb(6,78,59);                    /* emerald-900 */
  --input-border: rgba(110,231,183,0.55);          /* match border contrast */
  --input-bg: rgba(6,95,70,0.60);                  /* emerald-900/60 */

  /* text accents for readability */
  --footer-fg: rgb(110,231,183);                   /* emerald-300/400 */
  --subtitle-fg: rgb(226,252,236);                 /* emerald-100 */
  --timeline-fg: rgb(187,247,208);                 /* emerald-200 */

  /* hero base & gradient (unchanged, stays emerald) */
  --hero-base: rgb(2,44,34);                       /* emerald-950 (#022c22) */
  --hero-r1: rgba(16,185,129,.14);
  --hero-r2: rgba(163,230,53,.12);
  --hero-wash: rgba(5,150,105,.10);
}

</style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">



  <!-- Header -->
  <header id="top" class="hero border-b border-var">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="subtitle text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl input-surface px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg btn-surface">Clear</button>
        <button id="colorSchemeToggle" type="button" class="inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Change color scheme">
          <span class="inline md:hidden">Colors</span>
          <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
            <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
            <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
            <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 7.012 17.461 2 12 2z"/>
          </svg>
        </button>
        <button id="themeToggle" type="button" class="inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Toggle dark mode" aria-pressed="false">
          <span class="inline md:hidden">Theme</span>
          <svg aria-hidden="true" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg aria-hidden="true" class="w-5 h-5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </div>

    <!-- Timeline -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="timeline-fg">
        <ol id="timeline" class="grid grid-cols-3 sm:grid-cols-6 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl surface p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 hr-var" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg btn-surface">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg btn-surface">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- DROP ARTICLE HERE -->

<article class="rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <meta name="doc-title" content="Salary Negotiation in the Utah Market">
  <meta name="doc-subtitle" content="Strategic approaches to secure competitive compensation in Salt Lake City finance roles">
  <meta name="timeline-steps" content="research-local-benchmarks,emphasize-total-compensation,time-the-discussion-well,tie-requests-to-impact,be-flexible-for-the-right-opportunity">
  <meta name="timeline-labels" content="Research,Total Comp,Timing,Impact,Flexibility">

  <h2>Research Local Benchmarks</h2>
  <p>Use sites like Glassdoor, Salary.com, and BuiltIn Utah to find current salary ranges for your target roles. Account for variations by industry and company size. Utah's cost of living advantage often means salary discussions focus on quality of life alongside compensation.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">SLC market salary research strategy</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Primary sources:</strong> Glassdoor (company-specific), Salary.com (role benchmarks), BuiltIn Utah (tech focus), LinkedIn Salary Insights</li>
        <li><strong>Industry variations:</strong> Tech/fintech (+10-15%), Energy/industrial (+5-10%), Healthcare/education (baseline), Manufacturing (-5% to +5%)</li>
        <li><strong>Company size impact:</strong> Large corps (Goldman, Comcast) pay premiums; mid-size growth companies offer equity upside; smaller firms provide broader scope</li>
        <li><strong>Geographic considerations:</strong> SLC proper vs. suburbs (minimal variation), remote/hybrid options expanding market comparisons</li>
        <li><strong>Professional networks:</strong> Utah Association of CPAs, local finance meetups, university alumni groups for insider perspectives</li>
      </ul>
    </div>
  </details>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Current SLC finance salary ranges (2025)</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Senior Financial Analyst:</strong> $85K-$110K (avg. $97K total comp)</li>
        <li><strong>Finance Manager:</strong> $95K-$125K (plus 10-20% bonus potential)</li>
        <li><strong>Controller:</strong> $110K-$150K (varies significantly by company size/complexity)</li>
        <li><strong>Finance Director:</strong> $130K-$180K (plus equity in growth companies)</li>
        <li><strong>VP Finance/CFO:</strong> $180K-$300K+ (highly variable based on revenue/industry)</li>
      </ul>
      <p class="text-sm opacity-80 mt-2">Ranges reflect base salary; total compensation typically 15-25% higher with bonuses and benefits.</p>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Emphasize Total Compensation</h2>
  <p>Factor in benefits, bonuses, retirement plans, and flexible work arrangements when evaluating offers. Many SLC employers offer competitive benefits to attract senior talent, often providing value equivalent to 20-30% of base salary.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Total compensation components to evaluate</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Health benefits:</strong> Premium coverage (often 80-100% employer-paid), HSA contributions, wellness programs</li>
        <li><strong>Retirement:</strong> 401(k) matching (typically 3-6%), immediate vs. graded vesting, additional profit sharing</li>
        <li><strong>Bonus structure:</strong> Annual performance bonuses (10-25% of base), spot bonuses, retention bonuses</li>
        <li><strong>Equity participation:</strong> Stock options, RSUs, ESPP programs (especially in growth companies)</li>
        <li><strong>Time off:</strong> PTO (15-25 days), sick leave, sabbatical programs, floating holidays</li>
        <li><strong>Professional development:</strong> Training budgets ($2K-$5K annually), conference attendance, certification support</li>
        <li><strong>Work arrangements:</strong> Hybrid flexibility, home office stipends, commuter benefits</li>
      </ul>
    </div>
  </details>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Calculating total compensation value</summary>
    <div class="pt-2">
      <p><strong>Create a comprehensive comparison:</strong></p>
      <ul>
        <li><strong>Base salary:</strong> Direct cash compensation</li>
        <li><strong>Bonus potential:</strong> Multiply target bonus by achievement probability (usually 80-90%)</li>
        <li><strong>Benefits value:</strong> Health (~$8K-$15K), 401k match (~$3K-$8K), other perks (~$2K-$5K)</li>
        <li><strong>Flexibility premium:</strong> Value hybrid work at $5K-$10K equivalent based on commute savings</li>
        <li><strong>Growth trajectory:</strong> Factor promotion timeline and salary progression potential</li>
      </ul>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Time the Discussion Well</h2>
  <p>Delay salary conversations until after you've demonstrated your value in interviews. This increases leverage and ensures the discussion is based on proven fit. Utah employers appreciate straightforward, professional approaches to compensation discussions.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Negotiation timeline strategy</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Initial screening:</strong> If pressed, provide broad range based on research ("I'm looking for roles in the $110K-$140K range")</li>
        <li><strong>First interview:</strong> Redirect focus to role fit and value contribution</li>
        <li><strong>Second/third rounds:</strong> After demonstrating capabilities, express interest in discussing full package</li>
        <li><strong>Reference/final stage:</strong> Ideal time for detailed compensation negotiation</li>
        <li><strong>Offer stage:</strong> Professional, data-driven negotiation based on research and value proposition</li>
      </ul>
    </div>
  </details>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Professional deflection scripts</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Early inquiry:</strong> "I'm focused on finding the right role fit first. Could we discuss the compensation structure later in the process?"</li>
        <li><strong>Persistent questioning:</strong> "Based on my research, roles like this typically range from $X to $Y. I'm more interested in learning about the growth opportunities here."</li>
        <li><strong>Moving to specifics:</strong> "Now that we've established mutual interest, I'd love to discuss how we can structure a compensation package that works for both of us."</li>
      </ul>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Tie Requests to Impact</h2>
  <p>When negotiating, link your desired salary to the measurable results you've achieved—cost savings, revenue growth, operational efficiency. SLC employers respond well to data-driven justifications that demonstrate clear return on investment.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Value-based negotiation framework</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Cost reduction examples:</strong> "I reduced close cycle by 40%, saving approximately $50K annually in overtime costs—more than justifying the salary difference."</li>
        <li><strong>Process improvement:</strong> "My ERP implementation delivered $200K in efficiency gains, demonstrating ROI that supports this compensation level."</li>
        <li><strong>Revenue impact:</strong> "I improved forecast accuracy by 25%, enabling better strategic decisions—I'd like compensation that reflects this value creation."</li>
        <li><strong>Risk mitigation:</strong> "My SOX compliance work avoided potential penalties and audit issues worth hundreds of thousands in risk exposure."</li>
        <li><strong>Team development:</strong> "I've built high-performing teams with 95% retention, reducing recruitment costs and maintaining institutional knowledge."</li>
      </ul>
    </div>
  </details>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Structuring the value proposition</summary>
    <div class="pt-2">
      <p><strong>Three-part negotiation approach:</strong></p>
      <ol class="list-decimal pl-5">
        <li><strong>Establish market range:</strong> "Based on my research, similar roles in SLC typically pay $X-$Y for someone with my experience."</li>
        <li><strong>Quantify your value:</strong> "In my previous role, I delivered [specific measurable impact] which directly contributed $Z in value."</li>
        <li><strong>Connect to their needs:</strong> "Given the [specific challenges/opportunities] we discussed, I believe I can deliver similar results here, justifying compensation at the higher end of the range."</li>
      </ol>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Be Flexible for the Right Opportunity</h2>
  <p>If a role offers strong growth potential, meaningful work, and cultural alignment, consider balancing salary expectations with long-term career benefits. Utah's business environment often rewards loyalty and long-term thinking with accelerated advancement opportunities.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Strategic trade-offs to consider</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Growth company equity:</strong> Lower base salary for meaningful equity stake in high-potential companies</li>
        <li><strong>Rapid advancement path:</strong> Accept current-level pay for clear promotion timeline (6-18 months to next level)</li>
        <li><strong>Skill development opportunity:</strong> Slightly lower compensation for exposure to new systems, industries, or leadership scope</li>
        <li><strong>Work-life balance premium:</strong> Value flexible arrangements, shorter commutes, and supportive culture</li>
        <li><strong>Industry transition:</strong> Accept temporary step back to enter higher-growth sector (tech, energy)</li>
        <li><strong>Geographic advantages:</strong> Factor in Utah's lower cost of living and quality of life benefits</li>
      </ul>
    </div>
  </details>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Alternative negotiation strategies</summary>
    <div class="pt-2">
      <ul>
        <li><strong>Performance milestones:</strong> "I'd accept $X with a review at 6 months to adjust based on early wins."</li>
        <li><strong>Accelerated reviews:</strong> "Could we schedule the first performance review at 9 months instead of 12?"</li>
        <li><strong>Enhanced benefits:</strong> "If salary flexibility is limited, could we explore additional PTO or professional development budget?"</li>
        <li><strong>Title progression:</strong> "I'm flexible on initial salary if there's a clear path to [Senior Manager/Director] level."</li>
        <li><strong>Bonus enhancement:</strong> "Would it be possible to increase the target bonus percentage to bridge the base salary gap?"</li>
        <li><strong>Signing bonus:</strong> "A one-time signing bonus could help offset the difference while staying within your salary structure."</li>
      </ul>
    </div>
  </details>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Long-term value assessment</summary>
    <div class="pt-2">
      <p><strong>Questions to evaluate total opportunity:</strong></p>
      <ul>
        <li>What's the typical promotion timeline for this role?</li>
        <li>How has the company grown over the past 3 years?</li>
        <li>What new initiatives or markets is the company pursuing?</li>
        <li>How does leadership view the finance function's strategic role?</li>
        <li>What's the retention rate for finance professionals at this level?</li>
        <li>Are there opportunities for cross-functional leadership or special projects?</li>
      </ul>
    </div>
  </details>
</article>

      <!-- DO NOT PASTE ANYTHING AFTER THIS POINT -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs footer-note">
    Threaded Reader — a single-file template
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from Content =====
      const firstArticle = document.querySelector('#content article');
      const docTitle = firstArticle?.querySelector('meta[name="doc-title"]')?.content || 'Untitled Document';
      const docSubtitle = firstArticle?.querySelector('meta[name="doc-subtitle"]')?.content || '';
      const timelineStepsData = firstArticle?.querySelector('meta[name="timeline-steps"]')?.content;
      const timelineLabelsData = firstArticle?.querySelector('meta[name="timeline-labels"]')?.content;

      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle; // Also update browser tab title

      // ===== Theme packs: only control article "prose-*" family
      // ===== Theme packs: control article prose family AND base <body> ink/background
const THEME_PACKS = {
  slate: {
    proseClass: 'prose-slate',
    bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
  },
  emerald: {
    proseClass: 'prose-emerald',
    bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
  }
};
const availableThemes = Object.keys(THEME_PACKS);


function applyTheme(themeKey){
  const root = document.documentElement;
  const isDark = root.classList.contains('dark');

  const THEME_PACKS = {
    slate: {
      proseClass: 'prose-slate',
      bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
    },
    emerald: {
      proseClass: 'prose-emerald',
      bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
    }
  };

  const pack = THEME_PACKS[themeKey] || THEME_PACKS.slate;

  // Color theme classes only attach in DARK; LIGHT is always neutral slate
  root.classList.toggle('theme-emerald', isDark && themeKey === 'emerald');

  // Body ink/background:
  document.body.className = isDark ? pack.bodyClass : THEME_PACKS.slate.bodyClass;

  // Article prose color family (ok to vary by theme in both modes; change if you want neutral):
  const content = document.getElementById('content');
  content.className = `prose ${pack.proseClass} dark:prose-invert max-w-none`;

  // Persist choice (used when you return to dark)
  try { localStorage.setItem('colorScheme', themeKey); } catch(_){}
}



      // Initialize from localStorage
      let currentThemeIndex = 0;
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && THEME_PACKS[saved]) currentThemeIndex = availableThemes.indexOf(saved);
      } catch(_) {}

      // ===== Color Scheme Toggle =====
const colorBtn = document.getElementById('colorSchemeToggle');
colorBtn?.addEventListener('click', () => {
  const root = document.documentElement;

  // If we're in LIGHT mode, switch to DARK and stop here (do NOT cycle color yet)
  if (!root.classList.contains('dark')) {
    root.classList.add('dark');
    try { localStorage.setItem('theme','dark'); } catch(_){}
    document.getElementById('themeToggle')?.setAttribute('aria-pressed','true');
    return; // first click behaves like the theme toggle only
  }

  // Already DARK: now cycle to the next color scheme
  currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
  const newTheme = availableThemes[currentThemeIndex];
  applyTheme(newTheme);

  // Rebuild TOC (keeps hover styles consistent with the new scheme)
  buildTOC();
});


      // ===== Theme (dark/light) Handling =====
const themeBtn = document.getElementById('themeToggle');
if (themeBtn) {
  themeBtn.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')));
}
themeBtn?.addEventListener('click', () => {
  const root = document.documentElement;
  const isDark = root.classList.toggle('dark');
  try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){}
  themeBtn.setAttribute('aria-pressed', String(isDark));

  if (!isDark) {
    // Going to LIGHT → always neutralize to slate
    root.classList.remove('theme-emerald');
    try { localStorage.setItem('colorScheme','slate'); } catch(_){}
    applyTheme('slate');
  } else {
    // Back to DARK → reapply saved (or default) color
    let saved = 'slate';
    try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
    applyTheme(saved);
  }
  buildTOC();
});

try {
  const mq = matchMedia('(prefers-color-scheme: dark)');
  const onChange = (e) => {
    if (!localStorage.getItem('theme')) { // only if user hasn't forced a theme
      const isDark = e.matches;
      const root = document.documentElement;
      root.classList.toggle('dark', isDark);
      themeBtn?.setAttribute('aria-pressed', String(isDark));

      if (!isDark) {
        root.classList.remove('theme-emerald');
        try { localStorage.setItem('colorScheme','slate'); } catch(_){}
        applyTheme('slate');
      } else {
        let saved = 'slate';
        try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
        applyTheme(saved);
      }
      buildTOC();
    }
  };
  if (mq.addEventListener) mq.addEventListener('change', onChange);
  else if (mq.addListener) mq.addListener(onChange); // Safari <14
} catch (_) {}

      // ===== Expand/Collapse Functionality =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      // ===== Add Back to Top Links =====
      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      // ===== Build Table of Contents =====
      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          if (!h.id) h.id = slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      buildTOC();

      // ===== Build Timeline from Metadata =====
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }

        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];

        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );

        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      // ===== Search Highlighter =====
      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        const content = document.getElementById('content');
        if (!input || !content) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            content.innerHTML = originalHTML; 
            buildTOC(); 
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = content.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          content.innerHTML = content.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();

      // ===== Apply initial theme pack to prose =====
      try {
        const saved = localStorage.getItem('colorScheme');
        applyTheme(saved && THEME_PACKS[saved] ? saved : 'slate');
      } catch(_){
        applyTheme('slate');
      }
    });
  </script>
</body>
</html>

