<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
.material-symbols-outlined {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
}
</style>
<title>The Evolution of the City</title>

<!-- Prepaint bootstrap: set theme from localStorage or system preference -->
<script>
(function () {
  const root = document.documentElement;
  const saved = JSON.parse(localStorage.getItem('ui_theme')||'{}');
  const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
  const mode = saved.mode || (prefersDark ? 'dark' : 'light');
  const theme = saved.theme || 'slate';
  root.classList.toggle('dark', mode==='dark');
  root.classList.toggle('theme-emerald', mode==='dark' && theme==='emerald');
})();
</script>

<!-- Theme Variables -->
<style>
:root{
  --active: rgb(59,130,246);
  --subtitle-fg: rgb(71,85,105);
  --timeline-fg: rgb(100,116,139);
  --footer-fg: rgb(100,116,139);
  --border: rgb(226,232,240);
  --hover-bg: rgb(248,250,252);
  --btn-border: rgb(203,213,225);
  --btn-hover-bg: rgb(248,250,252);
  --input-border: rgba(203,213,225,0.7);
  --input-bg: rgba(255,255,255,0.7);
  --hero-base: transparent;
  --hero-r1: rgba(49,46,129,0.12);
  --hero-r2: rgba(234,88,12,0.12);
  --hero-wash: rgba(14,165,233,0.08);
}
html.dark{
  --subtitle-fg: rgb(203,213,225);
  --timeline-fg: rgb(148,163,184);
  --footer-fg: rgb(148,163,184);
  --border: rgb(30,41,59);
  --hover-bg: rgb(15,23,42);
  --btn-border: rgb(51,65,85);
  --btn-hover-bg: rgb(15,23,42);
  --input-border: rgba(51,65,85,0.7);
  --input-bg: rgba(2,6,23,0.6);
  --hero-base: rgb(2,6,23);
}
html.dark.theme-emerald{
  --active: #10b981;
  --border: rgba(110,231,183,0.55);
  --hover-bg: rgb(6,78,59);
  --btn-border: rgba(110,231,183,0.45);
  --btn-hover-bg: rgb(6,78,59);
  --input-border: rgba(110,231,183,0.55);
  --input-bg: rgba(6,95,70,0.60);
  --footer-fg: rgb(110,231,183);
  --subtitle-fg: rgb(226,252,236);
  --timeline-fg: rgb(187,247,208);
  --hero-base: rgb(2,44,34);
  --hero-r1: rgba(16,185,129,0.14);
  --hero-r2: rgba(163,230,53,0.12);
  --hero-wash: rgba(5,150,105,0.10);
}
.theme-emerald .prose h2,
.theme-emerald .prose h3,
.theme-emerald #docTitle,
.theme-emerald .subtitle,
.theme-emerald aside h2,
.theme-emerald .active-link{ color:#f0c475; }
</style>

<!-- Tailwind (with Typography) -->
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = { darkMode: 'class' };
</script>

<!-- Google Font (optional) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

<style>
:root { color-scheme: light dark; }
html { scroll-behavior: smooth; }
.font-newspaper { font-family: 'Lora', serif; }
:where(h2,h3,h4){ scroll-margin-top: 84px; }
mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
@media (max-width: 380px){ .prose { font-size: .96rem; } }

/* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.active-link { color: var(--active); font-weight: 700; }
.toc-link:hover { background: var(--hover-bg); }

/* Give the first paragraph after each H2/H3 the ribbon */
.prose :where(h2,h3) + p { padding-left: 1rem; border-left: 2px solid var(--border); }

/* Stop Tailwind Typography from enlarging `.lead` */
.prose p.lead { font-size: inherit !important; line-height: inherit !important; font-weight: inherit !important; }

/* ===== Modal Styles ===== */
.modal-overlay {
  display: none; position: fixed; z-index: 1000; left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.6);
  justify-content: center; align-items: center;
}
.modal-overlay.show { display: flex; }
.modal-content {
  background: var(--input-bg);
  color: var(--subtitle-fg);
  border: 1px solid var(--border);
  padding: 2rem; border-radius: 8px;
  text-align: center; position: relative; width: 90%; max-width: 400px;
}
.modal-content h3 { font-size: 1.5rem; margin-bottom: 1.5rem; }
.close-btn {
  position: absolute; top: 10px; right: 15px;
  color: var(--timeline-fg);
  font-size: 28px; font-weight: bold; background: none;
  border: none; cursor: pointer;
}
</style>
</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">

  <!-- Modal Theme Switcher HTML -->
  <div class="fixed top-4 right-4 z-50">
    <button id="settings-btn" class="p-2 rounded-full shadow-lg bg-white/70 dark:bg-slate-800/70 backdrop-blur" aria-label="toggle settings">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>
  </div>
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <button id="close-modal-btn" class="close-btn">×</button>
        <h3>Display Settings</h3>
        <button id="modalThemeBtn" class="w-full text-sm px-3 py-2 rounded-lg border border-[var(--btn-border)] hover:bg-[var(--btn-hover-bg)] mb-2">Toggle Light/Dark</button>
        <button id="modalColorBtn" class="w-full text-sm px-3 py-2 rounded-lg border border-[var(--btn-border)] hover:bg-[var(--btn-hover-bg)]">Change Color Scheme</button>
    </div>
  </div>

  <!-- Header -->
  <header id="top" class="hero border-b border-[var(--border)]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="text-[var(--subtitle-fg)] text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl bg-[var(--input-bg)] border-[var(--input-border)] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--active)]" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg border border-[var(--btn-border)] hover:bg-[var(--btn-hover-bg)]">Clear</button>
      </div>
    </div>

    <!-- Timeline / Sections Nav -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="text-[var(--timeline-fg)]">
        <ol id="timeline" class="grid grid-cols-2 sm:grid-cols-4 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl border border-[var(--border)] p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 border-t border-[var(--border)]" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg border border-[var(--btn-border)] hover:bg-[var(--btn-hover-bg)]">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg border border-[var(--btn-border)] hover:bg-[var(--btn-hover-bg)]">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- START PASTING HERE -->

      <!-- DO NOT PASTE ANYTHING AFTER THIS POINT -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs text-[var(--footer-fg)]">
    Threaded Reader — a single-file template
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from Content =====
      const firstArticle = document.querySelector('#content article');
      const docTitle = firstArticle?.querySelector('meta[name="doc-title"]')?.content || 'Untitled Document';
      const docSubtitle = firstArticle?.querySelector('meta[name="doc-subtitle"]')?.content || '';
      const timelineStepsData = firstArticle?.querySelector('meta[name="timeline-steps"]')?.content;
      const timelineLabelsData = firstArticle?.querySelector('meta[name="timeline-labels"]')?.content;

      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle;

      // ===== MODAL WIRING =====
      function initializeModal() {
        const modal = document.getElementById('settings-modal');
        const openBtn = document.getElementById('settings-btn');
        const closeBtn = document.getElementById('close-modal-btn');
        const modalThemeBtn = document.getElementById('modalThemeBtn');
        const modalColorBtn = document.getElementById('modalColorBtn');

        openBtn.onclick = () => modal.classList.add('show');
        closeBtn.onclick = () => modal.classList.remove('show');
        modal.onclick = (event) => { if (event.target === modal) modal.classList.remove('show'); };
        
        // Wire buttons to the global ThemeManager
        modalThemeBtn.onclick = () => ThemeManager.setMode(ThemeManager.get().mode==='dark'?'light':'dark');
        modalColorBtn.onclick = () => ThemeManager.setTheme(ThemeManager.get().theme==='emerald'?'slate':'emerald');
      }
      initializeModal();

      // ===== Expand/Collapse, TOC, Timeline, Search =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          if (!h.id) h.id = slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }

      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }
        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];
        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );
        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        const content = document.getElementById('content');
        if (!input || !content) return;
        let originalHTML = '';
        function restore(){
          if (originalHTML) {
            content.innerHTML = originalHTML;
            buildTOC();
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = content.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          content.innerHTML = content.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t;
        input.addEventListener('input', (e) => {
          clearTimeout(t);
          t = setTimeout(() => highlight(e.target.value.trim()), 120);
        });
        clearBtn?.addEventListener('click', () => {
          if (input) input.value='';
          restore();
        });
      })();

      buildTOC();
    });
  </script>

  <!-- Sanitizer: remove stray toolbar words; unwrap code-fenced HTML -->
  <script>
  (function () {
    // 1) Remove stray toolbar words the UI sometimes injects
    var BAD = new Set(['code','Code','download','content_copy','expand_less','expand_more']);
    (function cleanToolbarWords(root){
      var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      var toRemove = [];
      while (walker.nextNode()) {
        var n = walker.currentNode;
        var t = n.textContent.trim();
        if (!t) continue;
        if (BAD.has(t)) {
          var p = n.parentNode;
          var lonely = Array.from(p.childNodes).every(function(ch){
            return ch===n || (ch.nodeType===3 && !ch.textContent.trim());
          });
          toRemove.push(lonely ? p : n);
        }
      }
      toRemove.forEach(function(node){ if (node && node.remove) node.remove(); });
    })(document.body);

    // 2) Unwrap code-fenced HTML fragments into real nodes inside #content
    function unwrap(pre) {
      if (!pre) return;
      var raw = pre.textContent.trim();
      raw = raw.replace(/^```[a-z]*\n?/i,'').replace(/\n?```$/,'').trim();
      // decode HTML entities if needed
      if (raw.includes('&lt;') || raw.includes('&gt;') || raw.includes('&amp;')) {
        var ta = document.createElement('textarea'); ta.innerHTML = raw; raw = ta.value;
      }
      if (/<article|<h2|<meta\s+name="doc-title"/i.test(raw)) {
        var range = document.createRange();
        range.selectNode(pre);
        var frag = range.createContextualFragment(raw);
        pre.replaceWith(frag);
      }
    }

    // unwrap <pre><code>…</code></pre>
    document.querySelectorAll('#content pre > code').forEach(function(codeEl){
      unwrap(codeEl.closest('pre'));
    });
    // unwrap bare <pre> blocks (no :has() for iOS compatibility)
    document.querySelectorAll('#content pre').forEach(function(pre){
      if (!pre.querySelector('code')) unwrap(pre);
    });
  })();
  </script>
  
  <!-- Global Theme Manager -->
  <script>
  (function(){
    const root=document.documentElement;
    const saved=JSON.parse(localStorage.getItem('ui_theme')||'{}');
    const prefersDark=matchMedia('(prefers-color-scheme: dark)').matches;
    const state={ mode: saved.mode|| (prefersDark?'dark':'light'), theme: saved.theme||'slate' };
    function apply(){
      root.classList.toggle('dark', state.mode==='dark');
      root.classList.toggle('theme-emerald', state.mode==='dark' && state.theme==='emerald');
    }
    window.ThemeManager={
      setMode(m){ state.mode=m; localStorage.setItem('ui_theme',JSON.stringify(state)); apply(); },
      setTheme(t){ state.theme=t; localStorage.setItem('ui_theme',JSON.stringify(state)); apply(); },
      get(){ return {...state}; }
    };
    apply();
  })();
  </script>

</body>
</html>
