<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Colorful Reader 1.5</title>
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
tailwind.config = { darkMode: 'class' }
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
<style>
.font-newspaper{font-family:'Lora',serif}
html { scroll-behavior: smooth; }
details[open] summary::after { content: "▲"; float: right; }
details summary::after { content: "▼"; float: right; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 font-newspaper">
<div id="app" class="max-w-4xl mx-auto p-4">
<header class="flex items-center justify-between mb-6">
<h1 id="app-title" class="text-3xl font-bold">Colorful Reader</h1>
<button id="theme-toggle" class="px-3 py-1 border rounded">Toggle Theme</button>
</header>
<nav id="topic-nav" class="mb-4 flex flex-wrap gap-2"></nav>
<div id="article-nav" class="mb-4 flex flex-wrap gap-2"></div>
<article id="content-area" class="prose dark:prose-invert max-w-none"></article>
</div>
<script id="embedded-content" type="application/json">
{
  "song-of-moses": {
    "display_order": 10,
    "title": "The Song of Moses – Exodus 15",
    "description": "Study notes for church on the ‘Song of the Sea’ (Exodus 15:1–18), with Miriam’s refrain (15:20–21). Focus: story context, themes, worship use, reception, and music inspired by it.",
    "categories": {
      "biblical-text-outline": {
        "display_order": 10,
        "name": "Biblical Text & Outline",
        "display_name": "Biblical Text & Outline",
        "introduction": "Where it sits in Scripture and how the poem flows.",
        "paragraphs": [
          {
            "heading": "Location in Scripture",
            "content": "Exodus 15:1–18 is the main song (often called “Song of the Sea”); Exodus 15:20–21 preserves Miriam’s refrain with timbrel and dance."
          },
          {
            "heading": "Simple Outline",
            "content": "1) Opening praise: the LORD as the Deliverer (vv. 1–3). 2) Egypt’s defeat and Israel’s rescue through the sea (vv. 4–16). 3) Hope for God’s dwelling and reign among His people (vv. 17–18)."
          },
          {
            "heading": "Poetry Features",
            "content": "Repetition (“horse and rider”), vivid imagery (deep waters, right hand of the LORD), short parallel lines, and a forward look to worship at God’s holy mountain."
          }
        ]
      },
      "historical-background": {
        "display_order": 20,
        "name": "Historical Background",
        "display_name": "Historical Background",
        "introduction": "Setting, moment, and why this was sung.",
        "paragraphs": [
          {
            "heading": "Right After the Crossing",
            "content": "Israel sings in response to deliverance from Pharaoh’s chariots (Exodus 14). The song is communal thanksgiving after passing through the waters."
          },
          {
            "heading": "Late Bronze Age Context",
            "content": "References to horses, chariots, and elite officers match the period’s Egyptian military. The sea imagery fits a real escape followed by enemy loss."
          },
          {
            "heading": "Women Lead the Refrain",
            "content": "Miriam the prophet leads the women with timbrels and dancing, echoing the key line, modeling responsive worship for the congregation."
          }
        ]
      },
      "theological-themes": {
        "display_order": 30,
        "name": "Theological Themes",
        "display_name": "Theological Themes",
        "introduction": "What the song teaches about God and salvation.",
        "paragraphs": [
          {
            "heading": "God the Warrior—for the Oppressed",
            "content": "Calling the LORD a “man of war” pictures God using power to free slaves and confront injustice—not to bully the weak."
          },
          {
            "heading": "From Rescue to Worship",
            "content": "Verse 17 anticipates a holy dwelling where God “plants” His people. Salvation aims at fellowship and worship, not just escape from danger."
          },
          {
            "heading": "From Exodus to Revelation",
            "content": "Revelation 15:3–4 echoes this as “the song of Moses and the Lamb,” connecting the first great deliverance to the final one."
          }
        ]
      },
      "liturgy-use": {
        "display_order": 40,
        "name": "Use in Worship",
        "display_name": "Use in Worship",
        "introduction": "How God’s people have prayed/sung this through history.",
        "paragraphs": [
          {
            "heading": "Jewish Prayer",
            "content": "Known as Shirat HaYam, it’s recited in daily morning prayers and read on the seventh day of Passover in many communities."
          },
          {
            "heading": "Christian Baptismal Echoes",
            "content": "Early Christians connected the Red Sea to baptism: slavery → freedom, death → life, enemies left behind."
          },
          {
            "heading": "Call-and-Response",
            "content": "Miriam’s refrain shows a worship pattern—leader lines with congregational response—that churches still use today."
          }
        ]
      },
      "music-influence": {
        "display_order": 50,
        "name": "Music & Arts",
        "display_name": "Music & Arts",
        "introduction": "Notable musical settings and influence.",
        "paragraphs": [
          {
            "heading": "Handel and Beyond",
            "content": "Baroque works like Handel’s “Israel in Egypt” set Exodus 15 lines for choir; composers continue to adapt the text."
          },
          {
            "heading": "Chant and Cantillation",
            "content": "Traditional Torah cantillation assigns special melodies to this chapter; many congregations stand during its singing."
          },
          {
            "heading": "Modern Chorus",
            "content": "Popular worship songs quote the refrain: “I will sing unto the LORD, for He has triumphed gloriously; the horse and rider thrown into the sea.”"
          }
        ]
      },
      "reception-history": {
        "display_order": 60,
        "name": "Reception Through Time",
        "display_name": "Reception Through Time",
        "introduction": "How the song has been read and used.",
        "paragraphs": [
          {
            "heading": "Rabbinic and Patristic Readings",
            "content": "Rabbis linked the song to creation and covenant; church fathers read Pharaoh as sin and the sea as the waters of baptism."
          },
          {
            "heading": "Scholarly Notes",
            "content": "Many consider it among the oldest Hebrew poems, noting archaic style and early Israelite worship themes."
          }
        ]
      },
      "geography-and-visuals": {
        "display_order": 70,
        "name": "Geography & Visuals",
        "display_name": "Geography & Visuals",
        "introduction": "Maps and mental pictures for teaching.",
        "paragraphs": [
          {
            "heading": "Route Snapshot",
            "content": "A simple map can show: Egypt → departure sites → sea crossing → desert route toward Sinai."
          },
          {
            "heading": "Teaching Aid",
            "content": "Use a one-slide timeline: Slavery → Plagues → Passover → Crossing → Song → Journey to Sinai."
          }
        ]
      },
      "discussion-questions": {
        "display_order": 80,
        "name": "Discussion Starters",
        "display_name": "Discussion Starters",
        "introduction": "Prompt sharing and reflection.",
        "paragraphs": [
          {
            "heading": "Praise After Rescue",
            "content": "Why does praise come so naturally after deliverance? Share a time God brought you through and how you responded."
          },
          {
            "heading": "Power and Goodness",
            "content": "How does the song keep power from feeling scary? What in the lyrics shows God’s power is for the vulnerable?"
          },
          {
            "heading": "From Then to Now",
            "content": "If Revelation 15 puts this song on the lips of the redeemed, what do we learn about worship at the end of time?"
          }
        ]
      },
      "teaching-helps": {
        "display_order": 90,
        "name": "Teaching Helps",
        "display_name": "Teaching Helps",
        "introduction": "Ready-to-use class bits.",
        "paragraphs": [
          {
            "heading": "Memory Line",
            "content": "“The LORD is my strength and my song, and He has become my salvation” (Exodus 15:2)."
          },
          {
            "heading": "One-Sentence Summary",
            "content": "God rescues His people, defeats oppression, and leads them toward a future of worship in His presence."
          },
          {
            "heading": "Class Opener",
            "content": "Play a modern setting of Exodus 15’s refrain and ask: which words or images stand out to you and why?"
          }
        ]
      },
      "further-reading": {
        "display_order": 100,
        "name": "Further Reading",
        "display_name": "Further Reading",
        "introduction": "Next steps for the curious.",
        "paragraphs": [
          {
            "heading": "Bible Cross-Refs",
            "content": "See Psalms 66, 78, 106; Isaiah 12; Revelation 15:3–4 for echoes of the song’s themes."
          },
          {
            "heading": "Background Notes",
            "content": "Intro sections of good Exodus commentaries summarize historical setting, poetry, and worship use."
          }
        ]
      }
    }
  }
}
</script>
<script>
// ---------- State ----------
let library = null;
let sortedTopicIds = [];
let currentTopicId = null;
let currentArticleId = null;
let currentSectionSlug = null;

// ---------- Helpers ----------
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
const slug = s => (s||'').toLowerCase().trim()
  .replace(/[^\w\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-');

function readHash(){
  const p = new URLSearchParams(location.hash.slice(1));
  currentTopicId    = p.get('t') || currentTopicId;
  currentArticleId  = p.get('a') || currentArticleId;
  currentSectionSlug= p.get('s') || null;
}
function setHash(){
  const p = new URLSearchParams({
    t: currentTopicId || '',
    a: currentArticleId || '',
    s: currentSectionSlug || ''
  });
  if(location.hash.slice(1)!==p.toString()) location.hash = p.toString();
}
window.addEventListener('hashchange', ()=>{ readHash(); render(); });

function sectionKey(h){ return `cr15:sec:${currentTopicId}:${currentArticleId}:${slug(h)}`; }

// ---------- Theme ----------
function toggleTheme(){
  const dark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('cr15:dark', dark ? '1' : '0');
}
function applyThemeFromStorage(){
  const dark = localStorage.getItem('cr15:dark')==='1';
  document.documentElement.classList.toggle('dark', dark);
}

// ---------- UI Builders ----------
function buildTopicNav(){
  const nav = $('#topic-nav');
  nav.innerHTML = '';
  sortedTopicIds.forEach(id=>{
    const t = library[id];
    const btn = document.createElement('button');
    btn.className = `px-3 py-1 rounded border ${id===currentTopicId?'bg-gray-900 text-white dark:bg-white dark:text-gray-900':''}`;
    btn.textContent = t.title || id;
    btn.addEventListener('click', ()=>{
      currentTopicId = id;
      currentArticleId = null;
      currentSectionSlug = null;
      render();
    });
    nav.appendChild(btn);
  });
}

function buildArticleNav(topic){
  const nav = $('#article-nav');
  nav.innerHTML = '';

  const keys = Object.keys(topic.categories||{}).sort(
    (a,b)=>(topic.categories[a].display_order||0)-(topic.categories[b].display_order||0)
  );
  if(!currentArticleId || !topic.categories[currentArticleId]) currentArticleId = keys[0] || null;

  keys.forEach(k=>{
    const a = topic.categories[k];
    const btn = document.createElement('button');
    btn.className = `px-3 py-1 rounded border ${k===currentArticleId?'bg-gray-900 text-white dark:bg-white dark:text-gray-900':''}`;
    btn.textContent = a.display_name || a.name || k;
    btn.addEventListener('click', ()=>{
      currentArticleId = k;
      currentSectionSlug = null;
      render();
    });
    nav.appendChild(btn);
  });
}

function buildContent(topic, article){
  const area = $('#content-area');
  const intro = article.introduction ? `<p>${article.introduction}</p>` : '';
  const paras = (article.paragraphs||[]).map(p=>{
    const s = slug(p.heading);
    const open = localStorage.getItem(sectionKey(p.heading))==='1' || (currentSectionSlug===s);
    return `
      <details class="mb-3" data-sec="${s}" ${open?'open':''}>
        <summary class="font-semibold cursor-pointer">${p.heading}</summary>
        <div class="mt-2">
          <div class="mb-2">
            <button class="text-sm border px-2 py-0.5 rounded copy-link" data-sec="${s}">🔗 Copy link</button>
          </div>
          ${p.content}
        </div>
      </details>`;
  }).join('');

  area.innerHTML = `
    <h2 class="mt-4">${article.display_name || article.name || ''}</h2>
    ${intro}
    ${paras}
  `;

  // persist open/close + set deep link on open
  $$('#content-area details').forEach(d=>{
    const s = d.getAttribute('data-sec');
    const heading = $('summary', d)?.textContent?.trim() || '';
    d.addEventListener('toggle', ()=>{
      localStorage.setItem(sectionKey(heading), d.open?'1':'0');
      if(d.open){
        currentSectionSlug = s;
        setHash();
      }
    });
  });

  // copy link buttons
  $$('.copy-link').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const s = e.currentTarget.getAttribute('data-sec');
      currentSectionSlug = s; setHash();
      try{
        await navigator.clipboard.writeText(location.href);
        e.currentTarget.textContent = '✅ Copied';
        setTimeout(()=>e.currentTarget.textContent='🔗 Copy link', 1200);
      }catch{
        alert('Link: '+location.href);
      }
    });
  });

  // scroll to deep-linked section if present
  if(currentSectionSlug){
    const target = $(`details[data-sec="${currentSectionSlug}"]`, area);
    if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
  }
}

// ---------- Render ----------
function render(){
  if(!library) return;

  sortedTopicIds = Object.keys(library).sort((a,b)=>(library[a].display_order||0)-(library[b].display_order||0));
  if(!currentTopicId || !library[currentTopicId]) currentTopicId = sortedTopicIds[0];

  const topic = library[currentTopicId];
  document.title = topic.title || 'Colorful Reader';
  $('#app-title').textContent = topic.title || 'Colorful Reader';

  buildTopicNav();
  buildArticleNav(topic);
  if(currentArticleId){
    buildContent(topic, topic.categories[currentArticleId]);
  }else{
    $('#content-area').innerHTML = '<p>No article found.</p>';
  }

  setHash();
}

// ---------- Boot ----------
(async function boot(){
  applyThemeFromStorage();
  $('#theme-toggle').addEventListener('click', toggleTheme);

  // try external /data/content.json, else embedded
  try{
    const res = await fetch('./data/content.json', {cache:'no-store'});
    if(!res.ok) throw new Error(String(res.status));
    library = await res.json();
  }catch{
    const embedded = $('#embedded-content')?.textContent?.trim() || '';
    library = embedded ? JSON.parse(embedded) : null;
  }

  if(!library){
    $('#content-area').innerHTML = '<h2>Could not load content</h2><p>Provide /data/content.json or embedded JSON.</p>';
    return;
  }

  readHash();
  render();
})();
</script>
</body>
</html>
