<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analyzer</title>
  <style>
    /* 1. STRICT DARK COMMAND CENTER THEME */
    :root { 
        --brand: #8bb9ff; /* Default, will be overridden by JS */
        --bg: #0b1020;    /* STRICT NAVY */
        --panel: #111833; /* STRICT NAVY PANEL */
        --border: #26325b;
        --ink: #e6ecff;
        --muted: #a7b0cc;
        --bad: #ff6b6b;
    }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        background-color: var(--bg);
        color: var(--ink);
        /* Exact Gradient from War Hub */
        background: radial-gradient(1200px 600px at 10% -5%, rgba(139,185,255,.10), transparent 55%),
                    radial-gradient(1000px 400px at 95% 10%, rgba(192,255,225,.05), transparent 60%), var(--bg);
        padding: 1rem; 
        min-height: 100vh; 
    }

    .wrapper { max-width: 860px; margin: 0 auto; }
    
    .breadcrumb { margin-bottom: 1.5rem; }
    .breadcrumb a { color: var(--brand); text-decoration: none; font-weight: 500; opacity: 0.8; transition: opacity 0.2s; }
    .breadcrumb a:hover { opacity: 1; }

    /* Typography */
    h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.2; color: var(--ink); }
    .subtitle { color: var(--muted); font-style: italic; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }

    /* 2. SNAPSHOT ACCORDION CSS */
    .section { 
        background: var(--panel); 
        border: 1px solid var(--border); 
        border-radius: 12px; 
        margin-bottom: 1rem; 
        overflow: hidden; 
        transition: border-color 0.2s;
    }
    
    .section:hover { border-color: var(--brand); }

    .section-header { 
        padding: 1rem 1.5rem; 
        background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent); 
        color: var(--brand); 
        font-weight: 700; 
        font-size: 1.1rem;
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        user-select: none;
    }

    .section-icon { transition: transform 0.3s ease; }
    .section.active .section-icon { transform: rotate(180deg); }

    .section-content { 
        max-height: 0; 
        overflow: hidden; 
        transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
        opacity: 0.9;
        line-height: 1.7;
        color: var(--muted);
    }

    .section.active .section-content { 
        max-height: 3000px; 
        border-top: 1px solid var(--border);
        padding: 1.5rem; 
    }

    /* Children Styling (Lists & Paragraphs) */
    .section-content ul { list-style: none; padding: 0; margin: 0; }
    .section-content li { 
        margin-bottom: 0.75rem; 
        padding-left: 1rem; 
        border-left: 2px solid var(--brand); 
    }
    .section-content p { margin-bottom: 1rem; }
    .section-content strong { color: var(--ink); }

    /* Summary Box */
    .main-summary {
        background: var(--panel);
        border: 1px solid var(--border);
        border-left: 4px solid var(--brand);
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        font-size: 1.1rem;
        line-height: 1.6;
        color: var(--ink);
    }

    /* Loading/Error */
    .loading { opacity: 0.5; pointer-events: none; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.2; } }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="breadcrumb">
      <a id="backLink" href="#">‚Üê Return</a>
    </div>

    <div id="container">
        <h1 id="r-title">Initializing...</h1>
        <p id="r-subtitle" class="subtitle"></p>
        <div id="r-content"></div> 
    </div>
  </div>

  <script>
    const API_KEY = ""; // Set API Key
    
    // 1. BOOTSTRAP
    const urlParams = new URLSearchParams(window.location.search);
    const FACTORY_SLUG = urlParams.get('factory');
    const CONTEXT_SLUG = urlParams.get('context');
    const RECORD_ID = urlParams.get('id');
    const QUERY = urlParams.get('q');

    const CONFIG = JSON.parse(localStorage.getItem(`as-config-${FACTORY_SLUG}`));
    const CONTEXT_NAME = CONTEXT_SLUG.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

    // 2. APPLY THEME (ACCENTS ONLY)
    // We strictly control the Brand color, but keep the background Navy
    document.documentElement.style.setProperty('--brand', CONFIG.theme.brand);
    // Tint the border slightly with the brand color for integration
    document.documentElement.style.setProperty('--border', `${CONFIG.theme.brand}33`); // 20% opacity
    
    document.getElementById('backLink').innerText = `‚Üê Return to ${CONTEXT_NAME}`;
    document.getElementById('backLink').href = `../as-factory-hub/index.html?factory=${FACTORY_SLUG}&context=${CONTEXT_SLUG}`;

    // 3. HANDLER
    const APP_ID = `as-${FACTORY_SLUG}-${CONTEXT_SLUG}-data-`;

    async function init() {
        if (RECORD_ID) {
            const cached = localStorage.getItem(RECORD_ID);
            if(cached) render(JSON.parse(cached));
        } else if (QUERY) {
            const simpleKey = QUERY.toLowerCase().replace(/[^a-z0-9]/g, '');
            const fullKey = APP_ID + simpleKey;
            
            const cached = localStorage.getItem(fullKey);
            if(cached) { render(JSON.parse(cached)); return; }

            // Fetch
            document.getElementById('container').classList.add('loading');
            document.getElementById('r-title').innerText = "Processing...";
            document.getElementById('r-subtitle').innerText = `Consulting ${CONFIG.ai.role}...`;
            
            try {
                const result = await fetchAI(QUERY);
                result.timestamp = Date.now();
                localStorage.setItem(fullKey, JSON.stringify(result));
                render(result);
            } catch(e) {
                alert(e.message);
                document.getElementById('r-title').innerText = "Error";
            } finally {
                document.getElementById('container').classList.remove('loading');
            }
        }
    }

    // 4. DYNAMIC PROMPT BUILDER
    async function fetchAI(query) {
        // Build schema list for the prompt
        const schemaInstructions = CONFIG.ai.sections.map(s => 
            `{ "label": "${s.label}", "content": "Write content based on instruction: ${s.instruction}" }`
        ).join(',\n');

        const prompt = `
            Role: ${CONFIG.ai.role}.
            Context: ${CONFIG.ai.context}: "${CONTEXT_NAME}".
            Query: "${query}".

            Guard Rails: ${CONFIG.ai.guardRails} If violated, return isDenial: true.

            Format: STRICT JSON.
            {
                "isDenial": boolean,
                "title": "Formal Title",
                "subtitle": "Thematic Subtitle",
                "summary": "Executive Summary (Paragraph)",
                "sections": [ 
                    ${schemaInstructions} 
                ]
            }
        `;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
        });
        const data = await response.json();
        return JSON.parse(data.candidates[0].content.parts[0].text);
    }

    // 5. RENDERER (SNAPSHOT UI)
    function render(data) {
        const title = document.getElementById('r-title');
        const sub = document.getElementById('r-subtitle');
        const content = document.getElementById('r-content');

        if(data.isDenial) {
            title.innerText = "ACCESS DENIED";
            title.style.color = "#ff6b6b";
            sub.innerText = data.subtitle || "Irrelevant Query";
            content.innerHTML = `<div style="border:1px dashed #ff6b6b; color:#ff6b6b; padding:2rem; text-align:center;">${data.summary}</div>`;
            return;
        }

        title.innerText = data.title;
        sub.innerText = data.subtitle;
        
        // 1. Render Summary Card
        let html = `<div class="main-summary">${data.summary}</div>`;
        
        // 2. Render Accordions
        if(data.sections) {
            data.sections.forEach((sec, index) => {
                const configSec = CONFIG.ai.sections[index] || { icon: "üîπ" };
                
                html += `
                    <div class="section">
                        <div class="section-header" onclick="this.parentElement.classList.toggle('active')">
                            <span>${configSec.icon} ${sec.label}</span>
                            <span class="section-icon">‚ñº</span>
                        </div>
                        <div class="section-content">
                            ${sec.content}
                        </div>
                    </div>
                `;
            });
        }
        content.innerHTML = html;
        
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    }

    init();
  </script>
</body>
</html>
