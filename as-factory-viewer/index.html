<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analyzer</title>
  <style>
    :root { --brand: #fff; --panel: rgba(255,255,255,0.05); }
    body { font-family: sans-serif; background: #000; color: #e6ecff; padding: 1rem; min-height: 100vh; }
    .wrapper { max-width: 860px; margin: 0 auto; }
    .breadcrumb a { color: var(--brand); text-decoration: none; }
    h1 { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
    .section { background: var(--panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; }
    .section-header { padding: 1rem; background: rgba(255,255,255,0.03); color: var(--brand); font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; }
    .section-content { padding: 1.5rem; color: #ccc; line-height: 1.6; }
    .loading { opacity: 0.5; pointer-events: none; animation: pulse 1s infinite; }
    @keyframes pulse { 50% { opacity: 0.2; } }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="breadcrumb" style="margin-bottom:1rem;">
      <a id="backLink" href="#">‚Üê Return</a>
    </div>

    <div id="container">
        <h1 id="r-title">Initializing...</h1>
        <p id="r-subtitle" style="color:#888; margin-bottom:2rem; font-style:italic;"></p>
        <div id="r-content"></div> 
    </div>
  </div>

  <script>
    const API_KEY = "AIzaSyBjL7zhEjoBgqCaXCxID3hV9KZNaPm5M8A"; 
    
    // 1. BOOTSTRAP
    const urlParams = new URLSearchParams(window.location.search);
    const FACTORY_SLUG = urlParams.get('factory');
    const CONTEXT_SLUG = urlParams.get('context');
    const RECORD_ID = urlParams.get('id');
    const QUERY = urlParams.get('q');

    const CONFIG = JSON.parse(localStorage.getItem(`as-config-${FACTORY_SLUG}`));
    const CONTEXT_NAME = CONTEXT_SLUG.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

    // 2. APPLY THEME
    document.documentElement.style.setProperty('--brand', CONFIG.theme.brand);
    document.body.style.background = `radial-gradient(circle at 50% -20%, ${CONFIG.theme.bg_gradient_1}, ${CONFIG.theme.bg_gradient_2})`;
    
    document.getElementById('backLink').innerText = `‚Üê Return to ${CONTEXT_NAME}`;
    document.getElementById('backLink').href = `../as-factory-hub/index.html?factory=${FACTORY_SLUG}&context=${CONTEXT_SLUG}`;

    // 3. HANDLER
    const APP_ID = `as-${FACTORY_SLUG}-${CONTEXT_SLUG}-data-`;

    async function init() {
        if (RECORD_ID) {
            const cached = localStorage.getItem(RECORD_ID);
            if(cached) render(JSON.parse(cached));
        } else if (QUERY) {
            const simpleKey = QUERY.toLowerCase().replace(/[^a-z0-9]/g, '');
            const fullKey = APP_ID + simpleKey;
            
            const cached = localStorage.getItem(fullKey);
            if(cached) { render(JSON.parse(cached)); return; }

            // Fetch
            document.getElementById('container').classList.add('loading');
            document.getElementById('r-title').innerText = "Analyzing...";
            document.getElementById('r-subtitle').innerText = `Consulting ${CONFIG.ai.role}...`;
            
            try {
                const result = await fetchAI(QUERY);
                result.timestamp = Date.now();
                localStorage.setItem(fullKey, JSON.stringify(result));
                render(result);
            } catch(e) {
                alert(e.message);
            } finally {
                document.getElementById('container').classList.remove('loading');
            }
        }
    }

    // 4. DYNAMIC PROMPT BUILDER
    async function fetchAI(query) {
        // Dynamically build the section schema based on config
        const sectionSchema = CONFIG.ai.sections.map(s => `
            { "label": "${s.label}", "content": "Detailed content following instruction: ${s.instruction}" }
        `).join(',');

        const prompt = `
            Role: ${CONFIG.ai.role}.
            Context: ${CONFIG.ai.context}: "${CONTEXT_NAME}".
            Query: "${query}".

            Guard Rails: ${CONFIG.ai.guardRails} If violated, return isDenial: true.

            Format: STRICT JSON.
            {
                "isDenial": boolean,
                "title": "Formal Title",
                "subtitle": "Thematic Subtitle",
                "summary": "Executive Summary",
                "sections": [ ${sectionSchema} ]
            }
        `;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
        });
        const data = await response.json();
        return JSON.parse(data.candidates[0].content.parts[0].text);
    }

    // 5. DYNAMIC RENDERER
    function render(data) {
        const title = document.getElementById('r-title');
        const sub = document.getElementById('r-subtitle');
        const content = document.getElementById('r-content');

        if(data.isDenial) {
            title.innerText = "ACCESS DENIED";
            title.style.color = "#ff6b6b";
            sub.innerText = data.subtitle || "Irrelevant Query";
            content.innerHTML = `<div style="border:1px dashed #ff6b6b; color:#ff6b6b; padding:2rem; text-align:center;">${data.summary}</div>`;
            return;
        }

        title.innerText = data.title;
        sub.innerText = data.subtitle;
        
        // Loop through the CONFIG SECTIONS (not just data) to ensure icons match
        let html = `<div class="section"><div class="section-content" style="font-size:1.1rem; color:#fff;">${data.summary}</div></div>`;
        
        // We iterate the data sections, matching them to config icons if possible
        if(data.sections) {
            data.sections.forEach((sec, index) => {
                // Try to find the matching icon from config by index or label
                const configSec = CONFIG.ai.sections[index] || { icon: "üîπ" };
                
                html += `
                    <div class="section">
                        <div class="section-header" onclick="this.parentElement.classList.toggle('active')">
                            <span>${configSec.icon} ${sec.label}</span>
                        </div>
                        <div class="section-content">${sec.content}</div>
                    </div>
                `;
            });
        }
        content.innerHTML = html;
    }

    init();
  </script>
</body>
</html>
