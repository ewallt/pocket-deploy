<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WWII Viewer</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚔️</text></svg>">
  <link rel="stylesheet" href="poc-ww2-styles.css">
</head>
<body>
  <script src="poc-ww2-config.js"></script>
  <script src="poc-ww2-renderers.js"></script>
  <script src="poc-ww2-store.js"></script>

  <div class="container narrow">
    <div class="breadcrumb">
      <a href="poc-ww2-hub.html" id="nav-hub-link">Hub</a> <span id="bread-title">...</span>
    </div>
    <div id="app-root"></div>
  </div>
  <button id="backToTop" class="back-to-top" onclick="scrollToTop()">↑</button>

  <script>
    function applyTheme() {
      const themeName = localStorage.getItem('poc-ww2-theme-pref') || 'navy_exp';
      
      // 1. Check for Custom
      if (themeName === 'custom') {
        const customRaw = localStorage.getItem('poc-ww2-custom-theme');
        if (customRaw) {
          const customColors = JSON.parse(customRaw);
          const root = document.documentElement;
          for (const [key, value] of Object.entries(customColors)) {
            root.style.setProperty(key, value);
          }
          return;
        }
      }

      // 2. Standard Loading
      if (typeof APP_CONFIG === 'undefined') return;
      let theme = APP_CONFIG.themes[themeName];
      if (!theme) theme = APP_CONFIG.themes['navy_exp'];
      if (!theme) theme = Object.values(APP_CONFIG.themes)[0];

      const root = document.documentElement;
      for (const [key, value] of Object.entries(theme.colors)) {
        root.style.setProperty(key, value);
      }
    }
    applyTheme();

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function renderPage() {
      const id = getQueryParam('id');
      const appRoot = document.getElementById('app-root');
      const breadTitle = document.getElementById('bread-title');
      const navHubLink = document.getElementById('nav-hub-link');

      breadTitle.innerText = APP_CONFIG.labels.loading;
      navHubLink.innerText = APP_CONFIG.labels.backToHub;

      if (typeof Store === 'undefined') return;
      const item = Store.getById(id);

      if (!item) {
        breadTitle.innerText = APP_CONFIG.labels.errorTitle;
        appRoot.innerHTML = `<div class="error-msg"><h2>${APP_CONFIG.labels.errorBody}</h2></div>`;
        return;
      }

      document.title = item.meta.title;
      breadTitle.innerText = `› ${item.meta.title}`;

      let html = `
        <header>
          <h1>${item.meta.title}</h1>
          <p class="subtitle">${item.meta.subtitle}</p>
        </header>
        <section class="main-answer">
          <h2>${APP_CONFIG.labels.summaryHeader}</h2>
          <p>${item.content.summary}</p>
        </section>
      `;

      APP_CONFIG.sections.forEach((sectionConfig) => {
        const sectionData = item.content[sectionConfig.key];
        const renderFn = RENDERERS[sectionConfig.type] || RENDERERS.list;
        html += `
          <section class="section">
            <div class="section-header" onclick="toggleSection(this)">
              <h2>${sectionConfig.title}</h2>
              <span class="section-icon">▼</span>
            </div>
            <div class="section-content"><div class="section-inner">${renderFn(sectionData)}</div></div>
          </section>
        `;
      });
      appRoot.innerHTML = html;
    }

    function toggleSection(header) {
      const section = header.parentElement;
      document.querySelectorAll('.section').forEach(s => {
        if (s !== section && s.classList.contains('active')) s.classList.remove('active');
      });
      section.classList.toggle('active');
    }

    window.addEventListener('scroll', () => {
      const btn = document.getElementById('backToTop');
      if (window.pageYOffset > 300) btn.classList.add('visible');
      else btn.classList.remove('visible');
    });
    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    document.addEventListener('DOMContentLoaded', renderPage);
  </script>
</body>
</html>
