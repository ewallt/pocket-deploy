<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Collective Intelligence Playbook</title>

  <!-- Prepaint bootstrap: set dark + theme class before paint to avoid flicker -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');       // 'light' | 'dark' | null
      const savedColor = localStorage.getItem('colorScheme'); // 'slate' | 'emerald' | future
      const isDark = savedTheme !== 'light';                  // default to dark if unset
      root.classList.toggle('dark', isDark);
      // Apply colored theme classes ONLY in dark mode; light is always neutral slate
      root.classList.toggle('theme-emerald', isDark && savedColor === 'emerald');
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
  :root { color-scheme: light dark; }
  html { scroll-behavior: smooth; }
  .font-newspaper { font-family: 'Lora', serif; }
  :where(h2,h3,h4){ scroll-margin-top: 84px; }
  mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
  @media (max-width: 380px){ .prose { font-size: .96rem; } }

  /* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  /* give the header an explicit base fill so gradient blends to the right hue */
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.border-var { border-color: var(--border) !important; }
.surface { border-width: 1px; border-style: solid; border-color: var(--border); }
.hr-var { border-color: var(--border); }
.subtitle { color: var(--subtitle-fg); }
.timeline-fg { color: var(--timeline-fg); }
.footer-note { color: var(--footer-fg); }
.active-link { color: var(--active); font-weight: 700; }

.input-surface {
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
}
.btn-surface { border: 1px solid var(--btn-border); }
.btn-surface:hover { background: var(--btn-hover-bg); }
.toc-link:hover { background: var(--hover-bg); }

/* ---------- Slate (default) variables ---------- */
:root{
  /* accents / inks */
  --active: rgb(59,130,246);                      /* sky-500 */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(100,116,139);                /* slate-500 */
  --footer-fg: rgb(100,116,139);                  /* slate-500 */

  /* surfaces */
  --border: rgb(226,232,240);                     /* slate-200 */
  --hover-bg: rgb(248,250,252);                   /* slate-50 */
  --btn-border: rgb(203,213,225);                 /* slate-300 */
  --btn-hover-bg: rgb(248,250,252);               /* slate-50 */
  --input-border: rgba(203,213,225,0.7);          /* slate-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* hero base & gradient (light) */
  --hero-base: transparent;                       /* keep light header airy */
  --hero-r1: rgba(49,46,129,.12);                 /* indigo-700 */
  --hero-r2: rgba(234,88,12,.12);                 /* orange-600 hint */
  --hero-wash: rgba(14,165,233,.08);              /* sky-500 wash */
}
.dark{
  --subtitle-fg: rgb(203,213,225);                /* slate-300 */
  --timeline-fg: rgb(148,163,184);                /* slate-400 */
  --footer-fg: rgb(148,163,184);                  /* slate-400 */

  --border: rgb(30,41,59);                        /* slate-800 */
  --hover-bg: rgb(15,23,42);                      /* slate-900 */
  --btn-border: rgb(51,65,85);                    /* slate-700 */
  --btn-hover-bg: rgb(15,23,42);                  /* slate-900 */
  --input-border: rgba(51,65,85,0.7);             /* slate-700/70 */
  --input-bg: rgba(2,6,23,0.6);                   /* slate-950/60 */

  /* hero base & gradient (dark) */
  --hero-base: rgb(2,6,23);                       /* slate-950 */
  --hero-r1: rgba(49,46,129,.12);
  --hero-r2: rgba(234,88,12,.12);
  --hero-wash: rgba(14,165,233,.08);
}

/* ---------- Emerald theme overrides (light & dark) ---------- */
.theme-emerald{
  --active: #10b981;                              /* emerald-500 */

  --border: rgb(187,247,208);                     /* emerald-200 */
  --hover-bg: rgb(240,253,244);                   /* emerald-50 */
  --btn-border: rgb(187,247,208);                 /* emerald-200 */
  --btn-hover-bg: rgb(240,253,244);               /* emerald-50 */
  --input-border: rgba(110,231,183,0.7);          /* emerald-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* keep subtitles/timeline neutral for readability over hero */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(71,85,105);                  /* slate-600 */
  --footer-fg: rgb(16,185,129);                   /* emerald-500 */

  /* hero base & gradient (emerald light) */
  --hero-base: transparent;
  --hero-r1: rgba(16,185,129,.14);                /* emerald-500 */
  --hero-r2: rgba(163,230,53,.12);                /* lime-400 */
  --hero-wash: rgba(5,150,105,.10);               /* emerald-600 wash */
}
.dark.theme-emerald{
  /* ↑ Give borders enough contrast on dark emerald surfaces */
  --border: rgba(110,231,183,0.55);                /* emerald-300 @ 55% */
  --hover-bg: rgb(6,78,59);                        /* emerald-900 */
  --btn-border: rgba(110,231,183,0.45);            /* slightly softer than borders */
  --btn-hover-bg: rgb(6,78,59);                    /* emerald-900 */
  --input-border: rgba(110,231,183,0.55);          /* match border contrast */
  --input-bg: rgba(6,95,70,0.60);                  /* emerald-900/60 */

  /* text accents for readability */
  --footer-fg: rgb(110,231,183);                   /* emerald-300/400 */
  --subtitle-fg: rgb(226,252,236);                 /* emerald-100 */
  --timeline-fg: rgb(187,247,208);                 /* emerald-200 */

  /* hero base & gradient (unchanged, stays emerald) */
  --hero-base: rgb(2,44,34);                       /* emerald-950 (#022c22) */
  --hero-r1: rgba(16,185,129,.14);
  --hero-r2: rgba(163,230,53,.12);
  --hero-wash: rgba(5,150,105,.10);
}

/* ===== Mobile FAB quick settings ===== */
#fabPanel.show { display:block; animation: fadeUp .14s ease-out; }
@keyframes fadeUp { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
  </style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">

  <!-- Header -->
  <header id="top" class="hero border-b border-var">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="subtitle text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl input-surface px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg btn-surface">Clear</button>

        <!-- Header controls: hidden on small screens -->
        <button id="colorSchemeToggle" type="button" class="hidden sm:inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Change color scheme">
          <span class="inline md:hidden">Colors</span>
          <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
            <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
            <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
            <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 7.012 17.461 2 12 2z"/>
          </svg>
        </button>
        <button id="themeToggle" type="button" class="hidden sm:inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Toggle dark mode" aria-pressed="false">
          <span class="inline md:hidden">Theme</span>
          <svg aria-hidden="true" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg aria-hidden="true" class="w-5 h-5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </div>

    <!-- Timeline -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="timeline-fg">
        <ol id="timeline" class="grid grid-cols-3 sm:grid-cols-6 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl surface p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 hr-var" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg btn-surface">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg btn-surface">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- Content is generated by script from JSON -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs footer-note">
    Threaded Reader — a single-file template
  </footer>

  <!-- Mobile quick settings FAB + Panel -->
  <button id="fab" class="fixed z-40 top-4 right-4 sm:hidden rounded-full shadow-lg px-4 py-3 text-sm btn-surface backdrop-blur">
    ⚙️
  </button>
  <div id="fabPanel" class="bg-white dark:bg-slate-800 sm:hidden fixed z-40 top-20 right-4 w-56 rounded-xl surface p-3 hidden">
    <div class="text-xs mb-2 opacity-80">Quick settings</div>
    <button id="fabTheme" class="w-full text-sm px-3 py-2 rounded-lg btn-surface mb-2">Toggle Theme</button>
    <button id="fabColor" class="w-full text-sm px-3 py-2 rounded-lg btn-surface">Cycle Colors</button>
  </div>

  <script id="embedded-json" type="application/json">
    {
      "title": "The Collective Intelligence Playbook",
      "description": "A practical, action-oriented guide for applying the principles of collective intelligence in business, community, and personal decision-making.",
      "articles": [
        {
          "title": "How to Improve Team Decisions",
          "introduction": "Most teams default to open discussion, which is often dominated by the loudest voices and first opinions. These structured techniques are designed to extract the true, independent wisdom of every member to arrive at a smarter collective decision.",
          "threads": [
            {
              "title": "Tactic 1: Appoint a Devil's Advocate",
              "content": "<p>Groupthink is the silent killer of good decisions. To combat it, formally assign one or more team members the role of 'devil's advocate.' Their job is to <mark>critically question assumptions and argue against the prevailing consensus</mark>. This is not about being negative; it's about stress-testing the decision. By making dissent a formal role, you give it legitimacy and create psychological safety for others to voice their own concerns. Rotate the role so no single person becomes labeled as a naysayer.</p>"
            },
            {
              "title": "Tactic 2: The Delphi Method",
              "content": "<p>The Delphi Method is a powerful forecasting technique that leverages independence. Instead of a group discussion, you <mark>anonymously poll a panel of experts</mark> for their individual predictions and the reasoning behind them. A facilitator then aggregates the results, circulates a summary of the arguments, and asks the experts to revise their forecasts. This iterative process is repeated for a few rounds. It allows the group to benefit from diverse reasoning without the biasing effects of social pressure or a single charismatic expert dominating the conversation.</p>"
            },
            {
              "title": "Tactic 3: After-Action Reviews (AARs)",
              "content": "<p>To improve future decisions, you must learn from past ones. The AAR is a simple but profound technique developed by the U.S. Army. After any project or event, the team gathers to answer four simple questions: <mark>1) What was supposed to happen? 2) What actually happened? 3) Why was there a difference? 4) What will we do differently next time?</mark> This blameless process focuses on learning and creates a repository of organizational wisdom, ensuring that the group's intelligence grows over time.</p>"
            }
          ]
        },
        {
          "title": "How to Design a Prediction Market",
          "introduction": "Prediction markets are one of the purest forms of collective intelligence, forcing people to 'bet on beliefs' to produce uncannily accurate forecasts. Setting one up requires careful design to ensure the market is clear, fair, and effective.",
          "threads": [
            {
              "title": "Step 1: Frame a Clear, Resolvable Question",
              "content": "<p>The foundation of a good prediction market is an unambiguously worded question whose outcome will be clear to everyone. A bad question is, 'Will the new product be a success?' A good question is, <mark>'Will Product X achieve over 100,000 unit sales in Q3 2026, as reported in the official Q3 earnings call?'</mark> The question must be specific, time-bound, and have an objective source for resolution. This clarity is non-negotiable.</p>"
            },
            {
              "title": "Step 2: Define the Outcomes as Contracts",
              "content": "<p>The question must be translated into tradable contracts. For a simple 'Yes/No' question, you create a contract that pays out $1 if the answer is 'Yes' and $0 if the answer is 'No.' The market price of this contract will then fluctuate between $0 and $1, representing the market's real-time probability estimate. For example, a price of $0.70 implies a 70% chance of the 'Yes' outcome.</p>"
            },
            {
              "title": "Step 3: Incentivize and Attract Traders",
              "content": "<p>A market needs traders to be wise. You must incentivize participation. This can be done with <mark>real but small amounts of money</mark>, which is the most powerful incentive. Alternatively, you can use 'play money' where participants compete for status on a leaderboard or small non-monetary prizes. The key is to attract a diverse group of traders who possess different pieces of information and perspectives about the question being asked.</p>"
            },
            {
              "title": "Step 4: Interpret the Results",
              "content": "<p>The market's output is not a single answer but a <mark>continuously updated probability</mark>. The price is the forecast. A manager can watch this price evolve over time. If the probability of a project finishing on time drops from 80% to 40% over two weeks, it's a powerful early warning signal that something is wrong, allowing for intervention long before a formal delay is announced. The wisdom is in the dynamic signal, not a final answer.</p>"
            }
          ]
        },
        {
          "title": "How to Run an Effective Brainstorm",
          "introduction": "Traditional brainstorming often fails because it violates the core principles of collective intelligence. A few people dominate, ideas get shot down prematurely, and the pressure to conform stifles creativity. These techniques are designed to maximize both the diversity and quality of ideas.",
          "threads": [
            {
              "title": "Tactic 1: Brainwriting (Silent Brainstorming)",
              "content": "<p>To ensure independence and diversity, begin with silence. Before any discussion, give every individual 5-10 minutes to <mark>write down as many ideas as they can on their own</mark>. This prevents the 'anchoring effect' where the first idea spoken aloud frames the entire conversation. It ensures that ideas from introverts are captured just as effectively as those from extroverts. The initial pool of ideas will be far larger and more varied than in a traditional brainstorm.</p>"
            },
            {
              "title": "Tactic 2: Round Robin for Sharing",
              "content": "<p>After the silent generation phase, go around the room in a structured, 'round robin' fashion. Each person shares <mark>one idea from their list</mark>. The facilitator writes it on a whiteboard. Continue going around the room until all unique ideas have been shared. During this phase, there is no discussion or criticism allowed—the goal is simply to get all the raw ideas out and visible to the group. This ensures every single person contributes.</p>"
            },
            {
              "title": "Tactic 3: Dot-Voting for Aggregation",
              "content": "<p>Now that you have a diverse set of ideas, you need a way to aggregate the group's preferences. Dot-voting is a simple and effective method. Give each person a limited number of sticky dots (e.g., 3-5). They can then <mark>place their dots on the ideas they believe are the most promising</mark>. They can put all their dots on one idea or spread them out. This quiet, democratic process quickly reveals which ideas have the most collective energy and support, providing a clear starting point for a more focused discussion on the top contenders.</p>"
            }
          ]
        },
        {
          "title": "How to Structure a Crowdsourcing Project",
          "introduction": "Crowdsourcing isn't just about asking a crowd for an idea; it's a disciplined process of breaking down a large problem into small, independent pieces that can be solved in parallel by a distributed network of individuals. Success hinges on a thoughtful project structure.",
          "threads": [
            {
              "title": "Step 1: Decompose the Problem",
              "content": "<p>The most critical step is problem decomposition. You must break down your large, complex challenge into a series of small, self-contained 'micro-tasks' that can be completed by an individual with minimal training or context. A bad task is 'Help us build a website.' A good task is <mark>'Does this photo contain a cat? (Yes/No)'</mark> or 'Transcribe this 10-second audio clip.' The more you can modularize the problem, the more effective the crowd will be.</p>"
            },
            {
              "title": "Step 2: Design the Micro-task",
              "content": "<p>The design of the micro-task itself is key. It needs to have crystal-clear instructions and a simple interface. A worker on a platform like Amazon Mechanical Turk should be able to understand and complete the task in minutes or even seconds. Provide clear examples of correct and incorrect work. The goal is to make the individual contribution as simple and foolproof as possible.</p>"
            },
            {
              "title": "Step 3: Build in Quality Control",
              "content": "<p>You cannot assume every contribution will be high quality. You must design a system to filter out noise and error. A common and powerful technique is <mark>redundancy</mark>. You give the exact same micro-task to multiple (e.g., 3-5) different workers independently. The 'correct' answer is then determined by the majority consensus. This statistical method is incredibly effective at ensuring high accuracy even with a variable-quality workforce.</p>"
            },
            {
              "title": "Step 4: Aggregate the Solutions",
              "content": "<p>Once the thousands of micro-tasks are complete and quality-checked, you need a process to aggregate the results back into a coherent whole. For a data labeling project, this might be a simple database compilation. For a more complex project like OpenStreetMap (where volunteers map the world), it requires sophisticated software to stitch together the millions of individual road segments and points of interest into a unified, functional map.</p>"
            }
          ]
        },
        {
          "title": "How to Overcome Groupthink",
          "introduction": "Groupthink occurs when the desire for harmony or conformity in a group results in an irrational or dysfunctional decision-making outcome. It's a pathology of collective intelligence. These tactics are designed to break the consensus trance and reintroduce healthy dissent and critical thinking.",
          "threads": [
            {
              "title": "Tactic 1: The Leader Speaks Last",
              "content": "<p>A leader's opinion carries immense weight and can prematurely anchor a discussion, causing subordinates to suppress their own views. To prevent this, leaders should adopt a policy of <mark>withholding their own opinion until everyone else has had a chance to speak</mark>. Their role should be to act as a facilitator, asking questions and ensuring a wide range of views are heard, rather than directing the group to their own preconceived conclusion.</p>"
            },
            {
              "title": "Tactic 2: Seek Outside Perspectives",
              "content": "<p>Insular groups are highly susceptible to groupthink. They develop shared assumptions and blind spots. To counter this, make it a regular practice to <mark>invite external experts or colleagues from other departments</mark> into your decision-making process. These outsiders are not invested in the group's internal politics and can bring fresh perspectives that challenge the group's core assumptions, revealing risks or opportunities the team has overlooked.</p>"
            },
            {
              "title": "Tactic 3: The Pre-Mortem Technique",
              "content": "<p>This is one of the most effective techniques for surfacing risks. Before starting a new project, the team gathers and imagines that they are in the future: <mark>'The project has failed spectacularly.'</mark> Then, for 10 minutes, everyone independently writes down every possible reason for this hypothetical failure. This process legitimizes dissent by framing it as a creative exercise rather than as opposition. It harnesses the team's collective intelligence to identify potential threats before they materialize, allowing them to be addressed proactively.</p>"
            }
          ]
        }
      ]
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from JSON =====
      let jsonData = {};
      try {
        jsonData = JSON.parse(document.getElementById('embedded-json').textContent);
      } catch (e) {
        console.error("Error parsing embedded JSON:", e);
        document.getElementById('docTitle').textContent = 'Error Loading Content';
        return;
      }
      const docTitle = jsonData.title || 'Untitled Document';
      const docSubtitle = jsonData.description || '';
      const timelineStepsData = jsonData.timeline_steps;
      const timelineLabelsData = jsonData.timeline_labels;
      
      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle;

      // ===== Build Content from JSON =====
      const contentSection = document.getElementById('content');
      let contentHtml = '';
      if (jsonData.articles) {
        jsonData.articles.forEach(article => {
          contentHtml += `<article id="${slug(article.title)}">`;
          contentHtml += `<h2>${article.title}</h2>`;
          if (article.introduction) {
            contentHtml += `<p class="lead">${article.introduction}</p>`;
          }
          if (article.threads) {
            article.threads.forEach(thread => {
              contentHtml += `<details open>`;
              contentHtml += `<summary><h3>${thread.title}</h3></summary>`;
              if (thread.content) {
                contentHtml += `<div class="pl-4 border-l-2 border-var">${thread.content}</div>`;
              }
              contentHtml += `</details>`;
            });
          }
          contentHtml += `</article>`;
        });
      }
      contentSection.innerHTML = contentHtml;

      // ===== Theme packs =====
      const THEME_PACKS = {
        slate: {
          proseClass: 'prose-slate',
          bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
        },
        emerald: {
          proseClass: 'prose-emerald',
          bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
        }
      };
      const availableThemes = Object.keys(THEME_PACKS);

      function applyTheme(themeKey){
        const root = document.documentElement;
        const isDark = root.classList.contains('dark');
        const pack = THEME_PACKS[themeKey] || THEME_PACKS.slate;
        root.classList.toggle('theme-emerald', isDark && themeKey === 'emerald');
        document.body.className = isDark ? pack.bodyClass : THEME_PACKS.slate.bodyClass;
        contentSection.className = `prose ${pack.proseClass} dark:prose-invert max-w-none`;
        try { localStorage.setItem('colorScheme', themeKey); } catch(_){}
      }

      let currentThemeIndex = 0;
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && THEME_PACKS[saved]) currentThemeIndex = availableThemes.indexOf(saved);
      } catch(_) {}
      
      const colorBtn = document.getElementById('colorSchemeToggle');
      colorBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        if (!root.classList.contains('dark')) {
          root.classList.add('dark');
          try { localStorage.setItem('theme','dark'); } catch(_){}
          document.getElementById('themeToggle')?.setAttribute('aria-pressed','true');
          applyTheme(availableThemes[currentThemeIndex]); // apply color when switching to dark
          return;
        }
        currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
        const newTheme = availableThemes[currentThemeIndex];
        applyTheme(newTheme);
        buildTOC();
      });

      const themeBtn = document.getElementById('themeToggle');
      if (themeBtn) {
        themeBtn.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')));
      }
      themeBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        const isDark = root.classList.toggle('dark');
        try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){}
        themeBtn.setAttribute('aria-pressed', String(isDark));

        if (!isDark) {
          root.classList.remove('theme-emerald');
          applyTheme('slate');
        } else {
          let saved = 'slate';
          try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
          applyTheme(saved);
        }
        buildTOC();
      });

      // ===== Expand/Collapse, TOC, Timeline, Search =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          const parentArticle = h.closest('article');
          const parentSlug = parentArticle ? parentArticle.id : '';
          if (!h.id) h.id = parentSlug + '-' + slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }
        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];
        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );
        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        if (!input || !contentSection) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            contentSection.innerHTML = originalHTML; 
            buildTOC(); // Rebuild TOC to reattach observers
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = contentSection.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          contentSection.innerHTML = contentSection.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();

      buildTOC();
      try {
        const saved = localStorage.getItem('colorScheme');
        applyTheme(saved && THEME_PACKS[saved] ? saved : 'slate');
      } catch(_){
        applyTheme('slate');
      }

      // ===== Mobile FAB wiring =====
      const fab = document.getElementById('fab');
      const fabPanel = document.getElementById('fabPanel');
      const fabTheme = document.getElementById('fabTheme');
      const fabColor = document.getElementById('fabColor');

      fab?.addEventListener('click', () => fabPanel.classList.toggle('show'));
      document.addEventListener('click', (e)=>{
        if (fabPanel && !fabPanel.contains(e.target) && fab && !fab.contains(e.target)) fabPanel.classList.remove('show');
      });
      fabTheme?.addEventListener('click', () => document.getElementById('themeToggle')?.click());
      fabColor?.addEventListener('click', () => document.getElementById('colorSchemeToggle')?.click());
    });
  </script>
</body>
</html>
