code
Html

download

content_copy

expand_less
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
.material-symbols-outlined {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
}
</style>
  <title>Timeline of Urban Innovation</title>

  <!-- Prepaint bootstrap: set dark + theme class before paint to avoid flicker -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');       // 'light' | 'dark' | null
      const savedColor = localStorage.getItem('colorScheme'); // 'slate' | 'emerald' | future
      const isDark = savedTheme !== 'light';                  // default to dark if unset
      root.classList.toggle('dark', isDark);
      // Apply colored theme classes ONLY in dark mode; light is always neutral slate
      root.classList.toggle('theme-emerald', isDark && savedColor === 'emerald');
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
  :root { color-scheme: light dark; }
  html { scroll-behavior: smooth; }
  .font-newspaper { font-family: 'Lora', serif; }
  :where(h2,h3,h4){ scroll-margin-top: 84px; }
  mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
  @media (max-width: 380px){ .prose { font-size: .96rem; } }

  /* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  /* give the header an explicit base fill so gradient blends to the right hue */
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.border-var { border-color: var(--border) !important; }
.surface { border-width: 1px; border-style: solid; border-color: var(--border); }
.hr-var { border-color: var(--border); }
.subtitle { color: var(--subtitle-fg); }
.timeline-fg { color: var(--timeline-fg); }
.footer-note { color: var(--footer-fg); }
.active-link { color: var(--active); font-weight: 700; }

.input-surface {
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
}
.btn-surface { border: 1px solid var(--btn-border); }
.btn-surface:hover { background: var(--btn-hover-bg); }
.toc-link:hover { background: var(--hover-bg); }

/* ---------- Slate (default) variables ---------- */
:root{
  /* accents / inks */
  --active: rgb(59,130,246);                      /* sky-500 */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(100,116,139);                /* slate-500 */
  --footer-fg: rgb(100,116,139);                  /* slate-500 */

  /* surfaces */
  --border: rgb(226,232,240);                     /* slate-200 */
  --hover-bg: rgb(248,250,252);                   /* slate-50 */
  --btn-border: rgb(203,213,225);                 /* slate-300 */
  --btn-hover-bg: rgb(248,250,252);               /* slate-50 */
  --input-border: rgba(203,213,225,0.7);          /* slate-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* hero base & gradient (light) */
  --hero-base: transparent;                       /* keep light header airy */
  --hero-r1: rgba(49,46,129,.12);                 /* indigo-700 */
  --hero-r2: rgba(234,88,12,.12);                 /* orange-600 hint */
  --hero-wash: rgba(14,165,233,.08);              /* sky-500 wash */
}
.dark{
  --subtitle-fg: rgb(203,213,225);                /* slate-300 */
  --timeline-fg: rgb(148,163,184);                /* slate-400 */
  --footer-fg: rgb(148,163,184);                  /* slate-400 */

  --border: rgb(30,41,59);                        /* slate-800 */
  --hover-bg: rgb(15,23,42);                      /* slate-900 */
  --btn-border: rgb(51,65,85);                    /* slate-700 */
  --btn-hover-bg: rgb(15,23,42);                  /* slate-900 */
  --input-border: rgba(51,65,85,0.7);             /* slate-700/70 */
  --input-bg: rgba(2,6,23,0.6);                   /* slate-950/60 */

  /* hero base & gradient (dark) */
  --hero-base: rgb(2,6,23);                       /* slate-950 */
  --hero-r1: rgba(49,46,129,.12);
  --hero-r2: rgba(234,88,12,.12);
  --hero-wash: rgba(14,165,233,.08);
}

/* ---------- Emerald theme overrides (light & dark) ---------- */
.theme-emerald{
  --active: #10b981;                              /* emerald-500 */

  --border: rgb(187,247,208);                     /* emerald-200 */
  --hover-bg: rgb(240,253,244);                   /* emerald-50 */
  --btn-border: rgb(187,247,208);                 /* emerald-200 */
  --btn-hover-bg: rgb(240,253,244);               /* emerald-50 */
  --input-border: rgba(110,231,183,0.7);          /* emerald-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* keep subtitles/timeline neutral for readability over hero */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(71,85,105);                  /* slate-600 */
  --footer-fg: rgb(16,185,129);                   /* emerald-500 */

  /* hero base & gradient (emerald light) */
  --hero-base: transparent;
  --hero-r1: rgba(16,185,129,.14);                /* emerald-500 */
  --hero-r2: rgba(163,230,53,.12);                /* lime-400 */
  --hero-wash: rgba(5,150,105,.10);               /* emerald-600 wash */
}
.dark.theme-emerald{
  /* ↑ Give borders enough contrast on dark emerald surfaces */
  --border: rgba(110,231,183,0.55);                /* emerald-300 @ 55% */
  --hover-bg: rgb(6,78,59);                        /* emerald-900 */
  --btn-border: rgba(110,231,183,0.45);            /* slightly softer than borders */
  --btn-hover-bg: rgb(6,78,59);                    /* emerald-900 */
  --input-border: rgba(110,231,183,0.55);          /* match border contrast */
  --input-bg: rgba(6,95,70,0.60);                  /* emerald-900/60 */

  /* text accents for readability */
  --footer-fg: rgb(110,231,183);                   /* emerald-300/400 */
  --subtitle-fg: rgb(226,252,236);                 /* emerald-100 */
  --timeline-fg: rgb(187,247,208);                 /* emerald-200 */

  /* hero base & gradient (unchanged, stays emerald) */
  --hero-base: rgb(2,44,34);                       /* emerald-950 (#022c22) */
  --hero-r1: rgba(16,185,129,.14);
  --hero-r2: rgba(163,230,53,.12);
  --hero-wash: rgba(5,150,105,.10);
}

/* NEW STYLE FOR EMERALD HEADINGS */
.theme-emerald .prose h2,
.theme-emerald .prose h3,
.theme-emerald #docTitle,
.theme-emerald .subtitle,
.theme-emerald aside h2,
.theme-emerald .active-link {
    color: #f0c475;
}

/* ===== Modal Styles ===== */
.modal-overlay {
    display: none; position: fixed; z-index: 1000; left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6);
    justify-content: center; align-items: center;
}
.modal-overlay.show { display: flex; }
.modal-content {
    background: #fff; color: #1e293b; /* slate-800 */
    padding: 2rem; border-radius: 8px;
    text-align: center; position: relative; width: 90%; max-width: 400px;
}
.dark .modal-content { background: #1e293b; color: #f8fafc; } /* slate-800, slate-50 */
.modal-content h3 { font-size: 1.5rem; margin-bottom: 1.5rem; }
.close-btn {
    position: absolute; top: 10px; right: 15px; color: #94a3b8; /* slate-400 */
    font-size: 28px; font-weight: bold; background: none;
    border: none; cursor: pointer;
}
.dark .close-btn { color: #64748b; } /* slate-500 */
</style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">

  <!-- Modal Theme Switcher HTML -->
  <div class="fixed top-4 right-4 z-50">
    <button id="settings-btn" class="p-2 rounded-full shadow-lg bg-white/70 dark:bg-slate-800/70 backdrop-blur" aria-label="toggle settings">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>
  </div>
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content surface">
        <button id="close-modal-btn" class="close-btn">×</button>
        <h3>Display Settings</h3>
        <button id="modalThemeBtn" class="w-full text-sm px-3 py-2 rounded-lg btn-surface mb-2">Toggle Light/Dark</button>
        <button id="modalColorBtn" class="w-full text-sm px-3 py-2 rounded-lg btn-surface">Change Color Scheme</button>
    </div>
  </div>


  <!-- Header -->
  <header id="top" class="hero border-b border-var">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="subtitle text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl input-surface px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg btn-surface">Clear</button>
      </div>
    </div>

    <!-- Timeline / Sections Nav -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="timeline-fg">
        <ol id="timeline" class="grid grid-cols-2 sm:grid-cols-3 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl surface p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 hr-var" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg btn-surface">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg btn-surface">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- Article Content Starts Here -->
      
      <article class="rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
        <meta name="doc-title" content="Timeline of Urban Innovation">
        <meta name="doc-subtitle" content="The key technological and social breakthroughs that shaped city life.">
        <meta name="timeline-steps" content="foundations-of-the-metropolis,the-industrial-city-goes-vertical,the-smart-and-sustainable-city">
        <meta name="timeline-labels" content="Foundations,Industrial Revolution,Smart & Sustainable">
      
        <h2 id="foundations-of-the-metropolis">Foundations of the Metropolis</h2>
        <p class="lead">Before cities could reach for the sky, they had to master the ground. Ancient and classical innovations were not just about grand monuments; they were about creating the fundamental systems of water, waste, and order that allowed large populations to live together safely and sustainably for the first time in history.</p>
        
        <details open>
          <summary><h3>The Aqueduct: Engineering Rivers in the Sky</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>The Roman aqueducts are the ultimate symbol of ancient civic engineering. By mastering the gradual incline, Romans could transport fresh water over dozens of miles, supplying public baths, fountains, and private homes. This unprecedented access to clean water was a public health revolution, enabling cities like Rome to grow to a million inhabitants by preventing the waterborne diseases that plagued dense populations.</p></div>
        </details>
        <details open>
          <summary><h3>The Sewer: The Unseen Grid Below</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>Just as important as bringing clean water in was the ability to get waste out. Early systems like the Cloaca Maxima in Rome were masterpieces of sanitation. By creating a subterranean network to carry away stormwater and waste, these early engineers tackled the single greatest threat to urban life: filth and disease. It was an invisible foundation upon which urban health was built.</p></div>
        </details>
        <details open>
          <summary><h3>The Grid Plan: Imposing Order on Chaos</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>First pioneered by the Greeks and perfected by the Romans, the orthogonal grid plan was a radical act of urban rationalism. By laying out streets in a simple, repeating grid of right angles, planners could create cities that were easy to navigate, divide, and administer. The grid facilitated the fair distribution of land, the efficient movement of troops, and the organized layout of public and private spaces.</p></div>
        </details>
        <details open>
          <summary><h3>Concrete: The Revolutionary Material</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>Roman concrete was a technological game-changer. Stronger, more flexible, and easier to work with than cut stone, it allowed for the creation of structures on a scale never before imagined—from the massive dome of the Pantheon to the colossal arches of the Colosseum. It was the material that enabled the architectural ambition of the ancient world's greatest cities.</p></div>
        </details>
      </article>
      
      <article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
        <h2 id="the-industrial-city-goes-vertical">The Industrial City Goes Vertical</h2>
        <p class="lead">The Industrial Revolution crowded cities with factories and people, creating immense challenges of density and scale. The solutions that arose were just as revolutionary as the problems themselves, driven by steel, electricity, and the audacious idea that a city's only true limit was the sky.</p>
        
        <details open>
          <summary><h3>The Steel Frame: The Skeleton of the Skyscraper</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>The single most important innovation for the vertical city was the steel frame. Prior to its development, the height of a building was limited by the thickness of its load-bearing masonry walls. The steel frame acted as a strong but lightweight skeleton, transferring the building's weight to the foundation and allowing the outer walls to be mere "curtains." It was this breakthrough that unlocked the skyscraper.</p></div>
        </details>
        <details open>
          <summary><h3>The Elevator: Making Height Habitable</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>A ten-story building is useless if no one can get to the top. The invention of the safety elevator by Elisha Otis in 1854 made tall buildings not just possible, but practical and desirable. The elevator transformed urban geography and real estate, turning upper floors from cheap attic spaces into premium penthouses and creating the dense, high-rise urban core we know today.</p></div>
        </details>
        <details open>
          <summary><h3>Mass Transit: The Arteries of the Metropolis</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>As cities swelled, moving millions of people became a critical challenge. The development of mass transit systems—first horse-drawn streetcars, then electric trams, and finally underground subways—acted as the circulatory system of the industrial metropolis. They allowed the city to expand far beyond its walkable core, enabling the creation of residential suburbs and the daily ritual of the commute.</p></div>
        </details>
        <details open>
          <summary><h3>Electric Lighting: Conquering the Night</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>The mass adoption of electric streetlights in the late 19th century fundamentally changed urban life. It extended the hours of commerce and social activity, making cities safer and more vibrant after dark. No longer governed by the sun, the 24-hour city was born, lit by the glow of electricity.</p></div>
        </details>
      </article>

      <article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
        <h2 id="the-smart-and-sustainable-city">The Smart and Sustainable City</h2>
        <p class="lead">Faced with the modern challenges of climate change, resource scarcity, and exponential population growth, the 21st-century city is undergoing another evolution. The new building blocks are not steel and concrete, but data and sustainable design, aimed at creating cities that are more efficient, resilient, and livable.</p>
        
        <details open>
          <summary><h3>The Digital Network (IoT): The City's Nervous System</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>The "Smart City" is built on a network of sensors and data known as the Internet of Things (IoT). These systems form a digital nervous system, allowing the city to monitor and manage everything in real-time. Traffic lights adjust to congestion, the electrical grid reroutes power to prevent blackouts, and waste bins signal when they're full. It's about using data to make urban services radically more efficient.</p></div>
        </details>
        <details open>
          <summary><h3>Green Infrastructure: Engineering with Nature</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>Instead of fighting nature, the sustainable city seeks to integrate it. Green infrastructure uses natural systems to solve urban problems. Green roofs and permeable pavements absorb stormwater to prevent flooding, urban tree canopies combat the "heat island" effect, and linear parks built on old rail lines create new corridors for biodiversity and recreation. It's a shift from gray to green engineering.</p></div>
        </details>
        <details open>
          <summary><h3>Renewable Energy Grids: Powering the Future</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>The modern city is incredibly power-hungry. The key to its sustainable future is a transition away from fossil fuels. This involves integrating renewable energy sources like solar and wind directly into the urban fabric and creating "smart grids" that can efficiently manage energy flow, store power during off-peak hours, and even allow buildings to sell their own generated solar power back to the grid.</p></div>
        </details>
        <details open>
          <summary><h3>Mixed-Use Zoning: Re-Engineering Human Proximity</h3></summary>
          <div class="pl-4 border-l-2 border-var"><p>For much of the 20th century, cities were strictly zoned into separate districts for living, working, and shopping, a model that enforced car dependency. The modern innovation is a return to a more traditional model: mixed-use zoning. By designing neighborhoods where homes, offices, shops, and restaurants are all within walking distance, planners are creating more vibrant, less-polluting communities that prioritize people over cars.</p></div>
        </details>
      </article>

      <!-- DO NOT PASTE ANYTHING AFTER THIS POINT -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs footer-note">
    Threaded Reader — a single-file template
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from Content =====
      const firstArticle = document.querySelector('#content article');
      const docTitle = firstArticle?.querySelector('meta[name="doc-title"]')?.content || 'Untitled Document';
      const docSubtitle = firstArticle?.querySelector('meta[name="doc-subtitle"]')?.content || '';
      const timelineStepsData = firstArticle?.querySelector('meta[name="timeline-steps"]')?.content;
      const timelineLabelsData = firstArticle?.querySelector('meta[name="timeline-labels"]')?.content;

      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle;

      // ===== THEME ENGINE =====
      const THEME_PACKS = {
        slate: {
          proseClass: 'prose-slate',
          bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
        },
        emerald: {
          proseClass: 'prose-emerald',
          bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
        }
      };
      const availableThemes = Object.keys(THEME_PACKS);
      let currentThemeIndex = 0;
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && THEME_PACKS[saved]) currentThemeIndex = availableThemes.indexOf(saved);
      } catch(_) {}

      function applyTheme(themeKey){
        const root = document.documentElement;
        const isDark = root.classList.contains('dark');
        const pack = THEME_PACKS[themeKey] || THEME_PACKS.slate;
        root.classList.toggle('theme-emerald', isDark && themeKey === 'emerald');
        document.body.className = isDark ? pack.bodyClass : THEME_PACKS.slate.bodyClass;
        document.getElementById('content').className = `prose ${pack.proseClass} dark:prose-invert max-w-none`;
        try { localStorage.setItem('colorScheme', themeKey); } catch(_){}
      }
      
      function toggleLightDark() {
          const root = document.documentElement;
          const isDark = root.classList.toggle('dark');
          try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){}

          if (!isDark) {
            root.classList.remove('theme-emerald');
            applyTheme('slate');
          } else {
            let saved = 'slate';
            try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
            applyTheme(saved);
          }
          buildTOC();
      }

      function cycleColorScheme() {
          const root = document.documentElement;
          if (!root.classList.contains('dark')) {
            toggleLightDark();
            return;
          }
          currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
          const newTheme = availableThemes[currentThemeIndex];
          applyTheme(newTheme);
          buildTOC();
      }
      
      // ===== MODAL WIRING =====
      function initializeModal() {
        const modal = document.getElementById('settings-modal');
        const openBtn = document.getElementById('settings-btn');
        const closeBtn = document.getElementById('close-modal-btn');
        const modalThemeBtn = document.getElementById('modalThemeBtn');
        const modalColorBtn = document.getElementById('modalColorBtn');
        
        openBtn.onclick = () => modal.classList.add('show');
        closeBtn.onclick = () => modal.classList.remove('show');
        modal.onclick = (event) => { if (event.target === modal) modal.classList.remove('show'); };
        modalThemeBtn.onclick = () => toggleLightDark();
        modalColorBtn.onclick = () => cycleColorScheme();
      }
      initializeModal();

      // ===== Expand/Collapse, TOC, Timeline, Search =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          if (!h.id) h.id = slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }
        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];
        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );
        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        const content = document.getElementById('content');
        if (!input || !content) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            content.innerHTML = originalHTML; 
            buildTOC(); 
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = content.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          content.innerHTML = content.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();

      buildTOC();
      try {
        const saved = localStorage.getItem('colorScheme');
        applyTheme(saved && THEME_PACKS[saved] ? saved : 'slate');
      } catch(_){
        applyTheme('slate');
      }
    });
  </script>
</body>
</html>
