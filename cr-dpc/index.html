<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Course Template</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Default Theme: Newspaper */
    :root {
      --bg-gradient: #fdfdf8;
      --text: #1c1c1c;
      --accent-text: #8c1c13;
      --nav-bg: #f1f1eb;
      --nav-border: #dcdcd3;
      --nav-text: #1c1c1c;
      --nav-hover-bg: #e5e5dd;
      --nav-active-bg: #dcdcd3;
      --nav-active-text: #1c1c1c;
      --prose-text: var(--text);
      --prose-headings: var(--accent-text);
      --prose-links: var(--accent-text);
      --prose-bold: var(--text);
      font-family: 'Merriweather', serif;
    }

    .theme-emerald-paper,
    .theme-cyber-blue,
    .theme-emerald-gold {
      font-family: 'Lato', sans-serif;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
    }

    .ui-bg { background-color: var(--nav-bg); }
    .ui-border { border-color: var(--nav-border); }
    .text-primary { color: var(--text); }
    .text-accent { color: var(--accent-text); }

    .tab-button {
      background-color: var(--nav-bg);
      color: var(--nav-text);
      border-bottom: 3px solid transparent;
    }
    .tab-button:hover,
    .tab-button:focus-visible {
      background-color: var(--nav-hover-bg);
    }
    .tab-button.tab-active {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-text);
      border-bottom-color: var(--accent-text);
    }

    .settings-button { background-color: var(--nav-hover-bg); }
    .settings-button:hover { opacity: 0.8; }
    *:focus-visible { outline: 3px solid var(--accent-text); outline-offset: 2px; }

    .prose { color: var(--prose-text); }
    .prose h2,
    .prose h3,
    .prose a,
    .prose strong { color: var(--prose-headings); }
    .prose p.lead { color: var(--prose-text); }

    /* Navy (Dark) overrides */
    .theme-cyber-blue .tab-button.tab-active {
      background-color: #1f2937; /* slate-800 */
      color: #e5e7eb;           /* slate-200 */
      border-bottom-color: #3b82f6; /* blue-500 */
      box-shadow: inset 0 -2px 0 0 #3b82f6;
    }
    .theme-cyber-blue .prose a {
      color: #60a5fa;              /* blue-400 */
      text-decoration-color: #60a5fa;
    }
    .theme-cyber-blue .prose a:hover {
      color: #93c5fd;              /* blue-300 */
      text-decoration-color: #93c5fd;
    }

    /* === Scripture preview UI === */
    .ref-pop { position:absolute; z-index:50; max-width:28rem; background:var(--nav-bg); border:1px solid var(--nav-border);
      padding:.6rem .8rem; border-radius:.5rem; box-shadow:0 6px 20px rgba(0,0,0,.15); font-size:.9rem; }
    #verse-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60;
      background:rgba(0,0,0,.5); backdrop-filter: blur(2px); }
    #verse-modal .card { background:var(--nav-bg); color:var(--text); border:1px solid var(--nav-border); border-radius:.6rem; max-width:36rem; width:92%; padding:1rem; }
    #verse-modal .actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem; }
    #verse-modal button, #verse-modal a { padding:.4rem .7rem; border-radius:.4rem; border:1px solid var(--nav-border); }
  </style>

</head>
<body class="transition-colors duration-300">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <header id="app-header" class="ui-bg border ui-border rounded-lg shadow-lg p-6 mb-6"></header>
    <nav id="app-tabs" class="ui-bg border ui-border rounded-lg shadow-lg mb-6" role="tablist" aria-label="Main navigation"></nav>
    <main id="app-panels" class="ui-bg border ui-border rounded-lg shadow-lg p-6 md:p-8"></main>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="ui-bg border ui-border rounded-lg p-6 max-w-md w-full shadow-2xl">
        <h2 id="settings-title" class="text-xl font-bold text-accent mb-4">Display Settings</h2>
        <div class="space-y-4">
          <div>
            <label for="themeSelect" class="block text-primary font-semibold mb-2">Theme</label>
            <select id="themeSelect" class="w-full px-3 py-2 rounded ui-bg border ui-border text-primary"></select>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button id="closeSettings" class="px-4 py-2 rounded text-primary hover:opacity-80">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripture modal -->
  <div id="verse-modal" role="dialog" aria-modal="true" aria-labelledby="verse-title" class="hidden">
    <div class="card">
      <div id="verse-title" class="text-accent font-bold mb-2"></div>
      <div id="verse-body" style="white-space:pre-wrap"></div>
      <div class="actions">
        <a id="verse-open" target="_blank" rel="noopener">Open in Bible Gateway (KJV)</a>
        <button id="verse-close">Close</button>
      </div>
    </div>
  </div>

  <!--
  ============================================================
  vvvvvvvvvvvvvv PASTE YOUR JSON CONTENT BELOW vvvvvvvvvvvvvv
  ============================================================
  -->
  <script type="application/json" id="app-data">
{
“title”: “Cozinha por Padrões — Base Pescetariana”,
“description”: “Um guia prático, em português, para facilitar o dia a dia de uma pescetariana: padrões (técnicas), molhos-mãe, templates de refeição, despensa esperta e planejamento semanal.”,
“categories”: {
“inicio”: {
“display_order”: 1,
“name”: “inicio”,
“display_name”: “Como Usar”,
“introduction”: “Pense em blocos: técnica + proteína + base (grão/verdura) + molho-mãe + acidez/crocância. Troque apenas um bloco para variar sem esforço.”,
“paragraphs”: [
{ “heading”: “Fluxo de Noite Útil (20–30 min)”, “content”: “1) Descongele/prepare a proteína. 2) Escolha a técnica pelo corte/espessura. 3) Reaqueça um grão pronto e escolha um legume. 4) Aplique um molho-mãe. 5) Finalize com limão/ervas e um toque crocante.” },
{ “heading”: “Padrões vs. Receitas”, “content”: “Use os padrões como LEGO: um conjunto pequeno de técnicas e molhos gera dezenas de pratos, sem depender de receitas longas.” }
]
},
“despensa-base”: {
“display_order”: 2,
“name”: “despensa-base”,
“display_name”: “Despensa Base”,
“introduction”: “Uma despensa curta e versátil reduz decisões e acelera o preparo.”,
“paragraphs”: [
{ “heading”: “Grãos & Massas”, “content”: “Arroz integral/jasmin, quinoa, cuscuz marroquino, farro (se achar), massa de trigo ou arroz. Cozinhe um lote semanal para bowls e acompanhamentos.” },
{ “heading”: “Leguminosas & Conservas”, “content”: “Grão-de-bico, lentilha, feijão branco; tomate pelado; atum/sardinha (em água/azeite); palmito, milho, ervilha; leite de coco; cogumelos.” },
{ “heading”: “Nozes, Sementes & Farinhas”, “content”: “Amêndoas, castanhas, nozes; chia, gergelim; panko, farinha de rosca/farinha de milho; aveia.” },
{ “heading”: “Ácidos, Óleos & Molhos”, “content”: “Azeite, óleo neutro; limão/lima, vinagre de vinho/maçã; shoyu, miso, tahine, mostarda, gochujang, alcaparras.” },
{ “heading”: “Frescos de Rotina”, “content”: “Alho, cebola, gengibre, coentro/salsinha, cebolinha, pimentões, folhas (rúcula/espinafre), tomates-cereja, pepino, limão.” }
]
},
“proteinas-do-mar”: {
“display_order”: 3,
“name”: “proteinas-do-mar”,
“display_name”: “Proteínas do Mar”,
“introduction”: “Escolha cortes práticos; porcione e congele em camada fina para descongelar rápido.”,
“paragraphs”: [
{ “heading”: “Peixes Magros”, “content”: “Tilápia, linguado, pescada: ideais para vapor, papillote e assado rápido (8–12 min).” },
{ “heading”: “Peixes Gordurosos”, “content”: “Salmão, sardinha, cavalinha: bons para selar + terminar no forno, grelhar, ou assar em alta.” },
{ “heading”: “Frutos do Mar”, “content”: “Camarão limpo (congelado), mexilhão, lula: cocção curtíssima (2–5 min) para não borrachar.” },
{ “heading”: “Compra Inteligente”, “content”: “Cheiro de mar (não de amônia), carne firme, olho brilhante. Prefira peixes do dia ou pacotes congelados confiáveis.” }
]
},
“molhos-mae”: {
“display_order”: 4,
“name”: “molhos-mae”,
“display_name”: “Molhos-Mãe (Padrões)”,
“introduction”: “Molhos base prontos em 5–10 min que viram dezenas de pratos. Faça 1–2 por semana.”,
“paragraphs”: [
{ “heading”: “Emulsão Cítrica”, “content”: “Azeite + limão + mostarda + mel/maple + sal/pimenta. Variações: laranja; alcaparras; ervas frescas.” },
{ “heading”: “Iogurte Herbáceo”, “content”: “Iogurte grego + alho ralado + limão + dill/salsinha. Versões: pepino (tzatziki), hortelã.” },
{ “heading”: “Tomate Assado Express”, “content”: “Tomate-cereja + alho + azeite + sal; 15 min a 220 °C; amasse. Base para massas e peixe.” },
{ “heading”: “Tahine & Limão”, “content”: “Tahine + limão + água até ponto + sal; adições: cominho, páprica, alho.” },
{ “heading”: “Moqueca-Base Ligeira”, “content”: “Refogue cebola/alho/pimentão; some tomate + leite de coco + fio de dendê; finalize com coentro.” },
{ “heading”: “Pesto de Coentro (Sem Queijo, se quiser)”, “content”: “Coentro + castanha de caju + alho + azeite + limão + sal; ajuste com água para textura de molho.” }
]
},
“tecnicas”: {
“display_order”: 5,
“name”: “tecnicas”,
“display_name”: “Técnicas-Padrão”,
“introduction”: “Selecione a técnica pela espessura e tipo de corte. Cronometrar é meio caminho.”,
“paragraphs”: [
{ “heading”: “Papillote (Forno)”, “content”: “Peixe + sal + fatias de limão + ervas + fio de azeite em papel manteiga; 200–220 °C por 10–14 min.” },
{ “heading”: “Vapor Rápido”, “content”: “Cesto de vapor; 6–8 min para filés finos. Finalize com molho-mãe e ervas.” },
{ “heading”: “Selar + Forno”, “content”: “Para salmão/postas: 2–3 min por lado na frigideira quente + 5–8 min no forno a 200 °C.” },
{ “heading”: “Poaching Suave”, “content”: “Líquido aromatizado (água/caldo/leite de coco) a 80–90 °C por 6–10 min; ponto úmido e delicado.” },
{ “heading”: “Escabeche Rápido”, “content”: “Finalize com vinagre/limão + azeite + aromáticos; ótimo para servir frio no dia seguinte.” },
{ “heading”: “Salmoura Relâmpago”, “content”: “10 g sal/200 ml água, 15–20 min; enxágue e seque. Textura mais suculenta e tempero por dentro.” }
]
},
“templates-de-refeicao”: {
“display_order”: 6,
“name”: “templates-de-refeicao”,
“display_name”: “Templates de Refeição”,
“introduction”: “Use ‘slots’: grão + verdura/legume + proteína + molho; adicione acidez e crocância no final.”,
“paragraphs”: [
{ “heading”: “Bowl 4-Slots”, “content”: “Grão (arroz/quinoa) + folhas/legumes + peixe/camarão + molho-mãe (tahine/iogurte/emulsão).” },
{ “heading”: “Salada Proteica”, “content”: “Folhas + grão ou leguminosa + peixe em lascas + crocante (panko tostado/nozes) + vinagrete.” },
{ “heading”: “Massa do Mar”, “content”: “Espaguete/penne + tomate assado ou pesto + camarão/atum + raspas e suco de limão.” },
{ “heading”: “Moqueca Ligeira”, “content”: “Template da moqueca-base com postas/camarão; finalize com coentro e limão.” },
{ “heading”: “Wrap/Taco”, “content”: “Tortilha + peixe assado em tiras + repolho + coentro + emulsão cítrica.” },
{ “heading”: “Sopa Rápida”, “content”: “Caldo + legumes + leguminosa + peixe em cubos (poaching no final). Azeite/ervas na tigela.” }
]
},
“perfis-de-sabor”: {
“display_order”: 7,
“name”: “perfis-de-sabor”,
“display_name”: “Perfis de Sabor”,
“introduction”: “Perfis prontos ajudam a variar sem pensar em receita.”,
“paragraphs”: [
{ “heading”: “Brasileiro”, “content”: “Alho/cebola, pimentão, coentro/salsinha, limão, leite de coco, dendê (moderado).” },
{ “heading”: “Mediterrâneo”, “content”: “Azeite, alho, limão, tomate, azeitona, alcaparra, salsa/dill/orégano.” },
{ “heading”: “Japonês”, “content”: “Shoyu, gengibre, cebolinha, gergelim, miso; sirva com arroz e pepino.” },
{ “heading”: “Tailandês”, “content”: “Leite de coco, curry, limão, coentro, pimenta; finalize com amendoim torrado.” },
{ “heading”: “Mexicano”, “content”: “Limão, coentro, pimenta, cominho; milho/feijão; pico de gallo.” },
{ “heading”: “Árabe”, “content”: “Tahine, limão, cominho, páprica, hortelã; pepino e tomate.” }
]
},
“substituicoes-e-restricoes”: {
“display_order”: 8,
“name”: “substituicoes-e-restricoes”,
“display_name”: “Substituições & Restrições”,
“introduction”: “Trocas simples preservam o padrão mesmo com limitações.”,
“paragraphs”: [
{ “heading”: “Sem Laticínios”, “content”: “Iogurte → tahine/‘leitelho’ de castanha; manteiga → azeite; pesto sem queijo (castanha + limão).” },
{ “heading”: “Sem Glúten”, “content”: “Use arroz/quinoa/massa de arroz; panko → farinha de milho/torrada de arroz triturada.” },
{ “heading”: “Alergia a Crustáceos”, “content”: “Substitua camarão/mexilhão/lula por peixes brancos/gordurosos nos templates.” },
{ “heading”: “Baixo FODMAP (geral)”, “content”: “Reduza alho/cebola; use azeite aromatizado com alho; priorize cebolinha verde (folhas).” }
]
},
“planejamento-semanal”: {
“display_order”: 9,
“name”: “planejamento-semanal”,
“display_name”: “Planejamento Semanal”,
“introduction”: “Um pequeno ‘ritual’ semanal salva a semana inteira.”,
“paragraphs”: [
{ “heading”: “Preparo de 60 min (Domingo)”, “content”: “Cozinhe 1 grão (arroz/quinoa), 1 leguminosa (grão-de-bico), 2 molhos-mãe; lave/parte legumes; porcione 3 noites de peixe no freezer.” },
{ “heading”: “Roteiro 30 min (Dia Útil)”, “content”: “Descongele porção → escolha técnica (papillote/vapor/selar) → aqueça grão → legume rápido (salteado/forno) → molho-mãe + limão/ervas.” },
{ “heading”: “Lista Sempre Comprar”, “content”: “Limão, folhas, tomates-cereja, ervas frescas, alho/gengibre, 2 peixes da semana, 1 fruto do mar congelado, leite de coco, uma leguminosa.” }
]
},
“exemplos-rapidos”: {
“display_order”: 10,
“name”: “exemplos-rapidos”,
“display_name”: “Exemplos Rápidos (15–25 min)”,
“introduction”: “Cartas-idéia para usar os padrões hoje.”,
“paragraphs”: [
{ “heading”: “Salmão Selado + Emulsão de Limão”, “content”: “Selar 2–3 min por lado; forno 5–6 min; servir com quinoa, rúcula e emulsão cítrica.” },
{ “heading”: “Tilápia em Papillote Mediterrânea”, “content”: “Azeitona, alcaparra, tomate, ervas; 12 min a 210 °C; finalize com azeite e limão.” },
{ “heading”: “Camarão Alho & Limão + Massa”, “content”: “Saltear 2 min com alho; juntar tomate assado express; envolver espaguete; salsinha.” },
{ “heading”: “Moqueca Ligeira de Peixe”, “content”: “Base de leite de coco + dendê; postas 8–10 min; pimentões, coentro e limão no final.” },
{ “heading”: “Bowl Asiático com Atum”, “content”: “Arroz, pepino, cebolinha; atum em lata; molho shoyu-gengibre-gergelim; gergelim torrado.” },
{ “heading”: “Salada Grega com Sardinha”, “content”: “Folhas, pepino, tomate, cebola roxa, azeitona; sardinha; iogurte herbáceo (ou tahine).” }
]
},
“utensilios”: {
“display_order”: 11,
“name”: “utensilios”,
“display_name”: “Utensílios Essenciais”,
“introduction”: “Poucas peças resolvem 90% das noites.”,
“paragraphs”: [
{ “heading”: “Panelas & Frigideiras”, “content”: “Antiaderente média, inox pesada, caçarola média, panela para vapor (ou cesto).” },
{ “heading”: “Facas & Tábuas”, “content”: “Faca do chef + fileteira; tábuas separadas para cru e pronto.” },
{ “heading”: “Miscelânea”, “content”: “Assadeira, papel manteiga, pinça, termômetro (opcional), peneira, potes com tampa.” }
]
},
“congelamento”: {
“display_order”: 12,
“name”: “congelamento”,
“display_name”: “Congelar & Descongelar”,
“introduction”: “Ganhe tempo porcionando bem.”,
“paragraphs”: [
{ “heading”: “Porções Planas”, “content”: “Congele em saquinhos, camada fina; descongela mais rápido e por igual.” },
{ “heading”: “Descongelamento Seguro”, “content”: “Geladeira (8–12 h) ou água fria corrente (embalado), trocando a água; cozinhe imediatamente.” },
{ “heading”: “Temperos Após Descongelar”, “content”: “Tempere próximo à cocção para melhor textura.” }
]
}
}
}


  </script>
  <!--
  ============================================================
  ^^^^^^^^^^^^^^ PASTE YOUR JSON CONTENT ABOVE ^^^^^^^^^^^^^^
  ============================================================
  -->

<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const THEMES = {
    'newspaper': {
      name: 'Newspaper',
      type: 'classic',
      isDark: false
    },
    'emerald-paper': {
      name: 'Emerald Paper',
      type: 'variable',
      isDark: false,
      vars: {
        '--bg-gradient': '#f7fbf9',
        '--text': '#1e2b28',
        '--accent-text': '#0f7f6d',
        '--nav-bg': '#e7f3ef',
        '--nav-border': '#86c8ba',
        '--nav-text': '#1e2b28',
        '--nav-hover-bg': '#d7ece6',
        '--nav-active-bg': '#bfe3d9',
        '--nav-active-text': '#1e2b28',
        '--prose-text': '#1e2b28',
        '--prose-headings': '#0f7f6d'
      }
    },
    'cyber-blue': {
      name: 'Navy (Dark)',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#0a0a23 0%, #141433 50%, #0f172a 100%)',
        '--text': '#e5e7eb',
        '--accent-text': '#cbd5e1',
        '--nav-bg': '#0f172a',
        '--nav-border': '#1f2937',
        '--nav-text': '#e5e7eb',
        '--nav-hover-bg': '#111827',
        '--nav-active-bg': '#1f2937',
        '--nav-active-text': '#e5e7eb',
        '--prose-text': '#e5e7eb',
        '--prose-headings': '#cbd5e1'
      }
    },
    'emerald-gold': {
      name: 'Emerald/Gold',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#022c22 0%,#064e3b 60%,#065f46 100%)',
        '--text': '#ecfdf5',
        '--accent-text': '#f0c475',
        '--nav-bg': '#064e3b',
        '--nav-border': '#d4a24c',
        '--nav-text': '#ecfdf5',
        '--nav-hover-bg': '#065f46',
        '--nav-active-bg': '#0b3d31',
        '--nav-active-text': '#f0c475',
        '--prose-text': '#a7f3d0',
        '--prose-headings': '#f0c475'
      }
    }
  };

  const app = {
    root: document.documentElement,
    header: document.getElementById('app-header'),
    tabs: document.getElementById('app-tabs'),
    panels: document.getElementById('app-panels'),
    settings: {
      modal: document.getElementById('settingsModal'),
      closeBtn: document.getElementById('closeSettings'),
      themeSelect: document.getElementById('themeSelect')
    }
  };

  /* ---------- State (now with per-project storage prefix) ---------- */
  const state = { activeTab: null, theme: 'newspaper', storagePrefix: 'cr_' };

  const loadState = () => {
    state.theme = localStorage.getItem(state.storagePrefix + 'theme') || 'newspaper';
    state.activeTab = localStorage.getItem(state.storagePrefix + 'tab');
  };

  const saveState = () => {
    localStorage.setItem(state.storagePrefix + 'theme', state.theme);
    localStorage.setItem(state.storagePrefix + 'tab', state.activeTab);
  };

  /* ------------------- Theme helpers ------------------- */
  const applyTheme = (themeKey) => {
    const theme = THEMES[themeKey];
    if (!theme) return;

    app.root.className = '';
    app.root.style.cssText = '';

    if (theme.type === 'variable' && theme.vars) {
      for (const [key, value] of Object.entries(theme.vars)) {
        app.root.style.setProperty(key, value);
      }
      app.root.classList.add(`theme-${themeKey}`);
    }

    state.theme = themeKey;
    if (app.settings.themeSelect.value !== themeKey) {
      app.settings.themeSelect.value = themeKey;
    }
    saveState();
  };

  const populateThemeSelector = () => {
    app.settings.themeSelect.innerHTML = Object.entries(THEMES)
      .map(([key, theme]) => `<option value="${key}">${theme.name}</option>`)
      .join('');
  };

  /* ----------------- NEW: flexible loader -----------------
     Accepts either:
     A) CR shape: { title, description, categories:{...} }
     B) Sections shape: { meta:{title,subtitle}, sections:[{id,title,intro,bullets,items}] }
     Also supports a map of apps: { "appKey": {...} } (uses the first)
  --------------------------------------------------------- */

  const slugify = (s) => (s||'app').toString().toLowerCase()
    .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  function sectionAppToCR(root) {
    const title = root.meta?.title || 'Untitled';
    const description = root.meta?.subtitle || '';
    const categories = {};
    (root.sections || []).forEach((s, idx) => {
      const slug = s.id || ('section-' + (idx + 1));
      const paragraphs = [];
      if (Array.isArray(s.bullets) && s.bullets.length) {
        const lis = s.bullets.map(b => `<li>${b}</li>`).join('');
        paragraphs.push({ heading: 'Key points', content: `<ul>${lis}</ul>` });
      }
      (s.items || []).forEach(it => {
        const heading = it.label || it.summary || '';
        const detail = (it.summary ? `<em>${it.summary}</em> ` : '') + (it.detail || '');
        paragraphs.push({ heading, content: detail });
      });
      categories[slug] = {
        display_order: s.display_order ?? (idx + 1),
        name: s.title || slug,
        display_name: s.title || slug,
        introduction: s.intro || '',
        paragraphs
      };
    });
    return { title, description, categories };
  }

  function normalizeFlexible(raw) {
    // Single-app CR
    if (raw && typeof raw === 'object' && raw.categories) return raw;
    // Single-app sections
    if (raw && typeof raw === 'object' && (Array.isArray(raw.sections) || raw.meta)) {
      return sectionAppToCR(raw);
    }
    // Map of apps -> first
    const keys = raw ? Object.keys(raw) : [];
    if (!keys.length) throw new Error('Empty content.');
    const first = raw[keys[0]];
    if (first?.categories) return first;
    if (first && (Array.isArray(first.sections) || first.meta)) return sectionAppToCR(first);
    throw new Error('Unsupported content shape. Expected {categories} or {sections}.');
  }

  /* ----------------- Load & transform data ----------------- */
  const loadAndTransformData = () => {
    try {
      const dataNode = document.getElementById('app-data');
      let rawData = null;
      if (dataNode && dataNode.textContent.trim()) {
        rawData = JSON.parse(dataNode.textContent);
      } else if (window.__CR_APP__ || window.__CONTENT__) {
        rawData = window.__CR_APP__ || window.__CONTENT__;
      } else {
        throw new Error('JSON data is empty.');
      }

      const appObj = normalizeFlexible(rawData);

      const units = Object.entries(appObj.categories || {})
        .map(([id, unitData]) => ({ id, ...unitData }))
        .sort((a, b) => (a.display_order ?? 999) - (b.display_order ?? 999));

      const prefix = 'cr_' + slugify(appObj.title || Object.keys(rawData||{})[0] || 'app') + '_';

      return { meta: { title: appObj.title, description: appObj.description }, units, storagePrefix: prefix };
    } catch (e) {
      console.error('Failed to load or transform app data:', e);
      app.panels.innerHTML =
        `<div class="p-4 text-red-500 bg-red-100 rounded"><strong>Error:</strong> Could not load content. Ensure the JSON is valid and present in the data island (or window.__CR_APP__/__CONTENT__).</div>`;
      return null;
    }
  };

  const data = loadAndTransformData();
  if (!data) return;
  state.storagePrefix = data.storagePrefix || state.storagePrefix;

  /* ----------------- Scripture linking + previews ----------------- */
  const BIBLE_LINK_BASE = 'https://www.biblegateway.com/passage/?search=';
  const BIBLE_VERSION = 'KJV';
  const REF_RE = /\b(?:(?:1|2|3)\s*)?(?:Gen|Ex(?:od)?|Lev|Num|Deut|Josh|Judg|Ruth|1(?:\s)?Sam|2(?:\s)?Sam|1(?:\s)?Kgs|2(?:\s)?Kgs|1(?:\s)?Chr|2(?:\s)?Chr|Ezra|Neh|Esth|Job|Ps(?:alm|alms)?|Prov|Eccl|Song|Isa|Jer|Lam|Ezek|Dan|Hos|Joel|Amos|Obad|Jonah|Mic|Nah|Hab|Zeph|Hag|Zech|Mal|Matt|Mark|Luke|John|Acts|Rom|1(?:\s)?Cor|2(?:\s)?Cor|Gal|Eph|Phil|Col|1(?:\s)?Thess|2(?:\s)?Thess|1(?:\s)?Tim|2(?:\s)?Tim|Titus|Phlm|Heb|Jas|1(?:\s)?Pet|2(?:\s)?Pet|1(?:\s)?John|2(?:\s)?John|3(?:\s)?John|Jude|Rev)\.?\s*\d{1,3}:\d{1,3}(?:[-–]\d{1,3})?(?:,\s*\d{1,3}:\d{1,3})*/g;

  function linkifyBibleRefs(container = app.panels) {
    const nodes = container.querySelectorAll('p, li');
    nodes.forEach(n => {
      n.innerHTML = n.innerHTML.replace(REF_RE, (m) => {
        const q = encodeURIComponent(m.replace(/\s+/g, '+'));
        const href = `${BIBLE_LINK_BASE}${q}&version=${BIBLE_VERSION}`;
        return `<a class="bible-ref" href="${href}" target="_blank" rel="noopener" data-ref="${m}">${m}</a>`;
      });
    });
  }

  async function fetchKJV(ref){
    const url = 'https://bible-api.com/' + encodeURIComponent(ref.replace(/\s+/g,' '));
    const res = await fetch(url);
    if(!res.ok) return null;
    const j = await res.json();
    return j.text ? j.text.trim() + ' — KJV' : null;
  }
  function isTouch(){ return matchMedia('(hover: none)').matches; }

  function attachRefPreviews(container = app.panels){
    let pop; let hideT;
    const modal = document.getElementById('verse-modal');
    const vTitle = document.getElementById('verse-title');
    const vBody = document.getElementById('verse-body');
    const vOpen = document.getElementById('verse-open');
    const vClose = document.getElementById('verse-close');

    function openModal(ref, href, text){
      vTitle.textContent = ref;
      vBody.textContent = text || 'Loading…';
      vOpen.href = href;
      modal.style.display = 'flex';
      vClose.focus();
    }
    function closeModal(){ modal.style.display = 'none'; }

    vClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    container.querySelectorAll('a.bible-ref').forEach(a=>{
      const ref = a.dataset.ref;
      const href = a.href;

      if (isTouch()){
        a.addEventListener('click', async (e)=>{
          e.preventDefault();
          openModal(ref, href, 'Loading…');
          try { vBody.textContent = (await fetchKJV(ref)) || 'Preview unavailable.'; }
          catch { vBody.textContent = 'Preview unavailable.'; }
        });
      } else {
        a.addEventListener('mouseenter', async ()=>{
          clearTimeout(hideT);
          if (!pop){ pop = document.createElement('div'); pop.className='ref-pop'; document.body.appendChild(pop); }
          pop.textContent = 'Loading…';
          const rect = a.getBoundingClientRect();
          pop.style.top = (window.scrollY + rect.bottom + 6) + 'px';
          pop.style.left = (window.scrollX + rect.left) + 'px';
          pop.hidden = false;
          try { pop.textContent = (await fetchKJV(ref)) || 'Preview unavailable'; }
          catch { pop.textContent = 'Preview unavailable'; }
        });
        a.addEventListener('mouseleave', ()=>{ hideT = setTimeout(()=>{ if(pop) pop.hidden=true; }, 150); });
        // Desktop: click flows to Bible Gateway (no preventDefault)
      }
    });
  }

  /* ----------------- Renderers ----------------- */
  const renderHeader = () => {
    document.title = data.meta.title || 'Interactive Course';
    app.header.innerHTML = `
      <div class="flex justify-between items-start gap-4">
        <div>
          <h1 class="text-3xl font-bold text-accent">${data.meta.title}</h1>
          <p class="mt-2 text-primary/80">${data.meta.description || ''}</p>
        </div>
        <button id="settingsBtn" class="flex-shrink-0 p-3 rounded-lg settings-button transition-opacity" aria-label="Display Settings">
          <span class="text-2xl text-accent">⚙️</span>
        </button>
      </div>`;
  };

  const renderTabs = () => {
    app.tabs.innerHTML = `<div class="flex flex-wrap">${
      data.units.map(unit => `
        <button role="tab" aria-selected="false" aria-controls="${unit.id}-panel" id="${unit.id}-tab"
                class="px-5 py-3 font-semibold transition-colors tab-button">
          ${unit.display_name || unit.name || unit.id}
        </button>`
      ).join('')
    }</div>`;
  };

  const renderPanels = () => {
    app.panels.innerHTML = data.units.map(unit => {
      const introHTML = unit.introduction ? `<p class="lead">${unit.introduction}</p>` : '';
      const paragraphsHTML = (unit.paragraphs || []).map(p => `
        ${p.heading ? `<h3>${p.heading}</h3>` : ''}
        ${p.content ? `<p>${p.content}</p>` : ''}
      `).join('');
      const proseClasses = THEMES[state.theme].isDark ? 'prose prose-lg max-w-none prose-invert' : 'prose prose-lg max-w-none';
      return `
        <div role="tabpanel" id="${unit.id}-panel" aria-labelledby="${unit.id}-tab" hidden>
          <div class="${proseClasses}">
            <h2>${unit.display_name || unit.name || unit.id}</h2>
            ${introHTML}
            ${paragraphsHTML}
          </div>
        </div>`;
    }).join('');

    /* After panels render, linkify and attach previews */
    linkifyBibleRefs(app.panels);
    attachRefPreviews(app.panels);
  };

  /* ----------------- Tab & UI logic ----------------- */
  const switchTab = (tabId) => {
    if (!data.units.some(u => u.id === tabId)) {
      tabId = data.units[0]?.id;
    }
    if (!tabId) return;

    app.tabs.querySelectorAll('[role="tab"]').forEach(tab => {
      const isActive = tab.id === `${tabId}-tab`;
      tab.setAttribute('aria-selected', isActive);
      tab.classList.toggle('tab-active', isActive);
    });

    app.panels.querySelectorAll('[role="tabpanel"]').forEach(panel => {
      panel.hidden = panel.id !== `${tabId}-panel`;
    });

    state.activeTab = tabId;
    saveState();
  };

  const setupEventListeners = () => {
    app.tabs.addEventListener('click', e => {
      const tab = e.target.closest('[role="tab"]');
      if (tab) {
        switchTab(tab.id.replace('-tab', ''));
        // Ensure previews on the now-visible panel (already linked globally)
      }
    });

    app.header.addEventListener('click', e => {
      if (e.target.closest('#settingsBtn')) {
        app.settings.modal.classList.remove('hidden');
        app.settings.themeSelect.focus();
      }
    });

    const closeModal = () => {
      app.settings.modal.classList.add('hidden');
      document.getElementById('settingsBtn')?.focus();
    };
    app.settings.closeBtn.addEventListener('click', closeModal);
    app.settings.modal.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    app.settings.themeSelect.addEventListener('change', (e) => {
      applyTheme(e.target.value);
      renderPanels();                 // re-render applies prose theme
      const activePanel = document.getElementById(`${state.activeTab}-panel`);
      if (activePanel) activePanel.hidden = false;
    });
  };

  /* ----------------- Init ----------------- */
  const init = () => {
    loadState();
    populateThemeSelector();
    applyTheme(state.theme);
    renderHeader();
    renderTabs();
    renderPanels();
    setupEventListeners();
    switchTab(state.activeTab || data.units[0]?.id);
  };

  init();
});
</script>
</body>
</html>

