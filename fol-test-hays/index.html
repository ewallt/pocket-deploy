<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Course Template</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Default Theme: Newspaper */
    :root {
      --bg-gradient: #fdfdf8;
      --text: #1c1c1c;
      --accent-text: #8c1c13;
      --nav-bg: #f1f1eb;
      --nav-border: #dcdcd3;
      --nav-text: #1c1c1c;
      --nav-hover-bg: #e5e5dd;
      --nav-active-bg: #dcdcd3;
      --nav-active-text: #1c1c1c;
      --prose-text: var(--text);
      --prose-headings: var(--accent-text);
      --prose-links: var(--accent-text);
      --prose-bold: var(--text);
      font-family: 'Merriweather', serif;
    }

    .theme-emerald-paper,
    .theme-cyber-blue,
    .theme-emerald-gold {
      font-family: 'Lato', sans-serif;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
    }

    .ui-bg { background-color: var(--nav-bg); }
    .ui-border { border-color: var(--nav-border); }
    .text-primary { color: var(--text); }
    .text-accent { color: var(--accent-text); }

    .tab-button {
      background-color: var(--nav-bg);
      color: var(--nav-text);
      border-bottom: 3px solid transparent;
    }
    .tab-button:hover,
    .tab-button:focus-visible {
      background-color: var(--nav-hover-bg);
    }
    .tab-button.tab-active {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-text);
      border-bottom-color: var(--accent-text);
    }

    .settings-button { background-color: var(--nav-hover-bg); }
    .settings-button:hover { opacity: 0.8; }
    *:focus-visible { outline: 3px solid var(--accent-text); outline-offset: 2px; }

    .prose { color: var(--prose-text); }
    .prose h2,
    .prose h3,
    .prose a,
    .prose strong { color: var(--prose-headings); }
    .prose p.lead { color: var(--prose-text); }

    /* Navy (Dark) overrides */
    .theme-cyber-blue .tab-button.tab-active {
      background-color: #1f2937; /* slate-800 */
      color: #e5e7eb;           /* slate-200 */
      border-bottom-color: #3b82f6; /* blue-500 */
      box-shadow: inset 0 -2px 0 0 #3b82f6;
    }
    .theme-cyber-blue .prose a {
      color: #60a5fa;              /* blue-400 */
      text-decoration-color: #60a5fa;
    }
    .theme-cyber-blue .prose a:hover {
      color: #93c5fd;              /* blue-300 */
      text-decoration-color: #93c5fd;
    }
  </style>

</head>
<body class="transition-colors duration-300">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <header id="app-header" class="ui-bg border ui-border rounded-lg shadow-lg p-6 mb-6"></header>
    <nav id="app-tabs" class="ui-bg border ui-border rounded-lg shadow-lg mb-6" role="tablist" aria-label="Main navigation"></nav>
    <main id="app-panels" class="ui-bg border ui-border rounded-lg shadow-lg p-6 md:p-8"></main>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="ui-bg border ui-border rounded-lg p-6 max-w-md w-full shadow-2xl">
        <h2 id="settings-title" class="text-xl font-bold text-accent mb-4">Display Settings</h2>
        <div class="space-y-4">
          <div>
            <label for="themeSelect" class="block text-primary font-semibold mb-2">Theme</label>
            <select id="themeSelect" class="w-full px-3 py-2 rounded ui-bg border ui-border text-primary"></select>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button id="closeSettings" class="px-4 py-2 rounded text-primary hover:opacity-80">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!--
  ============================================================
  vvvvvvvvvvvvvv PASTE YOUR JSON CONTENT BELOW vvvvvvvvvvvvvv
  ============================================================
  -->
  <script type="application/json" id="app-data">
{
  "hays-hermeneutic-essay": {
    "title": "Reading Backwards to Live Forward: Richard B. Hays’s Hermeneutic as a Coherent System of New Testament Ethics",
    "description": "Richard B. Hays’s biblical hermeneutics presents a unified system where method generates framework, which yields practice. By translating figural interpretation into ecclesial practices, Hays offers contemporary churches a coherent alternative to proof-texting and ethical fragmentation.",
    "categories": {
      "unit-1-figural-reading": {
        "display_order": 10,
        "name": "A Figural Reading",
        "display_name": "The Method",
        "paragraphs": [
          {
            "heading": "The Problem of Fragmentation",
            "content": "Contemporary New Testament ethics suffers from two interrelated problems: fragmentation across diverse biblical voices and the reduction of Scripture to proof-texts for predetermined positions. Churches seeking moral guidance encounter seemingly contradictory teachings—Romans 13’s submission to authorities versus Revelation 13’s resistance to the beast—while ethical debates devolve into citation wars where isolated verses function as weapons rather than wisdom. This methodological poverty leaves Christian communities unable to articulate why their sacred texts cohere or how ancient writings address modern dilemmas."
          },
          {
            "heading": "Hays's Diagnostic: How NT Authors Read",
            "content": "Richard B. Hays diagnoses this crisis as stemming from inadequate attention to how New Testament authors themselves read Scripture. Rather than mining the Old Testament for isolated predictions, Paul and the Gospel writers engaged in sophisticated intertextual interpretation. Hays identifies three levels of such engagement. An “echo” is “a word or phrase that evokes, for the alert reader, a reminiscence of an earlier text” where “recognizing the echo will often trigger the recovery of contextual elements of Text A beyond the words that are directly echoed.” “Metalepsis” operates when New Testament authors “cite from the OT with the expectation that readers will grasp the meaning of a citation in light of the context from which it was taken”—essentially “filling in a gap in understanding from an unquoted part of the background text.”"
          },
          {
            "heading": "The Logic of 'Reading Backwards'",
            "content": "Most radically, “figural reading” or “reading backwards” means discovering “previously unanticipated correspondences” between later events and earlier texts, where “the facts experienced by the Church” illuminate Israel’s traditions retrospectively. Consider an everyday analogy: when we reread a detective novel after knowing the ending, previously insignificant details suddenly reveal themselves as crucial clues. Similarly, the resurrection transforms how disciples read their Scriptures—not as conscious predictions but as patterns awaiting fulfillment."
          },
          {
            "heading": "Detecting Echoes and Allusions",
            "content": "Hays’s method begins with careful detection of scriptural echoes using specific criteria. Unlike quotations marked by formulae like “as it is written,” echoes involve subtle verbal correspondences that evoke broader narrative contexts. An “allusion” falls between these extremes, “caught by a perceptive reader because they usually include only a few words signalling the connection between source text and target text.” The key methodological principle is metaleptic reading: even separated quotations “retain a memory” of their original context, which “serves to illuminate the new surroundings in which they are embedded.”"
          },
          {
            "heading": "Example: Jesus and Elijah",
            "content": "Consider Luke 7:11-17, where Jesus raises a widow’s son at Nain. Hays identifies this as an echo of 1 Kings 17:17-24, where Elijah raises the widow of Zarephath’s son. No explicit quotation appears, yet the “narrative correspondence or ‘rhyming’ of the two stories” becomes evident to an “alert reader.” This echo accomplishes dual work: it implies “the mysterious continuity of God’s action in history” while simultaneously highlighting that “in Jesus we encounter something far greater than Elijah.” The method reveals how Luke portrays Jesus not through abstract christological statements but through carefully orchestrated scriptural resonances."
          },
          {
            "heading": "Example: Composite Quotations in Matthew",
            "content": "A more complex case appears in Matthew 27:9-10, which Hays acknowledges as a “composite quotation” that “seems badly garbled.” Matthew attributes to Jeremiah a text combining elements from Jeremiah 32:6-15 (field purchase) and Zechariah 11:12-13 (thirty silver pieces). Yet through metalepsis, Matthew uses Jeremiah’s broader context as a “hermeneutical frame.” The unquoted portions of Jeremiah’s field purchase—a prophetic sign of restoration despite judgment—illuminate the theological significance of Judas’s betrayal money purchasing the potter’s field. What appears as textual confusion operates as sophisticated theological interpretation."
          },
          {
            "heading": "The Analogy of Jazz",
            "content": "Think of how jazz musicians quote melodic fragments from earlier compositions—a few notes from “Summertime” woven into a new improvisation don’t just reference Gershwin but evoke an entire emotional world of languid Southern heat and lost innocence. Similarly, Gospel writers drop scriptural fragments that carry their original contexts forward into new theological arrangements."
          },
          {
            "heading": "Methodological Honesty: Letting Tensions Stand",
            "content": "Hays’s method acknowledges interpretive challenges. He explicitly instructs interpreters to “Let the Tensions Stand” rather than forcing resolutions that “distort individual texts.” When Romans 13 and Revelation 13 present conflicting views of state authority, Hays maintains that “texts must retain their identities as distinct witnesses.” This methodological honesty prevents the domestication of difficult passages while maintaining that diverse voices can still sing in “harmony—albeit, not in unison.”"
          }
        ]
      },
      "unit-2-ethical-triad": {
        "display_order": 20,
        "name": "The Ethical Triad",
        "display_name": "The Framework",
        "paragraphs": [
          {
            "heading": "Community",
            "content": "The ethical triad of community, cross, and new creation emerges necessarily from Hays’s figural method. Community arises from Paul’s “ecclesiocentric hermeneutic,” where he “read Scripture for prefigurations of the church.” This reading strategy yields the ethical norm that “the primary moral concern is not the character of the individual, but the corporate obedience of the church.” The mechanism operates through recognizing continuity with Israel: “we have been grafted into the story of Israel, and… the church carries forward the story of God’s election and redemption of a particular people.” Paul’s letters, especially 1 Corinthians, demonstrate this communal emphasis, echoing Israel’s covenant structure, where individual righteousness finds meaning within collective faithfulness. The church’s unity across ethnicities reflects “God’s wider redemption plan” rooted in Old Testament promises."
          },
          {
            "heading": "Cross",
            "content": "The cross emerges from how the Gospels “skillfully interweave in their narrative fine OT strands that create a tapestry portraying Jesus as ‘the embodied presence of the God of Israel’” culminating in his identity as “the crucified Messiah.” This figural reading generates the ethical norm of “self-sacrificial love and non-violence,” with Jesus’s “non-violent surrender to crucifixion” serving as the “paradigm of self-giving, sacrificial love.” Mark’s Gospel particularly conveys “moral teachings through Jesus’ life and death as the foundation for moral values.” Through figural interpretation, Old Testament passages about suffering servants and rejected stones gain new meaning as prefigurations of cruciform discipleship. To follow Jesus means “obeying his call to bear the cross, thereby becoming like him in suffering and self-denial.”"
          },
          {
            "heading": "New Creation",
            "content": "New Creation derives from the eschatological trajectory that figural reading reveals. The “figural coherence between the Old and New Testaments includes the hope for New Creation” where “the arrival of Jesus completes the story begun in the Old Testament.” This generates an ethic of “active participation in God’s transformation of the world, living out faithfulness in anticipation of future redemption.” Paul’s ethics operate within the “already and not yet of God’s kingdom,” where “hope for New Creation and God’s eschatological transformation of the world” shapes present behavior. Revelation’s vision of “Resisting the Beast” demonstrates how future hope enables present resistance. The mechanism works through temporal reorientation: because God will transform creation, the church embodies that transformation proleptically."
          },
          {
            "heading": "The Pauline Center: pistis Christou",
            "content": "The pistis Christou debate crystallizes how Hays’s hermeneutical method reshapes theological understanding. This Greek phrase presents a grammatical ambiguity: should it be translated as “faith in Christ” (objective genitive) or “faithfulness of Christ” (subjective genitive)? Hays champions the subjective reading, arguing that “Paul’s focus in Galatians is not on human faith as an alternative to human ‘works of the law,’ but on Christ’s own faithfulness as the expression of God’s commitment to his promise to Abraham.”"
          },
          {
            "heading": "The pistis Christou Debate",
            "content": "The debate “cannot be resolved on the basis of semantics, grammar, or even exegesis alone” but requires “theological reconstruction.” Traditional interpretation, favoring the objective genitive, emphasizes individual trust in Christ for salvation. Luther and some New Perspective scholars like James Dunn maintain this reading, viewing “human deliverance in the gospel” as “attributed to an individual’s trusting faith in Christ.”"
          },
          {
            "heading": "Implications of the Subjective Reading",
            "content": "Hays’s subjective genitive interpretation yields three crucial implications. First, it reorients soteriology from human response to divine initiative: salvation depends on Christ’s faithfulness rather than our faith, offering “a bracing corrective to an individualistic and exclusively forensic doctrine of justification by faith.” Second, it underscores grace as entirely God’s work: “It is the faithfulness OF Christ that led to his death and resurrection, not our faith IN Christ that made it happen.” Third, it reveals faith’s correlative nature: “the faith which trusts (fides qua) and the faith which is believed (fides quae) are not disjunctive but correlative.”"
          },
          {
            "heading": "Ethical Transformation",
            "content": "This interpretation transforms ethical implications. If Christ’s faithful narrative “warrants and defines the way of liberation for those who believe,” then Christian ethics involves conforming to Christ’s pattern rather than generating faith through moral effort. The Holy Spirit mediates Christ’s faithfulness, “calling forth faith in Christ as a corresponding response.” Ethics becomes responsive participation in God’s prior action rather than achievement of moral standards."
          }
        ]
      },
      "unit-3-implementation-critique": {
        "display_order": 30,
        "name": "Implementation & Critique",
        "display_name": "The Practice",
        "paragraphs": [
          {
            "heading": "Integrate Figural Reading into Liturgy",
            "content": "Translating Hays’s hermeneutical system into ecclesial practice requires specific, actionable modifications. First, churches should “integrate Figural Reading into Liturgy, Lectionaries, and Preaching” to help congregations understand themselves as “grafted into the story of Israel” and recognize their call to “carry forward the mission of God’s justice and mercy in the world.” This means selecting Old Testament readings that resonate figurally with Gospel texts, teaching congregations to hear echoes, and structuring sermons around metaleptic connections. Preachers would ask: “How does this Evangelist, by invoking or evoking Israel’s Scripture, re-narrate the history of Israel?”"
          },
          {
            "heading": "Cultivate a Hermeneutic of Trust",
            "content": "Second, communities must “Cultivate a ‘Hermeneutic of Trust’ and Imaginative Engagement with Texts” rather than approaching Scripture with suspicion. This involves “patient expectancy and trust in the texts—a confidence that, as we tarry and wrestle with them, they’ll reward us with illumination and an encounter with a good and loving God.” Practically, this means Bible studies that dwell patiently with difficult passages, expecting revelation rather than rushing to application, and embracing “boldly imaginative” interpretation that allows Scripture’s “complex symphony” to be heard."
          },
          {
            "heading": "Frame Ethical Discernment around the Triad",
            "content": "Third, churches should “Frame Ethical Discernment around the Focal Images of Community, Cross, and New Creation” when addressing moral questions. Rather than seeking isolated proof-texts, communities would ask: How does this decision affect our corporate witness (community)? Does it embody self-giving love (cross)? How does it anticipate God’s coming kingdom (new creation)? This framework ensures that “ethical teaching goes beyond a single principle like love” while maintaining coherence."
          },
          {
            "heading": "Objection: Methodological Circularity",
            "content": "Critics raise several substantive challenges to Hays’s system. Regarding methodological circularity, some argue that his “presupposition” of divine continuity “invalidates the work as serious scholarship in the eyes of some beholders.” Hays responds by openly acknowledging his work as “faith seeking exegetical clarity,” explicitly promoting a “hermeneutic of trust” over a “hermeneutic of suspicion.”"
          },
          {
            "heading": "Objection: Impressionistic Methodology",
            "content": "Christopher Seitz critiques Hays’s “impressionistic methodology” as delivering “us into subjectivity instead of the way that thematic biblical theology has traditionally worked.” Hays counters that his method involves “close attention to the text and to techniques of literary composition” with specific criteria for detecting echoes, employing a “key hermeneutical binomial—‘encyclopedia of production’ and ‘encyclopedia of reception’” to ground interpretation."
          },
          {
            "heading": "Objection: Criteria Precision",
            "content": "Regarding criteria precision, critics note that Hays “does not supply any examples from the Gospels illustrating the difference between allusion and echo.” While acknowledging this limitation, Hays directs readers to his extensive work on Paul for detailed criteria and maintains that an “alert reader” can discern these resonances through careful attention."
          },
          {
            "heading": "The Challenge of Sexuality",
            "content": "The sexuality debate presents the sharpest challenge. Hays’s recent work argues that God “repeatedly changes his mind in ways that expand the sphere of his love,” suggesting a “trajectory hermeneutic” that some see as undermining biblical authority. Hays responds that this trajectory emerges from “serious reading of the biblical narratives” themselves, not from abandoning Scripture."
          },
          {
            "heading": "Conclusion",
            "content": "Richard B. Hays’s hermeneutical system demonstrates that method determines framework, which shapes practice. Figural reading—detecting echoes, employing metalepsis, reading backwards from Christ—necessarily generates the ethical triad of community, cross, and new creation because these patterns emerge from how New Testament authors themselves interpreted Scripture. The pistis Christou debate exemplifies how this method shifts focus from human achievement to divine initiative, transforming both soteriology and ethics. When implemented through concrete ecclesial practices—figural preaching, hermeneutic of trust, triad-based discernment—this system offers churches a coherent alternative to proof-texting fragmentation. Hays contributes to contemporary Christian moral reasoning a methodologically grounded path from textual interpretation to communal transformation, demonstrating that how we read determines how we live."
          }
        ]
      }
    }
  }
}


  </script>
  <!--
  ============================================================
  ^^^^^^^^^^^^^^ PASTE YOUR JSON CONTENT ABOVE ^^^^^^^^^^^^^^
  ============================================================
  -->

<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const THEMES = {
    'newspaper': {
      name: 'Newspaper',
      type: 'classic',
      isDark: false
    },
    'emerald-paper': {
      name: 'Emerald Paper',
      type: 'variable',
      isDark: false,
      vars: {
        '--bg-gradient': '#f7fbf9',
        '--text': '#1e2b28',
        '--accent-text': '#0f7f6d',
        '--nav-bg': '#e7f3ef',
        '--nav-border': '#86c8ba',
        '--nav-text': '#1e2b28',
        '--nav-hover-bg': '#d7ece6',
        '--nav-active-bg': '#bfe3d9',
        '--nav-active-text': '#1e2b28',
        '--prose-text': '#1e2b28',
        '--prose-headings': '#0f7f6d'
      }
    },
    'cyber-blue': {
      name: 'Navy (Dark)',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#0a0a23 0%, #141433 50%, #0f172a 100%)',
        '--text': '#e5e7eb',
        '--accent-text': '#cbd5e1',
        '--nav-bg': '#0f172a',
        '--nav-border': '#1f2937',
        '--nav-text': '#e5e7eb',
        '--nav-hover-bg': '#111827',
        '--nav-active-bg': '#1f2937',
        '--nav-active-text': '#e5e7eb',
        '--prose-text': '#e5e7eb',
        '--prose-headings': '#cbd5e1'
      }
    },
    'emerald-gold': {
      name: 'Emerald/Gold',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#022c22 0%,#064e3b 60%,#065f46 100%)',
        '--text': '#ecfdf5',
        '--accent-text': '#f0c475',
        '--nav-bg': '#064e3b',
        '--nav-border': '#d4a24c',
        '--nav-text': '#ecfdf5',
        '--nav-hover-bg': '#065f46',
        '--nav-active-bg': '#0b3d31',
        '--nav-active-text': '#f0c475',
        '--prose-text': '#a7f3d0',
        '--prose-headings': '#f0c475'
      }
    }
  };

  const app = {
    root: document.documentElement,
    header: document.getElementById('app-header'),
    tabs: document.getElementById('app-tabs'),
    panels: document.getElementById('app-panels'),
    settings: {
      modal: document.getElementById('settingsModal'),
      closeBtn: document.getElementById('closeSettings'),
      themeSelect: document.getElementById('themeSelect')
    }
  };

  /* ---------- State (now with per-project storage prefix) ---------- */
  const state = { activeTab: null, theme: 'newspaper', storagePrefix: 'cr_' };

  const loadState = () => {
    state.theme = localStorage.getItem(state.storagePrefix + 'theme') || 'newspaper';
    state.activeTab = localStorage.getItem(state.storagePrefix + 'tab');
  };

  const saveState = () => {
    localStorage.setItem(state.storagePrefix + 'theme', state.theme);
    localStorage.setItem(state.storagePrefix + 'tab', state.activeTab);
  };

  /* ------------------- Theme helpers ------------------- */
  const applyTheme = (themeKey) => {
    const theme = THEMES[themeKey];
    if (!theme) return;

    app.root.className = '';
    app.root.style.cssText = '';

    if (theme.type === 'variable' && theme.vars) {
      for (const [key, value] of Object.entries(theme.vars)) {
        app.root.style.setProperty(key, value);
      }
      app.root.classList.add(`theme-${themeKey}`);
    }

    state.theme = themeKey;
    if (app.settings.themeSelect.value !== themeKey) {
      app.settings.themeSelect.value = themeKey;
    }
    saveState();
  };

  const populateThemeSelector = () => {
    app.settings.themeSelect.innerHTML = Object.entries(THEMES)
      .map(([key, theme]) => `<option value="${key}">${theme.name}</option>`)
      .join('');
  };

  /* ----------------- NEW: flexible loader -----------------
     Accepts either:
     A) CR shape: { title, description, categories:{...} }
     B) Sections shape: { meta:{title,subtitle}, sections:[{id,title,intro,bullets,items}] }
     Also supports a map of apps: { "appKey": {...} } (uses the first)
  --------------------------------------------------------- */

  const slugify = (s) => (s||'app').toString().toLowerCase()
    .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  function sectionAppToCR(root) {
    const title = root.meta?.title || 'Untitled';
    const description = root.meta?.subtitle || '';
    const categories = {};
    (root.sections || []).forEach((s, idx) => {
      const slug = s.id || ('section-' + (idx + 1));
      const paragraphs = [];
      if (Array.isArray(s.bullets) && s.bullets.length) {
        const lis = s.bullets.map(b => `<li>${b}</li>`).join('');
        paragraphs.push({ heading: 'Key points', content: `<ul>${lis}</ul>` });
      }
      (s.items || []).forEach(it => {
        const heading = it.label || it.summary || '';
        const detail = (it.summary ? `<em>${it.summary}</em> ` : '') + (it.detail || '');
        paragraphs.push({ heading, content: detail });
      });
      categories[slug] = {
        display_order: s.display_order ?? (idx + 1),
        name: s.title || slug,
        display_name: s.title || slug,
        introduction: s.intro || '',
        paragraphs
      };
    });
    return { title, description, categories };
  }

  function normalizeFlexible(raw) {
    // Single-app CR
    if (raw && typeof raw === 'object' && raw.categories) return raw;
    // Single-app sections
    if (raw && typeof raw === 'object' && (Array.isArray(raw.sections) || raw.meta)) {
      return sectionAppToCR(raw);
    }
    // Map of apps -> first
    const keys = raw ? Object.keys(raw) : [];
    if (!keys.length) throw new Error('Empty content.');
    const first = raw[keys[0]];
    if (first?.categories) return first;
    if (first && (Array.isArray(first.sections) || first.meta)) return sectionAppToCR(first);
    throw new Error('Unsupported content shape. Expected {categories} or {sections}.');
  }

  /* ----------------- Load & transform data ----------------- */
  const loadAndTransformData = () => {
    try {
      // Prefer data island; fallback to globals if present
      const dataNode = document.getElementById('app-data');
      let rawData = null;
      if (dataNode && dataNode.textContent.trim()) {
        rawData = JSON.parse(dataNode.textContent);
      } else if (window.__CR_APP__ || window.__CONTENT__) {
        rawData = window.__CR_APP__ || window.__CONTENT__;
      } else {
        throw new Error('JSON data is empty.');
      }

      // Normalize to CR app
      const appObj = normalizeFlexible(rawData);

      // Units from categories
      const units = Object.entries(appObj.categories || {})
        .map(([id, unitData]) => ({ id, ...unitData }))
        .sort((a, b) => (a.display_order ?? 999) - (b.display_order ?? 999));

      // Derive per-project storage prefix
      const prefix = 'cr_' + slugify(appObj.title || Object.keys(rawData||{})[0] || 'app') + '_';

      return { meta: { title: appObj.title, description: appObj.description }, units, storagePrefix: prefix };
    } catch (e) {
      console.error('Failed to load or transform app data:', e);
      app.panels.innerHTML =
        `<div class="p-4 text-red-500 bg-red-100 rounded"><strong>Error:</strong> Could not load content. Ensure the JSON is valid and present in the data island (or window.__CR_APP__/__CONTENT__).</div>`;
      return null;
    }
  };

  const data = loadAndTransformData();
  if (!data) return;
  state.storagePrefix = data.storagePrefix || state.storagePrefix;

  /* ----------------- Renderers ----------------- */
  const renderHeader = () => {
    document.title = data.meta.title || 'Interactive Course';
    app.header.innerHTML = `
      <div class="flex justify-between items-start gap-4">
        <div>
          <h1 class="text-3xl font-bold text-accent">${data.meta.title}</h1>
          <p class="mt-2 text-primary/80">${data.meta.description || ''}</p>
        </div>
        <button id="settingsBtn" class="flex-shrink-0 p-3 rounded-lg settings-button transition-opacity" aria-label="Display Settings">
          <span class="text-2xl text-accent">⚙️</span>
        </button>
      </div>`;
  };

  const renderTabs = () => {
    app.tabs.innerHTML = `<div class="flex flex-wrap">${
      data.units.map(unit => `
        <button role="tab" aria-selected="false" aria-controls="${unit.id}-panel" id="${unit.id}-tab"
                class="px-5 py-3 font-semibold transition-colors tab-button">
          ${unit.display_name || unit.name || unit.id}
        </button>`
      ).join('')
    }</div>`;
  };

  const renderPanels = () => {
    app.panels.innerHTML = data.units.map(unit => {
      const introHTML = unit.introduction ? `<p class="lead">${unit.introduction}</p>` : '';
      const paragraphsHTML = (unit.paragraphs || []).map(p => `
        ${p.heading ? `<h3>${p.heading}</h3>` : ''}
        ${p.content ? `<p>${p.content}</p>` : ''}
      `).join('');
      const proseClasses = THEMES[state.theme].isDark ? 'prose prose-lg max-w-none prose-invert' : 'prose prose-lg max-w-none';
      return `
        <div role="tabpanel" id="${unit.id}-panel" aria-labelledby="${unit.id}-tab" hidden>
          <div class="${proseClasses}">
            <h2>${unit.display_name || unit.name || unit.id}</h2>
            ${introHTML}
            ${paragraphsHTML}
          </div>
        </div>`;
    }).join('');
  };

  /* ----------------- Tab & UI logic ----------------- */
  const switchTab = (tabId) => {
    if (!data.units.some(u => u.id === tabId)) {
      tabId = data.units[0]?.id;
    }
    if (!tabId) return;

    app.tabs.querySelectorAll('[role="tab"]').forEach(tab => {
      const isActive = tab.id === `${tabId}-tab`;
      tab.setAttribute('aria-selected', isActive);
      tab.classList.toggle('tab-active', isActive);
    });

    app.panels.querySelectorAll('[role="tabpanel"]').forEach(panel => {
      panel.hidden = panel.id !== `${tabId}-panel`;
    });

    state.activeTab = tabId;
    saveState();
  };

  const setupEventListeners = () => {
    app.tabs.addEventListener('click', e => {
      const tab = e.target.closest('[role="tab"]');
      if (tab) switchTab(tab.id.replace('-tab', ''));
    });

    app.header.addEventListener('click', e => {
      if (e.target.closest('#settingsBtn')) {
        app.settings.modal.classList.remove('hidden');
        app.settings.themeSelect.focus();
      }
    });

    const closeModal = () => {
      app.settings.modal.classList.add('hidden');
      document.getElementById('settingsBtn')?.focus();
    };
    app.settings.closeBtn.addEventListener('click', closeModal);
    app.settings.modal.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    app.settings.themeSelect.addEventListener('change', (e) => {
      applyTheme(e.target.value);
      renderPanels();
      const activePanel = document.getElementById(`${state.activeTab}-panel`);
      if (activePanel) activePanel.hidden = false;
    });
  };

  /* ----------------- Init ----------------- */
  const init = () => {
    loadState();
    populateThemeSelector();
    applyTheme(state.theme);
    renderHeader();
    renderTabs();
    renderPanels();
    setupEventListeners();
    switchTab(state.activeTab || data.units[0]?.id);
  };

  init();
});
</script>
</body>
</html>

