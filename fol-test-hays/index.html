<!DOCTYPE html>
<html lang="en" class="theme-newspaper">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Folio — Template (CR JSON compatible)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Custom Properties for Theming */
    /* Default Theme: Newspaper (light, serif) */
    :root {
      --bg-gradient: #fdfdf8;
      --text: #1c1c1c;
      --accent-text: #8c1c13;
      --nav-bg: #f1f1eb;
      --nav-border: #dcdcd3;
      --nav-text: #1c1c1c;
      --nav-hover-bg: #e5e5dd;
      --nav-active-bg: #dcdcd3;
      --nav-active-text: #1c1c1c;
      --prose-text: var(--text);
      --prose-headings: var(--accent-text);
      --prose-links: var(--accent-text);
      --prose-bold: var(--text);
      font-family: 'Merriweather', serif;
      line-height: 1.6;
    }

    .theme-emerald-paper,
    .theme-cyber-blue,
    .theme-emerald-gold {
      font-family: 'Lato', sans-serif;
      line-height: 1.6;
    }

    .theme-emerald-paper {
      --bg-gradient: #f7fbf9;
      --text: #1e2b28;
      --accent-text: #0f7f6d;
      --nav-bg: #e7f3ef;
      --nav-border: #86c8ba;
      --nav-text: #1e2b28;
      --nav-hover-bg: #d7ece6;
      --nav-active-bg: #bfe3d9;
      --nav-active-text: #1e2b28;
      --prose-text: #1e2b28;
      --prose-headings: #0f7f6d;
    }

    .theme-cyber-blue {
      --bg-gradient: #0f172a;
      --text: #e5e7eb;
      --accent-text: #94a3b8;
      --nav-bg: #0f172a;
      --nav-border: #1f2937;
      --nav-text: #e5e7eb;
      --nav-hover-bg: #111827;
      --nav-active-bg: #1f2937;
      --nav-active-text: #e5e7eb;
      --prose-text: #d1d5db;
      --prose-headings: #cbd5e1;
    }

    .theme-emerald-gold {
      --bg-gradient: #064e3b;
      --text: #ecfdf5;
      --accent-text: #f0c475;
      --nav-bg: #064e3b;
      --nav-border: #d4a24c;
      --nav-text: #ecfdf5;
      --nav-hover-bg: #065f46;
      --nav-active-bg: #0b3d31;
      --nav-active-text: #f0c475;
      --prose-text: #a7f3d0;
      --prose-headings: #f0c475;
    }

    body { background-color: var(--bg-gradient); color: var(--text); min-height: 100vh; }
    .ui-bg { background-color: var(--nav-bg); }
    .ui-border { border-color: var(--nav-border); }
    .text-primary { color: var(--text); }
    .text-accent { color: var(--accent-text); }
    *:focus-visible { outline: 3px solid var(--accent-text); outline-offset: 2px; border-radius: 2px; }

    .prose { color: var(--prose-text); }
    .prose h2, .prose h3 { color: var(--prose-headings); }
    .prose a { color: var(--prose-links); text-decoration: underline; }
    .prose strong { color: var(--prose-bold); font-weight: bold; }
    .prose h2 { font-size: 1.875rem; line-height: 2.25rem; margin-top: 2rem; margin-bottom: 1rem; font-weight: 700; border-bottom: 1px solid var(--nav-border); padding-bottom: 0.5rem; }
    .prose h3 { font-size: 1.5rem; line-height: 2rem; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 700; }
    .prose p, .prose ul, .prose ol { margin-bottom: 1rem; }
    .prose ul { list-style-position: inside; }
    .prose li { margin-bottom: 0.5rem; }
    .prose blockquote { border-left: 4px solid var(--nav-border); padding-left: 1rem; margin: 1rem 0; font-style: italic; }
    .prose .note {
      font-size: 0.95rem;
      background-color: var(--nav-bg);
      border: 1px solid var(--nav-border);
      padding: 1rem;
      border-radius: 0.5rem;
    }

    .prose .cite { display: none; }
    .prose .cite:not(:empty) { display: inline; font-size: 0.75rem; color: var(--accent-text); vertical-align: super; line-height: 0; }

    body, .ui-bg, .ui-border, .prose, .prose h2, .prose h3, .prose a, .prose strong, .prose .cite {
      transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
    }

    .nav-link[aria-current="page"] {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-text);
      font-weight: bold;
    }
  </style>
</head>
<body class="antialiased">

<!-- Data island for drop-in JSON (optional). If empty, falls back to content.json or window.__CONTENT__ -->
<script id="app-data" type="application/json">
{
  "meta": {
    "title": "Mark 1:1–3 — “Prepare the Way”: Hays on Figural Christology",
    "subtitle": "How Mark’s composite citation (Exod 23:20/Mal 3:1 + Isa 40:3) signals the LORD’s own advent in Jesus",
    "report_provenance": [
      { "label": "Compiled by", "detail": "Instructor v6.1 — Hays Session" },
      { "label": "Last updated", "detail": "2025-09-03" },
      { "label": "Primary sources", "detail": "Mark 1:1–3; Exod 23:20; Mal 3:1; Isa 40:3 (cf. Isa 40–55; Ps 2; Isa 42; Mark 1:10–11; 15:38)" },
      { "label": "Secondary sources", "detail": "Richard B. Hays, Reading Backwards (2014); Echoes of Scripture in the Gospels (2016)" }
    ]
  },
  "sections": [
    {
      "id": "overview",
      "title": "Overview",
      "intro": "Hays reads Mark’s prologue as a figural claim: the way prepared for YHWH in Isaiah is, in Mark’s story, the way for Jesus—so Jesus embodies Israel’s God returning to His people.",
      "bullets": [
        "Mark opens with a composite quotation labeled “in Isaiah,” foregrounding the Isaianic new-exodus horizon.",
        "Identity effect: the “way of the LORD” becomes the way for Jesus, aligning Him with YHWH via LXX kyrios.",
        "Early motifs (wilderness, Jordan, torn heavens) deepen the new-exodus/theophany frame."
      ],
      "items": [
        {
          "id": "o1",
          "label": "Composite as Overture",
          "summary": "Exod 23:20/Mal 3:1 + Isa 40:3 function as Mark’s theological prelude.",
          "detail": "By heading a composite as “in Isaiah,” Mark centers Isaiah’s promise of divine return while weaving in messenger language from Exodus/Malachi."
        },
        {
          "id": "o2",
          "label": "Figural Identification",
          "summary": "Jesus as the LORD’s arrival.",
          "detail": "If John prepares YHWH’s way (Isa 40), yet Jesus arrives after John, the narrative identifies Jesus with Israel’s God—without erasing the texts’ original sense."
        },
        {
          "id": "o3",
          "label": "New-Exodus Horizon",
          "summary": "Wilderness, water, and return from exile.",
          "detail": "Mark’s wilderness/Jordan setting and the “torn heavens” evoke Isaiah 40–55: God breaks in to restore His people."
        },
        {
          "id": "o4",
          "label": "Narrated Christology",
          "summary": "Story + Scripture disclose identity.",
          "detail": "Mark shows who Jesus is by scripting Him into Israel’s Scriptures rather than by abstract titles alone."
        }
      ]
    },
    {
      "id": "concepts",
      "title": "Core Concepts",
      "intro": "Key terms in Hays’s reading of Mark 1:1–3 and its scriptural horizon.",
      "bullets": [
        "Figural reading sees fuller patterns recognized retrospectively after Jesus’ death and resurrection.",
        "Metalepsis: an echo that summons its wider OT context.",
        "Narrative Christology: identity is shown by the story’s scriptural patterning."
      ],
      "items": [
        {
          "id": "c1",
          "label": "Figural Reading",
          "summary": "Later events disclose prefiguring patterns.",
          "detail": "Not free allegory; the OT sense stands, yet is seen anew in light of Christ’s paschal event."
        },
        {
          "id": "c2",
          "label": "Metalepsis",
          "summary": "Echo that pulls in its broader context.",
          "detail": "Quoting Isa 40:3 invokes the new-exodus chapters (Isa 40–55), shaping how we read Mark’s opening scenes."
        },
        {
          "id": "c3",
          "label": "Composite Citation",
          "summary": "Multiple texts as one witness.",
          "detail": "Mark conflates Exod 23:20/Mal 3:1 with Isa 40:3 to craft a single overture about God’s coming."
        },
        {
          "id": "c4",
          "label": "New Exodus",
          "summary": "Promise of divine return and renewal.",
          "detail": "Isaiah anticipates God Himself leading His people from exile; Mark frames Jesus within this hope."
        },
        {
          "id": "c5",
          "label": "Kyrios (Lord)",
          "summary": "LXX rendering of the divine name.",
          "detail": "The Greek kyrios often translates YHWH, easing the Markan identification effect when applied to Jesus."
        },
        {
          "id": "c6",
          "label": "Narrative Christology",
          "summary": "Identity shown in plot and pattern.",
          "detail": "Mark’s Christology emerges from narrative/scriptural choreography more than from formal creedal ascriptions."
        },
        {
          "id": "c7",
          "label": "Schizō — “Torn”",
          "summary": "Heavens/veil rent open.",
          "detail": "Mark 1:10 and 15:38 bookend access to God’s presence, echoing Isa 64:1."
        }
      ]
    },
    {
      "id": "data",
      "title": "Evidence / Data",
      "intro": "Textual signals that support a figural, high-Christology reading in Mark’s prologue.",
      "bullets": [
        "Identity transfer: YHWH’s “way” → Jesus’ way.",
        "LXX semantics: kyrios as YHWH’s title in Greek.",
        "Motif recurrence: wilderness, Jordan, torn heavens, divine voice."
      ],
      "items": [
        {
          "id": "d1",
          "label": "Identity Transfer",
          "summary": "From YHWH’s path to Jesus’ arrival.",
          "detail": "Mark 1:2–3 assigns Isaiah’s highway for the LORD to the one who comes after John—Jesus."
        },
        {
          "id": "d2",
          "label": "LXX Kyrios",
          "summary": "Title that bridges OT to NT usage.",
          "detail": "Kyrios commonly renders the Tetragrammaton; Mark’s “Lord” language can carry divine connotations when applied to Jesus."
        },
        {
          "id": "d3",
          "label": "Motif Recurrence",
          "summary": "Wilderness/Jordan + torn heavens.",
          "detail": "The setting and theophany (1:10–11) align with Isaianic hopes of God’s return and Spirit-anointed Servant."
        },
        {
          "id": "d4",
          "label": "Bookend Tearing",
          "summary": "Heavens (1:10) ↔ veil (15:38).",
          "detail": "Schizō links opening and climax, suggesting renewed access/presence consistent with divine advent."
        },
        {
          "id": "d5",
          "label": "Servant-King Convergence",
          "summary": "Ps 2 + Isa 42 at baptism.",
          "detail": "The heavenly voice blends royal sonship and servant vocation, reinforcing the Isaianic frame."
        }
      ]
    },
    {
      "id": "timeline",
      "title": "Timeline",
      "intro": "From the Greek Scriptures to Mark’s composition and modern articulation.",
      "bullets": [
        "LXX era establishes kyrios = YHWH convention.",
        "Mark’s Gospel opens with Isaianic overture.",
        "Modern scholarship articulates figural logic."
      ],
      "items": [
        { "id": "t1", "label": "3rd–1st c. BCE — Septuagint", "detail": "Greek OT normalizes kyrios for the divine name, shaping NT diction." },
        { "id": "t2", "label": "c. 60–70 CE — Mark Composed", "detail": "Gospel begins with Exod/Mal + Isa composite (1:2–3) as theological overture." },
        { "id": "t3", "label": "Mark 1:10–11 — Baptism Theophany", "detail": "Heavens torn; voice identifies the Son; Spirit descends—new-exodus tones." },
        { "id": "t4", "label": "Mark 15:38 — Veil Torn", "detail": "Temple curtain rips, echoing 1:10 and Isa 64:1; access theme climaxes." },
        { "id": "t5", "label": "2014 — Reading Backwards", "detail": "Hays articulates figural Christology across the Gospels." },
        { "id": "t6", "label": "2016 — Echoes of Scripture in the Gospels", "detail": "Expanded case studies of OT resonances shaping Gospel portraits." }
      ]
    },
    {
      "id": "critiques",
      "title": "Critiques & Debates",
      "intro": "Where readers push back and how Hays’s approach is assessed.",
      "bullets": [
        "Risk of over-reading echoes without controls.",
        "Historical-critical concerns about early Christology.",
        "Source-critical questions about the composite heading."
      ],
      "items": [
        {
          "id": "k1",
          "label": "Over-Reading?",
          "summary": "Echo vs. eisegesis.",
          "detail": "Subtle allusions can be subjective; Hays answers with criteria (availability, volume, recurrence, thematic coherence, satisfaction)."
        },
        {
          "id": "k2",
          "label": "Christology Controls",
          "summary": "Agent vs. identity.",
          "detail": "Some read the “way” as for God’s agent; Hays argues the Isaianic frame and Mark’s motifs press toward divine identity."
        },
        {
          "id": "k3",
          "label": "“In Isaiah” Problem",
          "summary": "Composite under one prophet.",
          "detail": "Mark’s ascription raises source questions; literarily it spotlights Isaiah’s horizon as the governing lens."
        }
      ]
    }
  ],
  "glossary": [
    { "term": "Figural Reading", "definition": "A retrospective, canonical way of seeing earlier texts prefigure later events in Christ without canceling their original sense." },
    { "term": "Metalepsis", "definition": "An echo that invokes the broader context of its source text, shaping interpretation beyond the quoted line." },
    { "term": "Composite Citation", "definition": "A merged quotation of multiple OT passages treated as a single scriptural witness." },
    { "term": "New Exodus", "definition": "Isaiah’s promise that God Himself would return to restore His people, guiding a second, greater deliverance." },
    { "term": "Kyrios", "definition": "Greek ‘Lord’; the Septuagint’s common rendering of YHWH, often bearing divine connotations in the NT." },
    { "term": "Narrative Christology", "definition": "Understanding who Jesus is through the Gospel’s plot, symbols, and scriptural patterning." },
    { "term": "Schizō", "definition": "Greek for “to tear”; used in Mark 1:10 and 15:38 to frame divine access." },
    { "term": "Theophany", "definition": "A manifestation of God’s presence, often marked by voice, Spirit, or cosmic signs." }
  ],
  "quotes": [
    { "text": "Prepare the way of the LORD; make straight in the desert a highway for our God.", "ref": "Isaiah 40:3" },
    { "text": "Behold, I send my messenger before your face, who will prepare your way.", "ref": "Exodus 23:20; Malachi 3:1 (as used in Mark 1:2)" },
    { "text": "He saw the heavens being torn open and the Spirit descending on him like a dove.", "ref": "Mark 1:10" },
    { "text": "And the curtain of the temple was torn in two, from top to bottom.", "ref": "Mark 15:38" }
  ]
}

</script>

<div class="relative min-h-screen md:flex">
  <div class="ui-bg flex justify-between md:hidden sticky top-0 z-20 border-b ui-border">
    <button id="mobile-menu-btn" aria-controls="nav-panel" aria-expanded="false" class="p-4 text-primary hover:bg-[var(--nav-hover-bg)]">
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      <span class="sr-only">Open Menu</span>
    </button>
    <div class="p-2">
      <button id="theme-switcher-btn-mobile" aria-haspopup="dialog" aria-expanded="false" class="p-2 rounded-full hover:bg-[var(--nav-hover-bg)] text-primary">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.95 10.55a8 8 0 1 0-9.4 9.4 8 8 0 0 0 9.4-9.4ZM12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-14a6 6 0 0 0 0 12V6Z"/></svg>
        <span class="sr-only">Open Theme Settings</span>
      </button>
    </div>
  </div>

  <nav id="nav-panel" class="ui-bg text-primary w-64 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30 md:flex flex-col border-r ui-border">
    <div class="p-4 border-b ui-border">
      <h1 id="app-title" class="text-xl font-bold text-accent">Folio Title</h1>
      <p id="app-subtitle" class="text-sm"></p>
    </div>
    <ul id="nav-links" class="flex-grow p-2" role="menu"></ul>
    <div class="p-4 border-t ui-border hidden md:block">
      <button id="theme-switcher-btn-desktop" aria-haspopup="dialog" aria-expanded="false" class="w-full flex items-center justify-center p-2 rounded hover:bg-[var(--nav-hover-bg)] text-primary">
        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.95 10.55a8 8 0 1 0-9.4 9.4 8 8 0 0 0 9.4-9.4ZM12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-14a6 6 0 0 0 0 12V6Z"/></svg>
        <span>Theme Settings</span>
      </button>
    </div>
  </nav>
  <div id="nav-overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

  <main class="flex-1 p-6 sm:p-8 lg:p-12">
    <div class="max-w-4xl mx-auto prose" id="content-root">
      <!-- Panels generated from JSON will appear here -->
    </div>
  </main>
</div>

<div id="theme-modal" role="dialog" aria-modal="true" aria-labelledby="theme-modal-title" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
  <div id="theme-modal-content" class="ui-bg rounded-lg shadow-xl p-6 w-full max-w-sm border ui-border">
    <div class="flex justify-between items-center mb-4">
      <h2 id="theme-modal-title" class="text-lg font-bold text-primary">Display Settings</h2>
      <button id="theme-modal-close" class="p-1 rounded-full hover:bg-[var(--nav-hover-bg)] text-primary">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <span class="sr-only">Close settings</span>
      </button>
    </div>
    <fieldset>
      <legend class="sr-only">Choose a theme</legend>
      <div class="space-y-2" id="theme-options">
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-newspaper" class="h-4 w-4 mr-3">
          <span class="text-primary">Newspaper (Default)</span>
        </label>
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-emerald-paper" class="h-4 w-4 mr-3">
          <span class="text-primary">Emerald Paper</span>
        </label>
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-cyber-blue" class="h-4 w-4 mr-3">
          <span class="text-primary">Cyber Blue (Dark)</span>
        </label>
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-emerald-gold" class="h-4 w-4 mr-3">
          <span class="text-primary">Emerald Gold (Dark)</span>
        </label>
      </div>
    </fieldset>
  </div>
</div>

<div class="p-4 text-center text-xs text-gray-500">
  <details>
    <summary>Developer Validation Checklist</summary>
    <ul class="text-left mt-2 max-w-md mx-auto list-disc list-inside">
      <li>[X] Single index.html file.</li>
      <li>[X] Tailwind via CDN; vanilla JS.</li>
      <li>[X] Fully responsive; keyboard & touch accessible.</li>
      <li>[X] Four themes via CSS variables; persisted in localStorage.</li>
      <li>[X] View state persisted without changing original UX.</li>
      <li>[X] Content supplied by JSON: data-island > content.json > window.__CONTENT__.</li>
    </ul>
  </details>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const state = {
    activeView: 'introduction',
    activeTheme: 'theme-newspaper',
    themeOpen: false,
    mobileNavOpen: false,
    storagePrefix: 'folio_ntw_'
  };

  const navLinks = document.getElementById('nav-links');
  const navPanel = document.getElementById('nav-panel');
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const navOverlay = document.getElementById('nav-overlay');
  const themeBtns = [document.getElementById('theme-switcher-btn-desktop'), document.getElementById('theme-switcher-btn-mobile')];
  const themeModal = document.getElementById('theme-modal');
  const themeModalContent = document.getElementById('theme-modal-content');
  const themeModalCloseBtn = document.getElementById('theme-modal-close');
  const themeOptions = document.getElementById('theme-options');
  const htmlEl = document.documentElement;
  const contentRoot = document.getElementById('content-root');
  const appTitleEl = document.getElementById('app-title');
  const appSubtitleEl = document.getElementById('app-subtitle');

  let focusBeforeModal;

  async function loadContent() {
    const island = document.getElementById('app-data');
    if (island) {
      const raw = island.textContent.trim();
      if (raw && raw !== '{}' && raw.length > 2) {
        try { return JSON.parse(raw); } catch (e) { console.warn('Invalid JSON in data island:', e); }
      }
    }
    try {
      const res = await fetch('content.json', { cache: 'no-store' });
      if (res.ok) return await res.json();
    } catch (e) {}
    if (window.__CONTENT__) return window.__CONTENT__;
    if (window.__CR_APP__) return window.__CR_APP__;
    throw new Error('No content JSON found. Provide it via the #app-data script tag, a content.json file, or window.__CONTENT__.');
  }

  /* === allow {meta, sections,...} by converting to CR {categories} === */
  function sectionAppToCR(root) {
    const title = root.meta?.title || 'Untitled';
    const description = root.meta?.subtitle || '';
    const categories = {};
    (root.sections || []).forEach((s, idx) => {
      const slug = s.id || ('section-' + (idx + 1));
      const paragraphs = [];

      if (Array.isArray(s.bullets) && s.bullets.length) {
        const lis = s.bullets.map(b => `<li>${b}</li>`).join('');
        paragraphs.push({ heading: 'Key points', content: `<ul>${lis}</ul>` });
      }

      (s.items || []).forEach(it => {
        const heading = it.label || it.summary || '';
        const detail = (it.summary ? `<em>${it.summary}</em> ` : '') + (it.detail || '');
        paragraphs.push({ heading, content: detail });
      });

      categories[slug] = {
        display_order: s.display_order ?? (idx + 1),
        name: s.title || slug,
        display_name: s.title || slug,
        introduction: s.intro || '',
        paragraphs
      };
    });
    return { title, description, categories };
  }

  function normalizeFlexible(data) {
    if (data && typeof data === 'object' && data.categories) return data;
    if (data && typeof data === 'object' && (Array.isArray(data.sections) || data.meta)) {
      return sectionAppToCR(data);
    }
    const keys = data ? Object.keys(data) : [];
    if (!keys.length) throw new Error('Empty content.');
    const first = data[keys[0]];
    if (first?.categories) return first;
    if (first && (Array.isArray(first.sections) || first.meta)) return sectionAppToCR(first);
    throw new Error('Unsupported content shape. Expected {categories} or {sections}.');
  }
  /* === /transform === */

  function catArray(app) {
    return Object.entries(app.categories || {}).map(([slug, c]) => ({
      slug,
      display_order: c.display_order ?? 999,
      display_name: c.display_name || c.name || slug,
      introduction: c.introduction || '',
      paragraphs: Array.isArray(c.paragraphs) ? c.paragraphs : []
    })).sort((a, b) => (a.display_order - b.display_order) || a.display_name.localeCompare(b.display_name));
  }

  function renderApp(app) {
    appTitleEl.textContent = app.title || 'Untitled';
    appSubtitleEl.textContent = app.description || '';

    const cats = catArray(app);
    if (!cats.length) {
      contentRoot.innerHTML = '<div class="p-4 rounded border border-yellow-300 bg-yellow-50 text-yellow-800">No sections available.</div>';
      return;
    }

    const slugSet = new Set(cats.map(c => c.slug));

    navLinks.innerHTML = '';
    for (const c of cats) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#' + c.slug;
      a.className = 'nav-link block p-2 rounded hover:bg-[var(--nav-hover-bg)]';
      a.role = 'menuitem';
      a.dataset.view = c.slug;
      a.textContent = c.display_name;
      li.appendChild(a);
      navLinks.appendChild(li);
    }

    contentRoot.innerHTML = '';
    for (const c of cats) {
      const art = document.createElement('article');
      art.id = c.slug;
      art.className = 'content-panel';
      const h2 = document.createElement('h2');
      h2.textContent = c.display_name;
      art.appendChild(h2);
      if (c.introduction) {
        const p = document.createElement('p');
        p.className = 'note';
        p.innerHTML = c.introduction;
        art.appendChild(p);
      }
      for (const p of c.paragraphs) {
        if (p.heading) {
          const h3 = document.createElement('h3');
          h3.textContent = p.heading;
          art.appendChild(h3);
        }
        if (p.content) {
          const para = document.createElement('p');
          para.innerHTML = p.content;
          art.appendChild(para);
        }
      }
      contentRoot.appendChild(art);
    }

    const savedView = localStorage.getItem(state.storagePrefix + 'view');
    const firstSlug = cats[0].slug;
    const requested = (location.hash || '').replace(/^#/, '') || savedView || firstSlug;
    const initial = slugSet.has(requested) ? requested : firstSlug;

    updateView(initial, false);

    // keep URL + back/forward in sync
    window.addEventListener('hashchange', () => {
      const h = (location.hash || '').replace(/^#/, '');
      updateView(slugSet.has(h) ? h : firstSlug);
    });
  }

  function updateView(viewId, save = true) {
    state.activeView = viewId;

    for (const panel of contentRoot.querySelectorAll('.content-panel')) {
      panel.classList.toggle('hidden', panel.id !== viewId);
    }

    for (const link of navLinks.querySelectorAll('a.nav-link')) {
      const isCurrent = link.dataset.view === viewId;
      link.setAttribute('aria-current', isCurrent ? 'page' : 'false');
    }

    const activeLink = navLinks.querySelector(`[data-view="${viewId}"]`);
    if (activeLink) {
      document.title = `${activeLink.textContent} | ${appTitleEl.textContent}`;
    }

    if (save) {
      localStorage.setItem(state.storagePrefix + 'view', viewId);
    }
  }

  function loadTheme() {
    const saved = localStorage.getItem(state.storagePrefix + 'theme');
    state.activeTheme = saved || 'theme-newspaper';
    applyTheme(state.activeTheme, false);
  }

  function applyTheme(themeClass, save = true) {
    state.activeTheme = themeClass;
    htmlEl.className = themeClass;
    themeOptions.querySelectorAll('input[name="theme"]').forEach(r => r.checked = (r.value === themeClass));
    if (save) localStorage.setItem(state.storagePrefix + 'theme', themeClass);
  }

  function toggleMobileNav(forceClose = false) {
    state.mobileNavOpen = forceClose ? false : !state.mobileNavOpen;
    if (state.mobileNavOpen) {
      navPanel.classList.remove('-translate-x-full');
      navOverlay.classList.remove('hidden');
      mobileMenuBtn.setAttribute('aria-expanded', 'true');
    } else {
      navPanel.classList.add('-translate-x-full');
      navOverlay.classList.add('hidden');
      mobileMenuBtn.setAttribute('aria-expanded', 'false');
    }
  }

  function openThemeModal() {
    focusBeforeModal = document.activeElement;
    themeModal.classList.remove('hidden');
    themeBtns.forEach(b => b.setAttribute('aria-expanded', 'true'));
    const first = themeModal.querySelector('input[name="theme"]');
    if (first) first.focus();
    state.themeOpen = true;
  }
  function closeThemeModal() {
    themeModal.classList.add('hidden');
    themeBtns.forEach(b => b.setAttribute('aria-expanded', 'false'));
    state.themeOpen = false;
    if (focusBeforeModal) focusBeforeModal.focus();
  }

  navLinks.addEventListener('click', (e) => {
    const a = e.target.closest('a.nav-link');
    if (!a) return;
    e.preventDefault();
    const viewId = a.dataset.view;
    updateView(viewId);
    if (state.mobileNavOpen) toggleMobileNav(true);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    history.replaceState(null, '', '#' + viewId);
  });

  mobileMenuBtn.addEventListener('click', () => toggleMobileNav());
  navOverlay.addEventListener('click', () => toggleMobileNav(true));

  themeBtns.forEach(btn => btn.addEventListener('click', openThemeModal));
  themeModalCloseBtn.addEventListener('click', closeThemeModal);
  themeModal.addEventListener('click', (e) => { if (e.target === themeModal) closeThemeModal(); });
  themeOptions.addEventListener('change', (e) => {
    if (e.target.name === 'theme') applyTheme(e.target.value);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (state.themeOpen) closeThemeModal();
      if (state.mobileNavOpen) toggleMobileNav(true);
    }
    if (state.themeOpen && e.key === 'Tab') {
      const focusables = Array.from(themeModalContent.querySelectorAll('button, input'));
      const first = focusables[0], last = focusables[focusables.length - 1];
      if (!first || !last) return;
      if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
      if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
    }
  });

  (async function init(){
    try {
      const raw = await loadContent();
      const app = normalizeFlexible(raw);

      // safer per-project storage key (uses app.title when available)
      state.storagePrefix = 'folio_' + ((app.title || Object.keys(raw||{})[0] || 'app')
        .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')) + '_';

      renderApp(app);
      loadTheme();
    } catch (err) {
      document.body.innerHTML = '<div class="max-w-2xl mx-auto p-6 mt-8 rounded border border-red-300 bg-red-50 text-red-700">' +
        '<strong>Content error:</strong> ' + (err?.message || err) +
        '<div class="mt-2 text-sm">Provide JSON via #app-data, a content.json file, or window.__CONTENT__.</div>' +
        '</div>';
      console.error(err);
    }
  })();
});
</script>
</body>
</html>

