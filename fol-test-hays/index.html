<!DOCTYPE html>
<html lang="en" class="theme-newspaper">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Folio — Template (CR JSON compatible)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Custom Properties for Theming */
    /* Default Theme: Newspaper (light, serif) */
    :root {
      --bg-gradient: #fdfdf8;
      --text: #1c1c1c;
      --accent-text: #8c1c13;
      --nav-bg: #f1f1eb;
      --nav-border: #dcdcd3;
      --nav-text: #1c1c1c;
      --nav-hover-bg: #e5e5dd;
      --nav-active-bg: #dcdcd3;
      --nav-active-text: #1c1c1c;
      --prose-text: var(--text);
      --prose-headings: var(--accent-text);
      --prose-links: var(--accent-text);
      --prose-bold: var(--text);
      font-family: 'Merriweather', serif;
      line-height: 1.6;
    }

    .theme-emerald-paper,
    .theme-cyber-blue,
    .theme-emerald-gold {
      font-family: 'Lato', sans-serif;
      line-height: 1.6;
    }

    .theme-emerald-paper {
      --bg-gradient: #f7fbf9;
      --text: #1e2b28;
      --accent-text: #0f7f6d;
      --nav-bg: #e7f3ef;
      --nav-border: #86c8ba;
      --nav-text: #1e2b28;
      --nav-hover-bg: #d7ece6;
      --nav-active-bg: #bfe3d9;
      --nav-active-text: #1e2b28;
      --prose-text: #1e2b28;
      --prose-headings: #0f7f6d;
    }

    .theme-cyber-blue {
      --bg-gradient: #0f172a;
      --text: #e5e7eb;
      --accent-text: #94a3b8;
      --nav-bg: #0f172a;
      --nav-border: #1f2937;
      --nav-text: #e5e7eb;
      --nav-hover-bg: #111827;
      --nav-active-bg: #1f2937;
      --nav-active-text: #e5e7eb;
      --prose-text: #d1d5db;
      --prose-headings: #cbd5e1;
    }

    .theme-emerald-gold {
      --bg-gradient: #064e3b;
      --text: #ecfdf5;
      --accent-text: #f0c475;
      --nav-bg: #064e3b;
      --nav-border: #d4a24c;
      --nav-text: #ecfdf5;
      --nav-hover-bg: #065f46;
      --nav-active-bg: #0b3d31;
      --nav-active-text: #f0c475;
      --prose-text: #a7f3d0;
      --prose-headings: #f0c475;
    }

    body { background-color: var(--bg-gradient); color: var(--text); min-height: 100vh; }
    .ui-bg { background-color: var(--nav-bg); }
    .ui-border { border-color: var(--nav-border); }
    .text-primary { color: var(--text); }
    .text-accent { color: var(--accent-text); }
    *:focus-visible { outline: 3px solid var(--accent-text); outline-offset: 2px; border-radius: 2px; }

    .prose { color: var(--prose-text); }
    .prose h2, .prose h3 { color: var(--prose-headings); }
    .prose a { color: var(--prose-links); text-decoration: underline; }
    .prose strong { color: var(--prose-bold); font-weight: bold; }
    .prose h2 { font-size: 1.875rem; line-height: 2.25rem; margin-top: 2rem; margin-bottom: 1rem; font-weight: 700; border-bottom: 1px solid var(--nav-border); padding-bottom: 0.5rem; }
    .prose h3 { font-size: 1.5rem; line-height: 2rem; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 700; }
    .prose p, .prose ul, .prose ol { margin-bottom: 1rem; }
    .prose ul { list-style-position: inside; }
    .prose li { margin-bottom: 0.5rem; }
    .prose blockquote { border-left: 4px solid var(--nav-border); padding-left: 1rem; margin: 1rem 0; font-style: italic; }
    .prose .note {
      font-size: 0.95rem;
      background-color: var(--nav-bg);
      border: 1px solid var(--nav-border);
      padding: 1rem;
      border-radius: 0.5rem;
    }

    .prose .cite { display: none; }
    .prose .cite:not(:empty) { display: inline; font-size: 0.75rem; color: var(--accent-text); vertical-align: super; line-height: 0; }

    body, .ui-bg, .ui-border, .prose, .prose h2, .prose h3, .prose a, .prose strong, .prose .cite {
      transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
    }

    .nav-link[aria-current="page"] {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-text);
      font-weight: bold;
    }
  </style>
</head>
<body class="antialiased">

<!-- Data island for drop-in JSON (optional). If empty, falls back to content.json or window.__CONTENT__ -->
<script id="app-data" type="application/json">
{
  "hays-hermeneutic-essay": {
    "title": "Reading Backwards to Live Forward: Richard B. Hays’s Hermeneutic as a Coherent System of New Testament Ethics",
    "description": "Richard B. Hays’s biblical hermeneutics presents a unified system where method generates framework, which yields practice. By translating figural interpretation into ecclesial practices, Hays offers contemporary churches a coherent alternative to proof-texting and ethical fragmentation.",
    "categories": {
      "unit-1-figural-reading": {
        "display_order": 10,
        "name": "A Figural Reading",
        "display_name": "The Method",
        "paragraphs": [
          {
            "heading": "The Problem of Fragmentation",
            "content": "Contemporary New Testament ethics suffers from two interrelated problems: fragmentation across diverse biblical voices and the reduction of Scripture to proof-texts for predetermined positions. Churches seeking moral guidance encounter seemingly contradictory teachings—Romans 13’s submission to authorities versus Revelation 13’s resistance to the beast—while ethical debates devolve into citation wars where isolated verses function as weapons rather than wisdom. This methodological poverty leaves Christian communities unable to articulate why their sacred texts cohere or how ancient writings address modern dilemmas."
          },
          {
            "heading": "Hays's Diagnostic: How NT Authors Read",
            "content": "Richard B. Hays diagnoses this crisis as stemming from inadequate attention to how New Testament authors themselves read Scripture. Rather than mining the Old Testament for isolated predictions, Paul and the Gospel writers engaged in sophisticated intertextual interpretation. Hays identifies three levels of such engagement. An “echo” is “a word or phrase that evokes, for the alert reader, a reminiscence of an earlier text” where “recognizing the echo will often trigger the recovery of contextual elements of Text A beyond the words that are directly echoed.” “Metalepsis” operates when New Testament authors “cite from the OT with the expectation that readers will grasp the meaning of a citation in light of the context from which it was taken”—essentially “filling in a gap in understanding from an unquoted part of the background text.”"
          },
          {
            "heading": "The Logic of 'Reading Backwards'",
            "content": "Most radically, “figural reading” or “reading backwards” means discovering “previously unanticipated correspondences” between later events and earlier texts, where “the facts experienced by the Church” illuminate Israel’s traditions retrospectively. Consider an everyday analogy: when we reread a detective novel after knowing the ending, previously insignificant details suddenly reveal themselves as crucial clues. Similarly, the resurrection transforms how disciples read their Scriptures—not as conscious predictions but as patterns awaiting fulfillment."
          },
          {
            "heading": "Detecting Echoes and Allusions",
            "content": "Hays’s method begins with careful detection of scriptural echoes using specific criteria. Unlike quotations marked by formulae like “as it is written,” echoes involve subtle verbal correspondences that evoke broader narrative contexts. An “allusion” falls between these extremes, “caught by a perceptive reader because they usually include only a few words signalling the connection between source text and target text.” The key methodological principle is metaleptic reading: even separated quotations “retain a memory” of their original context, which “serves to illuminate the new surroundings in which they are embedded.”"
          },
          {
            "heading": "Example: Jesus and Elijah",
            "content": "Consider Luke 7:11-17, where Jesus raises a widow’s son at Nain. Hays identifies this as an echo of 1 Kings 17:17-24, where Elijah raises the widow of Zarephath’s son. No explicit quotation appears, yet the “narrative correspondence or ‘rhyming’ of the two stories” becomes evident to an “alert reader.” This echo accomplishes dual work: it implies “the mysterious continuity of God’s action in history” while simultaneously highlighting that “in Jesus we encounter something far greater than Elijah.” The method reveals how Luke portrays Jesus not through abstract christological statements but through carefully orchestrated scriptural resonances."
          },
          {
            "heading": "Example: Composite Quotations in Matthew",
            "content": "A more complex case appears in Matthew 27:9-10, which Hays acknowledges as a “composite quotation” that “seems badly garbled.” Matthew attributes to Jeremiah a text combining elements from Jeremiah 32:6-15 (field purchase) and Zechariah 11:12-13 (thirty silver pieces). Yet through metalepsis, Matthew uses Jeremiah’s broader context as a “hermeneutical frame.” The unquoted portions of Jeremiah’s field purchase—a prophetic sign of restoration despite judgment—illuminate the theological significance of Judas’s betrayal money purchasing the potter’s field. What appears as textual confusion operates as sophisticated theological interpretation."
          },
          {
            "heading": "The Analogy of Jazz",
            "content": "Think of how jazz musicians quote melodic fragments from earlier compositions—a few notes from “Summertime” woven into a new improvisation don’t just reference Gershwin but evoke an entire emotional world of languid Southern heat and lost innocence. Similarly, Gospel writers drop scriptural fragments that carry their original contexts forward into new theological arrangements."
          },
          {
            "heading": "Methodological Honesty: Letting Tensions Stand",
            "content": "Hays’s method acknowledges interpretive challenges. He explicitly instructs interpreters to “Let the Tensions Stand” rather than forcing resolutions that “distort individual texts.” When Romans 13 and Revelation 13 present conflicting views of state authority, Hays maintains that “texts must retain their identities as distinct witnesses.” This methodological honesty prevents the domestication of difficult passages while maintaining that diverse voices can still sing in “harmony—albeit, not in unison.”"
          }
        ]
      },
      "unit-2-ethical-triad": {
        "display_order": 20,
        "name": "The Ethical Triad",
        "display_name": "The Framework",
        "paragraphs": [
          {
            "heading": "Community",
            "content": "The ethical triad of community, cross, and new creation emerges necessarily from Hays’s figural method. Community arises from Paul’s “ecclesiocentric hermeneutic,” where he “read Scripture for prefigurations of the church.” This reading strategy yields the ethical norm that “the primary moral concern is not the character of the individual, but the corporate obedience of the church.” The mechanism operates through recognizing continuity with Israel: “we have been grafted into the story of Israel, and… the church carries forward the story of God’s election and redemption of a particular people.” Paul’s letters, especially 1 Corinthians, demonstrate this communal emphasis, echoing Israel’s covenant structure, where individual righteousness finds meaning within collective faithfulness. The church’s unity across ethnicities reflects “God’s wider redemption plan” rooted in Old Testament promises."
          },
          {
            "heading": "Cross",
            "content": "The cross emerges from how the Gospels “skillfully interweave in their narrative fine OT strands that create a tapestry portraying Jesus as ‘the embodied presence of the God of Israel’” culminating in his identity as “the crucified Messiah.” This figural reading generates the ethical norm of “self-sacrificial love and non-violence,” with Jesus’s “non-violent surrender to crucifixion” serving as the “paradigm of self-giving, sacrificial love.” Mark’s Gospel particularly conveys “moral teachings through Jesus’ life and death as the foundation for moral values.” Through figural interpretation, Old Testament passages about suffering servants and rejected stones gain new meaning as prefigurations of cruciform discipleship. To follow Jesus means “obeying his call to bear the cross, thereby becoming like him in suffering and self-denial.”"
          },
          {
            "heading": "New Creation",
            "content": "New Creation derives from the eschatological trajectory that figural reading reveals. The “figural coherence between the Old and New Testaments includes the hope for New Creation” where “the arrival of Jesus completes the story begun in the Old Testament.” This generates an ethic of “active participation in God’s transformation of the world, living out faithfulness in anticipation of future redemption.” Paul’s ethics operate within the “already and not yet of God’s kingdom,” where “hope for New Creation and God’s eschatological transformation of the world” shapes present behavior. Revelation’s vision of “Resisting the Beast” demonstrates how future hope enables present resistance. The mechanism works through temporal reorientation: because God will transform creation, the church embodies that transformation proleptically."
          },
          {
            "heading": "The Pauline Center: pistis Christou",
            "content": "The pistis Christou debate crystallizes how Hays’s hermeneutical method reshapes theological understanding. This Greek phrase presents a grammatical ambiguity: should it be translated as “faith in Christ” (objective genitive) or “faithfulness of Christ” (subjective genitive)? Hays champions the subjective reading, arguing that “Paul’s focus in Galatians is not on human faith as an alternative to human ‘works of the law,’ but on Christ’s own faithfulness as the expression of God’s commitment to his promise to Abraham.”"
          },
          {
            "heading": "The pistis Christou Debate",
            "content": "The debate “cannot be resolved on the basis of semantics, grammar, or even exegesis alone” but requires “theological reconstruction.” Traditional interpretation, favoring the objective genitive, emphasizes individual trust in Christ for salvation. Luther and some New Perspective scholars like James Dunn maintain this reading, viewing “human deliverance in the gospel” as “attributed to an individual’s trusting faith in Christ.”"
          },
          {
            "heading": "Implications of the Subjective Reading",
            "content": "Hays’s subjective genitive interpretation yields three crucial implications. First, it reorients soteriology from human response to divine initiative: salvation depends on Christ’s faithfulness rather than our faith, offering “a bracing corrective to an individualistic and exclusively forensic doctrine of justification by faith.” Second, it underscores grace as entirely God’s work: “It is the faithfulness OF Christ that led to his death and resurrection, not our faith IN Christ that made it happen.” Third, it reveals faith’s correlative nature: “the faith which trusts (fides qua) and the faith which is believed (fides quae) are not disjunctive but correlative.”"
          },
          {
            "heading": "Ethical Transformation",
            "content": "This interpretation transforms ethical implications. If Christ’s faithful narrative “warrants and defines the way of liberation for those who believe,” then Christian ethics involves conforming to Christ’s pattern rather than generating faith through moral effort. The Holy Spirit mediates Christ’s faithfulness, “calling forth faith in Christ as a corresponding response.” Ethics becomes responsive participation in God’s prior action rather than achievement of moral standards."
          }
        ]
      },
      "unit-3-implementation-critique": {
        "display_order": 30,
        "name": "Implementation & Critique",
        "display_name": "The Practice",
        "paragraphs": [
          {
            "heading": "Integrate Figural Reading into Liturgy",
            "content": "Translating Hays’s hermeneutical system into ecclesial practice requires specific, actionable modifications. First, churches should “integrate Figural Reading into Liturgy, Lectionaries, and Preaching” to help congregations understand themselves as “grafted into the story of Israel” and recognize their call to “carry forward the mission of God’s justice and mercy in the world.” This means selecting Old Testament readings that resonate figurally with Gospel texts, teaching congregations to hear echoes, and structuring sermons around metaleptic connections. Preachers would ask: “How does this Evangelist, by invoking or evoking Israel’s Scripture, re-narrate the history of Israel?”"
          },
          {
            "heading": "Cultivate a Hermeneutic of Trust",
            "content": "Second, communities must “Cultivate a ‘Hermeneutic of Trust’ and Imaginative Engagement with Texts” rather than approaching Scripture with suspicion. This involves “patient expectancy and trust in the texts—a confidence that, as we tarry and wrestle with them, they’ll reward us with illumination and an encounter with a good and loving God.” Practically, this means Bible studies that dwell patiently with difficult passages, expecting revelation rather than rushing to application, and embracing “boldly imaginative” interpretation that allows Scripture’s “complex symphony” to be heard."
          },
          {
            "heading": "Frame Ethical Discernment around the Triad",
            "content": "Third, churches should “Frame Ethical Discernment around the Focal Images of Community, Cross, and New Creation” when addressing moral questions. Rather than seeking isolated proof-texts, communities would ask: How does this decision affect our corporate witness (community)? Does it embody self-giving love (cross)? How does it anticipate God’s coming kingdom (new creation)? This framework ensures that “ethical teaching goes beyond a single principle like love” while maintaining coherence."
          },
          {
            "heading": "Objection: Methodological Circularity",
            "content": "Critics raise several substantive challenges to Hays’s system. Regarding methodological circularity, some argue that his “presupposition” of divine continuity “invalidates the work as serious scholarship in the eyes of some beholders.” Hays responds by openly acknowledging his work as “faith seeking exegetical clarity,” explicitly promoting a “hermeneutic of trust” over a “hermeneutic of suspicion.”"
          },
          {
            "heading": "Objection: Impressionistic Methodology",
            "content": "Christopher Seitz critiques Hays’s “impressionistic methodology” as delivering “us into subjectivity instead of the way that thematic biblical theology has traditionally worked.” Hays counters that his method involves “close attention to the text and to techniques of literary composition” with specific criteria for detecting echoes, employing a “key hermeneutical binomial—‘encyclopedia of production’ and ‘encyclopedia of reception’” to ground interpretation."
          },
          {
            "heading": "Objection: Criteria Precision",
            "content": "Regarding criteria precision, critics note that Hays “does not supply any examples from the Gospels illustrating the difference between allusion and echo.” While acknowledging this limitation, Hays directs readers to his extensive work on Paul for detailed criteria and maintains that an “alert reader” can discern these resonances through careful attention."
          },
          {
            "heading": "The Challenge of Sexuality",
            "content": "The sexuality debate presents the sharpest challenge. Hays’s recent work argues that God “repeatedly changes his mind in ways that expand the sphere of his love,” suggesting a “trajectory hermeneutic” that some see as undermining biblical authority. Hays responds that this trajectory emerges from “serious reading of the biblical narratives” themselves, not from abandoning Scripture."
          },
          {
            "heading": "Conclusion",
            "content": "Richard B. Hays’s hermeneutical system demonstrates that method determines framework, which shapes practice. Figural reading—detecting echoes, employing metalepsis, reading backwards from Christ—necessarily generates the ethical triad of community, cross, and new creation because these patterns emerge from how New Testament authors themselves interpreted Scripture. The pistis Christou debate exemplifies how this method shifts focus from human achievement to divine initiative, transforming both soteriology and ethics. When implemented through concrete ecclesial practices—figural preaching, hermeneutic of trust, triad-based discernment—this system offers churches a coherent alternative to proof-texting fragmentation. Hays contributes to contemporary Christian moral reasoning a methodologically grounded path from textual interpretation to communal transformation, demonstrating that how we read determines how we live."
          }
        ]
      }
    }
  }
}

</script>

<div class="relative min-h-screen md:flex">
  <div class="ui-bg flex justify-between md:hidden sticky top-0 z-20 border-b ui-border">
    <button id="mobile-menu-btn" aria-controls="nav-panel" aria-expanded="false" class="p-4 text-primary hover:bg-[var(--nav-hover-bg)]">
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      <span class="sr-only">Open Menu</span>
    </button>
    <div class="p-2">
      <button id="theme-switcher-btn-mobile" aria-haspopup="dialog" aria-expanded="false" class="p-2 rounded-full hover:bg-[var(--nav-hover-bg)] text-primary">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.95 10.55a8 8 0 1 0-9.4 9.4 8 8 0 0 0 9.4-9.4ZM12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-14a6 6 0 0 0 0 12V6Z"/></svg>
        <span class="sr-only">Open Theme Settings</span>
      </button>
    </div>
  </div>

  <nav id="nav-panel" class="ui-bg text-primary w-64 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30 md:flex flex-col border-r ui-border">
    <div class="p-4 border-b ui-border">
      <h1 id="app-title" class="text-xl font-bold text-accent">Folio Title</h1>
      <p id="app-subtitle" class="text-sm"></p>
    </div>
    <ul id="nav-links" class="flex-grow p-2" role="menu"></ul>
    <div class="p-4 border-t ui-border hidden md:block">
      <button id="theme-switcher-btn-desktop" aria-haspopup="dialog" aria-expanded="false" class="w-full flex items-center justify-center p-2 rounded hover:bg-[var(--nav-hover-bg)] text-primary">
        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.95 10.55a8 8 0 1 0-9.4 9.4 8 8 0 0 0 9.4-9.4ZM12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm0-14a6 6 0 0 0 0 12V6Z"/></svg>
        <span>Theme Settings</span>
      </button>
    </div>
  </nav>
  <div id="nav-overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

  <main class="flex-1 p-6 sm:p-8 lg:p-12">
    <div class="max-w-4xl mx-auto prose" id="content-root">
      <!-- Panels generated from JSON will appear here -->
    </div>
  </main>
</div>

<div id="theme-modal" role="dialog" aria-modal="true" aria-labelledby="theme-modal-title" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
  <div id="theme-modal-content" class="ui-bg rounded-lg shadow-xl p-6 w-full max-w-sm border ui-border">
    <div class="flex justify-between items-center mb-4">
      <h2 id="theme-modal-title" class="text-lg font-bold text-primary">Display Settings</h2>
      <button id="theme-modal-close" class="p-1 rounded-full hover:bg-[var(--nav-hover-bg)] text-primary">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <span class="sr-only">Close settings</span>
      </button>
    </div>
    <fieldset>
      <legend class="sr-only">Choose a theme</legend>
      <div class="space-y-2" id="theme-options">
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-newspaper" class="h-4 w-4 mr-3">
          <span class="text-primary">Newspaper (Default)</span>
        </label>
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-emerald-paper" class="h-4 w-4 mr-3">
          <span class="text-primary">Emerald Paper</span>
        </label>
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-cyber-blue" class="h-4 w-4 mr-3">
          <span class="text-primary">Cyber Blue (Dark)</span>
        </label>
        <label class="flex items-center p-3 rounded-md border ui-border hover:bg-[var(--nav-hover-bg)] cursor-pointer">
          <input type="radio" name="theme" value="theme-emerald-gold" class="h-4 w-4 mr-3">
          <span class="text-primary">Emerald Gold (Dark)</span>
        </label>
      </div>
    </fieldset>
  </div>
</div>

<div class="p-4 text-center text-xs text-gray-500">
  <details>
    <summary>Developer Validation Checklist</summary>
    <ul class="text-left mt-2 max-w-md mx-auto list-disc list-inside">
      <li>[X] Single index.html file.</li>
      <li>[X] Tailwind via CDN; vanilla JS.</li>
      <li>[X] Fully responsive; keyboard & touch accessible.</li>
      <li>[X] Four themes via CSS variables; persisted in localStorage.</li>
      <li>[X] View state persisted without changing original UX.</li>
      <li>[X] Content supplied by JSON: data-island > content.json > window.__CONTENT__.</li>
    </ul>
  </details>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const state = {
    activeView: 'introduction',
    activeTheme: 'theme-newspaper',
    themeOpen: false,
    mobileNavOpen: false,
    storagePrefix: 'folio_ntw_'
  };

  const navLinks = document.getElementById('nav-links');
  const navPanel = document.getElementById('nav-panel');
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const navOverlay = document.getElementById('nav-overlay');
  const themeBtns = [document.getElementById('theme-switcher-btn-desktop'), document.getElementById('theme-switcher-btn-mobile')];
  const themeModal = document.getElementById('theme-modal');
  const themeModalContent = document.getElementById('theme-modal-content');
  const themeModalCloseBtn = document.getElementById('theme-modal-close');
  const themeOptions = document.getElementById('theme-options');
  const htmlEl = document.documentElement;
  const contentRoot = document.getElementById('content-root');
  const appTitleEl = document.getElementById('app-title');
  const appSubtitleEl = document.getElementById('app-subtitle');

  let focusBeforeModal;

  async function loadContent() {
    const island = document.getElementById('app-data');
    if (island) {
      const raw = island.textContent.trim();
      if (raw && raw !== '{}' && raw.length > 2) {
        try { return JSON.parse(raw); } catch (e) { console.warn('Invalid JSON in data island:', e); }
      }
    }
    try {
      const res = await fetch('content.json', { cache: 'no-store' });
      if (res.ok) return await res.json();
    } catch (e) {}
    if (window.__CONTENT__) return window.__CONTENT__;
    if (window.__CR_APP__) return window.__CR_APP__;
    throw new Error('No content JSON found. Provide it via the #app-data script tag, a content.json file, or window.__CONTENT__.');
  }

  /* === NEW: allow {meta, sections,...} by converting to CR {categories} === */
  function sectionAppToCR(root) {
    const title = root.meta?.title || 'Untitled';
    const description = root.meta?.subtitle || '';
    const categories = {};
    (root.sections || []).forEach((s, idx) => {
      const slug = s.id || ('section-' + (idx + 1));
      const paragraphs = [];

      // bullets -> one list paragraph
      if (Array.isArray(s.bullets) && s.bullets.length) {
        const lis = s.bullets.map(b => `<li>${b}</li>`).join('');
        paragraphs.push({ heading: 'Key points', content: `<ul>${lis}</ul>` });
      }

      // items -> one paragraph per item (label -> heading; summary/detail -> content)
      (s.items || []).forEach(it => {
        const heading = it.label || it.summary || '';
        const detail = (it.summary ? `<em>${it.summary}</em> ` : '') + (it.detail || '');
        paragraphs.push({ heading, content: detail });
      });

      categories[slug] = {
        display_order: s.display_order ?? (idx + 1),
        name: s.title || slug,
        display_name: s.title || slug,
        introduction: s.intro || '',
        paragraphs
      };
    });
    return { title, description, categories };
  }

  function normalizeFlexible(data) {
    // Single-app CR shape
    if (data && typeof data === 'object' && data.categories) return data;

    // Single-app "sections" shape
    if (data && typeof data === 'object' && (Array.isArray(data.sections) || data.meta)) {
      return sectionAppToCR(data);
    }

    // Multi-app map (take the first app)
    const keys = data ? Object.keys(data) : [];
    if (!keys.length) throw new Error('Empty content.');
    const first = data[keys[0]];
    if (first?.categories) return first;
    if (first && (Array.isArray(first.sections) || first.meta)) return sectionAppToCR(first);

    throw new Error('Unsupported content shape. Expected {categories} or {sections}.');
  }
  /* === /NEW === */

  function catArray(app) {
    return Object.entries(app.categories || {}).map(([slug, c]) => ({
      slug,
      display_order: c.display_order ?? 999,
      display_name: c.display_name || c.name || slug,
      introduction: c.introduction || '',
      paragraphs: Array.isArray(c.paragraphs) ? c.paragraphs : []
    })).sort((a, b) => (a.display_order - b.display_order) || a.display_name.localeCompare(b.display_name));
  }

  function renderApp(app) {
    appTitleEl.textContent = app.title || 'Untitled';
    appSubtitleEl.textContent = app.description || '';

    const cats = catArray(app);

    navLinks.innerHTML = '';
    for (const c of cats) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#' + c.slug;
      a.className = 'nav-link block p-2 rounded hover:bg-[var(--nav-hover-bg)]';
      a.role = 'menuitem';
      a.dataset.view = c.slug;
      a.textContent = c.display_name;
      li.appendChild(a);
      navLinks.appendChild(li);
    }

    contentRoot.innerHTML = '';
    for (const c of cats) {
      const art = document.createElement('article');
      art.id = c.slug;
      art.className = 'content-panel';
      const h2 = document.createElement('h2');
      h2.textContent = c.display_name;
      art.appendChild(h2);
      if (c.introduction) {
        const p = document.createElement('p');
        p.className = 'note';
        p.innerHTML = c.introduction;
        art.appendChild(p);
      }
      for (const p of c.paragraphs) {
        if (p.heading) {
          const h3 = document.createElement('h3');
          h3.textContent = p.heading;
          art.appendChild(h3);
        }
        if (p.content) {
          const para = document.createElement('p');
          para.innerHTML = p.content;
          art.appendChild(para);
        }
      }
      contentRoot.appendChild(art);
    }

    const savedView = localStorage.getItem(state.storagePrefix + 'view');
    const firstSlug = cats[0]?.slug || 'introduction';
    const initial = (location.hash || '').replace(/^#/, '') || savedView || firstSlug;
    updateView(initial, false);
  }

  function updateView(viewId, save = true) {
    state.activeView = viewId;

    for (const panel of contentRoot.querySelectorAll('.content-panel')) {
      panel.classList.toggle('hidden', panel.id !== viewId);
    }

    for (const link of navLinks.querySelectorAll('a.nav-link')) {
      const isCurrent = link.dataset.view === viewId;
      link.setAttribute('aria-current', isCurrent ? 'page' : 'false');
    }

    const activeLink = navLinks.querySelector(`[data-view="${viewId}"]`);
    if (activeLink) {
      document.title = `${activeLink.textContent} | ${appTitleEl.textContent}`;
    }

    if (save) {
      localStorage.setItem(state.storagePrefix + 'view', viewId);
    }
  }

  function loadTheme() {
    const saved = localStorage.getItem(state.storagePrefix + 'theme');
    state.activeTheme = saved || 'theme-newspaper';
    applyTheme(state.activeTheme, false);
  }

  function applyTheme(themeClass, save = true) {
    state.activeTheme = themeClass;
    htmlEl.className = themeClass;
    themeOptions.querySelectorAll('input[name="theme"]').forEach(r => r.checked = (r.value === themeClass));
    if (save) localStorage.setItem(state.storagePrefix + 'theme', themeClass);
  }

  function toggleMobileNav(forceClose = false) {
    state.mobileNavOpen = forceClose ? false : !state.mobileNavOpen;
    if (state.mobileNavOpen) {
      navPanel.classList.remove('-translate-x-full');
      navOverlay.classList.remove('hidden');
      mobileMenuBtn.setAttribute('aria-expanded', 'true');
    } else {
      navPanel.classList.add('-translate-x-full');
      navOverlay.classList.add('hidden');
      mobileMenuBtn.setAttribute('aria-expanded', 'false');
    }
  }

  function openThemeModal() {
    focusBeforeModal = document.activeElement;
    themeModal.classList.remove('hidden');
    themeBtns.forEach(b => b.setAttribute('aria-expanded', 'true'));
    const first = themeModal.querySelector('input[name="theme"]');
    if (first) first.focus();
    state.themeOpen = true;
  }
  function closeThemeModal() {
    themeModal.classList.add('hidden');
    themeBtns.forEach(b => b.setAttribute('aria-expanded', 'false'));
    state.themeOpen = false;
    if (focusBeforeModal) focusBeforeModal.focus();
  }

  navLinks.addEventListener('click', (e) => {
    const a = e.target.closest('a.nav-link');
    if (!a) return;
    e.preventDefault();
    const viewId = a.dataset.view;
    updateView(viewId);
    if (state.mobileNavOpen) toggleMobileNav(true);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    history.replaceState(null, '', '#' + viewId);
  });

  mobileMenuBtn.addEventListener('click', () => toggleMobileNav());
  navOverlay.addEventListener('click', () => toggleMobileNav(true));

  themeBtns.forEach(btn => btn.addEventListener('click', openThemeModal));
  themeModalCloseBtn.addEventListener('click', closeThemeModal);
  themeModal.addEventListener('click', (e) => { if (e.target === themeModal) closeThemeModal(); });
  themeOptions.addEventListener('change', (e) => {
    if (e.target.name === 'theme') applyTheme(e.target.value);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (state.themeOpen) closeThemeModal();
      if (state.mobileNavOpen) toggleMobileNav(true);
    }
    if (state.themeOpen && e.key === 'Tab') {
      const focusables = Array.from(themeModalContent.querySelectorAll('button, input'));
      const first = focusables[0], last = focusables[focusables.length - 1];
      if (!first || !last) return;
      if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
      if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
    }
  });

  (async function init(){
    try {
      const raw = await loadContent();
      const app = normalizeFlexible(raw);

      /* safer per-project storage key (uses app.title when available) */
      state.storagePrefix = 'folio_' + ((app.title || Object.keys(raw||{})[0] || 'app')
        .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')) + '_';

      renderApp(app);
      loadTheme();
    } catch (err) {
      document.body.innerHTML = '<div class="max-w-2xl mx-auto p-6 mt-8 rounded border border-red-300 bg-red-50 text-red-700">' +
        '<strong>Content error:</strong> ' + (err?.message || err) +
        '<div class="mt-2 text-sm">Provide JSON via #app-data, a content.json file, or window.__CONTENT__.</div>' +
        '</div>';
      console.error(err);
    }
  })();
});
</script>
</body>
</html>

