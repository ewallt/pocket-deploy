<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Folio — Menu Reader</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet"/>

  <style>
    /* Default Theme: Newspaper (light, serif) */
    :root {
      --bg-gradient: #fdfdf8;
      --text: #1c1c1c;
      --accent-text: #8c1c13;
      --nav-bg: #f1f1eb;
      --nav-border: #dcdcd3;
      --nav-text: #1c1c1c;
      --nav-hover-bg: #e5e5dd;
      --nav-active-bg: #dcdcd3;
      --nav-active-text: #1c1c1c;
      --prose-text: var(--text);
      --prose-headings: var(--accent-text);
      --prose-links: var(--accent-text);
      --prose-bold: var(--text);
      font-family: 'Merriweather', serif;
      line-height: 1.6;
    }

    /* Alt themes use Lato */
    .theme-emerald-paper,
    .theme-cyber-blue,
    .theme-emerald-gold {
      font-family: 'Lato', sans-serif;
      line-height: 1.6;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
    }

    .ui-bg { background-color: var(--nav-bg); }
    .ui-border { border-color: var(--nav-border); }
    .text-primary { color: var(--text); }
    .text-accent { color: var(--accent-text); }
    *:focus-visible { outline: 3px solid var(--accent-text); outline-offset: 2px; border-radius: 2px; }

    .prose { color: var(--prose-text); }
    .prose h2, .prose h3, .prose a, .prose strong { color: var(--prose-headings); }
    .prose a { text-decoration: underline; text-decoration-color: var(--prose-links); }
    .prose p.lead { color: var(--prose-text); }

    /* Top bar */
    .topbar { backdrop-filter: saturate(120%) blur(6px); }

    /* Drawer (left menu) */
    .drawer {
      transform: translateX(-100%);
      transition: transform .25s ease;
    }
    .drawer.open {
      transform: translateX(0);
    }

    /* Theme variable packs */
    /* Navy (Dark) */
    .theme-cyber-blue {
      --bg-gradient: linear-gradient(135deg,#0a0a23 0%, #141433 50%, #0f172a 100%);
      --text: #e5e7eb;
      --accent-text: #cbd5e1;
      --nav-bg: #0f172a;
      --nav-border: #1f2937;
      --nav-text: #e5e7eb;
      --nav-hover-bg: #111827;
      --nav-active-bg: #1f2937;
      --nav-active-text: #e5e7eb;
      --prose-text: #e5e7eb;
      --prose-headings: #cbd5e1;
      --prose-links: #93c5fd;
      --prose-bold: #e5e7eb;
    }
    .theme-cyber-blue .prose a {
      color: #60a5fa;
      text-decoration-color: #60a5fa;
    }
    .theme-cyber-blue .prose a:hover {
      color: #93c5fd;
      text-decoration-color: #93c5fd;
    }

    /* Emerald Paper (light) */
    .theme-emerald-paper {
      --bg-gradient: #f7fbf9;
      --text: #1e2b28;
      --accent-text: #0f7f6d;
      --nav-bg: #e7f3ef;
      --nav-border: #86c8ba;
      --nav-text: #1e2b28;
      --nav-hover-bg: #d7ece6;
      --nav-active-bg: #bfe3d9;
      --nav-active-text: #1e2b28;
      --prose-text: #1e2b28;
      --prose-headings: #0f7f6d;
      --prose-links: #0f7f6d;
      --prose-bold: #1e2b28;
    }

    /* Emerald/Gold (Dark) */
    .theme-emerald-gold {
      --bg-gradient: linear-gradient(135deg,#022c22 0%,#064e3b 60%,#065f46 100%);
      --text: #ecfdf5;
      --accent-text: #f0c475;
      --nav-bg: #064e3b;
      --nav-border: #d4a24c;
      --nav-text: #ecfdf5;
      --nav-hover-bg: #065f46;
      --nav-active-bg: #0b3d31;
      --nav-active-text: #f0c475;
      --prose-text: #a7f3d0;
      --prose-headings: #f0c475;
      --prose-links: #f0c475;
      --prose-bold: #ecfdf5;
    }

    /* Smooth transitions on theme swap */
    body, .ui-bg, .ui-border, .prose, .prose h2, .prose h3, .prose a, .prose strong {
      transition: color .25s ease, background-color .25s ease, border-color .25s ease;
    }

    /* Active item in drawer */
    .nav-item-active {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-text);
    }

    /* Theme popover list */
    .theme-option[aria-checked="true"]::after {
      content: " ✓";
      font-weight: 700;
    }
  </style>
</head>

<body class="transition-colors duration-300 antialiased">
  <!-- Top Bar -->
  <header class="topbar sticky top-0 z-40 ui-bg border-b ui-border">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <button id="menuBtn" class="px-3 py-2 rounded hover:opacity-80" aria-label="Open menu">☰</button>
      <h1 id="topTitle" class="text-lg font-bold text-accent truncate">Folio</h1>
      <button id="themeBtn" class="px-3 py-2 rounded hover:opacity-80" aria-haspopup="true" aria-expanded="false" aria-controls="themePopover" aria-label="Theme">☾</button>
    </div>
  </header>

  <!-- Drawer + Backdrop -->
  <div id="backdrop" class="fixed inset-0 bg-black/50 hidden z-40"></div>
  <aside id="drawer" class="drawer fixed inset-y-0 left-0 w-80 ui-bg ui-border border-r z-50 flex flex-col">
    <div class="px-4 py-3 border-b ui-border flex items-center justify-between">
      <div class="font-semibold text-accent">Menu</div>
      <button id="closeDrawer" class="px-2 py-1 rounded hover:opacity-80" aria-label="Close menu">✕</button>
    </div>
    <nav id="navList" class="overflow-y-auto p-2"></nav>
  </aside>

  <!-- Theme popover -->
  <div id="themePopover" class="hidden absolute right-3 top-14 z-50 ui-bg border ui-border rounded-lg shadow-lg p-2 w-56">
    <div class="px-2 pb-2 text-sm font-semibold text-accent">Theme</div>
    <ul id="themeList" class="divide-y ui-border"></ul>
  </div>

  <!-- Main Content -->
  <main class="mx-auto max-w-4xl px-4 py-6">
    <article id="reader" class="ui-bg border ui-border rounded-lg shadow-lg p-6">
      <div class="prose prose-lg max-w-none" id="content"></div>
    </article>
  </main>

  <!-- ============================================================
       vvvvvvvvvvvvv PASTE YOUR JSON CONTENT BELOW vvvvvvvvvvvvvvvv
       Accepts:
       A) { "title","description","categories": { "<id>": { "display_order"?, "name"?, "display_name"?, "introduction"?, "paragraphs":[{"heading"?, "content"}] } } }
       B) { "<wrapper>": { ...same as A... } }
       C) { "course": { "title","description","categories":{...} } }
       D) { "title","subtitle","sections":[ { "id","title","note"?, "content":[{type:'p'|'ul'|'kv'|'refs'|'table'|'html',...}] } ] }
       E) { "article": { "title","description","blocks":[{type:'p'|...}] } }
       If this block is empty, the app will try to fetch "./content.json".
       ============================================================ -->
  <script type="application/json" id="app-data">
  {
    "title": "Sample Document",
    "description": "Replace with your JSON or provide content.json next to this file.",
    "categories": {
      "unit-1": {
        "display_order": 10,
        "display_name": "Introduction",
        "paragraphs": [
          { "heading": "Welcome", "content": "This Folio menu reader uses a left drawer for navigation and a half-moon theme switcher." }
        ]
      },
      "unit-2": {
        "display_order": 20,
        "display_name": "Details",
        "paragraphs": [
          { "heading": "Compatibility", "content": "It accepts Colorful Reader JSON (with or without a wrapper) and other plain article/sections shapes." }
        ]
      }
    }
  }
  </script>
  <!-- ============================================================
       ^^^^^^^^^^^^^^ PASTE YOUR JSON CONTENT ABOVE ^^^^^^^^^^^^^^^
       ============================================================ -->

  <script defer>
  document.addEventListener('DOMContentLoaded', () => {
    // ---------- Theme config ----------
    const THEMES = {
      newspaper:     { label: 'Newspaper',     isDark: false, class: '' },
      'emerald-paper': { label: 'Emerald Paper', isDark: false, class: 'theme-emerald-paper' },
      'cyber-blue':    { label: 'Navy (Dark)',   isDark: true,  class: 'theme-cyber-blue' },
      'emerald-gold':  { label: 'Emerald/Gold',  isDark: true,  class: 'theme-emerald-gold' }
    };

    // ---------- Elements ----------
    const $ = (id) => document.getElementById(id);
    const app = {
      root: document.documentElement,
      topTitle: $('topTitle'),
      content: $('content'),
      navList: $('navList'),
      drawer: $('drawer'),
      backdrop: $('backdrop'),
      menuBtn: $('menuBtn'),
      closeDrawer: $('closeDrawer'),
      themeBtn: $('themeBtn'),
      themePopover: $('themePopover'),
      themeList: $('themeList')
    };

    // ---------- State ----------
    const state = { activeId: null, theme: 'newspaper', data: null };

    const loadState = () => {
      state.theme = localStorage.getItem('folioMenuThemeV1') || 'newspaper';
      state.activeId = localStorage.getItem('folioMenuActiveV1');
    };
    const saveState = () => {
      localStorage.setItem('folioMenuThemeV1', state.theme);
      localStorage.setItem('folioMenuActiveV1', state.activeId || '');
    };

    const applyTheme = (key) => {
      const t = THEMES[key] || THEMES['newspaper'];
      app.root.classList.remove('theme-emerald-paper','theme-cyber-blue','theme-emerald-gold');
      if (t.class) app.root.classList.add(t.class);
      state.theme = key;
      saveState();
      // Update popover ARIA checks
      Array.from(app.themeList.querySelectorAll('.theme-option')).forEach(li => {
        li.setAttribute('aria-checked', li.dataset.key === key ? 'true' : 'false');
      });
    };

    // ---------- Safe HTML helpers ----------
    const escapeHtml = (s='') => s.replace(/[&<>"']/g, c =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const normalizeId = (s, i=0) =>
      (s || `section-${i+1}`).toString().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

    const nodeToHtml = (n) => {
      if (!n) return '';
      const has = (k) => Object.prototype.hasOwnProperty.call(n, k);
      const text = n.text ?? n.content ?? '';
      switch (n.type) {
        case 'p': return `<p>${escapeHtml(text)}</p>`;
        case 'ul': return `<ul>${(n.items||[]).map(li=>`<li>${escapeHtml(li)}</li>`).join('')}</ul>`;
        case 'refs': return `<p><em>${(n.items||[]).map(escapeHtml).join('; ')}</em></p>`;
        case 'kv': {
          const items = Array.isArray(n.items) ? n.items : [];
          return `<ul>${items.map(([k,v]=[])=>`<li><strong>${escapeHtml(k||'')}</strong>: ${escapeHtml(v||'')}</li>`).join('')}</ul>`;
        }
        case 'table': {
          const cols = n.table?.columns || [];
          const rows = n.table?.rows || [];
          return `
            <div class="overflow-x-auto">
              <table>
                <thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead>
                <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${escapeHtml(String(c))}</td>`).join('')}</tr>`).join('')}</tbody>
              </table>
            </div>`;
        }
        case 'html': return String(n.html || '');
        default:
          if (has('text') || has('content')) return `<p>${escapeHtml(text)}</p>`;
          return '';
      }
    };

    // ---------- Normalizers (accept multiple input schemas) ----------
    const fromCourseCategories = (raw) => {
      const course = raw.course || raw;
      const cats = course.categories || {};
      const units = Object.entries(cats).map(([id, u], idx) => ({
        id: id || normalizeId(u?.display_name || u?.name, idx),
        name: u?.name || u?.display_name || id || `Section ${idx+1}`,
        display_name: u?.display_name || u?.name || id || `Section ${idx+1}`,
        introduction: u?.introduction ? escapeHtml(u.introduction) : null,
        order: Number.isFinite(+u?.display_order) ? +u.display_order : null,
        paragraphs: (u?.paragraphs || []).map(p => ({
          heading: p?.heading || null,
          content: `<p>${escapeHtml(String(p?.content ?? ''))}</p>`
        }))
      }));
      units.sort((a,b)=>{
        if (a.order!==null || b.order!==null) return (a.order ?? Infinity) - (b.order ?? Infinity);
        const A=(a.display_name||a.name||'').toLowerCase(), B=(b.display_name||b.name||'').toLowerCase();
        return A.localeCompare(B);
      });
      return { meta:{ title: course.title||'Untitled', description: course.description||'' }, units };
    };

    const fromUnitsParagraphs = (raw) => {
      const units = (raw.units || []).map((u, idx) => ({
        id: u.id || normalizeId(u?.name, idx),
        name: u.name || u.display_name || `Section ${idx+1}`,
        display_name: u.display_name || u.name || `Section ${idx+1}`,
        introduction: u.introduction ? escapeHtml(u.introduction) : null,
        paragraphs: (u.paragraphs || []).map(p => ({
          heading: p?.heading || null,
          content: `<p>${escapeHtml(String(p?.content ?? ''))}</p>`
        }))
      }));
      return { meta:{ title: raw.title||'Untitled', description: raw.description||raw.subtitle||'' }, units };
    };

    const fromSectionsTyped = (raw) => {
      const secs = Array.isArray(raw.sections) ? raw.sections : [];
      const units = secs.map((s, i) => ({
        id: s.id || normalizeId(s?.title, i),
        name: s.title || `Section ${i+1}`,
        display_name: s.title || `Section ${i+1}`,
        introduction: s.note ? escapeHtml(s.note) : null,
        paragraphs: (s.content || []).map(node => ({
          heading: node?.heading || null,
          content: nodeToHtml(node)
        }))
      }));
      return { meta:{ title: raw.title||'Untitled', description: raw.subtitle||raw.description||'' }, units };
    };

    const fromArticleBlocks = (raw) => {
      const art = raw.article || {};
      const unit = {
        id: 'article',
        name: art.title || 'Article',
        display_name: art.title || 'Article',
        introduction: art.description ? escapeHtml(art.description) : null,
        paragraphs: (art.blocks || []).map(b => ({ heading: b.heading || null, content: nodeToHtml(b) }))
      };
      return { meta:{ title: art.title || raw.title || 'Untitled', description: art.description || raw.description || '' }, units:[unit] };
    };

    const detectAndNormalize = (raw) => {
      if (!raw || typeof raw !== 'object') return null;

      // Allow a single wrapper key: { "<wrapper>": { categories: {...} } }
      const keys = Object.keys(raw);
      if (!raw.categories && keys.length === 1 && raw[keys[0]] && typeof raw[keys[0]] === 'object') {
        const inner = raw[keys[0]];
        if (inner.categories || inner.course?.categories) {
          return detectAndNormalize(inner);
        }
      }

      if (raw.course?.categories || raw.categories) return fromCourseCategories(raw);
      if (Array.isArray(raw.units)) return fromUnitsParagraphs(raw);
      if (Array.isArray(raw.sections)) return fromSectionsTyped(raw);
      if (raw.article?.blocks) return fromArticleBlocks(raw);

      // Minimal fallback
      const html = raw.html ? String(raw.html) :
                   raw.content ? `<p>${escapeHtml(String(raw.content))}</p>` : '';
      return {
        meta: { title: raw.title || 'Untitled', description: raw.subtitle || raw.description || '' },
        units: [{ id: 'content', name: raw.title || 'Content', display_name: raw.title || 'Content', introduction: null, paragraphs: html ? [{ heading:null, content: html }] : [] }]
      };
    };

    // ---------- Load JSON (inline or ./content.json) ----------
    const loadData = async () => {
      const node = document.getElementById('app-data');
      const txt = node?.textContent?.trim() || '';
      if (txt) {
        try { return detectAndNormalize(JSON.parse(txt)); }
        catch { /* fall through to fetch */ }
      }
      try {
        const res = await fetch('./content.json', { cache: 'no-store' });
        if (res.ok) {
          const j = await res.json();
          return detectAndNormalize(j);
        }
      } catch {}
      return null;
    };

    // ---------- Render ----------
    const proseClass = () => (THEMES[state.theme]?.isDark ? 'prose prose-lg max-w-none prose-invert' : 'prose prose-lg max-w-none');

    const renderThemePopover = () => {
      app.themeList.innerHTML = Object.entries(THEMES).map(([key, t]) => `
        <li>
          <button class="theme-option w-full text-left px-3 py-2 hover:opacity-80"
                  role="radio" aria-checked="${state.theme===key}" data-key="${key}">
            ${t.label}
          </button>
        </li>
      `).join('');
    };

    const renderMenu = () => {
      app.navList.innerHTML = state.data.units.map(u => `
        <button class="w-full text-left px-3 py-2 rounded hover:bg-[var(--nav-hover-bg)] ${state.activeId===u.id ? 'nav-item-active' : ''}"
                data-id="${u.id}">
          ${escapeHtml(u.display_name ?? u.name ?? u.id)}
        </button>
      `).join('');
    };

    const renderContent = (unitId) => {
      const u = state.data.units.find(x => x.id === unitId) || state.data.units[0];
      if (!u) return;

      state.activeId = u.id;
      saveState();

      // Update top title and drawer active highlight
      app.topTitle.textContent = state.data.meta.title || 'Folio';
      Array.from(app.navList.children).forEach(btn => {
        btn.classList.toggle('nav-item-active', btn.getAttribute('data-id') === u.id);
      });

      // Build HTML
      const intro = u.introduction ? `<p class="lead">${u.introduction}</p>` : '';
      const paras = (u.paragraphs || []).map(p => `
        ${p.heading ? `<h3>${escapeHtml(p.heading)}</h3>` : ''}
        ${p.content || ''}
      `).join('');
      app.content.className = proseClass();
      app.content.innerHTML = `
        <h2>${escapeHtml(u.name ?? u.display_name ?? u.id)}</h2>
        ${intro}
        ${paras}
      `;

      // Update hash for deep-linking
      history.replaceState(null, '', `#${encodeURIComponent(u.id)}`);
    };

    // ---------- Drawer / Popover controls ----------
    const openDrawer = () => {
      app.drawer.classList.add('open');
      app.backdrop.classList.remove('hidden');
    };
    const closeDrawer = () => {
      app.drawer.classList.remove('open');
      app.backdrop.classList.add('hidden');
    };
    const toggleThemePopover = () => {
      const open = app.themePopover.classList.contains('hidden');
      app.themePopover.classList.toggle('hidden', !open);
      app.themeBtn.setAttribute('aria-expanded', String(open));
    };
    const closeThemePopover = () => {
      app.themePopover.classList.add('hidden');
      app.themeBtn.setAttribute('aria-expanded', 'false');
    };

    // ---------- Events ----------
    const bindEvents = () => {
      app.menuBtn.addEventListener('click', openDrawer);
      app.closeDrawer.addEventListener('click', closeDrawer);
      app.backdrop.addEventListener('click', () => { closeDrawer(); closeThemePopover(); });

      app.navList.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-id]');
        if (!btn) return;
        renderContent(btn.dataset.id);
        closeDrawer();
      });

      app.themeBtn.addEventListener('click', () => {
        renderThemePopover();
        toggleThemePopover();
      });

      app.themeList.addEventListener('click', (e) => {
        const b = e.target.closest('.theme-option');
        if (!b) return;
        applyTheme(b.dataset.key);          // immediate apply
        renderContent(state.activeId);      // refresh prose invert if needed
        // keep popover open or close—choose close for faster UX
        closeThemePopover();
      });

      // Close popover on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeDrawer();
          closeThemePopover();
        }
      });

      // Support deep link on hash change
      window.addEventListener('hashchange', () => {
        const id = decodeURIComponent(location.hash.replace(/^#/, ''));
        if (id && state.data.units.some(u=>u.id===id)) renderContent(id);
      });
    };

    // ---------- Init ----------
    (async () => {
      loadState();
      applyTheme(state.theme);

      const normalized = await loadData();
      if (!normalized || !Array.isArray(normalized.units) || normalized.units.length === 0) {
        document.title = 'Folio — Error';
        app.content.innerHTML = `<div class="p-4 text-red-600 bg-red-50 rounded">
          <strong>Error:</strong> Could not load content. Ensure valid JSON in the data island or provide <code>content.json</code>.
        </div>`;
        return;
      }
      state.data = normalized;

      document.title = state.data.meta.title || 'Folio';
      app.topTitle.textContent = state.data.meta.title || 'Folio';

      bindEvents();
      renderThemePopover();
      renderMenu();

      // Start on hash, saved tab, or first
      const startId = decodeURIComponent(location.hash.replace(/^#/, '')) || state.activeId || state.data.units[0].id;
      renderContent(startId);
    })();
  });
  </script>
</body>
</html>
