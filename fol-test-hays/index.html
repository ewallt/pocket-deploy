<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Course Template</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Default Theme: Newspaper */
    :root {
      --bg-gradient: #fdfdf8;
      --text: #1c1c1c;
      --accent-text: #8c1c13;
      --nav-bg: #f1f1eb;
      --nav-border: #dcdcd3;
      --nav-text: #1c1c1c;
      --nav-hover-bg: #e5e5dd;
      --nav-active-bg: #dcdcd3;
      --nav-active-text: #1c1c1c;
      --prose-text: var(--text);
      --prose-headings: var(--accent-text);
      --prose-links: var(--accent-text);
      --prose-bold: var(--text);
      font-family: 'Merriweather', serif;
    }

    .theme-emerald-paper,
    .theme-cyber-blue,
    .theme-emerald-gold {
      font-family: 'Lato', sans-serif;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
    }

    .ui-bg { background-color: var(--nav-bg); }
    .ui-border { border-color: var(--nav-border); }
    .text-primary { color: var(--text); }
    .text-accent { color: var(--accent-text); }

    .tab-button {
      background-color: var(--nav-bg);
      color: var(--nav-text);
      border-bottom: 3px solid transparent;
    }
    .tab-button:hover,
    .tab-button:focus-visible {
      background-color: var(--nav-hover-bg);
    }
    .tab-button.tab-active {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-text);
      border-bottom-color: var(--accent-text);
    }

    .settings-button { background-color: var(--nav-hover-bg); }
    .settings-button:hover { opacity: 0.8; }
    *:focus-visible { outline: 3px solid var(--accent-text); outline-offset: 2px; }

    .prose { color: var(--prose-text); }
    .prose h2,
    .prose h3,
    .prose a,
    .prose strong { color: var(--prose-headings); }
    .prose p.lead { color: var(--prose-text); }

    /* Navy (Dark) overrides */
    .theme-cyber-blue .tab-button.tab-active {
      background-color: #1f2937; /* slate-800 */
      color: #e5e7eb;           /* slate-200 */
      border-bottom-color: #3b82f6; /* blue-500 */
      box-shadow: inset 0 -2px 0 0 #3b82f6;
    }
    .theme-cyber-blue .prose a {
      color: #60a5fa;              /* blue-400 */
      text-decoration-color: #60a5fa;
    }
    .theme-cyber-blue .prose a:hover {
      color: #93c5fd;              /* blue-300 */
      text-decoration-color: #93c5fd;
    }
  </style>

</head>
<body class="transition-colors duration-300">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <header id="app-header" class="ui-bg border ui-border rounded-lg shadow-lg p-6 mb-6"></header>
    <nav id="app-tabs" class="ui-bg border ui-border rounded-lg shadow-lg mb-6" role="tablist" aria-label="Main navigation"></nav>
    <main id="app-panels" class="ui-bg border ui-border rounded-lg shadow-lg p-6 md:p-8"></main>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="ui-bg border ui-border rounded-lg p-6 max-w-md w-full shadow-2xl">
        <h2 id="settings-title" class="text-xl font-bold text-accent mb-4">Display Settings</h2>
        <div class="space-y-4">
          <div>
            <label for="themeSelect" class="block text-primary font-semibold mb-2">Theme</label>
            <select id="themeSelect" class="w-full px-3 py-2 rounded ui-bg border ui-border text-primary"></select>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button id="closeSettings" class="px-4 py-2 rounded text-primary hover:opacity-80">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!--
  ============================================================
  vvvvvvvvvvvvvv PASTE YOUR JSON CONTENT BELOW vvvvvvvvvvvvvv
  ============================================================
  -->
  <script type="application/json" id="app-data">
{
  "meta": {
    "title": "Mark 1:1–3 — “Prepare the Way”: Hays on Figural Christology",
    "subtitle": "How Mark’s composite citation (Exod 23:20/Mal 3:1 + Isa 40:3) signals the LORD’s own advent in Jesus",
    "report_provenance": [
      { "label": "Compiled by", "detail": "Instructor v6.1 — Hays Session" },
      { "label": "Last updated", "detail": "2025-09-03" },
      { "label": "Primary sources", "detail": "Mark 1:1–3; Exod 23:20; Mal 3:1; Isa 40:3 (cf. Isa 40–55; Ps 2; Isa 42; Mark 1:10–11; 15:38)" },
      { "label": "Secondary sources", "detail": "Richard B. Hays, Reading Backwards (2014); Echoes of Scripture in the Gospels (2016)" }
    ]
  },
  "sections": [
    {
      "id": "overview",
      "title": "Overview",
      "intro": "Hays reads Mark’s prologue as a figural claim: the way prepared for YHWH in Isaiah is, in Mark’s story, the way for Jesus—so Jesus embodies Israel’s God returning to His people.",
      "bullets": [
        "Mark opens with a composite quotation labeled “in Isaiah,” foregrounding the Isaianic new-exodus horizon.",
        "Identity effect: the “way of the LORD” becomes the way for Jesus, aligning Him with YHWH via LXX kyrios.",
        "Early motifs (wilderness, Jordan, torn heavens) deepen the new-exodus/theophany frame."
      ],
      "items": [
        {
          "id": "o1",
          "label": "Composite as Overture",
          "summary": "Exod 23:20/Mal 3:1 + Isa 40:3 function as Mark’s theological prelude.",
          "detail": "By heading a composite as “in Isaiah,” Mark centers Isaiah’s promise of divine return while weaving in messenger language from Exodus/Malachi."
        },
        {
          "id": "o2",
          "label": "Figural Identification",
          "summary": "Jesus as the LORD’s arrival.",
          "detail": "If John prepares YHWH’s way (Isa 40), yet Jesus arrives after John, the narrative identifies Jesus with Israel’s God—without erasing the texts’ original sense."
        },
        {
          "id": "o3",
          "label": "New-Exodus Horizon",
          "summary": "Wilderness, water, and return from exile.",
          "detail": "Mark’s wilderness/Jordan setting and the “torn heavens” evoke Isaiah 40–55: God breaks in to restore His people."
        },
        {
          "id": "o4",
          "label": "Narrated Christology",
          "summary": "Story + Scripture disclose identity.",
          "detail": "Mark shows who Jesus is by scripting Him into Israel’s Scriptures rather than by abstract titles alone."
        }
      ]
    },
    {
      "id": "concepts",
      "title": "Core Concepts",
      "intro": "Key terms in Hays’s reading of Mark 1:1–3 and its scriptural horizon.",
      "bullets": [
        "Figural reading sees fuller patterns recognized retrospectively after Jesus’ death and resurrection.",
        "Metalepsis: an echo that summons its wider OT context.",
        "Narrative Christology: identity is shown by the story’s scriptural patterning."
      ],
      "items": [
        {
          "id": "c1",
          "label": "Figural Reading",
          "summary": "Later events disclose prefiguring patterns.",
          "detail": "Not free allegory; the OT sense stands, yet is seen anew in light of Christ’s paschal event."
        },
        {
          "id": "c2",
          "label": "Metalepsis",
          "summary": "Echo that pulls in its broader context.",
          "detail": "Quoting Isa 40:3 invokes the new-exodus chapters (Isa 40–55), shaping how we read Mark’s opening scenes."
        },
        {
          "id": "c3",
          "label": "Composite Citation",
          "summary": "Multiple texts as one witness.",
          "detail": "Mark conflates Exod 23:20/Mal 3:1 with Isa 40:3 to craft a single overture about God’s coming."
        },
        {
          "id": "c4",
          "label": "New Exodus",
          "summary": "Promise of divine return and renewal.",
          "detail": "Isaiah anticipates God Himself leading His people from exile; Mark frames Jesus within this hope."
        },
        {
          "id": "c5",
          "label": "Kyrios (Lord)",
          "summary": "LXX rendering of the divine name.",
          "detail": "The Greek kyrios often translates YHWH, easing the Markan identification effect when applied to Jesus."
        },
        {
          "id": "c6",
          "label": "Narrative Christology",
          "summary": "Identity shown in plot and pattern.",
          "detail": "Mark’s Christology emerges from narrative/scriptural choreography more than from formal creedal ascriptions."
        },
        {
          "id": "c7",
          "label": "Schizō — “Torn”",
          "summary": "Heavens/veil rent open.",
          "detail": "Mark 1:10 and 15:38 bookend access to God’s presence, echoing Isa 64:1."
        }
      ]
    },
    {
      "id": "data",
      "title": "Evidence / Data",
      "intro": "Textual signals that support a figural, high-Christology reading in Mark’s prologue.",
      "bullets": [
        "Identity transfer: YHWH’s “way” → Jesus’ way.",
        "LXX semantics: kyrios as YHWH’s title in Greek.",
        "Motif recurrence: wilderness, Jordan, torn heavens, divine voice."
      ],
      "items": [
        {
          "id": "d1",
          "label": "Identity Transfer",
          "summary": "From YHWH’s path to Jesus’ arrival.",
          "detail": "Mark 1:2–3 assigns Isaiah’s highway for the LORD to the one who comes after John—Jesus."
        },
        {
          "id": "d2",
          "label": "LXX Kyrios",
          "summary": "Title that bridges OT to NT usage.",
          "detail": "Kyrios commonly renders the Tetragrammaton; Mark’s “Lord” language can carry divine connotations when applied to Jesus."
        },
        {
          "id": "d3",
          "label": "Motif Recurrence",
          "summary": "Wilderness/Jordan + torn heavens.",
          "detail": "The setting and theophany (1:10–11) align with Isaianic hopes of God’s return and Spirit-anointed Servant."
        },
        {
          "id": "d4",
          "label": "Bookend Tearing",
          "summary": "Heavens (1:10) ↔ veil (15:38).",
          "detail": "Schizō links opening and climax, suggesting renewed access/presence consistent with divine advent."
        },
        {
          "id": "d5",
          "label": "Servant-King Convergence",
          "summary": "Ps 2 + Isa 42 at baptism.",
          "detail": "The heavenly voice blends royal sonship and servant vocation, reinforcing the Isaianic frame."
        }
      ]
    },
    {
      "id": "timeline",
      "title": "Timeline",
      "intro": "From the Greek Scriptures to Mark’s composition and modern articulation.",
      "bullets": [
        "LXX era establishes kyrios = YHWH convention.",
        "Mark’s Gospel opens with Isaianic overture.",
        "Modern scholarship articulates figural logic."
      ],
      "items": [
        { "id": "t1", "label": "3rd–1st c. BCE — Septuagint", "detail": "Greek OT normalizes kyrios for the divine name, shaping NT diction." },
        { "id": "t2", "label": "c. 60–70 CE — Mark Composed", "detail": "Gospel begins with Exod/Mal + Isa composite (1:2–3) as theological overture." },
        { "id": "t3", "label": "Mark 1:10–11 — Baptism Theophany", "detail": "Heavens torn; voice identifies the Son; Spirit descends—new-exodus tones." },
        { "id": "t4", "label": "Mark 15:38 — Veil Torn", "detail": "Temple curtain rips, echoing 1:10 and Isa 64:1; access theme climaxes." },
        { "id": "t5", "label": "2014 — Reading Backwards", "detail": "Hays articulates figural Christology across the Gospels." },
        { "id": "t6", "label": "2016 — Echoes of Scripture in the Gospels", "detail": "Expanded case studies of OT resonances shaping Gospel portraits." }
      ]
    },
    {
      "id": "critiques",
      "title": "Critiques & Debates",
      "intro": "Where readers push back and how Hays’s approach is assessed.",
      "bullets": [
        "Risk of over-reading echoes without controls.",
        "Historical-critical concerns about early Christology.",
        "Source-critical questions about the composite heading."
      ],
      "items": [
        {
          "id": "k1",
          "label": "Over-Reading?",
          "summary": "Echo vs. eisegesis.",
          "detail": "Subtle allusions can be subjective; Hays answers with criteria (availability, volume, recurrence, thematic coherence, satisfaction)."
        },
        {
          "id": "k2",
          "label": "Christology Controls",
          "summary": "Agent vs. identity.",
          "detail": "Some read the “way” as for God’s agent; Hays argues the Isaianic frame and Mark’s motifs press toward divine identity."
        },
        {
          "id": "k3",
          "label": "“In Isaiah” Problem",
          "summary": "Composite under one prophet.",
          "detail": "Mark’s ascription raises source questions; literarily it spotlights Isaiah’s horizon as the governing lens."
        }
      ]
    }
  ],
  "glossary": [
    { "term": "Figural Reading", "definition": "A retrospective, canonical way of seeing earlier texts prefigure later events in Christ without canceling their original sense." },
    { "term": "Metalepsis", "definition": "An echo that invokes the broader context of its source text, shaping interpretation beyond the quoted line." },
    { "term": "Composite Citation", "definition": "A merged quotation of multiple OT passages treated as a single scriptural witness." },
    { "term": "New Exodus", "definition": "Isaiah’s promise that God Himself would return to restore His people, guiding a second, greater deliverance." },
    { "term": "Kyrios", "definition": "Greek ‘Lord’; the Septuagint’s common rendering of YHWH, often bearing divine connotations in the NT." },
    { "term": "Narrative Christology", "definition": "Understanding who Jesus is through the Gospel’s plot, symbols, and scriptural patterning." },
    { "term": "Schizō", "definition": "Greek for “to tear”; used in Mark 1:10 and 15:38 to frame divine access." },
    { "term": "Theophany", "definition": "A manifestation of God’s presence, often marked by voice, Spirit, or cosmic signs." }
  ],
  "quotes": [
    { "text": "Prepare the way of the LORD; make straight in the desert a highway for our God.", "ref": "Isaiah 40:3" },
    { "text": "Behold, I send my messenger before your face, who will prepare your way.", "ref": "Exodus 23:20; Malachi 3:1 (as used in Mark 1:2)" },
    { "text": "He saw the heavens being torn open and the Spirit descending on him like a dove.", "ref": "Mark 1:10" },
    { "text": "And the curtain of the temple was torn in two, from top to bottom.", "ref": "Mark 15:38" }
  ]
}


  </script>
  <!--
  ============================================================
  ^^^^^^^^^^^^^^ PASTE YOUR JSON CONTENT ABOVE ^^^^^^^^^^^^^^
  ============================================================
  -->

<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const THEMES = {
    'newspaper': {
      name: 'Newspaper',
      type: 'classic',
      isDark: false
    },
    'emerald-paper': {
      name: 'Emerald Paper',
      type: 'variable',
      isDark: false,
      vars: {
        '--bg-gradient': '#f7fbf9',
        '--text': '#1e2b28',
        '--accent-text': '#0f7f6d',
        '--nav-bg': '#e7f3ef',
        '--nav-border': '#86c8ba',
        '--nav-text': '#1e2b28',
        '--nav-hover-bg': '#d7ece6',
        '--nav-active-bg': '#bfe3d9',
        '--nav-active-text': '#1e2b28',
        '--prose-text': '#1e2b28',
        '--prose-headings': '#0f7f6d'
      }
    },
    'cyber-blue': {
      name: 'Navy (Dark)',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#0a0a23 0%, #141433 50%, #0f172a 100%)',
        '--text': '#e5e7eb',
        '--accent-text': '#cbd5e1',
        '--nav-bg': '#0f172a',
        '--nav-border': '#1f2937',
        '--nav-text': '#e5e7eb',
        '--nav-hover-bg': '#111827',
        '--nav-active-bg': '#1f2937',
        '--nav-active-text': '#e5e7eb',
        '--prose-text': '#e5e7eb',
        '--prose-headings': '#cbd5e1'
      }
    },
    'emerald-gold': {
      name: 'Emerald/Gold',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#022c22 0%,#064e3b 60%,#065f46 100%)',
        '--text': '#ecfdf5',
        '--accent-text': '#f0c475',
        '--nav-bg': '#064e3b',
        '--nav-border': '#d4a24c',
        '--nav-text': '#ecfdf5',
        '--nav-hover-bg': '#065f46',
        '--nav-active-bg': '#0b3d31',
        '--nav-active-text': '#f0c475',
        '--prose-text': '#a7f3d0',
        '--prose-headings': '#f0c475'
      }
    }
  };

  const app = {
    root: document.documentElement,
    header: document.getElementById('app-header'),
    tabs: document.getElementById('app-tabs'),
    panels: document.getElementById('app-panels'),
    settings: {
      modal: document.getElementById('settingsModal'),
      closeBtn: document.getElementById('closeSettings'),
      themeSelect: document.getElementById('themeSelect')
    }
  };

  /* ---------- State (now with per-project storage prefix) ---------- */
  const state = { activeTab: null, theme: 'newspaper', storagePrefix: 'cr_' };

  const loadState = () => {
    state.theme = localStorage.getItem(state.storagePrefix + 'theme') || 'newspaper';
    state.activeTab = localStorage.getItem(state.storagePrefix + 'tab');
  };

  const saveState = () => {
    localStorage.setItem(state.storagePrefix + 'theme', state.theme);
    localStorage.setItem(state.storagePrefix + 'tab', state.activeTab);
  };

  /* ------------------- Theme helpers ------------------- */
  const applyTheme = (themeKey) => {
    const theme = THEMES[themeKey];
    if (!theme) return;

    app.root.className = '';
    app.root.style.cssText = '';

    if (theme.type === 'variable' && theme.vars) {
      for (const [key, value] of Object.entries(theme.vars)) {
        app.root.style.setProperty(key, value);
      }
      app.root.classList.add(`theme-${themeKey}`);
    }

    state.theme = themeKey;
    if (app.settings.themeSelect.value !== themeKey) {
      app.settings.themeSelect.value = themeKey;
    }
    saveState();
  };

  const populateThemeSelector = () => {
    app.settings.themeSelect.innerHTML = Object.entries(THEMES)
      .map(([key, theme]) => `<option value="${key}">${theme.name}</option>`)
      .join('');
  };

  /* ----------------- NEW: flexible loader -----------------
     Accepts either:
     A) CR shape: { title, description, categories:{...} }
     B) Sections shape: { meta:{title,subtitle}, sections:[{id,title,intro,bullets,items}] }
     Also supports a map of apps: { "appKey": {...} } (uses the first)
  --------------------------------------------------------- */

  const slugify = (s) => (s||'app').toString().toLowerCase()
    .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  function sectionAppToCR(root) {
    const title = root.meta?.title || 'Untitled';
    const description = root.meta?.subtitle || '';
    const categories = {};
    (root.sections || []).forEach((s, idx) => {
      const slug = s.id || ('section-' + (idx + 1));
      const paragraphs = [];
      if (Array.isArray(s.bullets) && s.bullets.length) {
        const lis = s.bullets.map(b => `<li>${b}</li>`).join('');
        paragraphs.push({ heading: 'Key points', content: `<ul>${lis}</ul>` });
      }
      (s.items || []).forEach(it => {
        const heading = it.label || it.summary || '';
        const detail = (it.summary ? `<em>${it.summary}</em> ` : '') + (it.detail || '');
        paragraphs.push({ heading, content: detail });
      });
      categories[slug] = {
        display_order: s.display_order ?? (idx + 1),
        name: s.title || slug,
        display_name: s.title || slug,
        introduction: s.intro || '',
        paragraphs
      };
    });
    return { title, description, categories };
  }

  function normalizeFlexible(raw) {
    // Single-app CR
    if (raw && typeof raw === 'object' && raw.categories) return raw;
    // Single-app sections
    if (raw && typeof raw === 'object' && (Array.isArray(raw.sections) || raw.meta)) {
      return sectionAppToCR(raw);
    }
    // Map of apps -> first
    const keys = raw ? Object.keys(raw) : [];
    if (!keys.length) throw new Error('Empty content.');
    const first = raw[keys[0]];
    if (first?.categories) return first;
    if (first && (Array.isArray(first.sections) || first.meta)) return sectionAppToCR(first);
    throw new Error('Unsupported content shape. Expected {categories} or {sections}.');
  }

  /* ----------------- Load & transform data ----------------- */
  const loadAndTransformData = () => {
    try {
      // Prefer data island; fallback to globals if present
      const dataNode = document.getElementById('app-data');
      let rawData = null;
      if (dataNode && dataNode.textContent.trim()) {
        rawData = JSON.parse(dataNode.textContent);
      } else if (window.__CR_APP__ || window.__CONTENT__) {
        rawData = window.__CR_APP__ || window.__CONTENT__;
      } else {
        throw new Error('JSON data is empty.');
      }

      // Normalize to CR app
      const appObj = normalizeFlexible(rawData);

      // Units from categories
      const units = Object.entries(appObj.categories || {})
        .map(([id, unitData]) => ({ id, ...unitData }))
        .sort((a, b) => (a.display_order ?? 999) - (b.display_order ?? 999));

      // Derive per-project storage prefix
      const prefix = 'cr_' + slugify(appObj.title || Object.keys(rawData||{})[0] || 'app') + '_';

      return { meta: { title: appObj.title, description: appObj.description }, units, storagePrefix: prefix };
    } catch (e) {
      console.error('Failed to load or transform app data:', e);
      app.panels.innerHTML =
        `<div class="p-4 text-red-500 bg-red-100 rounded"><strong>Error:</strong> Could not load content. Ensure the JSON is valid and present in the data island (or window.__CR_APP__/__CONTENT__).</div>`;
      return null;
    }
  };

  const data = loadAndTransformData();
  if (!data) return;
  state.storagePrefix = data.storagePrefix || state.storagePrefix;

  /* ----------------- Renderers ----------------- */
  const renderHeader = () => {
    document.title = data.meta.title || 'Interactive Course';
    app.header.innerHTML = `
      <div class="flex justify-between items-start gap-4">
        <div>
          <h1 class="text-3xl font-bold text-accent">${data.meta.title}</h1>
          <p class="mt-2 text-primary/80">${data.meta.description || ''}</p>
        </div>
        <button id="settingsBtn" class="flex-shrink-0 p-3 rounded-lg settings-button transition-opacity" aria-label="Display Settings">
          <span class="text-2xl text-accent">⚙️</span>
        </button>
      </div>`;
  };

  const renderTabs = () => {
    app.tabs.innerHTML = `<div class="flex flex-wrap">${
      data.units.map(unit => `
        <button role="tab" aria-selected="false" aria-controls="${unit.id}-panel" id="${unit.id}-tab"
                class="px-5 py-3 font-semibold transition-colors tab-button">
          ${unit.display_name || unit.name || unit.id}
        </button>`
      ).join('')
    }</div>`;
  };

  const renderPanels = () => {
    app.panels.innerHTML = data.units.map(unit => {
      const introHTML = unit.introduction ? `<p class="lead">${unit.introduction}</p>` : '';
      const paragraphsHTML = (unit.paragraphs || []).map(p => `
        ${p.heading ? `<h3>${p.heading}</h3>` : ''}
        ${p.content ? `<p>${p.content}</p>` : ''}
      `).join('');
      const proseClasses = THEMES[state.theme].isDark ? 'prose prose-lg max-w-none prose-invert' : 'prose prose-lg max-w-none';
      return `
        <div role="tabpanel" id="${unit.id}-panel" aria-labelledby="${unit.id}-tab" hidden>
          <div class="${proseClasses}">
            <h2>${unit.display_name || unit.name || unit.id}</h2>
            ${introHTML}
            ${paragraphsHTML}
          </div>
        </div>`;
    }).join('');
  };

  /* ----------------- Tab & UI logic ----------------- */
  const switchTab = (tabId) => {
    if (!data.units.some(u => u.id === tabId)) {
      tabId = data.units[0]?.id;
    }
    if (!tabId) return;

    app.tabs.querySelectorAll('[role="tab"]').forEach(tab => {
      const isActive = tab.id === `${tabId}-tab`;
      tab.setAttribute('aria-selected', isActive);
      tab.classList.toggle('tab-active', isActive);
    });

    app.panels.querySelectorAll('[role="tabpanel"]').forEach(panel => {
      panel.hidden = panel.id !== `${tabId}-panel`;
    });

    state.activeTab = tabId;
    saveState();
  };

  const setupEventListeners = () => {
    app.tabs.addEventListener('click', e => {
      const tab = e.target.closest('[role="tab"]');
      if (tab) switchTab(tab.id.replace('-tab', ''));
    });

    app.header.addEventListener('click', e => {
      if (e.target.closest('#settingsBtn')) {
        app.settings.modal.classList.remove('hidden');
        app.settings.themeSelect.focus();
      }
    });

    const closeModal = () => {
      app.settings.modal.classList.add('hidden');
      document.getElementById('settingsBtn')?.focus();
    };
    app.settings.closeBtn.addEventListener('click', closeModal);
    app.settings.modal.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    app.settings.themeSelect.addEventListener('change', (e) => {
      applyTheme(e.target.value);
      renderPanels();
      const activePanel = document.getElementById(`${state.activeTab}-panel`);
      if (activePanel) activePanel.hidden = false;
    });
  };

  /* ----------------- Init ----------------- */
  const init = () => {
    loadState();
    populateThemeSelector();
    applyTheme(state.theme);
    renderHeader();
    renderTabs();
    renderPanels();
    setupEventListeners();
    switchTab(state.activeTab || data.units[0]?.id);
  };

  init();
});
</script>
</body>
</html>

