<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Course Template</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

<style>
  /* Default Theme: Newspaper */
  :root {
    --bg-gradient: #fdfdf8;
    --text: #1c1c1c;
    --accent-text: #8c1c13;
    --nav-bg: #f1f1eb;
    --nav-border: #dcdcd3;
    --nav-text: #1c1c1c;
    --nav-hover-bg: #e5e5dd;
    --nav-active-bg: #dcdcd3;
    --nav-active-text: #1c1c1c;
    --prose-text: var(--text);
    --prose-headings: var(--accent-text);
    --prose-links: var(--accent-text);
    --prose-bold: var(--text);
    font-family: 'Merriweather', serif;
  }

  .theme-emerald-paper,
  .theme-cyber-blue,
  .theme-emerald-gold {
    font-family: 'Lato', sans-serif;
  }

  body {
    background: var(--bg-gradient);
    color: var(--text);
    min-height: 100vh;
  }

  .ui-bg { background-color: var(--nav-bg); }
  .ui-border { border-color: var(--nav-border); }
  .text-primary { color: var(--text); }
  .text-accent { color: var(--accent-text); }

  .tab-button {
    background-color: var(--nav-bg);
    color: var(--nav-text);
    border-bottom: 3px solid transparent;
  }
  .tab-button:hover,
  .tab-button:focus-visible {
    background-color: var(--nav-hover-bg);
  }
  .tab-button.tab-active {
    background-color: var(--nav-active-bg);
    color: var(--nav-active-text);
    border-bottom-color: var(--accent-text);
  }

  .settings-button { background-color: var(--nav-hover-bg); }
  .settings-button:hover { opacity: 0.8; }
  *:focus-visible { outline: 3px solid var(--accent-text); outline-offset: 2px; }

  .prose { color: var(--prose-text); }
  .prose h2,
  .prose h3,
  .prose a,
  .prose strong { color: var(--prose-headings); }
  .prose p.lead { color: var(--prose-text); }

  /* Navy (Dark) overrides */
  .theme-cyber-blue .tab-button.tab-active {
    background-color: #1f2937; /* slate-800 */
    color: #e5e7eb;           /* slate-200 */
    border-bottom-color: #3b82f6; /* blue-500 */
    box-shadow: inset 0 -2px 0 0 #3b82f6;
  }
  .theme-cyber-blue .prose a {
    color: #60a5fa;              /* blue-400 */
    text-decoration-color: #60a5fa;
  }
  .theme-cyber-blue .prose a:hover {
    color: #93c5fd;              /* blue-300 */
    text-decoration-color: #93c5fd;
  }
</style>

</head>
<body class="transition-colors duration-300">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <header id="app-header" class="ui-bg border ui-border rounded-lg shadow-lg p-6 mb-6"></header>
        <nav id="app-tabs" class="ui-bg border ui-border rounded-lg shadow-lg mb-6" role="tablist" aria-label="Main navigation"></nav>
        <main id="app-panels" class="ui-bg border ui-border rounded-lg shadow-lg p-6 md:p-8"></main>
        
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settings-title">
            <div class="ui-bg border ui-border rounded-lg p-6 max-w-md w-full shadow-2xl">
                <h2 id="settings-title" class="text-xl font-bold text-accent mb-4">Display Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="themeSelect" class="block text-primary font-semibold mb-2">Theme</label>
                        <select id="themeSelect" class="w-full px-3 py-2 rounded ui-bg border ui-border text-primary">
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="closeSettings" class="px-4 py-2 rounded text-primary hover:opacity-80">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 
    ============================================================
    vvvvvvvvvvvvvv PASTE YOUR JSON CONTENT BELOW vvvvvvvvvvvvvv
    ============================================================
    -->
    <script type="application/json" id="app-data">
{
  "ntw-foundations-jesus": {
    "title": "NT Wright — Foundations & Jesus",
    "description": "A 6-unit overview of Wright’s method, Israel’s story, and Jesus’s kingdom mission.",
    "categories": {
      "unit-1-method-history-scripture": {
        "display_order": 10,
        "name": "Unit 1: Method — History, Story, Scripture",
        "display_name": "Unit 1",
        "paragraphs": [
          {
            "heading": "Critical realism",
            "content": "Wright’s preferred stance is a chastened confidence that the world God made is real and knowable, while our access to it is mediated through perspectives, stories, and communities. We do not possess a God’s-eye view, yet we can arrive at truthful, public knowledge by testing hypotheses against evidence and by letting the texts push back on our assumptions. This approach avoids both naive positivism and cynical relativism, freeing us to take history seriously without pretending to have certainty we do not have."
          },
          {
            "heading": "History and theology belong together",
            "content": "Christian claims are anchored in first-century events—what God has done in and through Israel’s Messiah—so responsible theology must be historically responsible. When we detach meaning from the world of Jesus and the apostles, we risk turning the gospel into timeless advice or private spirituality. Reading the New Testament historically allows doctrine to be shaped by the story God actually told, rather than by later abstractions alone."
          },
          {
            "heading": "Story as worldview",
            "content": "Scripture communicates primarily by means of a sweeping narrative that runs from creation and covenant to Messiah, Spirit, and new creation. Within that story, doctrines function like signposts: they summarize and direct but do not replace the road itself. The church’s task is to indwell the narrative so deeply that we can improvise faithful, context-aware responses that remain recognizably part of the same drama."
          },
          {
            "heading": "The authority of Scripture",
            "content": "For Wright, biblical authority is best understood as God’s authority exercised through Scripture to equip the church for its vocation. Authority, then, is not merely about proving propositions but about the Spirit using the text to form a people whose life enacts the kingdom. The canon’s diverse voices cohere around God’s saving purposes, and the church listens in community, worship, and mission."
          },
          {
            "heading": "Exegesis first, then theology",
            "content": "Sound theology grows from sustained attention to what the authors actually wrote in their historical and literary contexts. That means grammar, genre, intertextual echoes, and Second-Temple background come before later systematic synthesis. Exegesis and theology are partners, but exegesis leads the dance so that our conclusions stay tethered to the scriptural story."
          },
          {
            "heading": "Jesus within Judaism",
            "content": "The Gospels only make sense when Jesus is placed inside the world of Israel’s Scriptures, hopes, and conflicts. He is not a generic moral teacher or a wandering philosopher; he is Israel’s king bringing Israel’s story to its long-awaited climax. Seeing him this way clarifies his actions, his clashes with authorities, and his message of God’s kingdom arriving in surprising form."
          },
          {
            "heading": "Public truth of the gospel",
            "content": "If Jesus is Lord, that is a claim about the world, not merely about private experience. The gospel exposes the idols that shape cultures and invites all people to a new allegiance that reorders personal, social, and political life. The church therefore bears public witness—not by grasping for power but by modeling a different kind of power: cruciform love."
          },
          {
            "heading": "Aim: wisdom for the church",
            "content": "Method is not an end in itself; it serves the formation of a people who can think, pray, and act faithfully in their time. The Spirit uses historically rooted reading to produce practical wisdom—habits of mind and life that reflect the character of the crucified and risen Lord. The outcome is not merely correct ideas but a community embodying the story it proclaims."
          }
        ]
      },
      "unit-2-israel-second-temple": {
        "display_order": 20,
        "name": "Unit 2: Israel’s Story & Second-Temple Context",
        "display_name": "Unit 2",
        "paragraphs": [
          {
            "heading": "Still-exile motif",
            "content": "Many Jews of the Second-Temple period believed that, despite returning from Babylon, they remained in a deeper exile under pagan domination. The prophetic promises of forgiveness and restoration seemed unfulfilled, with sin and foreign rule still present. This sense of unfinished story fueled hopes that God would return to Zion, defeat Israel’s enemies, and renew the covenant."
          },
          {
            "heading": "Return of YHWH to the temple",
            "content": "Israel longed not simply for a repaired building but for the personal return of Israel’s God to dwell among his people. Prophets envisioned a day when sins would be forgiven, hearts renewed, and glory restored. In the Gospels, Wright argues, Jesus enacts that promise in person: what Israel expected YHWH to do for the temple, Jesus does around himself."
          },
          {
            "heading": "Messiah expectations",
            "content": "Messianic hopes were diverse—royal, priestly, prophetic, or some combination—but they shared the conviction that God would set the world right through his anointed representative. The Messiah would gather the scattered people, establish justice, and reveal Israel’s God as king. Jesus both fulfills and radically reframes these expectations through his suffering vocation and servant kingship."
          },
          {
            "heading": "Apocalyptic imagination",
            "content": "Apocalyptic language used cosmic imagery to describe God’s decisive interventions within history, not escape from it. Sun, moon, and stars falling signaled the collapse of regimes and the birth of a new order under God’s rule. This symbolic grammar saturated Jewish expectation and shapes Jesus’s own proclamations about the kingdom’s arrival."
          },
          {
            "heading": "Identity markers",
            "content": "Torah observance, temple worship, land, and strict monotheism functioned as boundary markers distinguishing Jews from the nations. These were not mere badges but expressions of covenant loyalty and hope. Debates about how to display this loyalty framed the controversies into which Jesus and, later, Paul stepped."
          },
          {
            "heading": "Rome and the options",
            "content": "Under Roman pressure, Jewish responses ranged from collaboration and accommodation to zealot revolution and Essene withdrawal. Each strategy sought to protect Israel’s identity and future, yet each risked distorting Israel’s vocation. Jesus offered a different path that neither blessed idolatrous power nor mirrored its violence."
          },
          {
            "heading": "Prophetic vocation of Israel",
            "content": "From Abraham onward, Israel’s call was to be a light to the nations, embodying the Creator’s purposes for the world. The question haunting the Second-Temple era was how God would bring that vocation to its intended climax. The Gospel answer is that Israel’s destiny comes to fulfillment in and through the Messiah."
          },
          {
            "heading": "Covenantal monotheism",
            "content": "Israel’s confession that the one God would act faithfully to his covenant framed every expectation. God’s oneness meant not isolation but the promise to fill the world with his life-giving rule. In Wright’s reading, the New Testament proclaims that this faithful action has arrived in Jesus and the Spirit."
          }
        ]
      },
      "unit-3-kingdom-mission-jesus": {
        "display_order": 30,
        "name": "Unit 3: Kingdom and Mission of Jesus",
        "display_name": "Unit 3",
        "paragraphs": [
          {
            "heading": "Announcement of God’s reign",
            "content": "Jesus begins by heralding the good news that Israel’s God is becoming king. This is not a vague spiritual experience but a concrete claim about the world’s true ruler arriving in and through Jesus’s ministry. The announcement invites allegiance, confronts rival powers, and redefines what power itself looks like."
          },
          {
            "heading": "Parables as reframing",
            "content": "The parables function as narrative puzzles that reorder expectations about God’s kingdom. Instead of a violent overthrow, the kingdom comes like seed, yeast, and welcome for the lost. Those with ears to hear are drawn into a story where grace, patience, and costly mercy reveal the nature of God’s rule."
          },
          {
            "heading": "Healings and exorcisms",
            "content": "Jesus’s deeds are not mere proofs of divinity; they are enactments of the kingdom. Healings restore bodies and reintegrate the ostracized, while exorcisms announce the defeat of dark powers. The works interpret the words, showing that God’s long-promised liberation is happening in the present."
          },
          {
            "heading": "Table fellowship and forgiveness",
            "content": "By eating with sinners, Jesus embodies God’s covenant mercy and declares a jubilee for those written off by respectable religion. The meals are both a scandal and a sign that the messianic banquet has begun. In him, forgiveness and restored communion replace exclusion as the true marker of holiness."
          },
          {
            "heading": "Choosing the Twelve",
            "content": "Calling twelve disciples signals the regathering of Israel around Jesus himself. He becomes the new locus of identity, instruction, and mission, forming a people who learn his way. This symbolic act proclaims that God is renewing his covenant people for the sake of the world."
          },
          {
            "heading": "Temple action and sign",
            "content": "Jesus’s dramatic action in the temple is a prophetic sign of judgment on a corrupt system and of a new center for God’s presence. He offers the reality to which temple pointed—divine forgiveness and fellowship—now focused in his life, death, and resurrection. The true meeting place of God and humanity is shifting to the Messiah."
          },
          {
            "heading": "Vocation through suffering",
            "content": "Confronted with zealot violence on one side and quietist retreat on the other, Jesus refuses both paths. He embodies Israel’s calling through nonviolent, self-giving love that absorbs hostility and offers reconciliation. The kingdom advances not by the sword but by the cross-shaped vocation of the king."
          },
          {
            "heading": "Call to discipleship",
            "content": "To follow Jesus is to take up the cross and learn the practices of enemy-love, forgiveness, and courageous truth-telling. Discipleship reorders loyalties and identities around the king who serves. The community that forms around him becomes the living parable of God’s reign."
          }
        ]
      },
      "unit-4-cross-victory-vocation": {
        "display_order": 40,
        "name": "Unit 4: The Cross — Victory & Vocation",
        "display_name": "Unit 4",
        "paragraphs": [
          {
            "heading": "The problem the cross addresses",
            "content": "Human sin is not only guilt but enslaving power that fractures God’s image and corrupts communities and creation. The cross confronts both aspects at once: the Creator’s covenant love deals with our failures and breaks the dominion of idols. In Jesus, judgment and mercy meet to heal the world at its deepest wound."
          },
          {
            "heading": "Representative Israel",
            "content": "Jesus gathers up Israel’s vocation to be the servant through whom the nations are blessed. As faithful Israel in person, he bears the story to its climax, doing for Israel and the world what neither could do alone. His obedience becomes the doorway through which covenant promises flow outward."
          },
          {
            "heading": "Passover and new exodus",
            "content": "The crucifixion occurs in a Passover frame: God liberates his people from the deeper Pharaohs of sin and death. The lamb’s deliverance becomes universal as Jesus leads a new exodus into forgiven, Spirit-filled life. The church is constituted as the pilgrim people who carry this liberation into the world."
          },
          {
            "heading": "Victory over the powers",
            "content": "At the cross the false authorities—spiritual and political—are unmasked as violent impostors. Their apparent triumph reveals their bankruptcy, while the self-giving king claims his throne. The resurrection will ratify that the decisive battle has been won and a new reign inaugurated."
          },
          {
            "heading": "Substitution inside the story",
            "content": "Wright places substitution within the larger covenant narrative: the representative king bears sin so that his people may be set right and set to work. The goal is not merely acquittal but restoration to vocation—image-bearing service in God’s world. Justification and transformation belong together in the Messiah."
          },
          {
            "heading": "Covenant justice revealed",
            "content": "The cross displays God’s righteousness as faithful love that puts the world right. Divine justice is not retribution alone but restorative faithfulness that keeps promises even at infinite cost. Here we learn what God’s power and holiness actually look like."
          },
          {
            "heading": "New forgiven family",
            "content": "Forgiveness in the Messiah creates a single, barrier-breaking family in which old markers no longer divide. The church becomes the sign that the powers have lost their grip, because enemies eat at one table. Reconciliation is not an optional extra; it is the form the victory takes in community."
          },
          {
            "heading": "Cross-shaped discipleship",
            "content": "Those who confess the crucified king are called to embody his pattern of life. Enemy-love, generous forgiveness, truthful speech, and patient suffering become the ordinary means of kingdom advance. The church’s credibility rests on this cruciform shape."
          }
        ]
      },
      "unit-5-resurrection-new-creation": {
        "display_order": 50,
        "name": "Unit 5: Resurrection & New Creation",
        "display_name": "Unit 5",
        "paragraphs": [
          {
            "heading": "Bodily, historical resurrection",
            "content": "Easter is not a spiritual metaphor or the disciples’ wishful thinking; it is God’s act of new creation within the old. The emptied tomb and transformed appearances signal that death’s rule has been broken in principle. The church proclaims a Lord who truly lives and reigns in God’s renewed world."
          },
          {
            "heading": "Vindication and enthronement",
            "content": "Resurrection publicly vindicates Jesus’s mission and identifies him as Israel’s Messiah and the world’s true ruler. The ascension expresses his present, sovereign lordship, not absence but active reign. From this position he pours out the Spirit and directs the mission of his people."
          },
          {
            "heading": "Firstfruits of what is coming",
            "content": "Jesus’s resurrection is the beginning of the general resurrection promised by the prophets. The future has arrived early, guaranteeing that what started with him will be completed for his people and, ultimately, for creation itself. Hope is therefore concrete and resilient, anchored in a past victory with future scope."
          },
          {
            "heading": "Hope reimagined",
            "content": "Christian hope is not evacuation to a disembodied heaven but the renewal of heaven and earth. Bodies, communities, and cultures are destined for transformation under the Messiah’s rule. This reorients piety toward patient, embodied faithfulness rather than escapism."
          },
          {
            "heading": "Ethics of resurrection",
            "content": "Because the future is already underway, the church’s labor is never in vain. Acts of justice, beauty, evangelism, and mercy are seeds of the coming world, not distractions from it. Resurrection hope empowers perseverance and creativity in the face of suffering."
          },
          {
            "heading": "Creation affirmed",
            "content": "Easter dignifies the material world and affirms the goodness of creaturely life. Bodies matter, land matters, work matters; salvation is as wide as creation’s wounds. Christian mission therefore engages culture with patient craftsmanship and public generosity."
          },
          {
            "heading": "Worship and witness",
            "content": "The risen Lord is confessed in worship that celebrates God’s victory and trains desire toward his kingdom. Liturgy and life belong together: the table nourishes the people who carry the news of the king into streets and workplaces. Joy becomes a hallmark of communities that believe death is defeated."
          },
          {
            "heading": "Suffering in hope",
            "content": "Resurrection does not cancel suffering; it reframes it within a story that ends in glory. The Spirit sustains endurance, intercedes in weakness, and conforms us to the Messiah even through trials. Hope keeps love working when outcomes are unclear."
          }
        ]
      },
      "unit-6-spirit-people-god": {
        "display_order": 60,
        "name": "Unit 6: Spirit & the People of God (Acts)",
        "display_name": "Unit 6",
        "paragraphs": [
          {
            "heading": "Pentecost as covenant gift",
            "content": "At Pentecost the promised Spirit is poured out, signaling that the new covenant has begun and that God now dwells with his people in a new way. The Spirit empowers witness, creates unity, and writes the law on hearts. What temple symbolized is now realized in a living community."
          },
          {
            "heading": "One multiethnic family",
            "content": "The decisive badge of belonging is the Spirit, not ethnic boundary markers. Jews and Gentiles share one table without the latter becoming Jews, fulfilling the promise to Abraham that the nations would be blessed in his family. This unity is not theoretical; it is practiced in meals, finances, and mutual care."
          },
          {
            "heading": "Apostolic proclamation",
            "content": "Apostolic preaching announces that Jesus’s death and resurrection fulfill Israel’s Scriptures and that he now reigns as Lord. The summons is to repent, believe, be baptized, and receive the Spirit. The message is public truth addressed to cities, synagogues, and emperors alike."
          },
          {
            "heading": "Persecution and growth",
            "content": "Witness provokes hostility because it challenges entrenched powers and exposes idols. Yet the church grows precisely through faithful suffering, which authenticates the message it proclaims. Weakness becomes the theater of divine strength."
          },
          {
            "heading": "Holiness and generosity",
            "content": "The Spirit forms communities marked by integrity, sexual holiness, truthful speech, and economic sharing. Sin is confronted not to shame but to heal, because the church’s life is meant to preview the world to come. Money, power, and status are reimagined under the lordship of Jesus."
          },
          {
            "heading": "Guided by the risen Lord",
            "content": "Through prayer, Scripture, and communal discernment, the church experiences the active leadership of the ascended Jesus. Missionary direction, leadership appointments, and pastoral decisions are made in dependence on his guidance. The Lord adds to the church those who are being saved."
          },
          {
            "heading": "Public confrontation with idols",
            "content": "Where the gospel advances, false worship and unjust economies are challenged, sometimes with visible social consequences. Conversion touches livelihoods, loyalties, and civic practices because Jesus’s lordship is comprehensive. The church learns to resist compromise while loving its neighbors."
          },
          {
            "heading": "Church as signpost",
            "content": "Local congregations are embassies of the kingdom—small but real previews of new creation. Their reconciled life, shared table, and hopeful work point beyond themselves to the God who raises the dead. The credibility of the message is bound up with the character of the people who bear it."
          }
        ]
      }
    }
  }
}

    </script>
    <!-- 
    ============================================================
    ^^^^^^^^^^^^^^ PASTE YOUR JSON CONTENT ABOVE ^^^^^^^^^^^^^^
    ============================================================
-->

<script defer>
document.addEventListener('DOMContentLoaded', () => {

  const THEMES = {
    'newspaper': {
      name: 'Newspaper',
      type: 'classic',
      isDark: false
    },
    'emerald-paper': {
      name: 'Emerald Paper',
      type: 'variable',
      isDark: false,
      vars: {
        '--bg-gradient': '#f7fbf9',
        '--text': '#1e2b28',
        '--accent-text': '#0f7f6d',
        '--nav-bg': '#e7f3ef',
        '--nav-border': '#86c8ba',
        '--nav-text': '#1e2b28',
        '--nav-hover-bg': '#d7ece6',
        '--nav-active-bg': '#bfe3d9',
        '--nav-active-text': '#1e2b28',
        '--prose-text': '#1e2b28',
        '--prose-headings': '#0f7f6d'
      }
    },
    'cyber-blue': {
      name: 'Navy (Dark)',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#0a0a23 0%, #141433 50%, #0f172a 100%)',
        '--text': '#e5e7eb',
        '--accent-text': '#cbd5e1',
        '--nav-bg': '#0f172a',
        '--nav-border': '#1f2937',
        '--nav-text': '#e5e7eb',
        '--nav-hover-bg': '#111827',
        '--nav-active-bg': '#1f2937',
        '--nav-active-text': '#e5e7eb',
        '--prose-text': '#e5e7eb',
        '--prose-headings': '#cbd5e1'
      }
    },
    'emerald-gold': {
      name: 'Emerald/Gold',
      type: 'variable',
      isDark: true,
      vars: {
        '--bg-gradient': 'linear-gradient(135deg,#022c22 0%,#064e3b 60%,#065f46 100%)',
        '--text': '#ecfdf5',
        '--accent-text': '#f0c475',
        '--nav-bg': '#064e3b',
        '--nav-border': '#d4a24c',
        '--nav-text': '#ecfdf5',
        '--nav-hover-bg': '#065f46',
        '--nav-active-bg': '#0b3d31',
        '--nav-active-text': '#f0c475',
        '--prose-text': '#a7f3d0',
        '--prose-headings': '#f0c475'
      }
    }
  };

  const app = {
    root: document.documentElement,
    header: document.getElementById('app-header'),
    tabs: document.getElementById('app-tabs'),
    panels: document.getElementById('app-panels'),
    settings: {
      modal: document.getElementById('settingsModal'),
      closeBtn: document.getElementById('closeSettings'),
      themeSelect: document.getElementById('themeSelect')
    }
  };

  const state = { activeTab: null, theme: 'newspaper' };

  const loadState = () => {
    state.theme = localStorage.getItem('appTheme') || 'newspaper';
    state.activeTab = localStorage.getItem('activeTab');
  };

  const saveState = () => {
    localStorage.setItem('appTheme', state.theme);
    localStorage.setItem('activeTab', state.activeTab);
  };

  const applyTheme = (themeKey) => {
    const theme = THEMES[themeKey];
    if (!theme) return;

    app.root.className = '';
    app.root.style.cssText = '';

    if (theme.type === 'variable' && theme.vars) {
      for (const [key, value] of Object.entries(theme.vars)) {
        app.root.style.setProperty(key, value);
      }
      app.root.classList.add(`theme-${themeKey}`);
    }

    state.theme = themeKey;
    if (app.settings.themeSelect.value !== themeKey) {
      app.settings.themeSelect.value = themeKey;
    }
    saveState();
  };

  const populateThemeSelector = () => {
    app.settings.themeSelect.innerHTML = Object.entries(THEMES)
      .map(([key, theme]) => `<option value="${key}">${theme.name}</option>`)
      .join('');
  };

  const loadAndTransformData = () => {
    try {
      const dataNode = document.getElementById('app-data');
      if (!dataNode.textContent.trim()) {
        console.error('JSON data is empty.');
        return null;
      }
      const rawData = JSON.parse(dataNode.textContent);

      const topLevelKey = Object.keys(rawData)[0];
      if (!topLevelKey) {
        console.error('JSON data is missing a top-level key.');
        return null;
      }
      const course = rawData[topLevelKey];

      const units = Object.entries(course.categories)
        .map(([id, unitData]) => ({ id, ...unitData }))
        .sort((a, b) => a.display_order - b.display_order);

      return { meta: { title: course.title, description: course.description }, units };
    } catch (e) {
      console.error('Failed to load or transform app data:', e);
      app.panels.innerHTML =
        `<div class="p-4 text-red-500 bg-red-100 rounded"><strong>Error:</strong> Could not load content. Please ensure the JSON is correctly formatted and pasted into the data island.</div>`;
      return null;
    }
  };

  const data = loadAndTransformData();
  if (!data) return;

  const renderHeader = () => {
    document.title = data.meta.title || 'Interactive Course';
    app.header.innerHTML = `
      <div class="flex justify-between items-start gap-4">
        <div>
          <h1 class="text-3xl font-bold text-accent">${data.meta.title}</h1>
          <p class="mt-2 text-primary/80">${data.meta.description}</p>
        </div>
        <button id="settingsBtn" class="flex-shrink-0 p-3 rounded-lg settings-button transition-opacity" aria-label="Display Settings">
          <span class="text-2xl text-accent">⚙️</span>
        </button>
      </div>`;
  };

  const renderTabs = () => {
    app.tabs.innerHTML = `<div class="flex flex-wrap">${
      data.units.map(unit => `
        <button role="tab" aria-selected="false" aria-controls="${unit.id}-panel" id="${unit.id}-tab"
                class="px-5 py-3 font-semibold transition-colors tab-button">
          ${unit.display_name}
        </button>`
      ).join('')
    }</div>`;
  };

  const renderPanels = () => {
    app.panels.innerHTML = data.units.map(unit => {
      const introHTML = unit.introduction ? `<p class="lead">${unit.introduction}</p>` : '';
      const paragraphsHTML = (unit.paragraphs || []).map(p => `
        <h3>${p.heading}</h3>
        <p>${p.content}</p>
      `).join('');
      const proseClasses = THEMES[state.theme].isDark ? 'prose prose-lg max-w-none prose-invert' : 'prose prose-lg max-w-none';
      return `
        <div role="tabpanel" id="${unit.id}-panel" aria-labelledby="${unit.id}-tab" hidden>
          <div class="${proseClasses}">
            <h2>${unit.name}</h2>
            ${introHTML}
            ${paragraphsHTML}
          </div>
        </div>`;
    }).join('');
  };

  const switchTab = (tabId) => {
    if (!data.units.some(u => u.id === tabId)) {
      tabId = data.units[0]?.id;
    }
    if (!tabId) return;

    app.tabs.querySelectorAll('[role="tab"]').forEach(tab => {
      const isActive = tab.id === `${tabId}-tab`;
      tab.setAttribute('aria-selected', isActive);
      tab.classList.toggle('tab-active', isActive);
    });

    app.panels.querySelectorAll('[role="tabpanel"]').forEach(panel => {
      panel.hidden = panel.id !== `${tabId}-panel`;
    });

    state.activeTab = tabId;
    saveState();
  };

  const setupEventListeners = () => {
    app.tabs.addEventListener('click', e => {
      const tab = e.target.closest('[role="tab"]');
      if (tab) switchTab(tab.id.replace('-tab', ''));
    });

    app.header.addEventListener('click', e => {
      if (e.target.closest('#settingsBtn')) {
        app.settings.modal.classList.remove('hidden');
        app.settings.themeSelect.focus();
      }
    });

    const closeModal = () => {
      app.settings.modal.classList.add('hidden');
      document.getElementById('settingsBtn')?.focus();
    };
    app.settings.closeBtn.addEventListener('click', closeModal);
    app.settings.modal.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    app.settings.themeSelect.addEventListener('change', (e) => {
      applyTheme(e.target.value);
      renderPanels();
      const activePanel = document.getElementById(`${state.activeTab}-panel`);
      if (activePanel) activePanel.hidden = false;
    });
  };

  const init = () => {
    loadState();
    populateThemeSelector();
    applyTheme(state.theme);
    renderHeader();
    renderTabs();
    renderPanels();
    setupEventListeners();
    switchTab(state.activeTab || data.units[0]?.id);
  };

  init();
});
</script>
</body>
</html>



