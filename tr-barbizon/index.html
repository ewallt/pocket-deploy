<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Threaded Reader</title>

  <!-- Prepaint bootstrap: set dark + theme class before paint to avoid flicker -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');       // 'light' | 'dark' | null
      const savedColor = localStorage.getItem('colorScheme'); // 'slate' | 'emerald' | future
      const isDark = savedTheme !== 'light';                  // default to dark if unset
      root.classList.toggle('dark', isDark);
      // Apply colored theme classes ONLY in dark mode; light is always neutral slate
      root.classList.toggle('theme-emerald', isDark && savedColor === 'emerald');
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
  :root { color-scheme: light dark; }
  html { scroll-behavior: smooth; }
  .font-newspaper { font-family: 'Lora', serif; }
  :where(h2,h3,h4){ scroll-margin-top: 84px; }
  mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
  @media (max-width: 380px){ .prose { font-size: .96rem; } }

  /* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  /* give the header an explicit base fill so gradient blends to the right hue */
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.border-var { border-color: var(--border) !important; }
.surface { border-width: 1px; border-style: solid; border-color: var(--border); }
.hr-var { border-color: var(--border); }
.subtitle { color: var(--subtitle-fg); }
.timeline-fg { color: var(--timeline-fg); }
.footer-note { color: var(--footer-fg); }
.active-link { color: var(--active); font-weight: 700; }

.input-surface {
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
}
.btn-surface { border: 1px solid var(--btn-border); }
.btn-surface:hover { background: var(--btn-hover-bg); }
.toc-link:hover { background: var(--hover-bg); }

/* ---------- Slate (default) variables ---------- */
:root{
  /* accents / inks */
  --active: rgb(59,130,246);                      /* sky-500 */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(100,116,139);                /* slate-500 */
  --footer-fg: rgb(100,116,139);                  /* slate-500 */

  /* surfaces */
  --border: rgb(226,232,240);                     /* slate-200 */
  --hover-bg: rgb(248,250,252);                   /* slate-50 */
  --btn-border: rgb(203,213,225);                 /* slate-300 */
  --btn-hover-bg: rgb(248,250,252);               /* slate-50 */
  --input-border: rgba(203,213,225,0.7);          /* slate-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* hero base & gradient (light) */
  --hero-base: transparent;                       /* keep light header airy */
  --hero-r1: rgba(49,46,129,.12);                 /* indigo-700 */
  --hero-r2: rgba(234,88,12,.12);                 /* orange-600 hint */
  --hero-wash: rgba(14,165,233,.08);              /* sky-500 wash */
}
.dark{
  --subtitle-fg: rgb(203,213,225);                /* slate-300 */
  --timeline-fg: rgb(148,163,184);                /* slate-400 */
  --footer-fg: rgb(148,163,184);                  /* slate-400 */

  --border: rgb(30,41,59);                        /* slate-800 */
  --hover-bg: rgb(15,23,42);                      /* slate-900 */
  --btn-border: rgb(51,65,85);                    /* slate-700 */
  --btn-hover-bg: rgb(15,23,42);                  /* slate-900 */
  --input-border: rgba(51,65,85,0.7);             /* slate-700/70 */
  --input-bg: rgba(2,6,23,0.6);                   /* slate-950/60 */

  /* hero base & gradient (dark) */
  --hero-base: rgb(2,6,23);                       /* slate-950 */
  --hero-r1: rgba(49,46,129,.12);
  --hero-r2: rgba(234,88,12,.12);
  --hero-wash: rgba(14,165,233,.08);
}

/* ---------- Emerald theme overrides (light & dark) ---------- */
.theme-emerald{
  --active: #10b981;                              /* emerald-500 */

  --border: rgb(187,247,208);                     /* emerald-200 */
  --hover-bg: rgb(240,253,244);                   /* emerald-50 */
  --btn-border: rgb(187,247,208);                 /* emerald-200 */
  --btn-hover-bg: rgb(240,253,244);               /* emerald-50 */
  --input-border: rgba(110,231,183,0.7);          /* emerald-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* keep subtitles/timeline neutral for readability over hero */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(71,85,105);                  /* slate-600 */
  --footer-fg: rgb(16,185,129);                   /* emerald-500 */

  /* hero base & gradient (emerald light) */
  --hero-base: transparent;
  --hero-r1: rgba(16,185,129,.14);                /* emerald-500 */
  --hero-r2: rgba(163,230,53,.12);                /* lime-400 */
  --hero-wash: rgba(5,150,105,.10);               /* emerald-600 wash */
}
.dark.theme-emerald{
  /* ↑ Give borders enough contrast on dark emerald surfaces */
  --border: rgba(110,231,183,0.55);                /* emerald-300 @ 55% */
  --hover-bg: rgb(6,78,59);                        /* emerald-900 */
  --btn-border: rgba(110,231,183,0.45);            /* slightly softer than borders */
  --btn-hover-bg: rgb(6,78,59);                    /* emerald-900 */
  --input-border: rgba(110,231,183,0.55);          /* match border contrast */
  --input-bg: rgba(6,95,70,0.60);                  /* emerald-900/60 */

  /* text accents for readability */
  --footer-fg: rgb(110,231,183);                   /* emerald-300/400 */
  --subtitle-fg: rgb(226,252,236);                 /* emerald-100 */
  --timeline-fg: rgb(187,247,208);                 /* emerald-200 */

  /* hero base & gradient (unchanged, stays emerald) */
  --hero-base: rgb(2,44,34);                       /* emerald-950 (#022c22) */
  --hero-r1: rgba(16,185,129,.14);
  --hero-r2: rgba(163,230,53,.12);
  --hero-wash: rgba(5,150,105,.10);
}

/* ===== Mobile FAB quick settings (Option A) ===== */
#fabPanel.show { display:block; animation: fadeUp .14s ease-out; }
@keyframes fadeUp { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
  </style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">

  <!-- Header -->
  <header id="top" class="hero border-b border-var">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="subtitle text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl input-surface px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg btn-surface">Clear</button>

        <!-- Header controls: hidden on small screens -->
        <button id="colorSchemeToggle" type="button" class="hidden sm:inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Change color scheme">
          <span class="inline md:hidden">Colors</span>
          <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
            <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
            <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
            <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 7.012 17.461 2 12 2z"/>
          </svg>
        </button>
        <button id="themeToggle" type="button" class="hidden sm:inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Toggle dark mode" aria-pressed="false">
          <span class="inline md:hidden">Theme</span>
          <svg aria-hidden="true" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg aria-hidden="true" class="w-5 h-5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </div>

    <!-- Timeline -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="timeline-fg">
        <ol id="timeline" class="grid grid-cols-3 sm:grid-cols-6 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl surface p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 hr-var" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg btn-surface">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg btn-surface">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- Content is generated by script from JSON -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs footer-note">
    Threaded Reader — a single-file template
  </footer>

  <!-- Mobile quick settings FAB + Panel -->
  <button id="fab" class="fixed z-40 top-4 right-4 sm:hidden rounded-full shadow-lg px-4 py-3 text-sm btn-surface backdrop-blur">
    ⚙️
  </button>
  <div id="fabPanel" class="bg-white dark:bg-slate-800 sm:hidden fixed z-40 top-20 right-4 w-56 rounded-xl surface p-3 hidden">
    <div class="text-xs mb-2 opacity-80">Quick settings</div>
    <button id="fabTheme" class="w-full text-sm px-3 py-2 rounded-lg btn-surface mb-2">Toggle Theme</button>
    <button id="fabColor" class="w-full text-sm px-3 py-2 rounded-lg btn-surface">Cycle Colors</button>
  </div>

  <script id="embedded-json" type="application/json">
    {
      "title": "The Impressionist Revolution",
      "description": "A thematic exploration of Impressionism, detailing its break from the Academy, its scientific approach to light, its focus on modern life, and its struggle for acceptance.",
      "timeline_steps": "the-salon-des-refuses, first-impressionist-exhibition, eighth-impressionist-exhibition",
      "timeline_labels": "1863: Salon des Refusés, 1874: First Exhibition, 1886: Final Exhibition",
      "articles": [
        {
          "title": "The Revolution Begins",
          "introduction": "This section covers the context of the 1860s art world, the break from the powerful Salon, the influence of the controversial forerunner Édouard Manet, and how the movement got its name.",
          "threads": [
            {
              "title": "The World of the Salon",
              "content": "<p>In the mid-19th century, the French art world was controlled by the state-sponsored Academy and its official exhibition, the Paris Salon. The Salon favored a polished, highly-finished style and a strict hierarchy of subjects, with grand historical and mythological scenes at the top. It was the only path to artistic success, and its conservative jury systematically rejected any work that was deemed too radical, unfinished, or modern in its subject matter.</p>"
            },
            {
              "title": "Manet: The Reluctant Father",
              "content": "<p>Édouard Manet was a pivotal figure who, while never officially an Impressionist, served as their primary inspiration. His paintings *Luncheon on the Grass* and *Olympia* caused massive scandals in the 1860s for their modern subject matter and flat, confrontational style. By challenging academic conventions, Manet showed a younger generation of artists that it was possible to create a new kind of art for the modern era.</p>"
            },
            {
              "title": "The Salon des Refusés (1863)",
              "content": "<p>In 1863, the Salon jury rejected an unprecedented number of works, causing a public outcry. In response, Emperor Napoleon III ordered a special exhibition to display the rejected art, the 'Salon des Refusés.' It was here that Manet's *Luncheon on the Grass* was shown, becoming the star of a scandalous but hugely influential exhibition that demonstrated the growing power of the artistic avant-garde.</p>"
            },
            {
              "title": "The Anonymous Society of Painters",
              "content": "<p>Frustrated by repeated rejections from the Salon, a group of young artists including Monet, Renoir, Pissarro, and Degas decided to bypass the official system entirely. They pooled their resources and in 1874, they organized their own independent exhibition under the name 'The Anonymous Society of Painters, Sculptors, Printmakers, etc.' This act of defiance was the true birth of the Impressionist movement.</p>"
            },
            {
              "title": "An Insult Becomes a Name",
              "content": "<p>At that first exhibition, Claude Monet exhibited a hazy painting of the port of Le Havre titled *Impression, Sunrise*. Seizing on the title, the hostile critic Louis Leroy wrote a scathing review titled 'The Exhibition of the Impressionists,' mocking the work as a mere, unfinished 'impression.' In a spirit of defiance, the artists adopted the derogatory label as their own, and the name stuck.</p>"
            },
            {
              "title": "The First Impressionist Exhibition (1874)",
              "content": "<p>The first exhibition, held in the former studio of the photographer Nadar, was a financial failure and a critical disaster. The public and critics, accustomed to the polished finish of academic art, were baffled by the visible brushwork, bright colors, and seemingly mundane subjects. However, it was a landmark event that established a new model for artistic independence and cooperative exhibition outside of state control.</p>"
            },
            {
              "title": "The Eighth (and Final) Impressionist Exhibition (1886)",
              "content": "<p>The group held a total of eight independent exhibitions between 1874 and 1886. The final show marked a turning point. By this time, Impressionism was beginning to gain wider acceptance, but the artists themselves were moving in different stylistic directions. The exhibition included the new, scientific 'Neo-Impressionism' of Georges Seurat, signaling that the unified phase of the revolution was over and new avant-garde movements were already emerging.</p>"
            }
          ]
        },
        {
          "title": "Core Principles & Techniques",
          "introduction": "This section explains the key ideas that made Impressionism so revolutionary: its focus on light and color, the practice of painting outdoors, the choice of modern subjects, and the influence of new technologies and foreign art.",
          "threads": [
            {
              "title": "Painting Light and Color",
              "content": "<p>The central goal of Impressionism was to capture the fleeting, sensory effect of a scene. Artists became obsessed with how light affects the color of objects, observing that shadows are not black but are filled with reflected color. They used short, thick strokes of pure, unmixed paint, a technique known as 'broken color,' which allowed the viewer's eye to mix the colors optically, creating a vibrant, shimmering effect.</p>"
            },
            {
              "title": "En Plein Air (In the Open Air)",
              "content": "<p>Aided by the invention of pre-mixed paint in portable tubes, the Impressionists took their easels out of the studio and into the natural world. This practice of painting *en plein air* was essential for directly observing and capturing the transient effects of sunlight and weather. It encouraged a rapid, spontaneous style of painting to record the 'impression' before the moment passed.</p>"
            },
            {
              "title": "The Subject of Modern Life",
              "content": "<p>The Impressionists radically democratized subject matter. They turned away from the grand themes of history, mythology, and religion favored by the Academy. Instead, they found their subjects in the world around them: the bustling boulevards and cafes of a newly modernized Paris, the suburban leisure of boating and picnics, and the quiet intimacy of domestic life. They were the first artists to truly paint the 19th-century as it happened.</p>"
            },
            {
              "title": "The Influence of Photography",
              "content": "<p>The new art of photography had a profound impact on Impressionist composition. Photography's ability to capture a 'snapshot' of a moment in time inspired the artists to create compositions that felt spontaneous and unposed. They adopted unusual, high or low viewing angles and often cropped figures at the edge of the canvas, techniques that mimicked the seemingly random framing of a photograph and gave their work a distinctly modern feel.</p>"
            },
            {
              "title": "Japonisme: A New Way of Seeing",
              "content": "<p>In the mid-19th century, Japanese ukiyo-e woodblock prints flooded the Parisian market, an artistic phenomenon known as *Japonisme*. The Impressionists were captivated by these prints. They learned from their bold, flat areas of color, their strong outlines, their asymmetrical compositions, and their unconventional viewpoints. This influence is clearly visible in the work of Degas, Monet, and Cassatt, who integrated these design principles into their own modern vision.</p>"
            },
            {
              "title": "The Series Paintings of Monet",
              "content": "<p>Claude Monet took the Impressionist obsession with light to its logical conclusion with his 'series' paintings. He would paint the same subject—haystacks, poplar trees, the Rouen Cathedral—over and over again, sometimes on dozens of canvases at once, to document how its appearance changed with the time of day, the season, and the weather. This method proved that the true subject of the painting was not the object itself, but the light that illuminated it.</p>"
            }
          ]
        },
        {
          "title": "The Masters of Impressionism",
          "introduction": "While they shared a common philosophy, the core members of the Impressionist group were distinct individuals with their own unique styles and preferred subjects.",
          "threads": [
            {
              "title": "Claude Monet: The Eye",
              "content": "<p>The most dedicated and quintessential Impressionist, Claude Monet (1840-1926) devoted his entire career to capturing the fleeting sensations of light and atmosphere. His work, from the painting that gave the movement its name to his final, near-abstract Water Lilies, represents the purest expression of the Impressionist ideal: to paint what one sees, not what one knows.</p>"
            },
            {
              "title": "Pierre-Auguste Renoir: The Human Touch",
              "content": "<p>Pierre-Auguste Renoir (1841-1919) was the great painter of human warmth and joy within the movement. While also a gifted landscape painter, he excelled at depicting people, especially women and children, in moments of leisure and happiness. His canvases, like *Luncheon of the Boating Party*, are filled with a sensuous appreciation for life, rendered in a rich, feathery brushwork that makes his figures glow with vitality.</p>"
            },
            {
              "title": "Edgar Degas: The Reluctant Impressionist",
              "content": "<p>Edgar Degas (1834-1917) was a founder of the group but preferred to be called a 'Realist.' A master of drawing, he rejected the pure landscape and focused on scenes of modern urban life: ballet dancers, horse races, cafes, and laundresses. His genius lay in his innovative and dynamic compositions, which often used sharp angles and cropped figures to create the feeling of a candid, captured moment.</p>"
            },
            {
              "title": "Camille Pissarro: The Mentor",
              "content": "<p>Camille Pissarro (1830-1903) was the patient, unifying figure of the movement. He was the only artist to exhibit in all eight Impressionist exhibitions and was a mentor and friend to many younger artists, including Cézanne and Gauguin. His work is celebrated for its humble, heartfelt depictions of rural and urban landscapes, capturing the quiet rhythms of life with profound sensitivity.</p>"
            },
            {
              "title": "Berthe Morisot: The Bold Innovator",
              "content": "<p>Berthe Morisot (1841-1895) was a central figure and one of the most daring and technically innovative of the Impressionists. Her brushwork was often the most free and energetic of the group, capturing scenes of domestic life and fashionable leisure with a distinctive feathery, dynamic touch. Her work provided a crucial female perspective on the modern world, focusing on the intimate sphere of women and children.</p>"
            },
            {
              "title": "Mary Cassatt: The American Abroad",
              "content": "<p>The only American to become a core member of the group, Mary Cassatt (1844-1926) brought a unique and powerful perspective to Impressionism. Encouraged by Degas, she developed a style that combined strong draftsmanship with a light, modern palette. She is best known for her unsentimental and deeply moving portrayals of the lives of women, particularly the intimate bond between mothers and children.</p>"
            }
          ]
        },
        {
          "title": "Legacy and Influence",
          "introduction": "Though initially scorned, Impressionism became one of the most beloved and influential movements in art history. Its radical innovations opened the door for all of modern art that would follow.",
          "threads": [
            {
              "title": "The Path to Public Acceptance",
              "content": "<p>While the first exhibitions were met with ridicule, public and critical opinion slowly began to shift. The art dealer Paul Durand-Ruel was a crucial champion, supporting the artists financially and promoting their work in Paris, London, and New York. By the time of the final exhibition in 1886, Impressionism was beginning to find a dedicated group of collectors, particularly in America, and its place in art history was becoming secure.</p>"
            },
            {
              "title": "Opening the Door to Post-Impressionism",
              "content": "<p>Impressionism's revolution was so profound that it immediately spawned a reaction. The next generation of artists, known as the Post-Impressionists—including Vincent van Gogh, Paul Gauguin, and Georges Seurat—built upon the Impressionists' innovations in color and brushwork. However, they rejected the focus on fleeting visual sensation in favor of more personal, emotional, symbolic, or scientific approaches, leading art down even more radical paths.</p>"
            },
            {
              "title": "The 'Father' of Cubism: Paul Cézanne",
              "content": "<p>Paul Cézanne, who exhibited with the Impressionists early on, took their principles in a completely new direction. He famously said he wanted to 'make of Impressionism something solid and durable, like the art of the museums.' His analytical approach to form, breaking down objects into geometric planes of color, would directly lead to the development of Cubism by Picasso and Braque, earning him the title 'Father of Modern Art.'</p>"
            },
            {
              "title": "A New Way of Seeing",
              "content": "<p>The most enduring legacy of Impressionism was that it fundamentally changed the definition of what a painting could be. It shifted the focus of art from the object depicted to the subjective vision of the artist. The movement validated personal experience, sensation, and the beauty of the everyday as worthy subjects for art. By breaking the rules of the Academy, the Impressionists gave future generations of artists the freedom to create their own.</p>"
            }
          ]
        }
      ]
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from JSON =====
      let jsonData = {};
      try {
        jsonData = JSON.parse(document.getElementById('embedded-json').textContent);
      } catch (e) {
        console.error("Error parsing embedded JSON:", e);
        document.getElementById('docTitle').textContent = 'Error Loading Content';
        return;
      }
      const docTitle = jsonData.title || 'Untitled Document';
      const docSubtitle = jsonData.description || '';
      const timelineStepsData = jsonData.timeline_steps;
      const timelineLabelsData = jsonData.timeline_labels;
      
      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle;

      // ===== Build Content from JSON =====
      const contentSection = document.getElementById('content');
      let contentHtml = '';
      if (jsonData.articles) {
        jsonData.articles.forEach(article => {
          contentHtml += `<article id="${slug(article.title)}">`;
          contentHtml += `<h2>${article.title}</h2>`;
          if (article.introduction) {
            contentHtml += `<p>${article.introduction}</p>`;
          }
          if (article.threads) {
            article.threads.forEach(thread => {
              contentHtml += `<details open>`;
              contentHtml += `<summary><h3>${thread.title}</h3></summary>`;
              if (thread.content) {
                contentHtml += `<div class="pl-4 border-l-2 border-var">${thread.content}</div>`;
              }
              contentHtml += `</details>`;
            });
          }
          contentHtml += `</article>`;
        });
      }
      contentSection.innerHTML = contentHtml;

      // ===== Theme packs =====
      const THEME_PACKS = {
        slate: {
          proseClass: 'prose-slate',
          bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
        },
        emerald: {
          proseClass: 'prose-emerald',
          bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
        }
      };
      const availableThemes = Object.keys(THEME_PACKS);

      function applyTheme(themeKey){
        const root = document.documentElement;
        const isDark = root.classList.contains('dark');
        const pack = THEME_PACKS[themeKey] || THEME_PACKS.slate;
        root.classList.toggle('theme-emerald', isDark && themeKey === 'emerald');
        document.body.className = isDark ? pack.bodyClass : THEME_PACKS.slate.bodyClass;
        contentSection.className = `prose ${pack.proseClass} dark:prose-invert max-w-none`;
        try { localStorage.setItem('colorScheme', themeKey); } catch(_){}
      }

      let currentThemeIndex = 0;
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && THEME_PACKS[saved]) currentThemeIndex = availableThemes.indexOf(saved);
      } catch(_) {}
      
      const colorBtn = document.getElementById('colorSchemeToggle');
      colorBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        if (!root.classList.contains('dark')) {
          root.classList.add('dark');
          try { localStorage.setItem('theme','dark'); } catch(_){}
          document.getElementById('themeToggle')?.setAttribute('aria-pressed','true');
          applyTheme(availableThemes[currentThemeIndex]); // apply color when switching to dark
          return;
        }
        currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
        const newTheme = availableThemes[currentThemeIndex];
        applyTheme(newTheme);
        buildTOC();
      });

      const themeBtn = document.getElementById('themeToggle');
      if (themeBtn) {
        themeBtn.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')));
      }
      themeBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        const isDark = root.classList.toggle('dark');
        try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){}
        themeBtn.setAttribute('aria-pressed', String(isDark));

        if (!isDark) {
          root.classList.remove('theme-emerald');
          applyTheme('slate');
        } else {
          let saved = 'slate';
          try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
          applyTheme(saved);
        }
        buildTOC();
      });

      // ===== Expand/Collapse, TOC, Timeline, Search =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          const parentArticle = h.closest('article');
          const parentSlug = parentArticle ? parentArticle.id : '';
          if (!h.id) h.id = parentSlug + '-' + slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }
        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];
        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );
        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        if (!input || !contentSection) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            contentSection.innerHTML = originalHTML; 
            buildTOC(); // Rebuild TOC to reattach observers
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = contentSection.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          contentSection.innerHTML = contentSection.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();

      buildTOC();
      try {
        const saved = localStorage.getItem('colorScheme');
        applyTheme(saved && THEME_PACKS[saved] ? saved : 'slate');
      } catch(_){
        applyTheme('slate');
      }

      // ===== Mobile FAB wiring (Option A) =====
      const fab = document.getElementById('fab');
      const fabPanel = document.getElementById('fabPanel');
      const fabTheme = document.getElementById('fabTheme');
      const fabColor = document.getElementById('fabColor');

      fab?.addEventListener('click', () => fabPanel.classList.toggle('show'));
      document.addEventListener('click', (e)=>{
        if (!fabPanel.contains(e.target) && !fab.contains(e.target)) fabPanel.classList.remove('show');
      });
      fabTheme?.addEventListener('click', () => document.getElementById('themeToggle')?.click());
      fabColor?.addEventListener('click', () => document.getElementById('colorSchemeToggle')?.click());
    });
  </script>
</body>
</html>
