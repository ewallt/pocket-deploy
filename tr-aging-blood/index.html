<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Threaded Reader</title>

  <!-- Prepaint bootstrap: set dark + theme class before paint to avoid flicker -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');       // 'light' | 'dark' | null
      const savedColor = localStorage.getItem('colorScheme'); // 'slate' | 'emerald' | future
      const isDark = savedTheme !== 'light';                  // default to dark if unset
      root.classList.toggle('dark', isDark);
      // Apply colored theme classes ONLY in dark mode; light is always neutral slate
      root.classList.toggle('theme-emerald', isDark && savedColor === 'emerald');
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
  :root { color-scheme: light dark; }
  html { scroll-behavior: smooth; }
  .font-newspaper { font-family: 'Lora', serif; }
  :where(h2,h3,h4){ scroll-margin-top: 84px; }
  mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
  @media (max-width: 380px){ .prose { font-size: .96rem; } }

  /* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  /* give the header an explicit base fill so gradient blends to the right hue */
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.border-var { border-color: var(--border) !important; }
.surface { border-width: 1px; border-style: solid; border-color: var(--border); }
.hr-var { border-color: var(--border); }
.subtitle { color: var(--subtitle-fg); }
.timeline-fg { color: var(--timeline-fg); }
.footer-note { color: var(--footer-fg); }
.active-link { color: var(--active); font-weight: 700; }

.input-surface {
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
}
.btn-surface { border: 1px solid var(--btn-border); }
.btn-surface:hover { background: var(--btn-hover-bg); }
.toc-link:hover { background: var(--hover-bg); }

/* ---------- Slate (default) variables ---------- */
:root{
  /* accents / inks */
  --active: rgb(59,130,246);                      /* sky-500 */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(100,116,139);                /* slate-500 */
  --footer-fg: rgb(100,116,139);                  /* slate-500 */

  /* surfaces */
  --border: rgb(226,232,240);                     /* slate-200 */
  --hover-bg: rgb(248,250,252);                   /* slate-50 */
  --btn-border: rgb(203,213,225);                 /* slate-300 */
  --btn-hover-bg: rgb(248,250,252);               /* slate-50 */
  --input-border: rgba(203,213,225,0.7);          /* slate-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* hero base & gradient (light) */
  --hero-base: transparent;                       /* keep light header airy */
  --hero-r1: rgba(49,46,129,.12);                 /* indigo-700 */
  --hero-r2: rgba(234,88,12,.12);                 /* orange-600 hint */
  --hero-wash: rgba(14,165,233,.08);              /* sky-500 wash */
}
.dark{
  --subtitle-fg: rgb(203,213,225);                /* slate-300 */
  --timeline-fg: rgb(148,163,184);                /* slate-400 */
  --footer-fg: rgb(148,163,184);                  /* slate-400 */

  --border: rgb(30,41,59);                        /* slate-800 */
  --hover-bg: rgb(15,23,42);                      /* slate-900 */
  --btn-border: rgb(51,65,85);                    /* slate-700 */
  --btn-hover-bg: rgb(15,23,42);                  /* slate-900 */
  --input-border: rgba(51,65,85,0.7);             /* slate-700/70 */
  --input-bg: rgba(2,6,23,0.6);                   /* slate-950/60 */

  /* hero base & gradient (dark) */
  --hero-base: rgb(2,6,23);                       /* slate-950 */
  --hero-r1: rgba(49,46,129,.12);
  --hero-r2: rgba(234,88,12,.12);
  --hero-wash: rgba(14,165,233,.08);
}

/* ---------- Emerald theme overrides (light & dark) ---------- */
.theme-emerald{
  --active: #10b981;                              /* emerald-500 */

  --border: rgb(187,247,208);                     /* emerald-200 */
  --hover-bg: rgb(240,253,244);                   /* emerald-50 */
  --btn-border: rgb(187,247,208);                 /* emerald-200 */
  --btn-hover-bg: rgb(240,253,244);               /* emerald-50 */
  --input-border: rgba(110,231,183,0.7);          /* emerald-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* keep subtitles/timeline neutral for readability over hero */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(71,85,105);                  /* slate-600 */
  --footer-fg: rgb(16,185,129);                   /* emerald-500 */

  /* hero base & gradient (emerald light) */
  --hero-base: transparent;
  --hero-r1: rgba(16,185,129,.14);                /* emerald-500 */
  --hero-r2: rgba(163,230,53,.12);                /* lime-400 */
  --hero-wash: rgba(5,150,105,.10);               /* emerald-600 wash */
}
.dark.theme-emerald{
  /* ↑ Give borders enough contrast on dark emerald surfaces */
  --border: rgba(110,231,183,0.55);                /* emerald-300 @ 55% */
  --hover-bg: rgb(6,78,59);                        /* emerald-900 */
  --btn-border: rgba(110,231,183,0.45);            /* slightly softer than borders */
  --btn-hover-bg: rgb(6,78,59);                    /* emerald-900 */
  --input-border: rgba(110,231,183,0.55);          /* match border contrast */
  --input-bg: rgba(6,95,70,0.60);                  /* emerald-900/60 */

  /* text accents for readability */
  --footer-fg: rgb(110,231,183);                   /* emerald-300/400 */
  --subtitle-fg: rgb(226,252,236);                 /* emerald-100 */
  --timeline-fg: rgb(187,247,208);                 /* emerald-200 */

  /* hero base & gradient (unchanged, stays emerald) */
  --hero-base: rgb(2,44,34);                       /* emerald-950 (#022c22) */
  --hero-r1: rgba(16,185,129,.14);
  --hero-r2: rgba(163,230,53,.12);
  --hero-wash: rgba(5,150,105,.10);
}

</style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">



  <!-- Header -->
  <header id="top" class="hero border-b border-var">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="subtitle text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl input-surface px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg btn-surface">Clear</button>
        <button id="colorSchemeToggle" type="button" class="inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Change color scheme">
          <span class="inline md:hidden">Colors</span>
          <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
            <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
            <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
            <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 7.012 17.461 2 12 2z"/>
          </svg>
        </button>
        <button id="themeToggle" type="button" class="inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Toggle dark mode" aria-pressed="false">
          <span class="inline md:hidden">Theme</span>
          <svg aria-hidden="true" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg aria-hidden="true" class="w-5 h-5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </div>

    <!-- Timeline -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="timeline-fg">
        <ol id="timeline" class="grid grid-cols-3 sm:grid-cols-6 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl surface p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 hr-var" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg btn-surface">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg btn-surface">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- DROP ARTICLE HERE -->

<article class="rounded-2xl surface p-6">
  <meta name="doc-title" content="Proteomics at Scale: What Plasma Proteins Reveal About Aging and Disease">
  <meta name="doc-subtitle" content="High-throughput blood proteomics, organ and body-wide aging clocks, and what large cohorts are teaching us">
  <meta name="timeline-steps" content="background,proteins-in-contrast-to-genome-variants,organ-clocks,body-wide-aging-clocks,proteomic-peaks-across-the-lifespan,disease-risk-proteins,establishing-cause-and-effect-proteins,proteomics-and-diets,bottom-line">
  <meta name="timeline-labels" content="Background,Genome vs Proteins,Organ Clocks,Body-Wide Clocks,Peaks,Lg. Cohort Risk,Causal Proteins,Diets,Bottom Line">

  <h2>Background</h2>
  <p>The recent capability to measure thousands of plasma proteins from a tiny blood sample has provided a new dimension of expansive data that can advance our understanding of human health. For example, the company SomaLogic has developed the means to measure 11,000 proteins and Thermo Fisher’s Olink assays over 5,400 proteins from as little as 2 μl. (This is real; not Theranos!) When these rich data are integrated with other layers of information from large patient cohorts, such as the UK Biobank’s genetic, health, and lifestyle information from half a million participants, we get new insights about the underpinnings of disease, the aging process, and the potential ability to forecast an individual’s health trajectory.</p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Proteins in Contrast to Genome Variants</h2>
  <p>For over a decade, polygenic risk scores that reflect the likelihood of a certain genetic trait manifesting as a disease have been developed that partition risk for most common diseases. This approach has been validated across groups of people from different ancestries and is now beginning to be used for patient guidance. These risk scores are typically based on the presence of hundreds of common (present in &gt;5% of the population) single-nucleotide polymorphisms (SNPs).</p>
  <p>But we know that the risk for disease is not just reflected by common DNA sequence variants. There are rare and ultra-rare genomic variants that are not factored into calculating risk, such as insertion–deletions that generate mutations, or structural variations. Moreover, there is variability in our proteomic, metabolomic, and epigenomic profiles as well as in our microbiome, immunome, and exposomes (environmental exposures). What was envisioned in 2000 when the human genome sequence draft was announced as our “operating instructions” turns out to be a critical, but incomplete, layer of information about what makes us tick—and our susceptibility to various medical conditions.</p>
  <p>In contrast to about 20,000 protein-coding genes in the human genome, there are over 100,000 different proteins and, as a result of alternative splicing, hundreds of thousands of protein isoforms in the human body. Being able to assay for a substantial fraction of these is the basis of hypothesis-free research—gather data and find patterns rather than presupposing them. This approach, along with machine learning analytics, has led to a revolution in understanding the foundations of disease.</p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Organ Clocks</h2>
  <p>Several recent high-throughput proteomic studies are illuminating at both the organ and body-wide level. Three studies have addressed organ-specific protein dynamics. Oh and colleagues culled data from five groups of individuals (three with healthy participants, two with Alzheimer’s disease patients) assembled from 5,676 adults to assess nearly 5,000 plasma proteins (with a 5-year follow-up). Using machine-learning models, proteins that are specific to 11 organs were identified and an “organ age gap” was derived by comparing biological with chronological age. About one in five individuals were hyper-agers for at least one organ, and 2% for multiple organs. For each of the 11 organs, the age gap was associated with an increased risk of mortality.</p>
  <p>Two subsequent studies took this further. In a preprint by Gladyshev and colleagues, about 3,000 plasma proteins were assessed in 53,000 UK Biobank participants. With machine learning, seven organ-specific aging clocks were defined. Lifestyle factors such as smoking were associated with an increased pace of aging for all seven organs, as was alcohol for intestinal aging. Organ aging also associated with many other factors including various foods, medications, and occupations.</p>
  <p>A third study, again by Oh and colleagues (preprint), assayed 3,000 plasma proteins in 44,000 UK Biobank participants, and further validated the 11 organ-specific aging clocks. Postmenopausal estrogen replacement was associated with slower aging across most organs, in contrast to smoking and alcohol. Notably, slow brain or immune system aging was associated with improved survival over an extended 15-year follow-up.</p>
  <p><em>Figure (summary): Organ-specific proteomic signatures can estimate “organ age”; larger positive gaps predict higher mortality risk; lifestyle and hormone exposure shift these trajectories.</em></p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Body-Wide Aging Clocks</h2>
  <p>Argentieri and colleagues analyzed nearly 3,000 plasma proteins in over 45,000 UK Biobank participants, with cross-validation in cohorts from China (~4,000) and Finland (~2,000), each with at least 11 years of follow-up. A cluster of 204 proteins not only predicted chronological age accurately, but was also associated with 18 chronic diseases, including four common cancers, multimorbidity, and all-cause mortality. Rapid proteomic-clock agers were at higher risk of Alzheimer’s disease, whereas among slow proteomic-clock agers (bottom decile), less than 1% developed Alzheimer’s disease.</p>
  <p>Two reports using AI models by Carrasco-Zanini and colleagues widened disease prediction. In EPIC-Norfolk (&gt;25,000 participants), ~3,000 plasma proteins associated with risk of 13 diseases and all-cause mortality. In &gt;41,000 UK Biobank participants, integrating the same plasma proteins with electronic health records yielded varying predictability across 52 of 218 common and rare diseases.</p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Proteomic Peaks Along the Lifespan Suggest Aging Isn’t Linear</h2>
  <p>Proteomic studies indicate aging is not linear. In 2019, Lehallier and colleagues (over 4,000 people aged 18–95 years; ~3,000 proteins) found three proteomic peaks during the lifespan at ~35, ~60, and ~80 years. More recently, a multi-omic study (over 300 proteins; upper age 75; follow-up ~1.7 years) identified peaks at ages 44 and 61.</p>
  <p>Williams et al. studied ~5,000 proteins in nearly 17,000 individuals and found proteins strongly linked with risk of cardiovascular disease, diabetes, and metabolic-associated fatty liver disease. Other high-throughput proteomic studies have focused on dementia risk in healthy individuals and on Alzheimer’s disease indexed to APOE genotype.</p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Disease-Risk Proteins in Large Cohorts</h2>
  <p><em>Figure (summary): “Disease-associated proteins per major biological contributor” map plasma-protein drivers to disease classes and highlight potential drug targets; several modifiable lifestyle factors align with distinct proteomic risk signatures.</em></p>
  <p><em>Figure (summary): Heat-map linking individual foods within eight diets to seven outcomes shows protective (blue) and adverse (red) associations when tracked via proteomic signatures—offering a more objective complement to food-diary methods.</em></p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Establishing Cause and Effect Proteins</h2>
  <p>Lars Lind and colleagues published Olink proteomic data (2,919 proteins) from &gt;52,000 UK Biobank participants and replicated findings in the China Kadoorie Biobank. Using protein data plus Mendelian Randomization (MR) from genomic data, they found three causal proteins for cardiovascular outcomes (heart attack, ischemic stroke, heart failure): FURIN, FGF5, and PROCR. None are currently trial targets, but all are potentially druggable for prevention.</p>
  <p>Julia Carrasco-Zanini and colleagues assessed 4,775 plasma proteins in ~8,000 healthy participants, integrated with genomic data, again enabling MR to infer causality and identify shifts in the plasma proteome from actionable, modifiable risk factors. Of &gt;100 potential causal drivers, one example was COL6A3 that appeared to mediate reduced kidney function in individuals with heart disease.</p>
  <p><em>Figure (summary): Example MR pathway highlights COL6A3 as a mediator linking a modifiable exposure to downstream renal dysfunction in heart-disease patients.</em></p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Proteomics and Diets</h2>
  <p>Kai Zhu and colleagues analyzed ~2,900 Olink plasma proteins in nearly 22,000 UK Biobank participants (~11-year follow-up) to ask: (1) do eight healthy diets have proteomic signatures, and (2) how do those signatures relate to major disease outcomes and life expectancy?</p>
  <p>The healthy diets and their proteomic signatures were associated with reduced all-cause mortality, type 2 diabetes, dementia, cancer, and chronic kidney and lung diseases. The figure showed estimated added life expectancy at age 45 by diet and by proteomic signature (highest vs. lowest decile); the healthful plant-based index diet (hPDI) used a different Y-axis scale reflecting the impact of its signature. Specific proteins were identified as mediators, such as FSTL3, interleukin-18 receptor 1, and hepatocyte growth factor.</p>
  <p><em>Figure (summary): Diet-specific proteomic signatures align with longer life expectancy and lower incidence of multiple chronic diseases; mediator proteins suggest plausible biological pathways.</em></p>
</article>

<article class="mt-6 rounded-2xl surface p-6">
  <h2>Bottom Line</h2>
  <p>Collectively, these studies highlight the new ability to assay and learn about a broad swath of plasma proteins. The work to date has enhanced our understanding of the human aging process, identified many organ-specific changes and how they may be favorably modulated, raised the potential of using proteomic scores for assessing risk of various diseases, identified novel protein drivers that are modifiable, and developed complementary signatures for dietary assessment. Note that most reviewed studies assessed fewer than 5,000 proteins; that number is rapidly increasing (now up to 11,000 and climbing).</p>
  <p>Proteomics is one layer among many that can be integrated with electronic health records, genomic risk, epigenetic clocks, inflammation biomarkers, gut microbiome, immune function, and environmental exposures. A current limitation is cost ($500–$1,000 per person), but validated subset panels for specific risk assessments may drive costs down. The field is advancing quickly, and its integration with AI is likely to cement a role in routine medical care.</p>
</article>


      <!-- DO NOT PASTE ANYTHING AFTER THIS POINT -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs footer-note">
    Threaded Reader — a single-file template
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from Content =====
      const firstArticle = document.querySelector('#content article');
      const docTitle = firstArticle?.querySelector('meta[name="doc-title"]')?.content || 'Untitled Document';
      const docSubtitle = firstArticle?.querySelector('meta[name="doc-subtitle"]')?.content || '';
      const timelineStepsData = firstArticle?.querySelector('meta[name="timeline-steps"]')?.content;
      const timelineLabelsData = firstArticle?.querySelector('meta[name="timeline-labels"]')?.content;

      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle; // Also update browser tab title

      // ===== Theme packs: only control article "prose-*" family
      // ===== Theme packs: control article prose family AND base <body> ink/background
const THEME_PACKS = {
  slate: {
    proseClass: 'prose-slate',
    bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
  },
  emerald: {
    proseClass: 'prose-emerald',
    bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
  }
};
const availableThemes = Object.keys(THEME_PACKS);


function applyTheme(themeKey){
  const root = document.documentElement;
  const isDark = root.classList.contains('dark');

  const THEME_PACKS = {
    slate: {
      proseClass: 'prose-slate',
      bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
    },
    emerald: {
      proseClass: 'prose-emerald',
      bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
    }
  };

  const pack = THEME_PACKS[themeKey] || THEME_PACKS.slate;

  // Color theme classes only attach in DARK; LIGHT is always neutral slate
  root.classList.toggle('theme-emerald', isDark && themeKey === 'emerald');

  // Body ink/background:
  document.body.className = isDark ? pack.bodyClass : THEME_PACKS.slate.bodyClass;

  // Article prose color family (ok to vary by theme in both modes; change if you want neutral):
  const content = document.getElementById('content');
  content.className = `prose ${pack.proseClass} dark:prose-invert max-w-none`;

  // Persist choice (used when you return to dark)
  try { localStorage.setItem('colorScheme', themeKey); } catch(_){}
}



      // Initialize from localStorage
      let currentThemeIndex = 0;
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && THEME_PACKS[saved]) currentThemeIndex = availableThemes.indexOf(saved);
      } catch(_) {}

      // ===== Color Scheme Toggle =====
const colorBtn = document.getElementById('colorSchemeToggle');
colorBtn?.addEventListener('click', () => {
  const root = document.documentElement;

  // If we're in LIGHT mode, switch to DARK and stop here (do NOT cycle color yet)
  if (!root.classList.contains('dark')) {
    root.classList.add('dark');
    try { localStorage.setItem('theme','dark'); } catch(_){}
    document.getElementById('themeToggle')?.setAttribute('aria-pressed','true');
    return; // first click behaves like the theme toggle only
  }

  // Already DARK: now cycle to the next color scheme
  currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
  const newTheme = availableThemes[currentThemeIndex];
  applyTheme(newTheme);

  // Rebuild TOC (keeps hover styles consistent with the new scheme)
  buildTOC();
});


      // ===== Theme (dark/light) Handling =====
const themeBtn = document.getElementById('themeToggle');
if (themeBtn) {
  themeBtn.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')));
}
themeBtn?.addEventListener('click', () => {
  const root = document.documentElement;
  const isDark = root.classList.toggle('dark');
  try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){}
  themeBtn.setAttribute('aria-pressed', String(isDark));

  if (!isDark) {
    // Going to LIGHT → always neutralize to slate
    root.classList.remove('theme-emerald');
    try { localStorage.setItem('colorScheme','slate'); } catch(_){}
    applyTheme('slate');
  } else {
    // Back to DARK → reapply saved (or default) color
    let saved = 'slate';
    try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
    applyTheme(saved);
  }
  buildTOC();
});

try {
  const mq = matchMedia('(prefers-color-scheme: dark)');
  const onChange = (e) => {
    if (!localStorage.getItem('theme')) { // only if user hasn't forced a theme
      const isDark = e.matches;
      const root = document.documentElement;
      root.classList.toggle('dark', isDark);
      themeBtn?.setAttribute('aria-pressed', String(isDark));

      if (!isDark) {
        root.classList.remove('theme-emerald');
        try { localStorage.setItem('colorScheme','slate'); } catch(_){}
        applyTheme('slate');
      } else {
        let saved = 'slate';
        try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
        applyTheme(saved);
      }
      buildTOC();
    }
  };
  if (mq.addEventListener) mq.addEventListener('change', onChange);
  else if (mq.addListener) mq.addListener(onChange); // Safari <14
} catch (_) {}

      // ===== Expand/Collapse Functionality =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      // ===== Add Back to Top Links =====
      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      // ===== Build Table of Contents =====
      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          if (!h.id) h.id = slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      buildTOC();

      // ===== Build Timeline from Metadata =====
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }

        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];

        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );

        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      // ===== Search Highlighter =====
      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        const content = document.getElementById('content');
        if (!input || !content) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            content.innerHTML = originalHTML; 
            buildTOC(); 
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = content.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          content.innerHTML = content.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();

      // ===== Apply initial theme pack to prose =====
      try {
        const saved = localStorage.getItem('colorScheme');
        applyTheme(saved && THEME_PACKS[saved] ? saved : 'slate');
      } catch(_){
        applyTheme('slate');
      }
    });
  </script>
</body>
</html>

