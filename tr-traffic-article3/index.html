<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Threaded Reader</title>

  <!-- Prepaint bootstrap: set dark + theme class before paint to avoid flicker -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');       // 'light' | 'dark' | null
      const savedColor = localStorage.getItem('colorScheme'); // 'slate' | 'emerald' | future
      const isDark = savedTheme !== 'light';                  // default to dark if unset
      root.classList.toggle('dark', isDark);
      // Apply colored theme classes ONLY in dark mode; light is always neutral slate
      root.classList.toggle('theme-emerald', isDark && savedColor === 'emerald');
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
  :root { color-scheme: light dark; }
  html { scroll-behavior: smooth; }
  .font-newspaper { font-family: 'Lora', serif; }
  :where(h2,h3,h4){ scroll-margin-top: 84px; }
  mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
  @media (max-width: 380px){ .prose { font-size: .96rem; } }

  /* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  /* give the header an explicit base fill so gradient blends to the right hue */
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.border-var { border-color: var(--border) !important; }
.surface { border-width: 1px; border-style: solid; border-color: var(--border); }
.hr-var { border-color: var(--border); }
.subtitle { color: var(--subtitle-fg); }
.timeline-fg { color: var(--timeline-fg); }
.footer-note { color: var(--footer-fg); }
.active-link { color: var(--active); font-weight: 700; }

.input-surface {
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
}
.btn-surface { border: 1px solid var(--btn-border); }
.btn-surface:hover { background: var(--btn-hover-bg); }
.toc-link:hover { background: var(--hover-bg); }

/* ---------- Slate (default) variables ---------- */
:root{
  /* accents / inks */
  --active: rgb(59,130,246);                      /* sky-500 */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(100,116,139);                /* slate-500 */
  --footer-fg: rgb(100,116,139);                  /* slate-500 */

  /* surfaces */
  --border: rgb(226,232,240);                     /* slate-200 */
  --hover-bg: rgb(248,250,252);                   /* slate-50 */
  --btn-border: rgb(203,213,225);                 /* slate-300 */
  --btn-hover-bg: rgb(248,250,252);               /* slate-50 */
  --input-border: rgba(203,213,225,0.7);          /* slate-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* hero base & gradient (light) */
  --hero-base: transparent;                       /* keep light header airy */
  --hero-r1: rgba(49,46,129,.12);                 /* indigo-700 */
  --hero-r2: rgba(234,88,12,.12);                 /* orange-600 hint */
  --hero-wash: rgba(14,165,233,.08);              /* sky-500 wash */
}
.dark{
  --subtitle-fg: rgb(203,213,225);                /* slate-300 */
  --timeline-fg: rgb(148,163,184);                /* slate-400 */
  --footer-fg: rgb(148,163,184);                  /* slate-400 */

  --border: rgb(30,41,59);                        /* slate-800 */
  --hover-bg: rgb(15,23,42);                      /* slate-900 */
  --btn-border: rgb(51,65,85);                    /* slate-700 */
  --btn-hover-bg: rgb(15,23,42);                  /* slate-900 */
  --input-border: rgba(51,65,85,0.7);             /* slate-700/70 */
  --input-bg: rgba(2,6,23,0.6);                   /* slate-950/60 */

  /* hero base & gradient (dark) */
  --hero-base: rgb(2,6,23);                       /* slate-950 */
  --hero-r1: rgba(49,46,129,.12);
  --hero-r2: rgba(234,88,12,.12);
  --hero-wash: rgba(14,165,233,.08);
}

/* ---------- Emerald theme overrides (light & dark) ---------- */
.theme-emerald{
  --active: #10b981;                              /* emerald-500 */

  --border: rgb(187,247,208);                     /* emerald-200 */
  --hover-bg: rgb(240,253,244);                   /* emerald-50 */
  --btn-border: rgb(187,247,208);                 /* emerald-200 */
  --btn-hover-bg: rgb(240,253,244);               /* emerald-50 */
  --input-border: rgba(110,231,183,0.7);          /* emerald-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* keep subtitles/timeline neutral for readability over hero */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(71,85,105);                  /* slate-600 */
  --footer-fg: rgb(16,185,129);                   /* emerald-500 */

  /* hero base & gradient (emerald light) */
  --hero-base: transparent;
  --hero-r1: rgba(16,185,129,.14);                /* emerald-500 */
  --hero-r2: rgba(163,230,53,.12);                /* lime-400 */
  --hero-wash: rgba(5,150,105,.10);               /* emerald-600 wash */
}
.dark.theme-emerald{
  /* ↑ Give borders enough contrast on dark emerald surfaces */
  --border: rgba(110,231,183,0.55);                /* emerald-300 @ 55% */
  --hover-bg: rgb(6,78,59);                        /* emerald-900 */
  --btn-border: rgba(110,231,183,0.45);            /* slightly softer than borders */
  --btn-hover-bg: rgb(6,78,59);                    /* emerald-900 */
  --input-border: rgba(110,231,183,0.55);          /* match border contrast */
  --input-bg: rgba(6,95,70,0.60);                  /* emerald-900/60 */

  /* text accents for readability */
  --footer-fg: rgb(110,231,183);                   /* emerald-300/400 */
  --subtitle-fg: rgb(226,252,236);                 /* emerald-100 */
  --timeline-fg: rgb(187,247,208);                 /* emerald-200 */

  /* hero base & gradient (unchanged, stays emerald) */
  --hero-base: rgb(2,44,34);                       /* emerald-950 (#022c22) */
  --hero-r1: rgba(16,185,129,.14);
  --hero-r2: rgba(163,230,53,.12);
  --hero-wash: rgba(5,150,105,.10);
}

</style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">



  <!-- Header -->
  <header id="top" class="hero border-b border-var">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="subtitle text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl input-surface px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg btn-surface">Clear</button>
        <button id="colorSchemeToggle" type="button" class="inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Change color scheme">
          <span class="inline md:hidden">Colors</span>
          <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
            <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
            <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
            <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 7.012 17.461 2 12 2z"/>
          </svg>
        </button>
        <button id="themeToggle" type="button" class="inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Toggle dark mode" aria-pressed="false">
          <span class="inline md:hidden">Theme</span>
          <svg aria-hidden="true" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg aria-hidden="true" class="w-5 h-5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </div>

    <!-- Timeline -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="timeline-fg">
        <ol id="timeline" class="grid grid-cols-3 sm:grid-cols-6 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl surface p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 hr-var" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg btn-surface">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg btn-surface">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- DROP ARTICLE HERE -->

<article class="rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <meta name="doc-title" content="Methodology & Data for Studying Sudden Traffic Jams">
  <meta name="doc-subtitle" content="Research framework, data sources, and analytical methods for detecting and measuring traffic collapse">
  <meta name="timeline-steps" content="data-sources,variables-definitions,estimating-the-traffic-curve,detecting-sudden-jams-step-by-step,validation-examples,what-the-metrics-mean,limitations-assumptions,takeaway">
  <meta name="timeline-labels" content="Data Sources,Variables,Traffic Curve,Detection,Validation,Metrics,Limitations,Takeaway">

  <h2>Data Sources</h2>
  <p>The study on sudden traffic jams leverages two distinct datasets to analyze congestion phenomena. The <strong>New York City Department of Transportation (NYCDOT) data</strong> provides detailed, minute-by-minute traffic information obtained from loop detectors across 153 road segments in New York City. This fine-grained data, including average vehicular speed and travel time, is particularly suitable for observing the rapid emergence of sudden jams within short timeframes.</p>
  
  <p>Complementing this, <strong>Uber Movements Speed Data</strong> offers hourly average speeds for road segments in Nairobi, New York City, and São Paulo. This extensive dataset, spanning from January 2018 to March 2020, allows for broader analysis of jam occurrences and their durations across multiple urban environments. Each road segment in the Uber dataset corresponds to a specific way in OpenStreetMap.</p>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Variables & Definitions</h2>
  <p>Central to understanding traffic flow are key variables and their definitions. <strong>Traffic density</strong>, also referred to as <strong>buffer size</strong>, quantifies the proportion of a road segment's capacity occupied by vehicles. The <strong>exit rate</strong>, or <strong>exit capacity</strong>, denotes the number of vehicles capable of leaving a segment per unit of time. These variables are integral to constructing the <strong>traffic curve</strong>, which illustrates how the exit rate varies with traffic density.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Jam type definitions</summary>
    <div class="pt-2">
      <p>The research distinguishes between two types of jams based on data resolution. A <strong>sudden traffic jam</strong> describes a rapid collapse in traffic flow, typically occurring within minutes, triggered by a sudden increase in vehicle density that pushes speeds to drop sharply. This definition is applied to high-resolution data. For hourly data, a <strong>slowdown jam</strong> is identified when the average segment speed falls below a specific threshold determined from statistical analysis of speed distributions.</p>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Estimating the Traffic Curve</h2>
  <p>Given that fine-grained flow and density information is often unavailable, the study develops a method to <strong>estimate the traffic curve using only observed speed data</strong>. This curve visually represents the relationship between traffic density and exit rate, highlighting how a road segment's capacity changes based on the number of vehicles present.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Three regions of the traffic curve</summary>
    <div class="pt-2">
      <p>The curve is conceptualized into three distinct regions:</p>
      <ul>
        <li><strong>Free-flow region:</strong> where traffic moves unimpeded</li>
        <li><strong>Spiraling region:</strong> where the exit rate rapidly decreases as density increases</li>
        <li><strong>Jam region:</strong> characterized by vehicles moving at a very slow, constant speed or being at a standstill</li>
      </ul>
      
      <p>The free-flow region is modeled based on vehicle spacing, accounting for human reaction time and braking distance. The jam region is assumed to begin at a specific high occupancy (e.g., 66% of the road occupied) and near-zero speed. The study hypothesizes that the transition from free-flow to the unstable spiraling region occurs around a specific speed value, referred to as 's1', identified from cumulative speed distributions.</p>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Detecting Sudden Jams (Step-by-Step)</h2>
  <p>The study employs distinct step-by-step methodologies for identifying jams based on data resolution:</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Minute-resolution data detection (NYCDOT)</summary>
    <div class="pt-2">
      <p>For <strong>sudden jams</strong> detection:</p>
      <ul>
        <li><strong>Data Filtering:</strong> Only segments with reliable, frequent reporting (e.g., less than 90 seconds average reporting time) and complete data within defined analysis windows are used.</li>
        <li><strong>Defining Time Windows:</strong> For each segment, specific "observation," "prediction," and "target" time intervals are established to compare speeds across time.</li>
        <li><strong>Calculating Speed Change:</strong> A measure of "acceleration" (or deceleration) is computed by comparing the average speed in the target window to the average speed in the observation window.</li>
        <li><strong>Threshold Application:</strong> An event is classified as a sudden jam if the calculated "acceleration" falls below or equals a specific negative threshold (e.g., -0.002), indicating a rapid decrease in speed.</li>
      </ul>
    </div>
  </details>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Hourly-resolution data detection (Uber Movements)</summary>
    <div class="pt-2">
      <p>For <strong>slowdown jams</strong> identification:</p>
      <ul>
        <li><strong>Data Preparation:</strong> Hourly speed time-series data is sampled using a Poisson distribution to remove temporal correlations, ensuring reliable speed distribution curves.</li>
        <li><strong>Speed Distribution Analysis:</strong> A cumulative distribution of observed average speeds is plotted for each segment.</li>
        <li><strong>Identifying Break Points:</strong> For segments showing a typical S-shaped speed distribution (about 90% of cases), two "break points," 's1' and 's2', are identified by fitting a piecewise linear function.</li>
        <li><strong>Threshold Classification:</strong> A slowdown jam is recorded when the mean segment speed drops below the threshold calculated as <code>(s1 + s2) / 4</code>.</li>
      </ul>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Validation & Examples</h2>
  <p>The developed methodologies undergo validation and are demonstrated with real-world examples. A significant correlation of 67.38% was found between occurrences of <strong>slowdown jams</strong> (identified from hourly NYCDOT data) and underlying <strong>sudden jams</strong> (identified from minute-level NYCDOT data) in the corresponding hours.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Cross-city analysis findings</summary>
    <div class="pt-2">
      <p>Cross-city analysis using Uber data provides compelling insights. Nairobi was found to experience approximately three times the mean jam time per road segment daily compared to New York City and São Paulo. While São Paulo and New York City exhibited similar late-night congestion patterns, Nairobi's jams were concentrated in the afternoon. Although most jams in all three cities lasted only one hour, New York City had the highest proportion of jams extending beyond an hour.</p>
      
      <p>Specific junction examples in Nairobi, particularly highway merges, illustrated prolonged congestion events lasting two to three hours. Travel time impact analysis showed that under jam conditions, travel times could increase by up to tenfold on specific segments, and for over 50% of source-destination pairs, travel time increased by more than 50%.</p>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>What the Metrics Mean</h2>
  <p>The study produces key metrics to quantify the impact of sudden traffic jams:</p>
  <ul>
    <li><strong>Mean jam time per road segment</strong> measures the average daily hours a specific segment is congested, indicating the chronic burden on commuters and the road network.</li>
    <li><strong>Total jam hours</strong> represents the aggregate time lost due to congestion across all affected segments.</li>
    <li><strong>Number of slowdown jams observed</strong> reflects the frequency of these critical events.</li>
    <li><strong>Average speed decrease</strong> during congestion directly quantifies the reduction in vehicular speeds, which translates into increased travel time and reduced efficiency.</li>
    <li><strong>Travel time increase</strong> measures the additional time journeys require due to jams, serving as a direct indicator of travel reliability and personal cost to travelers.</li>
  </ul>
  
  <p>The 's1' speed, identified from speed distributions, signifies a crucial <strong>phase-transition point</strong> where traffic flow becomes unstable and susceptible to collapse into a jam.</p>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Limitations & Assumptions</h2>
  <p>The research acknowledges several inherent limitations and assumptions. The <strong>hourly granularity of the Uber Movements data</strong> prevents direct application of the formal, minute-by-minute sudden jam definition, necessitating the use of the slowdown jam heuristic. The NYCDOT data, despite its high resolution, is affected by <strong>missing measurements</strong> due to periodic system downtime and varying reporting reliability across segments.</p>
  
  <details class="mt-4">
    <summary class="font-semibold cursor-pointer">Traffic curve estimation assumptions</summary>
    <div class="pt-2">
      <p>For estimating the traffic curve, assumptions include:</p>
      <ul>
        <li>Drivers maintaining consistent spacing and speeds, following a car-following model</li>
        <li>Roads being simplified as single-lane, single-direction segments without overtaking</li>
        <li>A fixed jam density of 66% road occupancy</li>
        <li>The hypothesis that the 's1' speed value represents the transition point from free-flow to the unstable spiraling phase</li>
      </ul>
      
      <p>Additionally, historical Uber data validation against other sources like Google Maps faces challenges due to differing data collection methods and the assumption that traffic patterns remain constant over extended periods.</p>
    </div>
  </details>
</article>

<article class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6">
  <h2>Takeaway</h2>
  <p>This research establishes a comprehensive framework for understanding and detecting sudden traffic jams, distinguishing them from ordinary congestion. By utilizing both high-resolution loop detector data and large-scale hourly speed datasets, the study provides valuable insights into the characteristics and widespread impact of these jams across diverse urban settings. The methodologies, though incorporating necessary assumptions due to data limitations, offer effective tools for identifying critical thresholds in traffic behavior. The findings underscore the significant costs of sudden jams, including increased travel time and reduced quality of life, emphasizing the urgent need for smart traffic management strategies.</p>
</article>

      <!-- DO NOT PASTE ANYTHING AFTER THIS POINT -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs footer-note">
    Threaded Reader — a single-file template
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from Content =====
      const firstArticle = document.querySelector('#content article');
      const docTitle = firstArticle?.querySelector('meta[name="doc-title"]')?.content || 'Untitled Document';
      const docSubtitle = firstArticle?.querySelector('meta[name="doc-subtitle"]')?.content || '';
      const timelineStepsData = firstArticle?.querySelector('meta[name="timeline-steps"]')?.content;
      const timelineLabelsData = firstArticle?.querySelector('meta[name="timeline-labels"]')?.content;

      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle; // Also update browser tab title

      // ===== Theme packs: only control article "prose-*" family
      // ===== Theme packs: control article prose family AND base <body> ink/background
const THEME_PACKS = {
  slate: {
    proseClass: 'prose-slate',
    bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
  },
  emerald: {
    proseClass: 'prose-emerald',
    bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
  }
};
const availableThemes = Object.keys(THEME_PACKS);


function applyTheme(themeKey){
  const root = document.documentElement;
  const isDark = root.classList.contains('dark');

  const THEME_PACKS = {
    slate: {
      proseClass: 'prose-slate',
      bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
    },
    emerald: {
      proseClass: 'prose-emerald',
      bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
    }
  };

  const pack = THEME_PACKS[themeKey] || THEME_PACKS.slate;

  // Color theme classes only attach in DARK; LIGHT is always neutral slate
  root.classList.toggle('theme-emerald', isDark && themeKey === 'emerald');

  // Body ink/background:
  document.body.className = isDark ? pack.bodyClass : THEME_PACKS.slate.bodyClass;

  // Article prose color family (ok to vary by theme in both modes; change if you want neutral):
  const content = document.getElementById('content');
  content.className = `prose ${pack.proseClass} dark:prose-invert max-w-none`;

  // Persist choice (used when you return to dark)
  try { localStorage.setItem('colorScheme', themeKey); } catch(_){}
}



      // Initialize from localStorage
      let currentThemeIndex = 0;
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && THEME_PACKS[saved]) currentThemeIndex = availableThemes.indexOf(saved);
      } catch(_) {}

      // ===== Color Scheme Toggle =====
const colorBtn = document.getElementById('colorSchemeToggle');
colorBtn?.addEventListener('click', () => {
  const root = document.documentElement;

  // If we're in LIGHT mode, switch to DARK and stop here (do NOT cycle color yet)
  if (!root.classList.contains('dark')) {
    root.classList.add('dark');
    try { localStorage.setItem('theme','dark'); } catch(_){}
    document.getElementById('themeToggle')?.setAttribute('aria-pressed','true');
    return; // first click behaves like the theme toggle only
  }

  // Already DARK: now cycle to the next color scheme
  currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
  const newTheme = availableThemes[currentThemeIndex];
  applyTheme(newTheme);

  // Rebuild TOC (keeps hover styles consistent with the new scheme)
  buildTOC();
});


      // ===== Theme (dark/light) Handling =====
const themeBtn = document.getElementById('themeToggle');
if (themeBtn) {
  themeBtn.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')));
}
themeBtn?.addEventListener('click', () => {
  const root = document.documentElement;
  const isDark = root.classList.toggle('dark');
  try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){}
  themeBtn.setAttribute('aria-pressed', String(isDark));

  if (!isDark) {
    // Going to LIGHT → always neutralize to slate
    root.classList.remove('theme-emerald');
    try { localStorage.setItem('colorScheme','slate'); } catch(_){}
    applyTheme('slate');
  } else {
    // Back to DARK → reapply saved (or default) color
    let saved = 'slate';
    try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
    applyTheme(saved);
  }
  buildTOC();
});

try {
  const mq = matchMedia('(prefers-color-scheme: dark)');
  const onChange = (e) => {
    if (!localStorage.getItem('theme')) { // only if user hasn't forced a theme
      const isDark = e.matches;
      const root = document.documentElement;
      root.classList.toggle('dark', isDark);
      themeBtn?.setAttribute('aria-pressed', String(isDark));

      if (!isDark) {
        root.classList.remove('theme-emerald');
        try { localStorage.setItem('colorScheme','slate'); } catch(_){}
        applyTheme('slate');
      } else {
        let saved = 'slate';
        try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
        applyTheme(saved);
      }
      buildTOC();
    }
  };
  if (mq.addEventListener) mq.addEventListener('change', onChange);
  else if (mq.addListener) mq.addListener(onChange); // Safari <14
} catch (_) {}

      // ===== Expand/Collapse Functionality =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      // ===== Add Back to Top Links =====
      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      // ===== Build Table of Contents =====
      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          if (!h.id) h.id = slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      buildTOC();

      // ===== Build Timeline from Metadata =====
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }

        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];

        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );

        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      // ===== Search Highlighter =====
      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        const content = document.getElementById('content');
        if (!input || !content) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            content.innerHTML = originalHTML; 
            buildTOC(); 
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = content.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          content.innerHTML = content.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();

      // ===== Apply initial theme pack to prose =====
      try {
        const saved = localStorage.getItem('colorScheme');
        applyTheme(saved && THEME_PACKS[saved] ? saved : 'slate');
      } catch(_){
        applyTheme('slate');
      }
    });
  </script>
</body>
</html>

