<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Adaptive Reader</title>

  <!-- Tailwind + typography -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>

  <!-- Optional BLB tagger (safe to leave in) -->
  <script src="https://www.blueletterbible.org/scripts/blbToolTip/BLB_ScriptTagger-min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
    /* Typography */
    .font-newspaper{font-family:'Lora',serif}
    .font-dark-theme{font-family:'Lora',serif}
    body{transition:background-color .3s,color .3s}
    .prose h1{min-height:7.5rem}

    /* Light */
    .newspaper-theme{background:#fdfdfd;color:#1a1a1a}
    .newspaper-theme .nav-button{background:#f8f9fa;border:1px solid #dee2e6;color:#212529}
    .newspaper-theme .nav-button:hover{background:#e9ecef}
    .newspaper-theme .nav-button.active{background:#1a1a1a;color:#fdfdfd}

    /* Dark */
    .dark-theme{background:#2d2d30;color:#fff}
    .dark-theme .nav-button{background:#3c3c3c;border:1px solid #4a4a4a;color:#ccc}
    .dark-theme .nav-button:hover{background:#4a4a4a}
    .dark-theme .nav-button.active{background:#fff;color:#2d2d30}

    /* Shared */
    .nav-container{margin-bottom:2rem}
    .nav-button{padding:.5rem 1rem;margin:.5rem .5rem .5rem 0;border-radius:.375rem;transition:all .2s;cursor:pointer}
    #library-switcher,#topic-switcher{padding:.5rem;border-radius:.375rem;margin-bottom:1rem;width:100%;border:1px solid #ccc}
    .nav-buttons-wrapper{display:flex;flex-wrap:wrap;align-items:center;width:100%}
    .flex-break{flex-basis:100%;height:0}
  </style>
</head>
<body class="font-newspaper newspaper-theme">  
  <script id="embedded-content" type="application/json">
{
  "inadequacy-of-mere-theory-and-primacy-of-story": {
    "display_order": 10,
    "title": "Lewis - The Inadequacy of Mere Theory & the Primacy of Story",
    "description": "This topic explores C.S. Lewis's foundational argument that the reality of the Atonement is infinitely more important than any single theological theory explaining it. It presents his concept of Christianity as the 'True Myth'—a story that, unlike pagan myths, actually entered history as fact, fulfilling universal human longings.",
    "categories": {
      "rejecting-systematic-reduction": {
        "display_order": 10,
        "name": "Rejecting Systematic Reduction of Mystery",
        "display_name": "Rejecting Reductionism",
        "introduction": "This section details Lewis's caution against reducing the mystery of the Atonement to a single systematic theory. He critiques simplistic 'police-court' analogies and emphasizes that the various biblical metaphors are partial glimpses of a reality that transcends any one explanation.",
        "paragraphs": [
          {
            "heading": "Not just an attribute, but God's essence",
            "content": "The central Christian belief is that Christ's death has somehow put us right with God and given us a fresh start. But theories as to how it did this are another matter entirely. A man can eat his dinner without understanding exactly how food nourishes him, and a man can accept what Christ has done without knowing how it works. The thing itself is infinitely more important than any explanations theologians have produced. We must never confuse the reality with our fumbling attempts to describe it."
          },
          {
            "heading": "Critique of 'police-court' mentality reducing divine action to legal transactions",
            "content": "The notion that God wanted to punish men but Christ volunteered to be punished instead seems, on the face of it, rather silly. If God was prepared to let us off, why on earth did He not do so? What possible point could there be in punishing an innocent person? This way of thinking reduces the cosmic drama to a courtroom transaction, missing entirely the deeper magic at work. Divine love operates by principles far more profound than human jurisprudence, principles that transform rather than merely acquit."
          },
          {
            "heading": "Multiple biblical metaphors as partial glimpses",
            "content": "The ideas of sacrifice, ransom, championship over death, and substitution are all images to suggest the reality of the atonement, not scientific definitions that contain and limit the truth. To fix on any one of them as if it were the complete explanation would be a mistake. Like a jewel held to the light, the mystery reveals different faces from different angles, each catching something true but none exhausting the brilliance. Scripture offers us a symphony of metaphors because no single instrument could play the full melody of redemption."
          }
        ]
      },
      "christianity-as-true-myth": {
        "display_order": 20,
        "name": "Christianity as 'True Myth' Rather Than Proposition",
        "display_name": "Christianity as True Myth",
        "introduction": "This section introduces Lewis's concept of Christianity as the 'True Myth.' It argues that myth is a primary vehicle for truth and that universal patterns of a dying and rising god in pagan stories were foreshadowings of the ultimate reality that became historical fact in Jesus Christ.",
        "paragraphs": [
          {
            "heading": "Myth as the vehicle of deepest truth",
            "content": "Myth is the mountain whence all the different streams arise which become truths down here in the valley of abstraction. What flows into you from myth is not truth but reality itself, for truth is always about something, but reality is that about which truth is. Every myth becomes the father of innumerable truths on the abstract level, but myth itself transcends thought just as incarnation transcends myth. The deepest things cannot be captured in propositions but only in stories that awaken the heart to recognize what it has always known."
          },
          {
            "heading": "Universal patterns in dying/rising god myths point toward ultimate reality",
            "content": "The old myth of the dying god appears in cultures across the world not by accident but by design. These stories are God expressing Himself through the minds of poets, using such images as He found there, preparing the human heart to recognize the True Myth when it arrived. Like shadows cast before the rising sun, these tales whispered of a coming reality. When the Word became flesh, He did not contradict these ancient longings but fulfilled them, being what they had always pointed toward—the Dying God who actually died and rose again."
          },
          {
            "heading": "The Incarnation as 'myth became fact'",
            "content": "The heart of Christianity is a myth which is also a fact. The old myth of the dying god, without ceasing to be myth, comes down from the heaven of legend and imagination to the earth of history. It happens at a particular date, in a particular place, followed by definable historical consequences. We pass from a Balder or an Osiris, dying nobody knows when or where, to a historical person crucified under Pontius Pilate. The eternal pattern that human hearts recognized in story has stepped into time itself."
          },
          {
            "heading": "God expressing Himself through 'real things' rather than human imagination alone",
            "content": "The pagan stories are God expressing Himself through the minds of poets, using such images as He found there, while Christianity is God expressing Himself through what we call real things. Therefore it is true, not in the sense of being a description of God—that no finite mind could take in—but in the sense of being the way in which God chooses to appear to our faculties. The actual incarnation, crucifixion, and resurrection are God's own language, more adequate than any human words, spoken in the grammar of history itself."
          }
        ]
      }
    }
  },
  "the-deeper-magic-divine-love-transcending-justice": {
    "display_order": 20,
    "title": "Lewis - The 'Deeper Magic' - Divine Love Transcending Justice",
    "description": "This topic uses the central metaphor from Narnia to explain the Atonement. It contrasts the 'Deep Magic' of inviolable divine justice with the 'Deeper Magic' of self-sacrificial love, arguing that Christ's sacrifice doesn't break the law but fulfills it in a transformative way, enabling our participation in the divine life.",
    "categories": {
      "stone-table-and-deep-magic": {
        "display_order": 10,
        "name": "The Stone Table and Deep Magic as Divine Law",
        "display_name": "Deep Magic as Law",
        "introduction": "Using the metaphor of the Stone Table from Narnia, this section explores the concept of 'Deep Magic'—an inviolable justice woven into creation's fabric. This law gives evil a rightful claim on traitors, establishing a debt that is owed not to the powers of evil, but to the cosmic moral order itself.",
        "paragraphs": [
          {
            "heading": "Justice woven into creation's fabric from 'before the Dawn of Time'",
            "content": "The Deep Magic was written on the Emperor's scepter when the world was first made, engraved upon the very throne of creation itself. This is not arbitrary law imposed from without, but the moral structure that holds reality together. Every traitor belongs to evil as lawful prey, for treachery carries within it the seeds of its own destruction. The Witch may claim her rights, but she claims them under a law greater than herself. What seems like cosmic tyranny is actually the foundation that makes freedom possible—for without justice, love itself would be meaningless."
          },
          {
            "heading": "The inescapable claim of righteousness upon traitorous humanity",
            "content": "The law written in stone cannot be broken without breaking the one who breaks it. Every human conscience bears witness to this truth, for we know instinctively that actions have consequences woven into the fabric of things. The traitor's blood becomes forfeit not through divine cruelty but through the inexorable logic of moral reality. To rebel against the good is to choose separation from the source of life itself. Even the White Witch, in all her malice, cannot manufacture rights she does not possess—she can only claim what justice itself demands."
          },
          {
            "heading": "Edmund's debt to the Emperor's justice, not merely the White Witch's power",
            "content": "When the Witch demands her due, she speaks not as sovereign but as hangman. The debt is owed to the Deep Magic itself, to the Emperor who wrote it before time began. Edmund's treachery has created a cosmic liability that must be satisfied, for the moral order of Narnia depends upon it. The Witch merely claims her role as executor of consequences, but the sentence comes from a throne far higher than hers. This distinction matters enormously—for it means the problem is not evil's strength but justice's claim, and only perfect justice can answer perfect justice."
          }
        ]
      },
      "deeper-magic-as-love": {
        "display_order": 20,
        "name": "Deeper Magic as Self-Sacrificial Love",
        "display_name": "Deeper Magic as Love",
        "introduction": "This section explains the 'Deeper Magic from before the Dawn of Time.' When a willing, innocent victim is killed in a traitor's place, a more profound cosmic principle is activated. This self-sacrificial love causes death itself to 'work backward,' revealing love's ultimate victory over mere justice.",
        "paragraphs": [
          {
            "heading": "Willing innocent substitution activating deeper cosmic principles",
            "content": "There is a magic deeper still which the Witch does not know, for her knowledge goes back only to the dawn of time. But this deeper magic reaches from before the dawn of time, written in a law more fundamental than justice itself. When a willing victim who has committed no treachery is killed in a traitor's stead, the Stone Table cracks and death itself begins working backward. Love, it seems, is the deepest law of all, and when perfectly expressed, it does not break justice but fulfills it in ways that transform the very meaning of law."
          },
          {
            "heading": "Death working backward when perfect love meets perfect justice",
            "content": "The moment Aslan's willing sacrifice satisfies the Deep Magic, something even more profound is unleashed. Death, having claimed its lawful victim, discovers it has overreached—for perfect innocence willingly offered creates a new category unknown to the old law. The Stone Table splits with the sound of a world being remade, and death finds itself cheated of its prey. What appeared to be love's defeat becomes its ultimate victory, for self-giving love proves mightier than the grave. The Deeper Magic reveals that the universe's deepest law is not retribution but redemption."
          },
          {
            "heading": "Victory through vulnerability - the 'eucatastrophe' of apparent defeat",
            "content": "The sudden joyous turn when all seems darkest—this is the pattern written into the very structure of reality. Aslan's death appears to be the triumph of evil, yet becomes the moment of its utter defeat. This unexpected reversal, this eucatastrophe, reflects something deeper than literary device—it reveals the way divine love operates in a fallen world. Victory comes not through superior force but through the willing embrace of weakness, proving that the first shall be last and the last first. Such topsy-turvy triumph can only be understood by those who grasp that love's logic runs contrary to power's arithmetic."
          },
          {
            "heading": "Resurrection as vindication of the deeper magic's supremacy",
            "content": "Aslan's return from death is not merely restoration but vindication—proof that love's law stands higher than justice's demand. The risen Lion bears the marks of his wounds not as badges of defeat but as evidence of victory won through sacrifice. Every scar proclaims that self-giving love cannot be conquered by evil, that the Deeper Magic has forever overthrown the tyranny of mere law. The resurrection demonstrates that God's love is not sentimental weakness but the strongest force in the universe, capable of transforming even death itself into a doorway to life."
          }
        ]
      },
      "transformation-through-participation": {
        "display_order": 30,
        "name": "Transformation Through Participation in Divine Death/Life",
        "display_name": "Participation & Transformation",
        "introduction": "This category explores the personal application of the Atonement. Through baptism, believers personally enter the cosmic story of Christ's death and resurrection. This participation allows the divine life (Zoe) to penetrate and gradually transform their natural life (Bios), turning them into 'little Christs' within the corporate body.",
        "paragraphs": [
          {
            "heading": "Baptism into Christ's death - joining the cosmic story personally",
            "content": "To be baptized is to go down into the waters of death with the true Aslan and rise with Him into newness of life. The cosmic drama becomes personal drama, the mythic pattern impressed upon individual experience. We do not merely observe the victory from afar but are swept up into it, becoming participants rather than spectators. Each believer re-enacts the fundamental story of the universe—death to self and resurrection to God. Through this sacred identification, the ancient pattern becomes as immediate as breath, as personal as heartbeat."
          },
          {
            "heading": "The Divine Life (Zoe) penetrating and transforming natural life (Bios)",
            "content": "There is the biological life we inherit from Adam and there is the uncreated spiritual life that proceeds from God Himself. When the second life penetrates the first, something unprecedented occurs—not replacement but transformation. Natural life becomes the vessel for supernatural life, like a wire carrying electric current or a garden receiving rain. This divine energy does not destroy our humanity but fulfills it, turning creatures into sons and daughters. The process is gradual but inexorable, working from within like leaven in bread."
          },
          {
            "heading": "Gradual metamorphosis from creature to 'son of God'",
            "content": "The transformation is not like teaching a horse to jump better but like turning a horse into a winged creature. God intends to make us into something we have never been—not improved humans but new kinds of beings altogether. The process will be long and in parts very painful, but the result will be creatures that can obey the command 'Be ye perfect' because they will have been given a perfect nature. We are being turned from tin soldiers into living men, from statues into children of the living God."
          },
          {
            "heading": "Corporate participation - the Church as 'little Christs' in formation",
            "content": "The Church exists for no other purpose than to draw men into Christ, to make them little Christs. If they are not doing that, all their social work and political activities are waste of time. God became Man for no other purpose than to turn creatures into sons, and the Church is His instrument for accomplishing this great work. Each member is meant to be a window through which the divine light shines, a note in the great symphony of redeemed creation. Together we form the Body through which the Head continues His saving work in the world."
          }
        ]
      }
    }
  },
  "literary-embodiment-and-imaginative-apologetics": {
    "display_order": 30,
    "title": "Lewis - Literary Embodiment & Imaginative Apologetics",
    "description": "This topic delves into Lewis's method of using literature, particularly the Chronicles of Narnia, as a form of imaginative apologetics. It shows how story can bypass intellectual defenses to communicate theological truth, making complex concepts like the Atonement accessible and emotionally resonant, thereby fulfilling humanity's deepest narrative longings.",
    "categories": {
      "narnia-as-theological-exploration": {
        "display_order": 10,
        "name": "Narnia as Theological Exploration",
        "display_name": "Narnia as Theology",
        "introduction": "This section examines how the Chronicles of Narnia function as a powerful theological exploration. Aslan's sacrifice serves as a concrete, mythic embodiment of the Atonement, while the character arcs of figures like Edmund and Eustace model the transformative purpose of grace beyond mere legal acquittal.",
        "paragraphs": [
          {
            "heading": "Aslan's sacrifice and resurrection as myth-made-concrete",
            "content": "The Lion's death reveals what has always been true about atonement—it is not God changing His mind about sinners but God revealing His heart toward them. Aslan does not die to persuade the Emperor to forgive Edmund; he dies because love itself demands the willing substitution of innocence for guilt. The Stone Table cracks not because a legal transaction is complete but because self-sacrificial love has activated deeper principles than law ever knew. In Edmund's place we see our place; in Aslan's willing death we glimpse the cosmic reality that innocence embraces guilt not from duty but from love. The resurrection follows as naturally as spring follows winter—for such love cannot be held by death."
          },
          {
            "heading": "Characters' transformation journeys as models of atonement's purpose",
            "content": "Edmund does not merely receive forgiveness—he becomes a different sort of person altogether, growing into the king he was meant to be. This is atonement's true goal: not legal acquittal but actual transformation of character through encounter with grace. Eustace's un-dragoning reveals the painful yet liberating process by which divine love strips away our false selves to reveal our true nature. Lucy's journey from trembling child to confident queen shows how trust in Aslan's goodness gradually transforms fear into faith. The children do not earn their thrones through good behavior but grow into their royal nature through relationship with the Lion who first loved them."
          },
          {
            "heading": "'Deeper magic' as accessible metaphor for grace beyond law",
            "content": "The White Witch knows the Deep Magic but remains ignorant of the Deeper Magic—just as legalistic religion grasps justice but misses grace. The cracking of the Stone Table demonstrates that love does not abolish law but fulfills it in ways unimaginable to mere jurisprudence. Atonement operates not by circumventing divine justice but by satisfying it through perfect love. The Deeper Magic shows that the universe runs not on the principle of strict exchange but on the principle of sacrificial gift. Where law demands payment, love provides it; where justice requires satisfaction, grace supplies it—not as contradiction but as completion."
          }
        ]
      },
      "power-of-secondary-creation": {
        "display_order": 20,
        "name": "The Power of Secondary Creation",
        "display_name": "Power of Story",
        "introduction": "This section explains Lewis's belief in the power of 'sub-creation' or storytelling. He argues that fantasy can serve as a potent vehicle for theological truth, bypassing intellectual and theological prejudices to baptize the imagination and allow the heart to recognize truth before the mind analyzes it.",
        "paragraphs": [
          {
            "heading": "Fantasy as vehicle for atonement truth",
            "content": "Story succeeds where doctrine fails because the heart recognizes truth before the mind can analyze it. A child weeping over Aslan's death has grasped something profound about the cost of redemption, something that might be missed entirely in theological discourse. The willing Lion's sacrifice communicates the voluntary nature of atonement more powerfully than any systematic explanation. Through narrative we see that God's love is not reluctant compassion overcome by Christ's intervention, but eager mercy seeking expression through willing sacrifice. The story baptizes our emotions as well as our intellects, teaching us to feel truly about divine love."
          },
          {
            "heading": "Imagination bypassing theological prejudices about atonement",
            "content": "Many reject the gospel because they have been taught to see atonement as divine child abuse or cosmic bookkeeping. But story can slip past these defensive misunderstandings to plant seeds of true comprehension. In Aslan's sacrifice, we see willing love rather than reluctant justice, eager gift rather than grudging payment. The imagination, properly instructed, becomes an ally to faith rather than its enemy. Through mythic narrative, the heart learns what the mind struggles to accept—that atonement springs from love's abundance, not from love's absence."
          }
        ]
      },
      "universal-appeal-through-mythic-truth": {
        "display_order": 30,
        "name": "Universal Appeal Through Mythic Truth",
        "display_name": "Universal Mythic Appeal",
        "introduction": "This section explores how Lewis uses archetypal patterns to give his apologetics a universal appeal. He contends that humanity tells similar stories of sacrifice and redemption everywhere because they echo the fundamental story of reality, making the Christian Atonement the ultimate fulfillment of every story worth telling.",
        "paragraphs": [
          {
            "heading": "Archetypal patterns pointing toward true atonement",
            "content": "Humanity tells the same story everywhere because it echoes the fundamental structure of moral reality. The tale of innocent suffering for the guilty, of love conquering death through apparent defeat—these are not cultural accidents but glimpses of the Truth that gives meaning to all partial truths. Every culture's stories of sacrificial heroes prepare the heart to recognize the ultimate Hero when He appears. The cross satisfies our deepest narrative longings not because we invented the pattern but because the pattern was written into creation before we learned to tell stories."
          },
          {
            "heading": "Atonement as the fulfillment of every story worth telling",
            "content": "The gospel is the eucatastrophe toward which all other stories point—the sudden joyous turn that makes sense of all previous sorrows. Every tale of love conquering hate, of light overcoming darkness, of sacrifice bringing victory, unconsciously echoes the central story of reality. Atonement is not one story among many but the Story that gives meaning to all others. When properly understood, it satisfies not only our need for forgiveness but our deepest aesthetic and narrative longings. Here is the happy ending that is both completely surprising and utterly inevitable—the ending every heart hopes for but hardly dares believe."
          }
        ]
      }
    }
  }
}
  </script>

  <!-- Theme toggle -->
  <div class="fixed top-4 right-4 z-50">
    <button id="theme-switcher-btn" class="p-2 rounded-full" aria-label="toggle theme">
      <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a5 5 0 100-10 5 5 0 000 10z"/></svg>
      <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
    </button>
  </div>

  <main id="app-container" class="prose dark:prose-invert mx-auto max-w-prose p-8"></main>

  <script>
    /* ---------- state ---------- */
    let masterLibrary=null,sortedLibraryIds=null,currentLibraryId=null
    let libraryData=null,sortedTopicIds=null,currentTopicId=null,currentArticleId=null
    const app=document.getElementById('app-container')

    /* ---------- helpers ---------- */
    const looksLikeTopic=o=>o&&typeof o==='object'&&('categories'in o||'title'in o)

    /* ---------- rendering ---------- */
    const buildLibrarySwitch=()=>!sortedLibraryIds||sortedLibraryIds.length<2?'':`
      <div class="nav-container">
        <select id="library-switcher" class="nav-button">
          ${sortedLibraryIds.map(id=>{
            const label=id.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase())
            return `<option value="${id}" ${id===currentLibraryId?'selected':''}>${label}</option>`
          }).join('')}
        </select>
      </div>`

    const buildTopicSwitch=()=>`
      <div class="nav-container">
        <select id="topic-switcher" class="nav-button">
          ${sortedTopicIds.map(tid=>{
            const t=libraryData[tid];return `<option value="${tid}" ${tid===currentTopicId?'selected':''}>${t.title}</option>`
          }).join('')}
        </select>
      </div>`

    const buildNav=(cats,keys)=>{
      let html='<div class="nav-container"><h3>Select Article:</h3><div class="nav-buttons-wrapper">'
      keys.forEach(k=>{
        const a=cats[k]
        html+=`<button class="nav-button article-btn ${k===currentArticleId?'active':''}" data-article-id="${k}">${a.display_name}</button>`
        if(a.breakAfter)html+='<div class="flex-break"></div>'
      })
      return html+'</div></div>'
    }

    function render(){
      if(!libraryData)return
      sortedTopicIds=Object.keys(libraryData).sort((a,b)=>(libraryData[a].display_order||0)-(libraryData[b].display_order||0))
      if(!currentTopicId||!libraryData[currentTopicId])currentTopicId=sortedTopicIds[0]
      const topic=libraryData[currentTopicId]
      const artKeys=Object.keys(topic.categories||{}).sort((a,b)=>(topic.categories[a].display_order||0)-(topic.categories[b].display_order||0))
      if(!currentArticleId||!topic.categories[currentArticleId])currentArticleId=artKeys[0]
      const art=topic.categories[currentArticleId]

      app.innerHTML=buildLibrarySwitch()+`<h1>${topic.title}</h1>`+buildTopicSwitch()+buildNav(topic.categories,artKeys)+
        `<h2>${art.name||art.display_name||''}</h2>${art.introduction?`<p>${art.introduction}</p>`:''}`+
        (art.paragraphs||[]).map(p=>`<h3>${p.heading}</h3><p>${p.content}</p>`).join('')
      document.title=topic.title||'Adaptive Reader'

      document.querySelectorAll('.article-btn').forEach(btn=>btn.onclick=e=>{
        currentArticleId=e.target.dataset.articleId;render()
      })
      const ts=document.getElementById('topic-switcher')
      if(ts)ts.onchange=e=>{currentTopicId=e.target.value;currentArticleId=null;render()}
      const ls=document.getElementById('library-switcher')
      if(ls)ls.onchange=e=>{
        currentLibraryId=e.target.value
        localStorage.setItem('readerLibraryId',currentLibraryId)
        libraryData=masterLibrary[currentLibraryId];currentTopicId=currentArticleId=null;render()
      }
    }

    /* ---------- data load ---------- */
    async function init(){
      let raw=null
      try{
        const res=await fetch('./data/content.json',{cache:'no-store'})
        if(!res.ok)throw new Error('not ok');raw=await res.json()
      }catch{
        const embedded=document.getElementById('embedded-content').textContent.trim()
        if(!embedded)throw new Error('no data');raw=JSON.parse(embedded)
      }

      const keys=Object.keys(raw)
      if(!keys.length)throw new Error('empty data')
      if(looksLikeTopic(raw[keys[0]])){
        masterLibrary=null;sortedLibraryIds=null;currentLibraryId=null
        libraryData=raw
      }else{
        masterLibrary=raw
        sortedLibraryIds=keys.sort()
        currentLibraryId=localStorage.getItem('readerLibraryId')
        if(!currentLibraryId||!masterLibrary[currentLibraryId])currentLibraryId=sortedLibraryIds[0]
        libraryData=masterLibrary[currentLibraryId]
      }
      currentTopicId=currentArticleId=null
      render()
    }

    /* ---------- theme ---------- */
    const themeBtn=document.getElementById('theme-switcher-btn')
    function applyTheme(t){
      const dark=t==='dark'
      document.documentElement.classList.toggle('dark',dark)
      document.body.classList.toggle('dark-theme',dark)
      document.body.classList.toggle('font-dark-theme',dark)
      document.body.classList.toggle('newspaper-theme',!dark)
      document.body.classList.toggle('font-newspaper',!dark)
      document.getElementById('sun-icon').classList.toggle('hidden',dark)
      document.getElementById('moon-icon').classList.toggle('hidden',!dark)
    }
    themeBtn.onclick=()=>{const t=document.documentElement.classList.contains('dark')?'light':'dark';localStorage.setItem('theme',t);applyTheme(t)}

    /* ---------- boot ---------- */
    document.addEventListener('DOMContentLoaded',()=>{
      applyTheme(localStorage.getItem('theme')||'light')
      init().catch(err=>{console.error(err);app.innerHTML='<h1>Error</h1><p>Could not load content.</p>'})
    })
  </script>
</body>
</html>
