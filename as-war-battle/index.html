<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Battle Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* DARK COMMAND CENTER THEME */
    :root{
      --bg:#0b1020; --panel:#111833; --ink:#e6ecff; --muted:#a7b0cc;
      --brand:#8bb9ff; --accent:#c0ffe1; --border:#26325b; --chip:#1a2347;
      --bad:#ff6b6b; --shadow:0 8px 28px rgba(0,0,0,.35);
      --radius:12px; --radius-sm:8px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 10% -5%, rgba(139,185,255,.20), transparent 55%),
                  radial-gradient(1000px 400px at 95% 10%, rgba(192,255,225,.18), transparent 60%), var(--bg);
      line-height:1.6; min-height:100vh; padding: 1rem;
      transition: --brand 0.5s ease;
    }
    .content-wrapper{ max-width:860px; margin:0 auto; }
    
    /* Navigation */
    .breadcrumb{ margin-bottom:1rem; font-size:.92rem; }
    .breadcrumb a{ color:var(--brand); text-decoration:none; transition:opacity 0.2s; }
    .breadcrumb a:hover { opacity: 0.8; }

    /* Typography */
    h1 { font-size: 2rem; font-weight: 700; color: var(--ink); margin-bottom: 0.5rem; line-height: 1.2; }
    .subtitle { color: var(--muted); font-style: italic; font-size: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1.5rem; }

    /* Accordion Sections */
    .section { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem; overflow: hidden; box-shadow: var(--shadow); transition: border-color 0.2s; }
    .section-header { 
        padding: 1.05rem 1.25rem; 
        background: linear-gradient(135deg,#1a2a6b 0%,#0f172a 100%); 
        color: var(--ink); 
        display: flex; justify-content: space-between; align-items: center; 
        cursor: pointer; border-bottom: 1px solid var(--border); user-select: none; 
    }
    .section-header h2 { font-size: 1.12rem; margin: 0; font-weight: 600; color: var(--brand); }
    .section-icon { font-size: 1.2rem; transition: transform 0.28s ease; }
    .section.active .section-icon { transform: rotate(180deg); }
    
    .section-content { max-height: 0; overflow: hidden; transition: max-height 0.38s ease; }
    .section.active .section-content { max-height: 5000px; border-top: 1px solid var(--border); }
    .section-inner { padding: 1.25rem; }

    /* List Items */
    .list-item { background: color-mix(in oklab,var(--chip) 75%,transparent); border-left: 3px solid var(--brand); padding: 1rem; margin-bottom: 0.75rem; border-radius: var(--radius-sm); border: 1px solid var(--border); color: var(--muted); }
    .list-item strong { color: var(--ink); display: block; margin-bottom: 0.2rem; }

    /* Timeline */
    .timeline { border-left: 3px solid var(--brand); padding-left: 1.25rem; margin-left: 0.5rem; }
    .timeline-item { position: relative; margin-bottom: 1.15rem; color: var(--muted); }
    .timeline-item::before { content: ''; position: absolute; left: -1.65rem; top: 0.4rem; width: 12px; height: 12px; border-radius: 50%; background: var(--brand); border: 3px solid var(--panel); box-shadow: 0 0 0 2px var(--brand); }
    .timeline-item strong { display: block; color: var(--brand); margin-bottom: 0.25rem; }

    /* Loading/Error States */
    .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; opacity: .5; pointer-events: none; }
    @keyframes pulse { 0%, 100% { opacity: .5; } 50% { opacity: .2; } }
    .denial-box { border: 1px dashed var(--bad); color: var(--bad); padding: 2rem; text-align: center; background: rgba(255, 107, 107, 0.05); border-radius: var(--radius); }
    
    .main-answer { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.25rem; border-left: 4px solid var(--brand); }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div class="breadcrumb">
      <a id="backLink" href="#">‚Üê Return to Hub</a>
    </div>

    <div id="reportContainer">
        <header>
          <h1 id="r-title">Initializing...</h1>
          <p id="r-subtitle" class="subtitle"></p>
        </header>

        <section class="main-answer">
          <h2 style="color:var(--brand); font-size:1.25rem; margin-bottom:.8rem">Executive Summary</h2>
          <p id="r-summary" style="color:var(--muted)">Accessing Archives...</p>
        </section>

        <section class="section" id="sec-context">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üéØ Strategic Context</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-context"></div>
          </div>
        </section>

        <section class="section" id="sec-overview">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>‚öîÔ∏è Combat Overview</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-overview"></div>
          </div>
        </section>

        <section class="section" id="sec-timeline">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üìú Timeline of Events</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner">
              <div class="timeline" id="r-timeline"></div>
            </div>
          </div>
        </section>

        <section class="section" id="sec-turning">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>‚ö° Turning Points</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-turning"></div>
          </div>
        </section>

        <section class="section" id="sec-outcomes">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üèÅ Outcomes & Legacy</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-outcomes"></div>
          </div>
        </section>

        <section class="section" id="sec-significance">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üè∞ Historical Significance</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-significance"></div>
          </div>
        </section>

        <section class="section" id="sec-sources">
          <div class="section-header" onclick="toggleSection(this)">
            <h2>üìö Sources</h2>
            <span class="section-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="section-inner" id="r-sources" style="font-size: 0.9rem; color: var(--muted);"></div>
          </div>
        </section>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const API_KEY = "AIzaSyBjL7zhEjoBgqCaXCxID3hV9KZNaPm5M8A"; 

    // --- UI HELPERS ---
    function toggleSection(header){
      const section = header.parentElement;
      section.classList.toggle('active');
    }

    // --- 1. CONTEXT EXTRACTION ---
    const urlParams = new URLSearchParams(window.location.search);
    const WAR_SLUG = urlParams.get('war');
    const RECORD_ID = urlParams.get('id');
    const QUERY_PARAM = urlParams.get('q');

    // Safety Check
    if (!WAR_SLUG) {
        alert("Missing War Context. Redirecting to War Room.");
        window.location.href='../as-war-room/index.html';
    }

    // Beautify the war name (e.g. "civil-war" -> "Civil War")
    const WAR_NAME = WAR_SLUG.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    
    // Set Dynamic App ID
    const APP_ID = `as-${WAR_SLUG}-data-`;

    // Update Back Link
    document.getElementById('backLink').innerText = `‚Üê Return to ${WAR_NAME} Hub`;
    document.getElementById('backLink').href = `../as-war-hub/index.html?war=${WAR_SLUG}`;

    // --- 2. INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        if (RECORD_ID) {
            const cached = localStorage.getItem(RECORD_ID);
            if(cached) renderReport(JSON.parse(cached));
        } else if (QUERY_PARAM) {
            handleRequest(QUERY_PARAM);
        }
    });

    // --- 3. HANDLER ---
    async function handleRequest(query) {
        // Generate a simplified key for this specific battle
        const simpleKey = query.toLowerCase().replace(/[^a-z0-9]/g, '');
        const fullKey = APP_ID + simpleKey;

        const cached = localStorage.getItem(fullKey);
        if (cached) {
            renderReport(JSON.parse(cached));
            return;
        }

        // Fetch
        const container = document.getElementById('reportContainer');
        container.classList.add('loading-pulse');
        document.getElementById('r-title').innerText = "Contacting War Room...";
        document.getElementById('r-subtitle').innerText = `Consulting ${WAR_NAME} Archives...`;

        try {
            const result = await fetchBattleData(query);
            result.timestamp = Date.now();
            localStorage.setItem(fullKey, JSON.stringify(result));
            renderReport(result);
        } catch(e) {
            document.getElementById('r-title').innerText = "Mission Failed";
            document.getElementById('r-subtitle').innerText = "Error: " + e.message;
        } finally {
            container.classList.remove('loading-pulse');
        }
    }

    // --- 4. AI PROMPT (AGNOSTIC + SNAPSHOT SCHEMA) ---
    async function fetchBattleData(query) {
        const prompt = `
            Role: Expert Military Historian.
            CONTEXT: You are analyzing the conflict known as: "${WAR_NAME}".
            QUERY: "${query}".

            Instructions:
            1. Analyze the query strictly within the context of ${WAR_NAME}.
            2. If the query is unrelated to ${WAR_NAME} (e.g. asking about "Tanks" in the "Civil War"), return a Denial.
            3. Typo Correction: Assume the user meant a battle/person within ${WAR_NAME}.

            Format: STRICT JSON (No markdown).
            
            Schema (Standard):
            {
                "isDenial": false,
                "title": "Formal Name",
                "subtitle": "Thematic Summary",
                "summary": "Overview paragraph (3-4 sentences).",
                "context": [{"label": "Header", "text": "Content"}],
                "overview": [{"label": "Label", "text": "Content"}],
                "timeline": [{"time": "Date/Time", "event": "Description"}],
                "turning_points": [{"label": "Point", "text": "Reason"}],
                "outcomes": [{"label": "Outcome", "text": "Detail"}],
                "significance": [{"label": "Legacy", "text": "Detail"}],
                "sources": {"primary": "List sources", "secondary": "List sources"}
            }

            Schema (Denial):
            {
                "isDenial": true,
                "title": "ACCESS DENIED",
                "subtitle": "Irrelevant Query",
                "summary": "This topic is outside the operational theater of the ${WAR_NAME}.",
                "context": [], "overview": [], "timeline": [], "turning_points": [], "outcomes": [], "significance": [],
                "sources": {"primary": "", "secondary": ""}
            }
        `;

        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            }
        );

        const data = await response.json();
        if(data.error) throw new Error(data.error.message);
        const rawText = data.candidates[0].content.parts[0].text;
        return JSON.parse(rawText);
    }

    // --- 5. RENDERER (SNAPSHOT UI) ---
    function renderReport(result) {
        const titleEl = document.getElementById('r-title');
        const subEl = document.getElementById('r-subtitle');

        // Handle Denials
        if (result.isDenial) {
            document.documentElement.style.setProperty('--brand', '#ff6b6b');
            titleEl.innerText = "ACCESS DENIED";
            subEl.innerText = result.subtitle;
            document.getElementById('r-summary').innerHTML = `<div class="denial-box">${result.summary}</div>`;
            // Hide accordions on denial
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            return;
        }

        // Handle Success
        document.documentElement.style.setProperty('--brand', '#8bb9ff');
        titleEl.innerText = result.title;
        subEl.innerText = result.subtitle;
        document.getElementById('r-summary').innerText = result.summary;

        // Reset visibility
        document.querySelectorAll('.section').forEach(el => el.style.display = 'block');

        // Render Lists
        renderList('r-context', result.context);
        renderList('r-overview', result.overview);
        renderTimeline('r-timeline', result.timeline);
        renderList('r-turning', result.turning_points);
        renderList('r-outcomes', result.outcomes);
        renderList('r-significance', result.significance);

        // Render Sources
        document.getElementById('r-sources').innerHTML = `
            <strong>Primary:</strong> ${result.sources.primary}<br><br>
            <strong>Secondary:</strong> ${result.sources.secondary}
        `;
        
        // Ensure closed state on load
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    }

    function renderList(id, items) {
        const el = document.getElementById(id);
        if (!items || items.length === 0) {
            el.innerHTML = '<div class="list-item">No data available.</div>';
            return;
        }
        el.innerHTML = items.map(i => `
            <div class="list-item"><strong>${i.label}:</strong> ${i.text}</div>
        `).join('');
    }

    function renderTimeline(id, items) {
        const el = document.getElementById(id);
        if (!items || items.length === 0) {
            el.innerHTML = '<div class="timeline-item">No timeline data available.</div>';
            return;
        }
        el.innerHTML = items.map(i => `
            <div class="timeline-item"><strong>${i.time}:</strong> ${i.event}</div>
        `).join('');
    }
  </script>
</body>
</html>
