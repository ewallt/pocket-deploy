<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Adaptive Reader</title>

  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>

  <script src="https://www.blueletterbible.org/scripts/blbToolTip/BLB_ScriptTagger-min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
    /* Typography */
    .font-newspaper{font-family:'Lora',serif}
    .font-dark-theme{font-family:'Lora',serif}
    body{transition:background .3s,color .3s}
    .prose h1{min-height:7.5rem}

    /* --- Classic Themes (Original) --- */
    .newspaper-theme{background:#fdfdfd;color:#1a1a1a}
    .newspaper-theme .nav-button{background:#f8f9fa;border:1px solid #dee2e6;color:#212529}
    .newspaper-theme .nav-button:hover{background:#e9ecef}
    .newspaper-theme .nav-button.active{background:#1a1a1a;color:#fdfdfd}

    .dark-theme{background:#2d2d30;color:#fff}
    .dark-theme .nav-button{background:#3c3c3c;border:1px solid #4a4a4a;color:#ccc}
    .dark-theme .nav-button:hover{background:#4a4a4a}
    .dark-theme .nav-button.active{background:#fff;color:#2d2d30}
    
    /* --- New Variable-Based Theme Engine --- */
    :root {
        --bg-gradient: #fdfdfd;
        --text: #1a1a1a;
        --accent-text: #1a1a1a;
        --nav-bg: #f8f9fa;
        --nav-border: #dee2e6;
        --nav-text: #212529;
        --nav-hover-bg: #e9ecef;
        --nav-active-bg: #1a1a1a;
        --nav-active-text: #fdfdfd;
    }
    
    .variable-theme {
        background: var(--bg-gradient);
        color: var(--text);
        font-family: 'Lora', serif;
    }
    .variable-theme .prose h1,
    .variable-theme .prose h2,
    .variable-theme .prose h3 {
        color: var(--accent-text);
    }
    .variable-theme .nav-button {
        background-color: var(--nav-bg);
        border: 1px solid var(--nav-border);
        color: var(--nav-text);
    }
    .variable-theme .nav-button:hover {
        background-color: var(--nav-hover-bg);
    }
    .variable-theme .nav-button.active {
        background-color: var(--nav-active-bg);
        color: var(--nav-active-text);
    }
    .variable-theme .nav-button.btn-dark-text.active,
    .variable-theme .nav-button.btn-dark-text:hover {
        color: var(--nav-active-text);
    }
    .variable-theme .nav-button.btn-light-text.active,
    .variable-theme .nav-button.btn-light-text:hover {
        color: var(--nav-active-text);
    }

    /* --- Shared & Modal Styles --- */
    .nav-container{margin-bottom:2rem}
    .nav-button{padding:.5rem 1rem;margin:.5rem .5rem .5rem 0;border-radius:.375rem;transition:all .2s;cursor:pointer}
    #library-switcher,#topic-switcher{padding:.5rem;border-radius:.375rem;margin-bottom:1rem;width:100%;border:1px solid #ccc}
    .nav-buttons-wrapper{display:flex;flex-wrap:wrap;align-items:center;width:100%}
    .flex-break{flex-basis:100%;height:0}

    .modal-overlay {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.6);
        justify-content: center; align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
        background: #fff; color: #2d2d30; padding: 2rem; border-radius: 8px;
        text-align: center; position: relative; width: 90%; max-width: 400px;
    }
    .dark .modal-content { background: #2d2d30; color: #fff; }
    .modal-content h3 { font-size: 1.5rem; margin-bottom: 1.5rem; }
    .modal-content label { font-size: 1.1rem; margin-right: 10px; }
    #theme-select {
        background-color: #f0f0f0; color: #2d2d30;
        border: 1px solid #ccc; border-radius: 5px; padding: 8px; font-size: 1rem;
    }
    .dark #theme-select {
        background-color: #3c3c3c; color: #fff; border-color: #4a4a4a;
    }
    .close-btn {
        position: absolute; top: 10px; right: 15px; color: #aaa;
        font-size: 28px; font-weight: bold; background: none;
        border: none; cursor: pointer;
    }
  </style>
</head>
<body class="font-newspaper newspaper-theme">

  <script id="embedded-content" type="application/json">
  {
    "god-is-love": {
      "display_order": 10,
      "title": "Boyd - God Is Love",
      "description": "This topic establishes the foundational truth that God is perfectly revealed in Jesus Christ. It explores how divine love requires risk and freedom, redefines power as self-sacrificial service, and demonstrates God's willingness to suffer with and for His creation.",
      "categories": {
        "god-is-just-like-jesus": {
          "display_order": 10,
          "name": "God Is Just Like Jesus",
          "display_name": "God Is Just Like Jesus",
          "introduction": "This section establishes that Jesus is the complete and perfect revelation of God's character, rejecting any contradiction between Old and New Testament portrayals of divinity.",
          "paragraphs": [
            {
              "heading": "The Complete Revelation of Divine Character",
              "content": "<br/>Everything we need to know about God is perfectly revealed in Jesus Christ. When Philip asked to see the Father, Jesus answered with gentle correction: \"Anyone who has seen me has seen the Father.\" This isn't theological poetry or approximation—it's the fundamental truth that must reshape our entire understanding of divinity. The God who flung galaxies into space is identical to the God who washed dirty feet. The God who sustains every atom in existence is the same God who wept over Jerusalem's coming destruction. The God who could summon twelve legions of angels is precisely the God who chose the nails instead. There is no hidden deity lurking behind Jesus, no secret divine personality that contradicts what we see in Christ. Jesus is the exact representation of God's being, the perfect window into the divine heart.<br/><br/><i>See The Crucifixion of the Warrior God, vol. 1, p. 45</i>"
            },
            {
              "heading": "No Contradiction Between Old and New Testament",
              "content": "<br/>Too many Christians live with a tragic split-screen theology, imagining a harsh Old Testament God who demands blood and a gentle New Testament Jesus who offers grace. But this creates an impossible contradiction at the heart of faith. The truth is revolutionary in its simplicity: there has only ever been one God, and He looks exactly like Jesus hanging on a cross with arms stretched wide, saying \"Father, forgive them, for they don't know what they're doing.\" The God of Abraham, Isaac, and Jacob is the God of Calvary. The God who grieved over humanity's rebellion in Noah's day is the God who grieved on Golgotha. The God who longed to gather Israel like chicks under His wings is the God who actually did it by dying for them. Every page of Scripture, properly understood, reveals the same cruciform heart that beats at the center of the universe."
            },
            {
              "heading": "Eternal Self-Giving Love Made Visible",
              "content": "<br/>The cross is not an exception to God's normal way of operating—it's the perfect revelation of how God has always been. Before there was sin to forgive, before there were enemies to love, before there was pain to absorb, God existed in eternal self-giving love within the Trinity. The Father eternally pours Himself out for the Son, the Son joyfully returns that love to the Father, and the Spirit binds them together in other-centered devotion. Calvary simply makes visible in time what has always been true in eternity. When we see Jesus dying for His enemies, we're not seeing God change His mind about humanity—we're seeing God's heart exposed. This is what love looks like when it meets rebellion. This is what happens when perfect goodness encounters perfect evil. The cross reveals that God would rather die than live without us."
            }
          ]
        },
        "love-requires-risk-and-freedom": {
          "display_order": 20,
          "name": "Love Requires Risk and Freedom",
          "display_name": "Love Requires Risk",
          "introduction": "This category examines how God's nature as love necessitates creating free beings capable of genuine relationship, even at the tremendous cost of potential rebellion and heartbreak.",
          "paragraphs": [
            {
              "heading": "Freedom Makes Authentic Love Possible",
              "content": "<br/>Because God is love—not merely loving but love itself in its purest essence—He created a universe where authentic relationship could flourish. And love, by its very nature, cannot be manufactured or coerced. You can force obedience through threats, extract compliance through punishment, demand submission through superior power, but you cannot compel love. Love requires freedom, and freedom always involves staggering risk. The risk that creatures might use their liberty to rebel. The risk that the beloved might choose to reject the Lover. The risk that divine vulnerability might be met with violence rather than reciprocal affection. God knew all this when He chose to create, yet He deemed the possibility of genuine love worth the certainty of genuine pain."
            },
            {
              "heading": "Divine Risk Realized at Calvary",
              "content": "<br/>The cross shows us just how far God was willing to go with the risk that love requires. He could have created automatons programmed for perpetual praise, robots incapable of disappointing Him or breaking His heart. Instead, He chose to make beings capable of authentic love—which meant they were necessarily capable of authentic rejection. Calvary reveals what happened when that divine gamble seemed to fail catastrophically. Even when His love was met with hatred, even when His creatures turned their freedom into weapons against Him, even when His vulnerability was exploited by those He came to save, God never stopped loving. He absorbed the worst that rebellious freedom could produce and transformed it into the means of redemption."
            },
            {
              "heading": "Love That Will Not Let Go",
              "content": "<br/>The beautiful and terrible truth is that God's love persists even when we use our freedom to wound Him. This is love that will not let us go, even when we use our liberty to crucify it. The cross demonstrates that there is literally nothing we can do to make God stop loving us—not rebellion, not rejection, not even deicide itself. Yet this same love respects our freedom so completely that it will allow us to choose separation if we insist upon it. God will not coerce us into relationship, but neither will He abandon His pursuit of our hearts. His love is both relentlessly persistent and utterly respectful of our choices. This is the divine dilemma: love that cannot force and will not quit."
            }
          ]
        },
        "cruciform-power-vs-coercive-force": {
          "display_order": 30,
          "name": "Cruciform Power vs. Coercive Force",
          "display_name": "Cruciform Power",
          "introduction": "This section redefines divine omnipotence as self-sacrificial love rather than dominating control, with the cross serving as the ultimate demonstration of what true power looks like.",
          "paragraphs": [
            {
              "heading": "True Power Serves Rather Than Dominates",
              "content": "<br/>The cross forever redefines what it means for God to be all-powerful. Omnipotence has nothing to do with the ability to force outcomes through superior might—any tyrant can dominate through threats and violence. True divine power is revealed as the capacity to love without limit, to create without controlling, to redeem without coercing. When Jesus could have summoned angelic armies, He chose vulnerability instead. When He could have forced every knee to bow through displays of raw power, He chose to kneel and wash feet. When He could have established His kingdom through military conquest, He chose to establish it through a cross. This isn't God restraining His power temporarily—this is God showing us what omnipotence has always looked like. The almighty God is almighty love, and almighty love serves rather than subjugates."
            },
            {
              "heading": "Strength Perfected in Weakness",
              "content": "<br/>The breathtaking paradox of Calvary is that apparent weakness becomes ultimate strength, seeming defeat transforms into complete victory. God's power is perfected not in spite of His vulnerability but precisely through it. The cross demonstrates that divine love is so secure, so confident in its own nature, that it can afford to appear weak. It can risk everything on the freedom of the beloved because it knows that genuine love—not forced compliance—is the only foundation strong enough to sustain the universe. This cruciform power doesn't impose itself through fear but invites response through beauty. It doesn't conquer through intimidation but wins through costly demonstration."
            },
            {
              "heading": "The Wisdom That Shames Human Understanding",
              "content": "<br/>Paul grasped what the world's philosophers could never fathom: \"The foolishness of God is wiser than human wisdom, and the weakness of God is stronger than human strength.\" The cross appears as cosmic absurdity to those who measure significance by earthly standards of success. How can public execution be private victory? How can death produce life? How can a curse become the greatest blessing in history? Yet in what looks like divine madness, perfect sanity emerges—the recognition that self-sacrificial love, not self-serving power, is the fundamental force that holds reality together. God's \"foolish\" strategy of winning through losing, of conquering through surrender, of leading through serving, exposes every human assumption about greatness as tragically upside-down."
            }
          ]
        },
        "divine-vulnerability-and-costly-grace": {
          "display_order": 40,
          "name": "Divine Vulnerability and Costly Grace",
          "display_name": "Divine Vulnerability",
          "introduction": "This final category explores God's willingness to suffer with and for His creation, demonstrating that love's greatest strength is revealed through apparent weakness and costly self-sacrifice.",
          "paragraphs": [
            {
              "heading": "God Suffers With His Creation",
              "content": "<br/>The God revealed in Jesus is not a distant deity immune to pain but a vulnerable God who enters fully into the human experience of suffering. When we hurt, God hurts with us. When we grieve, God grieves alongside us. When we face rejection, abandonment, and death, we discover that God has been there first. The incarnation means that God has experienced everything we face—poverty, homelessness, misunderstanding, betrayal, torture, and death itself. This is not a God who remains safely above the fray while His creatures suffer below. This is a God who climbs down into the pit with us, who shares our darkest nights, who knows our pain from the inside because He has made it His own."
            },
            {
              "heading": "Grace That Costs Everything",
              "content": "<br/>Divine grace is not cheap comfort but costly love that required everything God had to give. The cross reveals that forgiveness comes at an infinite price—not a price paid to satisfy divine wrath, but the price love always pays when it meets rebellion with mercy. Grace cost God His Son, cost the Son His life, cost the Spirit the anguish of watching divine love be crucified by those it came to save. This grace transforms us not through legal transaction but through the overwhelming beauty of love willing to die rather than give up on the beloved. When we truly see what our redemption cost, we cannot help but be changed by such extravagant love."
            },
            {
              "heading": "Love's Final Victory Through Surrender",
              "content": "<br/>The resurrection validates everything the cross proclaimed but seemed unable to prove. Love may appear to lose in the short term, but it always has the final word. Christ's resurrection demonstrates that no amount of evil can ultimately defeat self-sacrificial love, no depth of hatred can overcome divine compassion, no power of darkness can extinguish the light that shines in God's heart. Easter morning doesn't reverse Good Friday but reveals its hidden meaning—that apparent defeat was actually victory, that seeming weakness was ultimate strength, that what looked like love's failure was love's triumph. The cruciform pattern is thus vindicated: those who lose their lives for love's sake will find them, those who serve will be exalted, those who choose the way of the cross will share in resurrection glory."
            }
          ]
        }
      }
    },
    "god-of-the-possible": {
      "display_order": 20,
      "title": "Boyd - God of the Possible",
      "description": "This topic explores open theism—the understanding that God knows all possibilities without predetermining outcomes. It examines how divine sovereignty works through relationship rather than control, making prayer meaningful and preserving genuine freedom.",
      "categories": {
        "future-is-genuinely-open": {
          "display_order": 10,
          "name": "The Future Is Genuinely Open",
          "display_name": "The Open Future",
          "introduction": "This section establishes that God's omniscience includes perfect knowledge of all possibilities without requiring predetermined outcomes, preserving the reality of genuine freedom and choice.",
          "paragraphs": []
        },
        "dynamic-sovereignty-in-relationship": {
          "display_order": 20,
          "name": "Dynamic Sovereignty in Relationship",
          "display_name": "Dynamic Sovereignty",
          "introduction": "This category examines how God's power is expressed through adaptive response and relational engagement rather than meticulous control of every detail.",
          "paragraphs": []
        },
        "prayer-that-changes-things": {
          "display_order": 30,
          "name": "Prayer That Changes Things",
          "display_name": "Meaningful Prayer",
          "introduction": "This section explores how petitionary prayer represents genuine dialogue that can influence outcomes, not mere submission to predetermined divine plans.",
          "paragraphs": []
        },
        "hope-in-uncertain-world": {
          "display_order": 40,
          "name": "Hope in an Uncertain World",
          "display_name": "Uncertain Hope",
          "introduction": "This final category shows how we find security in God's faithful character and redemptive promises rather than in predetermined blueprints for our lives.",
          "paragraphs": []
        }
      }
    },
    "god-at-war": {
      "display_order": 30,
      "title": "Boyd - God at War",
      "description": "This topic presents reality as a battlefield between God's kingdom and Satan's rebellion. It distinguishes between suffering as collateral damage in spiritual warfare versus mysterious divine purposes, showing how God mourns with us rather than orchestrating our pain.",
      "categories": {
        "reality-as-battlefield": {
          "display_order": 10,
          "name": "Reality as Battlefield",
          "display_name": "Cosmic Battlefield",
          "introduction": "This section establishes the warfare worldview—understanding existence as a genuine conflict between good and evil that explains suffering without blaming God for evil.",
          "paragraphs": []
        },
        "collateral-damage-vs-divine-plan": {
          "display_order": 20,
          "name": "Collateral Damage vs. Divine Plan",
          "display_name": "Collateral Damage",
          "introduction": "This category distinguishes between tragedies as consequences of spiritual warfare versus the problematic idea that God orchestrates suffering for mysterious purposes.",
          "paragraphs": []
        },
        "gods-mournful-presence": {
          "display_order": 30,
          "name": "God's Mournful Presence in Pain",
          "display_name": "Mournful Presence",
          "introduction": "This section explores how God suffers with us in a war-torn world rather than remaining distant or orchestrating our pain for hidden reasons.",
          "paragraphs": []
        },
        "victory-through-enemy-love": {
          "display_order": 40,
          "name": "Victory Through Enemy-Love",
          "display_name": "Enemy-Love Victory",
          "introduction": "This final category examines Christ's triumph over evil powers through absorbing rather than inflicting violence, modeling our participation in spiritual warfare.",
          "paragraphs": []
        }
      }
    },
    "gods-nonviolence": {
      "display_order": 40,
      "title": "Boyd - God's Non-Violence",
      "description": "This topic addresses the challenge of violent divine actions in the Old Testament by using Jesus as the hermeneutical key. It explores how God accommodated ancient cultural assumptions while progressively revealing His true non-violent nature.",
      "categories": {
        "jesus-as-hermeneutical-key": {
          "display_order": 10,
          "name": "Jesus as Hermeneutical Key",
          "display_name": "Jesus as Key",
          "introduction": "This section establishes Christ's character as the essential lens through which to understand all seemingly violent divine actions recorded in Scripture.",
          "paragraphs": []
        },
        "accommodation-and-progressive-revelation": {
          "display_order": 20,
          "name": "Accommodation and Progressive Revelation",
          "display_name": "Divine Accommodation",
          "introduction": "This category examines how God worked within ancient Near Eastern cultural assumptions while gradually revealing His true non-violent nature throughout Scripture.",
          "paragraphs": []
        },
        "spiritual-warfare-behind-battles": {
          "display_order": 30,
          "name": "Spiritual Warfare Behind Physical Battles",
          "display_name": "Spiritual Battles",
          "introduction": "This section reinterprets Old Testament conquest narratives as accounts of cosmic conflict rather than divine endorsement of human violence.",
          "paragraphs": []
        },
        "from-vengeance-to-enemy-love": {
          "display_order": 40,
          "name": "From Vengeance to Enemy-Love",
          "display_name": "Vengeance to Love",
          "introduction": "This final category traces Scripture's trajectory from 'eye for eye' toward 'love your enemies' as the complete revelation of God's heart.",
          "paragraphs": []
        }
      }
    },
    "healing-and-restoration": {
      "display_order": 50,
      "title": "Boyd - Healing and Restoration",
      "description": "This topic explores the Christus Victor understanding of salvation as liberation from sin, death, and demonic powers. It presents salvation as participation in Christ's victory and transformation through trust, leading to hope for cosmic renewal.",
      "categories": {
        "liberation-from-powers": {
          "display_order": 10,
          "name": "Liberation from Powers",
          "display_name": "Liberation from Powers",
          "introduction": "This section examines how Christ's victory frees us from sin, death, and demonic oppression rather than merely satisfying divine wrath through legal transaction.",
          "paragraphs": []
        },
        "salvation-as-participation": {
          "display_order": 20,
          "name": "Salvation as Participation",
          "display_name": "Participatory Salvation",
          "introduction": "This category explores salvation as being united with Christ in His victory over evil rather than simply receiving legal pardon or status change.",
          "paragraphs": []
        },
        "transformation-through-trust": {
          "display_order": 30,
          "name": "Transformation Through Trust",
          "display_name": "Trust & Transformation",
          "introduction": "This section shows how faith enables God's healing work in our lives, creating space for divine transformation and restoration of our true humanity.",
          "paragraphs": []
        },
        "hope-for-cosmic-renewal": {
          "display_order": 40,
          "name": "Hope for Cosmic Renewal",
          "display_name": "Cosmic Renewal",
          "introduction": "This final category presents God's ultimate plan to restore all creation from the damage of spiritual warfare, establishing His kingdom of love throughout the universe.",
          "paragraphs": []
        }
      }
    }
  }
</script>

  <div class="fixed top-4 right-4 z-50">
    <button id="settings-btn" class="p-2 rounded-full" aria-label="toggle settings">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>
  </div>

  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <button id="close-modal-btn" class="close-btn">×</button>
        <h3>Display Settings</h3>
        <label for="theme-select">Theme:</label>
        <select id="theme-select"></select>
    </div>
  </div>

  <main id="app-container" class="prose dark:prose-invert mx-auto max-w-prose p-8"></main>

  <script>
    /* ---------- state ---------- */
    let masterLibrary=null,sortedLibraryIds=null,currentLibraryId=null
    let libraryData=null,sortedTopicIds=null,currentTopicId=null,currentArticleId=null
    const app=document.getElementById('app-container')

    /* ---------- helpers ---------- */
    const looksLikeTopic=o=>o&&typeof o==='object'&&('categories'in o||'title'in o)

    /* ---------- rendering ---------- */
    const buildLibrarySwitch=()=>!sortedLibraryIds||sortedLibraryIds.length<2?'':`
      <div class="nav-container">
        <select id="library-switcher" class="nav-button">
          ${sortedLibraryIds.map(id=>{
            const label=id.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase())
            return `<option value="${id}" ${id===currentLibraryId?'selected':''}>${label}</option>`
          }).join('')}
        </select>
      </div>`

    const buildTopicSwitch=()=>`
      <div class="nav-container">
        <select id="topic-switcher" class="nav-button">
          ${sortedTopicIds.map(tid=>{
            const t=libraryData[tid];return `<option value="${tid}" ${tid===currentTopicId?'selected':''}>${t.title}</option>`
          }).join('')}
        </select>
      </div>`

    const buildNav=(cats,keys)=>{
      let html='<div class="nav-container"><h3>Select Article:</h3><div class="nav-buttons-wrapper">'
      keys.forEach(k=>{
        const a=cats[k]
        html+=`<button class="nav-button article-btn ${k===currentArticleId?'active':''}" data-article-id="${k}">${a.display_name}</button>`
        if(a.breakAfter)html+='<div class="flex-break"></div>'
      })
      return html+'</div></div>'
    }

    function render(){
      if(!libraryData)return
      sortedTopicIds=Object.keys(libraryData).sort((a,b)=>(libraryData[a].display_order||0)-(libraryData[b].display_order||0))
      if(!currentTopicId||!libraryData[currentTopicId])currentTopicId=sortedTopicIds[0]
      const topic=libraryData[currentTopicId]
      const artKeys=Object.keys(topic.categories||{}).sort((a,b)=>(topic.categories[a].display_order||0)-(topic.categories[b].display_order||0))
      if(!currentArticleId||!topic.categories[currentArticleId])currentArticleId=artKeys[0]
      const art=topic.categories[currentArticleId]

      app.innerHTML=buildLibrarySwitch()+`<h1>${topic.title}</h1>`+buildTopicSwitch()+buildNav(topic.categories,artKeys)+
        `<h2>${art.name||art.display_name||''}</h2>${art.introduction?`<p>${art.introduction}</p>`:''}`+
        (art.paragraphs||[]).map(p=>`<h3>${p.heading}</h3><p>${p.content}</p>`).join('')
      document.title=topic.title||'Adaptive Reader'

      document.querySelectorAll('.article-btn').forEach(btn=>btn.onclick=e=>{
        currentArticleId=e.target.dataset.articleId;render()
      })
      const ts=document.getElementById('topic-switcher')
      if(ts)ts.onchange=e=>{currentTopicId=e.target.value;currentArticleId=null;render()}
      const ls=document.getElementById('library-switcher')
      if(ls)ls.onchange=e=>{
        currentLibraryId=e.target.value
        localStorage.setItem('readerLibraryId',currentLibraryId)
        libraryData=masterLibrary[currentLibraryId];currentTopicId=currentArticleId=null;render()
      }
      
      const themeName = localStorage.getItem('theme') || 'newspaper';
      applyThemeClasses(themeName);
    }

    /* ---------- data load ---------- */
    async function init(){
      let raw=null
      try{
        const res=await fetch('./data/content.json',{cache:'no-store'})
        if(!res.ok)throw new Error('not ok');raw=await res.json()
      }catch{
        const embedded=document.getElementById('embedded-content').textContent.trim()
        if(!embedded)throw new Error('no data');raw=JSON.parse(embedded)
      }

      const keys=Object.keys(raw)
      if(!keys.length)throw new Error('empty data')
      if(looksLikeTopic(raw[keys[0]])){
        masterLibrary=null;sortedLibraryIds=null;currentLibraryId=null
        libraryData=raw
      }else{
        masterLibrary=raw
        sortedLibraryIds=keys.sort()
        currentLibraryId=localStorage.getItem('readerLibraryId')
        if(!currentLibraryId||!masterLibrary[currentLibraryId])currentLibraryId=sortedLibraryIds[0]
        libraryData=masterLibrary[currentLibraryId]
      }
      currentTopicId=currentArticleId=null
      render()
    }


    /* ---------- FINAL THEME ENGINE --- */
    const THEMES = {
      'newspaper': { name: 'Newspaper', type: 'classic', isDark: false },
      'dark': { name: 'Dark', type: 'classic', isDark: true },
      'cyber-blue': {
        name: 'Cyber Blue', type: 'variable', isDark: true,
        vars: {
          '--bg-gradient': 'linear-gradient(135deg,#0a0a23 0%,#1a1a3a 50%,#2e2e5e 100%)',
          '--text': '#ecf0f1', '--accent-text': '#a8b8d0',
          '--nav-bg': '#34495e', '--nav-border': '#4a4a4a', '--nav-text': '#ecf0f1',
          '--nav-hover-bg': '#4a6078', '--nav-active-bg': '#2e2e5e', '--nav-active-text': '#ecf0f1'
        },
        hover_style: 'btn-light-text'
      },
      'teal-matrix': {
        name: 'Teal Matrix', type: 'variable', isDark: true,
        vars: {
          '--bg-gradient': 'linear-gradient(135deg,#0a231c 0%,#1a3a31 50%,#2e5e50 100%)',
          '--text': '#ecf0f1', '--accent-text': '#ace0d5',
          '--nav-bg': '#345e55', '--nav-border': '#92b3a9', '--nav-text': '#ecf0f1',
          '--nav-hover-bg': '#427569', '--nav-active-bg': '#0a231c', '--nav-active-text': '#ecf0f1'
        },
        hover_style: 'btn-light-text'
      },
      'scorched-gold': {
        name: 'Scorched Gold', type: 'variable', isDark: false,
        vars: {
          '--bg-gradient': '#fdfbf5', '--text': '#2a1d15', '--accent-text': '#d4a24c',
          '--nav-bg': '#f8f4e8', '--nav-border': '#d4a24c', '--nav-text': '#2a1d15',
          '--nav-hover-bg': '#f0c475', '--nav-active-bg': '#f0c475', '--nav-active-text': '#2a1d15'
        },
        hover_style: 'btn-dark-text'
      }
    };
    
    function applyThemeClasses(themeName) {
        const theme = THEMES[themeName];
        if (!theme) return;

        document.body.classList.remove('newspaper-theme', 'dark-theme', 'variable-theme', 'font-newspaper', 'font-dark-theme');
        document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('btn-light-text', 'btn-dark-text'));

        if (theme.type === 'classic') {
            document.body.classList.add(theme.isDark ? 'dark-theme' : 'newspaper-theme');
            document.body.classList.add(theme.isDark ? 'font-dark-theme' : 'font-newspaper');
        } else {
            document.body.classList.add('variable-theme');
            if (theme.hover_style) {
                document.querySelectorAll('.nav-button').forEach(button => button.classList.add(theme.hover_style));
            }
        }
    }

    function applyThemeVariables(name) {
      const theme = THEMES[name] || THEMES['newspaper'];
      
      document.documentElement.classList.toggle('dark', theme.isDark);

      if (theme.type === 'variable') {
        for (const [key, value] of Object.entries(theme.vars)) {
          document.documentElement.style.setProperty(key, value);
        }
      } else { 
        const sampleVars = THEMES['cyber-blue'].vars;
        Object.keys(sampleVars).forEach(varName => {
            document.documentElement.style.removeProperty(varName);
        });
      }
    }

    function setTheme(name) {
      if (THEMES[name]) {
        localStorage.setItem('theme', name);
        applyThemeVariables(name);
        applyThemeClasses(name);
      }
    }

    function initializeModal() {
        const modal = document.getElementById('settings-modal');
        const openBtn = document.getElementById('settings-btn');
        const closeBtn = document.getElementById('close-modal-btn');
        const themeSelect = document.getElementById('theme-select');
        
        const currentTheme = localStorage.getItem('theme') || 'newspaper';
        themeSelect.innerHTML = Object.keys(THEMES).map(key => {
            const theme = THEMES[key];
            return `<option value="${key}" ${key === currentTheme ? 'selected' : ''}>${theme.name}</option>`
        }).join('');

        openBtn.onclick = () => modal.classList.add('show');
        closeBtn.onclick = () => modal.classList.remove('show');
        modal.onclick = (event) => { if (event.target === modal) modal.classList.remove('show'); };
        themeSelect.onchange = (e) => setTheme(e.target.value);
    }

    /* ---------- boot ---------- */
    document.addEventListener('DOMContentLoaded',()=>{
      const currentTheme = localStorage.getItem('theme') || 'newspaper';
      applyThemeVariables(currentTheme);
      applyThemeClasses(currentTheme);
      
      initializeModal();
      init().catch(err=>{console.error(err);app.innerHTML='<h1>Error</h1><p>Could not load content.</p>'})
    })
  </script>
</body>
</html>

