<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WWII Viewer</title>
  <link rel="stylesheet" href="poc-ww2-styles.css">
</head>
<body>
  <!-- 1. Load Configuration & Logic -->
  <script src="poc-ww2-config.js"></script>
  <script src="poc-ww2-renderers.js"></script>
  <script src="poc-ww2-store.js"></script>

  <div class="container narrow">
    <div class="breadcrumb">
      <!-- FIXED LINK: Points to your canonical file poc-ww2-hub.html -->
      <a href="poc-ww2-hub.html" id="nav-hub-link">Hub</a> <span id="bread-title">...</span>
    </div>

    <div id="app-root">
      <!-- Content injected here -->
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal">
      <h3>Delete Battle?</h3>
      <p>This action cannot be undone. Are you sure you want to remove this record from local storage?</p>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn confirm" onclick="executeDelete()">Delete</button>
      </div>
    </div>
  </div>

  <button id="backToTop" class="back-to-top" onclick="scrollToTop()">↑</button>

  <script>
    // --- 1. SETUP & THEME ---
    function applyTheme(themeName) {
      const theme = APP_CONFIG.themes[themeName] || APP_CONFIG.themes.default;
      const root = document.documentElement;
      for (const [key, value] of Object.entries(theme.colors)) {
        root.style.setProperty(key, value);
      }
    }
    applyTheme('default');

    // --- 2. UTILITIES & STATE ---
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    let currentId = null; // Store ID globally for delete logic

    // --- 3. CORE RENDER LOGIC ---
    function renderPage() {
      const id = getQueryParam('id');
      currentId = id; // Capture ID

      const appRoot = document.getElementById('app-root');
      const breadTitle = document.getElementById('bread-title');
      const navHubLink = document.getElementById('nav-hub-link');

      breadTitle.innerText = APP_CONFIG.labels.loading;
      navHubLink.innerText = APP_CONFIG.labels.backToHub;

      if (typeof Store === 'undefined') {
        appRoot.innerHTML = `<div class="error-msg"><h2>Error</h2><p>Storage adapter not loaded.</p></div>`;
        return;
      }

      const item = Store.getById(id);

      if (!item) {
        breadTitle.innerText = APP_CONFIG.labels.errorTitle;
        appRoot.innerHTML = `
          <div class="error-msg">
            <h2>${APP_CONFIG.labels.errorBody}</h2>
            <p>ID: ${id || 'null'}</p>
          </div>`;
        return;
      }

      // META
      document.title = item.meta.title;
      breadTitle.innerText = `› ${item.meta.title}`;

      // HEADER with Delete Button
      let html = `
        <header>
          <button class="btn-delete" onclick="confirmDelete()">Delete Battle</button>
          <h1>${item.meta.title}</h1>
          <p class="subtitle">${item.meta.subtitle}</p>
        </header>

        <section class="main-answer">
          <h2>${APP_CONFIG.labels.summaryHeader}</h2>
          <p>${item.content.summary}</p>
        </section>
      `;

      // ACCORDIONS
      APP_CONFIG.sections.forEach((sectionConfig, index) => {
        const isActive = index === 0 ? 'active' : ''; 
        const sectionData = item.content[sectionConfig.key];
        const renderFn = RENDERERS[sectionConfig.type] || RENDERERS.list;
        const innerHTML = renderFn(sectionData);

        html += `
          <section class="section ${isActive}">
            <div class="section-header" onclick="toggleSection(this)">
              <h2>${sectionConfig.title}</h2>
              <span class="section-icon">▼</span>
            </div>
            <div class="section-content">
              <div class="section-inner">
                ${innerHTML}
              </div>
            </div>
          </section>
        `;
      });

      appRoot.innerHTML = html;
    }

    // --- 4. INTERACTION LOGIC ---
    function toggleSection(header) {
      const section = header.parentElement;
      document.querySelectorAll('.section').forEach(s => {
        if (s !== section && s.classList.contains('active')) s.classList.remove('active');
      });
      section.classList.toggle('active');
    }

    // --- 5. DELETE LOGIC ---
    const modal = document.getElementById('deleteModal');

    function confirmDelete() {
      modal.classList.add('open');
    }

    function closeModal() {
      modal.classList.remove('open');
    }

    function executeDelete() {
      if (!currentId) return;
      
      Store.delete(currentId);
      
      // Redirect back to Hub after deletion
      // FIXED LINK: Points to your actual filename poc-ww2-hub.html
      window.location.href = 'poc-ww2-hub.html';
    }

    // Close modal if clicking outside
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // --- 6. SCROLL LOGIC ---
    window.addEventListener('scroll', () => {
      const btn = document.getElementById('backToTop');
      if (window.pageYOffset > 300) btn.classList.add('visible');
      else btn.classList.remove('visible');
    });
    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    document.addEventListener('DOMContentLoaded', renderPage);
  </script>
</body>
</html>
