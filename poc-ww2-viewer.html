<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WWII Viewer</title>
  <!-- External CSS -->
  <link rel="stylesheet" href="poc-ww2-styles.css">
</head>
<body>
  <!-- 1. Load Adjunct Files -->
  <script src="poc-ww2-config.js"></script>
  <script src="poc-ww2-renderers.js"></script>
  <script src="poc-ww2-data.js"></script>

  <!-- Container.narrow applied to match previous max-width: 860px -->
  <div class="container narrow">
    <div class="breadcrumb">
      <!-- Note: We point back to the v2 hub here -->
      <a href="poc-ww2-hub-v2.html" id="nav-hub-link">Hub</a> <span id="bread-title">...</span>
    </div>

    <div id="app-root">
      <!-- Content injected here -->
    </div>
  </div>

  <button id="backToTop" class="back-to-top" onclick="scrollToTop()">↑</button>

  <script>
    // --- 1. SETUP & THEME ---
    function applyTheme(themeName) {
      const theme = APP_CONFIG.themes[themeName] || APP_CONFIG.themes.default;
      const root = document.documentElement;
      for (const [key, value] of Object.entries(theme.colors)) {
        root.style.setProperty(key, value);
      }
    }

    // Apply default theme immediately
    applyTheme('default');

    // --- 2. UTILITIES ---
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // --- 3. CORE RENDER LOGIC ---
    function renderPage() {
      const id = getQueryParam('id');
      const appRoot = document.getElementById('app-root');
      const breadTitle = document.getElementById('bread-title');
      const navHubLink = document.getElementById('nav-hub-link');

      // Set UI Labels from Config
      breadTitle.innerText = APP_CONFIG.labels.loading;
      navHubLink.innerText = APP_CONFIG.labels.backToHub;

      // Validation
      if (typeof DATABASE === 'undefined') {
        appRoot.innerHTML = `<div class="error-msg"><h2>Error</h2><p>Data source not loaded.</p></div>`;
        return;
      }

      // Data Lookup
      const item = DATABASE.items.find(i => i.id === id);

      if (!item) {
        breadTitle.innerText = APP_CONFIG.labels.errorTitle;
        appRoot.innerHTML = `
          <div class="error-msg">
            <h2>${APP_CONFIG.labels.errorBody}</h2>
            <p>ID: ${id || 'null'}</p>
          </div>`;
        return;
      }

      // Update Meta
      document.title = item.meta.title;
      breadTitle.innerText = `› ${item.meta.title}`;

      // --- BUILD HEADER (Static Structure) ---
      let html = `
        <header>
          <h1>${item.meta.title}</h1>
          <p class="subtitle">${item.meta.subtitle}</p>
        </header>

        <section class="main-answer">
          <h2>${APP_CONFIG.labels.summaryHeader}</h2>
          <p>${item.content.summary}</p>
        </section>
      `;

      // --- BUILD ACCORDIONS (Dynamic Structure from Config) ---
      APP_CONFIG.sections.forEach((sectionConfig, index) => {
        const isActive = index === 0 ? 'active' : ''; 
        
        // 1. Get Data for this section
        const sectionData = item.content[sectionConfig.key];

        // 2. Get Renderer
        const renderFn = RENDERERS[sectionConfig.type] || RENDERERS.list;
        
        // 3. Generate inner HTML
        const innerHTML = renderFn(sectionData);

        // 4. Append Section HTML
        html += `
          <section class="section ${isActive}">
            <div class="section-header" onclick="toggleSection(this)">
              <h2>${sectionConfig.title}</h2>
              <span class="section-icon">▼</span>
            </div>
            <div class="section-content">
              <div class="section-inner">
                ${innerHTML}
              </div>
            </div>
          </section>
        `;
      });

      appRoot.innerHTML = html;
    }

    // --- 4. INTERACTION LOGIC ---
    function toggleSection(header) {
      const section = header.parentElement;
      // Accordion behavior: Close others
      document.querySelectorAll('.section').forEach(s => {
        if (s !== section && s.classList.contains('active')) s.classList.remove('active');
      });
      section.classList.toggle('active');
    }

    // --- 5. SCROLL LOGIC ---
    window.addEventListener('scroll', () => {
      const btn = document.getElementById('backToTop');
      if (window.pageYOffset > 300) btn.classList.add('visible');
      else btn.classList.remove('visible');
    });
    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', renderPage);
  </script>
</body>
</html>
