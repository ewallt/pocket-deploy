<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Reasonable Revolutionary - Interactive Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);
            --accent-1: #2563eb;
            --accent-2: #1d4ed8;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --ui-background: #ffffff;
            --ui-background-accent: #f1f5f9;
            --btn-gradient: linear-gradient(45deg,#2563eb,#1d4ed8);
        }
        .theme-navy {
            --bg-gradient: linear-gradient(135deg,#0a0a23 0%,#1a1a3a 50%,#2e2e5e 100%);
            --accent-1: #60a5fa;
            --accent-2: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --ui-background: #1e293b;
            --ui-background-accent: #334155;
            --btn-gradient: linear-gradient(45deg,#3b82f6,#1e40af);
        }
        .theme-emerald {
            --bg-gradient: linear-gradient(135deg,#022c22 0%,#064e3b 60%,#065f46 100%);
            --accent-1: #f0c475;
            --accent-2: #d4a24c;
            --text-primary: #ecfdf5;
            --text-secondary: #a7f3d0;
            --ui-background: #064e3b;
            --ui-background-accent: #065f46;
            --btn-gradient: linear-gradient(45deg,#10b981,#065f46);
        }
        body { background: var(--bg-gradient); color: var(--text-primary); min-height: 100vh; }
        .ui-bg { background-color: var(--ui-background); }
        .ui-bg-accent { background-color: var(--ui-background-accent); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .accent-1 { color: var(--accent-1); }
        .accent-2 { color: var(--accent-2); }
        .btn-gradient { background: var(--btn-gradient); }
        .border-accent { border-color: var(--accent-1); }
        *:focus-visible { outline: 3px solid var(--accent-1); outline-offset: 2px; }
        .tab-active { border-bottom: 3px solid var(--accent-1); color: var(--accent-1); }
        .accordion-content {
            display: grid;
            grid-template-rows: 0fr;
            opacity: 0.5;
            transition: grid-template-rows 0.4s ease-out, opacity 0.3s ease-out;
        }
        .accordion-content > div { overflow: hidden; }
        .accordion-content.active {
            grid-template-rows: 1fr;
            opacity: 1;
            transition: grid-template-rows 0.5s ease-in, opacity 0.5s ease-in;
        }
        .search-highlight { background-color: #fef08a; color: #713f12; }
        .theme-navy .search-highlight { background-color: #fde047; color: #1e293b; }
        .theme-emerald .search-highlight { background-color: #a7f3d0; color: #064e3b; }
        .chart-container { position: relative; width: 100%; max-width: 48rem; margin: 0 auto; height: 20rem; max-height: 450px; }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header: Dynamically rendered -->
        <header id="app-header" class="ui-bg rounded-lg shadow-lg p-6 mb-6"></header>
        
        <!-- Search Bar -->
        <div class="ui-bg rounded-lg shadow-lg p-4 mb-6">
            <input type="search" id="searchInput" placeholder="Search concepts, people, or events..." 
                   class="w-full px-4 py-2 rounded-lg ui-bg-accent text-primary placeholder-gray-500 focus:ring-2">
        </div>
        
        <!-- Tab Navigation: Dynamically rendered -->
        <nav id="app-tabs" class="ui-bg rounded-lg shadow-lg mb-6" role="tablist" aria-label="Main navigation"></nav>
        
        <!-- Tab Panels: Dynamically rendered -->
        <main id="app-panels" class="ui-bg rounded-lg shadow-lg p-6"></main>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settings-title">
            <div class="ui-bg rounded-lg p-6 max-w-md w-full">
                <h2 id="settings-title" class="text-xl font-bold accent-1 mb-4">Display Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="themeSelect" class="block text-primary font-semibold mb-2">Theme</label>
                        <select id="themeSelect" class="w-full px-3 py-2 rounded ui-bg-accent text-primary">
                            <option value="default">Light (Default)</option>
                            <option value="theme-navy">Navy Blue</option>
                            <option value="theme-emerald">Green + Gold</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancelSettings" class="px-4 py-2 rounded ui-bg-accent text-primary hover:opacity-80">Cancel</button>
                    <button id="saveSettings" class="px-4 py-2 rounded btn-gradient text-white hover:opacity-80">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Island -->
    <script type="application/json" id="report-data">
    {
      "meta": {
        "title": "The Reasonable Revolutionary",
        "subtitle": "John Locke on Why God Never Forces Faith",
        "provenance": [
          { "label": "Title", "detail": "The Reasonable Revolutionary: John Locke on Why God Never Forces Faith" },
          { "label": "Subtitle", "detail": "How an Oxford scholar's defense of religious toleration revealed the divine logic of freedom" },
          { "label": "Type", "detail": "Historical and theological analysis" },
          { "label": "Focus", "detail": "Locke's revolutionary theology of non-coercion and religious toleration" }
        ]
      },
      "sections": [
        {
          "id": "overview", "title": "Overview",
          "intro": "John Locke's 'A Letter Concerning Toleration' (1689) revolutionized Western thought by arguing that religious coercion violates not just human dignity but divine design itself—the God who created minds to know truth through reason would never authorize force to compel faith.",
          "bullets": [
            "Written in Dutch exile as Louis XIV's persecution of Huguenots shocked Europe with forced conversions",
            "Argued that civil government and spiritual authority operate in fundamentally different realms by nature",
            "Established that coercion cannot produce sincere faith, making religious persecution both immoral and irrational"
          ],
          "items": [
            { "id": "overview-1", "label": "The Historical Crisis", "summary": "In 1685, Louis XIV revoked the Edict of Nantes, unleashing unprecedented persecution against French Protestants. Hundreds of thousands of Huguenots fled France, bringing tales of dragonnades, forced conversions, and children torn from families.", "detail": "Meanwhile, John Locke in Dutch exile was completing a letter that would transform Western civilization. Published anonymously in 1689, it didn't merely argue for tolerance as political expedient but claimed something radical: that God Himself never forces faith because coercion contradicts both divine nature and human design." },
            { "id": "overview-2", "label": "Drawing the Line", "summary": "Locke begins with a distinction so sharp it cuts through centuries of confusion: civil government and spiritual authority operate in fundamentally different realms. The magistrate secures 'civil interests'—life, liberty, health, property—through law.", "detail": "Religion aims at something else entirely: the salvation of souls through inward persuasion. This isn't administrative efficiency but follows from the nature of each realm. Temporal power operates on bodies and estates—things that can be touched, measured, seized. But saving faith is an interior act, 'a settled assent of the mind.' You can chain a body; you cannot chain a belief." },
            { "id": "overview-3", "label": "Revolutionary Impact", "summary": "Locke's argument produced a principled theology of non-coercion grounded in careful analysis of what faith is, how God governs, and why earthly rulers who try to rule souls inevitably corrupt both church and state.", "detail": "This wasn't the tolerance of exhaustion after Europe's religious wars but a positive vision: God governs conscience through truth that persuades and love that wins; the state governs bodies through laws that protect and punish. When each power remains in its proper sphere, both human dignity and civil peace are preserved—the 'Lockean settlement' that shaped modern democracy." }
          ]
        },
        {
          "id": "concepts", "title": "Concepts",
          "intro": "Locke developed revolutionary concepts about the nature of belief, the mechanics of faith, and the proper boundaries between civil and spiritual authority that fundamentally transformed Western political theology.",
          "bullets": [
            "True religion consists in 'inward and full persuasion of the mind'—something force cannot create",
            "Churches are voluntary societies fundamentally different from political communities",
            "God's government operates through illumination and attraction, never coercion"
          ],
          "items": [
            { "id": "concepts-1", "label": "The Mechanics of Belief", "summary": "Empirical observation about human psychology", "detail": "Belief isn't a posture you can adopt at will, like standing straight or smiling. It's a judgment formed when the mind encounters convincing evidence. Try to believe 2+2=5 by sheer will—you cannot. Force is not merely immoral in religion; it's irrational, like using a hammer to bake bread." },
            { "id": "concepts-2", "label": "The Voluntary Society", "summary": "Revolutionary definition of church", "detail": "A church is 'a voluntary society of men, joining themselves together of their own accord.' No one is born into faith like they're born into a nation. Religion is neither ethnic nor geographic. It's a choice—or it's nothing at all. Churches can only exclude from fellowship, never wield civil power." },
            { "id": "concepts-3", "label": "The Empire of Conscience", "summary": "God's exclusive jurisdiction", "detail": "Conscience is the interior forum where the soul stands before God, the sacred space where divine authority meets human response. Because God alone can judge hearts—knowing not just actions but intentions—He reserves this forum to Himself. Civil rulers lack both competence and authority." },
            { "id": "concepts-4", "label": "The Cascade of Failures", "summary": "Four types of coercion's failure", "detail": "Epistemic failure: pain isn't an argument. Moral failure: coercion rewards hypocrisy. Jurisdictional failure: magistrates claim to rule where God alone is Lord. Prudential failure: today's persecuted become tomorrow's persecutors, spinning endless cycles of religious violence." },
            { "id": "concepts-5", "label": "Divine Pedagogy", "summary": "How God chooses to govern", "detail": "God's government operates by teaching and drawing, not forcing. He illuminates minds without overriding them, wins hearts without conscripting them. This isn't divine weakness but the fitting expression of how a God of truth and love chooses to rule rational creatures He created." },
            { "id": "concepts-6", "label": "Moderate Penalties Fallacy", "summary": "Response to 'gentle pressure' arguments", "detail": "Jonas Proast argued for moderate fines to encourage religious reflection. Locke's response: you can't be 'slightly pregnant' or 'slightly coerce' conscience. Even gentle pressure corrupts the motive that gives religious acts their worth. Prayer to avoid punishment isn't prayer—it's a transaction." }
          ]
        },
        {
          "id": "evidence", "title": "Evidence",
          "intro": "Locke marshaled philosophical, theological, and practical evidence to demonstrate why religious coercion fails on every level—from the nature of belief itself to the lessons of history.",
          "bullets": [
            "Philosophical proof that force cannot produce genuine belief, only outward compliance",
            "Biblical evidence that Christ's kingdom operates through different means than earthly powers",
            "Historical demonstration that religious coercion produces cycles of persecution and violence"
          ],
          "items": [
            { "id": "evidence-1", "label": "The Impossibility Argument", "summary": "Can you, right now, by sheer act of will, believe that 2+2=5? Can you genuinely convince yourself the sun orbits the earth? Can a threat make these propositions true for you—not just make you say them, but actually believe them?", "detail": "The answer exposes coercion's fundamental futility. Force operates on the body; belief forms in the mind. Instruction can move a mind, dialogue can persuade, example can inspire, prayer can open hearts. But threats? Fines? Imprisonment? These might change behavior but cannot change belief. The state can make hypocrites; only reasons can make believers." },
            { "id": "evidence-2", "label": "Biblical Foundation", "summary": "Christ's kingdom is 'not of this world' and therefore cannot be advanced by worldly instruments. The wheat and tares must grow together until harvest—God will sort them, not the magistrate.", "detail": "The worship God seeks is 'in spirit and truth,' not external conformity without inward sincerity. God sends rain on just and unjust alike, seeks prodigals rather than slaves, knocks at the door rather than breaking it down. The spiritual logic Locke traces—God wins worshipers by light and love, not force and fear—echoes throughout Scripture." },
            { "id": "evidence-3", "label": "Historical Proof", "summary": "Once rulers claim authority to punish wrong belief, every sect dreams of seizing that power. Today's persecuted become tomorrow's persecutors. The cycle of religious violence spins on, each faction certain that this time, force will finally establish truth.", "detail": "Europe's religious wars demonstrated this pattern catastrophically. Each side claimed divine mandate to coerce; each produced only more violence and hatred. The practical conclusion matches the principled one: civil peace worth having cannot be built on forced religion, and religion worth having cannot be built on civil force." }
          ]
        },
        {
          "id": "timeline", "title": "Timeline",
          "intro": "The development of religious toleration spans from the Reformation's violence through Locke's revolutionary argument to modern challenges of freedom of conscience.",
          "bullets": [
            "1598 Edict of Nantes granted unprecedented tolerance to French Protestants",
            "1685 revocation triggered the persecution that prompted Locke's response",
            "1689 publication of the Letter transformed Western political thought"
          ],
          "items": [
            { "id": "timeline-1", "label": "1598", "detail": "Edict of Nantes grants religious tolerance to French Huguenots after decades of religious war." },
            { "id": "timeline-2", "label": "1685", "detail": "Louis XIV revokes the Edict, triggering mass persecution, dragonnades, and Huguenot exodus." },
            { "id": "timeline-3", "label": "1685-1689", "detail": "Locke writes 'A Letter Concerning Toleration' while in Dutch exile, observing European religious conflicts." },
            { "id": "timeline-4", "label": "1689", "detail": "Letter published anonymously in Latin, then translated to English, spreading rapidly across Europe." },
            { "id": "timeline-5", "label": "1690", "detail": "Jonas Proast publishes critique arguing for 'moderate penalties'; Locke responds with second letter." },
            { "id": "timeline-6", "label": "1692-1704", "detail": "Locke publishes third and fourth letters on toleration, refining arguments against various objections." },
            { "id": "timeline-7", "label": "18th Century", "detail": "Lockean principles influence American founders, shaping First Amendment and religious freedom." }
          ]
        },
        {
          "id": "critiques", "title": "Critiques",
          "intro": "Locke's toleration faced significant boundaries and criticisms, revealing tensions between principled tolerance and practical concerns about civil order.",
          "bullets": [
            "Excluded atheists and Catholics based on civil rather than theological grounds",
            "Critics argued his sharp separation of civil and spiritual realms was unrealistic",
            "Modern readers struggle with his exclusions while recognizing his revolutionary advancement"
          ],
          "items": [
            { "id": "critiques-1", "label": "The Boundaries Problem", "summary": "Locke famously excluded atheists (who he believed couldn't be trusted to keep oaths) and Catholics (whose allegiance to a foreign prince created divided loyalty).", "detail": "These exclusions strike modern readers as inconsistent, even hypocritical. But they reveal something important: Locke wasn't advocating tolerance as abstract principle but solving a concrete problem—maintaining civil peace in religiously diverse society. His exclusions, problematic as they seem, follow from practical concerns about minimal consensus needed for common life." },
            { "id": "critiques-2", "label": "The Moderate Coercion Debate", "summary": "Jonas Proast offered seemingly reasonable compromise: what about 'moderate penalties' to encourage people to consider religious truth more seriously? Not torture, just gentle pressure—fines or civil disabilities.", "detail": "Locke's response was devastating: moderate fines are still force, and force remains categorically unfit to produce belief. Once the state becomes tutor of conscience, minorities live at sufferance. Today's moderate Anglican pressure becomes tomorrow's moderate Catholic pressure. Where the Gospel persuades, the magistrate need not punish; where only punishment can move, there is no Gospel." },
            { "id": "critiques-3", "label": "The Separation Challenge", "summary": "Critics argued Locke's sharp distinction between civil and spiritual realms was artificial—religion inevitably shapes public life and civil law reflects moral commitments.", "detail": "This critique persists today: can religious and civil authority really be separated so cleanly? Locke would respond that the distinction isn't about eliminating religious influence on public morality but about means—persuasion versus coercion. Religious citizens can advocate their views; the state simply cannot enforce religious conformity through civil penalties." }
          ]
        },
        {
          "id": "glossary", "title": "Glossary",
          "intro": "Key terms and concepts essential for understanding Locke's framework of religious toleration and his revolutionary political theology.",
          "bullets": [
            "Technical philosophical terms about the nature of belief and conscience",
            "Historical references to 17th-century religious conflicts and persecutions",
            "Theological concepts about divine governance and human freedom"
          ],
          "items": []
        },
        {
          "id": "source", "title": "Source",
          "intro": "This analysis draws from Locke's 'Letter Concerning Toleration' and its historical context, examining how his argument transformed Western thinking about religious freedom.",
          "bullets": [
            "Primary text provides philosophical and theological arguments for religious toleration",
            "Historical context illuminates the urgency of Locke's intervention during religious persecution",
            "Contemporary relevance shows how these principles apply to modern challenges of conscience"
          ],
          "items": []
        }
      ],
      "glossary": [
        { "term": "Letter Concerning Toleration", "definition": "Locke's 1689 work arguing religious coercion violates both human nature and divine design, published anonymously in Latin while in Dutch exile." },
        { "term": "Civil Interests", "definition": "Life, liberty, health, and property—the proper sphere of government authority according to Locke, operating through law on external actions." },
        { "term": "Voluntary Society", "definition": "Locke's definition of a church: people joining of their own accord for worship, fundamentally different from political communities." },
        { "term": "Edict of Nantes", "definition": "1598 decree by Henry IV granting religious tolerance to French Protestants, ending decades of religious war until Louis XIV's revocation." },
        { "term": "Dragonnades", "definition": "French military units forcibly quartered in Protestant homes to intimidate and coerce conversions through violence and harassment." },
        { "term": "Huguenots", "definition": "French Protestants (Calvinists) who faced severe persecution after 1685, with hundreds of thousands fleeing to England, Holland, and America." },
        { "term": "Interior Forum", "definition": "The conscience as sacred space where the soul stands before God, reserved to divine authority alone, beyond civil jurisdiction." },
        { "term": "Divine Pedagogy", "definition": "God's method of governing souls through illumination and attraction rather than coercion, respecting rational creatures' nature." },
        { "term": "Jonas Proast", "definition": "Anglican chaplain who critiqued Locke's Letter, arguing for 'moderate penalties' to encourage religious consideration." }
      ],
      "quotes": [
        { "text": "True religion consists in the inward and full persuasion of the mind.", "ref": "On the nature of genuine faith" },
        { "text": "A voluntary society of men, joining themselves together of their own accord in order to the public worshipping of God.", "ref": "Locke's definition of a church" },
        { "text": "You can chain a body; you cannot chain a belief.", "ref": "On the limits of civil power" },
        { "text": "Where the Gospel persuades, the magistrate need not punish; where only punishment can move, there is no Gospel.", "ref": "On the futility of religious coercion" },
        { "text": "The God who created minds to know truth through evidence and hearts to respond in love would never authorize force to compel belief.", "ref": "On divine nature and human design" }
      ],
      "timelineChart": {
        "title": "Development of Religious Toleration",
        "labels": ["1598", "1685", "1689", "1690", "1700s", "1776", "Present"],
        "values": [3, 1, 4, 3, 4, 5, 3.5]
      }
    }
    </script>

    <script defer>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ------------------
        // DOM Element Refs
        // ------------------
        const app = {
            header: document.getElementById('app-header'),
            tabs: document.getElementById('app-tabs'),
            panels: document.getElementById('app-panels'),
            searchInput: document.getElementById('searchInput'),
            settings: {
                modal: document.getElementById('settingsModal'),
                btn: document.getElementById('settingsBtn'), // Will be rendered into header
                saveBtn: document.getElementById('saveSettings'),
                cancelBtn: document.getElementById('cancelSettings'),
                themeSelect: document.getElementById('themeSelect')
            }
        };

        // ------------------
        // State Management
        // ------------------
        const state = {
            activeTab: 'overview',
            theme: 'default',
            chartInstance: null
        };

        const loadState = () => {
            const storedTab = localStorage.getItem('activeTab');
            const storedTheme = localStorage.getItem('theme');
            const hashTab = location.hash.substring(1);

            state.theme = storedTheme || 'default';
            state.activeTab = hashTab || storedTab || 'overview';
            
            applyTheme(state.theme);
        };

        const saveState = () => {
            localStorage.setItem('activeTab', state.activeTab);
            localStorage.setItem('theme', state.theme);
        };

        const applyTheme = (theme) => {
            document.documentElement.className = theme === 'default' ? '' : theme;
            if (app.settings.themeSelect) app.settings.themeSelect.value = theme;
            state.theme = theme;
            // If chart exists, update its colors
            if (state.chartInstance) {
                updateChartColors();
            }
        };

        // ------------------
        // Data Loading
        // ------------------
        const loadData = () => {
            try {
                const dataNode = document.getElementById('report-data');
                if (!dataNode) throw new Error('Data script tag not found');
                return JSON.parse(dataNode.textContent);
            } catch (e) {
                console.error("Failed to load or parse report data:", e);
                app.panels.innerHTML = `<p class="text-red-500">Error: Could not load report data.</p>`;
                return null;
            }
        };
        
        const data = loadData();
        if (!data) return; // Stop execution if data fails to load

        // ------------------
        // Render Functions
        // ------------------
        const renderHeader = () => {
            const { meta } = data;
            app.header.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold accent-1 mb-2">${meta.title || 'Report'}</h1>
                        <p class="text-secondary text-lg">${meta.subtitle || ''}</p>
                    </div>
                    <button id="settingsBtn" class="p-3 rounded-lg ui-bg-accent hover:opacity-80 transition-opacity" aria-label="Display Settings">
                        <span class="text-2xl">⚙️</span>
                    </button>
                </div>`;
        };
        
        const renderTabs = () => {
            const { sections } = data;
            const tabsHTML = (sections || []).map(section => `
                <button role="tab" aria-selected="false" aria-controls="${section.id}-panel" id="${section.id}-tab"
                        class="px-6 py-3 font-semibold text-secondary hover:accent-1 transition-colors">
                    ${section.title}
                </button>
            `).join('');
            app.tabs.innerHTML = `<div class="flex flex-wrap">${tabsHTML}</div>`;
        };

        const renderPanels = () => {
            const { sections, glossary, quotes, timelineChart, meta } = data;
            const panelsHTML = (sections || []).map(section => {
                const contextBlock = `
                    <div class="ui-bg-accent rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-bold accent-1 mb-3">Context & Takeaways</h2>
                        <p class="text-primary mb-4">${section.intro || ''}</p>
                        ${section.bullets && section.bullets.length > 0 ? `
                        <ul class="list-disc list-inside space-y-2 text-secondary">
                            ${section.bullets.map(bullet => `<li>${bullet}</li>`).join('')}
                        </ul>` : ''}
                    </div>`;

                let content = '';
                switch(section.id) {
                    case 'overview':
                    case 'critiques':
                    case 'evidence':
                        content = `<div class="space-y-4">
                            ${(section.items || []).map(item => `
                            <div class="accordion" data-searchable="${item.label} ${item.summary} ${item.detail}">
                                <button class="accordion-trigger w-full text-left px-4 py-3 ui-bg-accent rounded-lg font-semibold text-primary hover:opacity-90 transition-opacity" aria-expanded="false">
                                    ${item.label}
                                </button>
                                <div class="accordion-content">
                                  <div>
                                    <div class="mt-2 p-4 ui-bg-accent rounded-lg">
                                        <p class="text-primary mb-3">${item.summary}</p>
                                        <p class="text-secondary">${item.detail}</p>
                                    </div>
                                  </div>
                                </div>
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'concepts':
                         content = `<div class="grid md:grid-cols-2 gap-4">
                            ${(section.items || []).map(item => `
                            <div class="ui-bg-accent rounded-lg p-4" data-searchable="${item.label} ${item.summary} ${item.detail}">
                                <h3 class="font-bold accent-1 mb-2">${item.label}</h3>
                                <p class="text-secondary text-sm mb-3">${item.summary}</p>
                                <p class="text-primary">${item.detail}</p>
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'timeline':
                        const chartHTML = timelineChart ? `
                            <div class="mb-6 chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>` : '';
                        content = `
                            ${chartHTML}
                            <div class="ui-bg-accent rounded-lg p-4 mb-6">
                                <h3 class="font-bold accent-1 mb-3">Historical Data Table</h3>
                                <table class="w-full text-sm">
                                    <thead><tr class="border-b"><th class="text-left py-2">Period</th><th class="text-left py-2">Event</th></tr></thead>
                                    <tbody class="text-primary">
                                        ${(section.items || []).map(item => `<tr class="border-b" data-searchable="${item.label} ${item.detail}"><td class="py-2 font-semibold">${item.label}</td><td class="py-2">${item.detail}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                        break;
                    case 'glossary':
                        content = `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${(glossary || []).map(item => `
                            <div class="ui-bg-accent rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer glossary-card" data-searchable="${item.term} ${item.definition}">
                                <h3 class="font-bold accent-1 mb-2">${item.term}</h3>
                                <p class="text-primary text-sm">${item.definition}</p>
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'source':
                        content = `<div class="space-y-6">
                            <div class="ui-bg-accent rounded-lg p-4">
                                <h3 class="font-bold accent-1 mb-3">Source Information</h3>
                                <div class="space-y-2">${(meta.provenance || []).map(p => `<p class="text-primary"><strong>${p.label}:</strong> ${p.detail}</p>`).join('')}</div>
                            </div>
                            <div class="ui-bg-accent rounded-lg p-4">
                                <h3 class="font-bold accent-1 mb-3">Key Quotes</h3>
                                <div class="space-y-4">${(quotes || []).map(q => `<div class="pl-4 border-l-4 border-accent"><p class="text-primary italic mb-2">"${q.text}"</p><p class="text-secondary text-sm">${q.ref}</p></div>`).join('')}</div>
                            </div>
                        </div>`;
                        break;
                }
                
                return `<div role="tabpanel" id="${section.id}-panel" aria-labelledby="${section.id}-tab" hidden>
                    ${contextBlock}
                    ${content || '<p class="text-secondary">No items yet.</p>'}
                </div>`;
            }).join('');
            app.panels.innerHTML = panelsHTML;
        };

        // ------------------
        // Interactivity
        // ------------------
        const switchTab = (tabId) => {
            const allTabs = app.tabs.querySelectorAll('[role="tab"]');
            const allPanels = app.panels.querySelectorAll('[role="tabpanel"]');
            
            const targetTab = document.getElementById(`${tabId}-tab`);
            if (!targetTab) {
                tabId = data.sections[0].id;
            }

            allTabs.forEach((tab, index) => {
                const isActive = tab.id === `${tabId}-tab`;
                tab.setAttribute('aria-selected', isActive);
                tab.setAttribute('tabindex', isActive ? '0' : '-1');
                tab.classList.toggle('tab-active', isActive);
                tab.classList.toggle('text-secondary', !isActive);
            });

            allPanels.forEach(panel => {
                panel.hidden = panel.id !== `${tabId}-panel`;
            });
            
            if (tabId === 'timeline' && !state.chartInstance && data.timelineChart) {
                setupChart();
            }

            state.activeTab = tabId;
            location.hash = tabId;
            saveState();
        };

        const setupEventListeners = () => {
            // Tabs
            app.tabs.addEventListener('click', e => {
                const tab = e.target.closest('[role="tab"]');
                if (tab) switchTab(tab.id.replace('-tab', ''));
            });
            app.tabs.addEventListener('keydown', e => {
                const tabs = Array.from(app.tabs.querySelectorAll('[role="tab"]'));
                const currentIndex = tabs.findIndex(t => t.id === `${state.activeTab}-tab`);
                let newIndex = currentIndex;

                if (e.key === 'ArrowRight') newIndex = (currentIndex + 1) % tabs.length;
                else if (e.key === 'ArrowLeft') newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                else if (e.key === 'Home') newIndex = 0;
                else if (e.key === 'End') newIndex = tabs.length - 1;
                else return;

                e.preventDefault();
                tabs[newIndex].focus();
                switchTab(tabs[newIndex].id.replace('-tab', ''));
            });

            // Accordions
            app.panels.addEventListener('click', e => {
                const trigger = e.target.closest('.accordion-trigger');
                if (trigger) {
                    const content = trigger.nextElementSibling;
                    const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
                    trigger.setAttribute('aria-expanded', !isExpanded);
                    content.classList.toggle('active');
                }
            });

            // Modal
            const settingsBtn = document.getElementById('settingsBtn'); // Re-query after render
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    app.settings.modal.classList.remove('hidden');
                    app.settings.themeSelect.focus();
                });
            }

            const closeModal = () => {
                app.settings.modal.classList.add('hidden');
                document.getElementById('settingsBtn')?.focus();
            };
            app.settings.saveBtn.addEventListener('click', () => {
                applyTheme(app.settings.themeSelect.value);
                saveState();
                closeModal();
            });
            app.settings.cancelBtn.addEventListener('click', closeModal);
            app.settings.modal.addEventListener('keydown', e => {
                if (e.key === 'Escape') closeModal();
            });

            // Search
            app.searchInput.addEventListener('input', handleSearch);
        };
        
        const handleSearch = (e) => {
            const query = e.target.value.toLowerCase().trim();
            const searchables = document.querySelectorAll('[data-searchable]');
            
            // Clear previous highlights
            searchables.forEach(el => {
                 if(el.hasAttribute('data-searchable-original')) {
                    el.innerHTML = el.getAttribute('data-searchable-original');
                 }
                 el.style.display = '';
            });
            
            if (query.length < 3) return;

            let firstHit = null;

            searchables.forEach(el => {
                if (!el.hasAttribute('data-searchable-original')) {
                    el.setAttribute('data-searchable-original', el.innerHTML);
                }
                const text = el.dataset.searchable.toLowerCase();
                if (text.includes(query)) {
                    if (!firstHit) firstHit = el;
                    el.style.display = '';
                    const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    el.innerHTML = el.getAttribute('data-searchable-original').replace(regex, `<mark class="search-highlight">$&</mark>`);
                } else {
                    el.style.display = 'none';
                }
            });

            if (firstHit) {
                const panel = firstHit.closest('[role="tabpanel"]');
                if (panel && panel.hidden) {
                    switchTab(panel.id.replace('-panel', ''));
                }
                setTimeout(() => {
                    firstHit.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstHit.focus({ preventScroll: true });
                }, 200);
            }
        };

        // ------------------
        // Chart.js Setup
        // ------------------
        const setupChart = () => {
            const { timelineChart } = data;
            if (!timelineChart) return;
            const ctx = document.getElementById('timelineChart')?.getContext('2d');
            if (!ctx) return;

            const chartData = {
                type: 'line',
                data: {
                    labels: timelineChart.labels,
                    datasets: [{
                        label: timelineChart.title,
                        data: timelineChart.values,
                        tension: 0.3,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { display: false } } }
                }
            };

            state.chartInstance = new Chart(ctx, chartData);
            updateChartColors();

            const container = document.querySelector('.chart-container');
            if (container && !container.hasAttribute('data-resize-observer-attached')) {
                container.setAttribute('data-resize-observer-attached', 'true');
                new ResizeObserver(() => {
                    if(state.chartInstance) state.chartInstance.resize();
                }).observe(container);
            }
        };

        const updateChartColors = () => {
            if (!state.chartInstance) return;
            const style = getComputedStyle(document.documentElement);
            state.chartInstance.data.datasets[0].borderColor = style.getPropertyValue('--accent-1');
            state.chartInstance.data.datasets[0].backgroundColor = style.getPropertyValue('--accent-2');
            state.chartInstance.options.plugins.legend.labels.color = style.getPropertyValue('--text-primary');
            state.chartInstance.options.scales.x.ticks.color = style.getPropertyValue('--text-secondary');
            state.chartInstance.update();
        };

        // ------------------
        // Initialization
        // ------------------
        const init = () => {
            loadState();
            renderHeader();
            renderTabs();
            renderPanels();
            setupEventListeners();
            switchTab(state.activeTab);

            window.addEventListener('hashchange', () => {
                const hashTab = location.hash.substring(1);
                if (hashTab && hashTab !== state.activeTab) {
                    switchTab(hashTab);
                }
            });
        };

        init();
    });
    </script>
</body>
</html>
