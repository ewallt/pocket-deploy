<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF--8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Scriptural Canvas</title>

  <!-- Prepaint bootstrap: set dark + theme class before paint to avoid flicker -->
  <script>
  (function () {
    const root = document.documentElement;
    try {
      const savedTheme = localStorage.getItem('theme');       // 'light' | 'dark' | null
      const savedColor = localStorage.getItem('colorScheme'); // 'slate' | 'emerald' | future
      const isDark = savedTheme !== 'light';                  // default to dark if unset
      root.classList.toggle('dark', isDark);
      // Apply colored theme classes ONLY in dark mode; light is always neutral slate
      root.classList.toggle('theme-emerald', isDark && savedColor === 'emerald');
    } catch (_) {}
  })();
  </script>

  <!-- Tailwind (with Typography) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Google Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

  <style>
  :root { color-scheme: light dark; }
  html { scroll-behavior: smooth; }
  .font-newspaper { font-family: 'Lora', serif; }
  :where(h2,h3,h4){ scroll-margin-top: 84px; }
  mark { background: #fde68a; padding: .1em .2em; border-radius: .2rem; }
  @media (max-width: 380px){ .prose { font-size: .96rem; } }

  /* ---------- Semantic surfaces (read from CSS variables) ---------- */
.hero {
  /* give the header an explicit base fill so gradient blends to the right hue */
  background-color: var(--hero-base);
  background:
    radial-gradient(50% 120% at 10% 10%, var(--hero-r1), transparent 60%),
    radial-gradient(80% 140% at 90% 10%, var(--hero-r2), transparent 70%),
    linear-gradient(180deg, var(--hero-wash), transparent 35%);
}
.border-var { border-color: var(--border) !important; }
.surface { border-width: 1px; border-style: solid; border-color: var(--border); }
.hr-var { border-color: var(--border); }
.subtitle { color: var(--subtitle-fg); }
.timeline-fg { color: var(--timeline-fg); }
.footer-note { color: var(--footer-fg); }
.active-link { color: var(--active); font-weight: 700; }

.input-surface {
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
}
.btn-surface { border: 1px solid var(--btn-border); }
.btn-surface:hover { background: var(--btn-hover-bg); }
.toc-link:hover { background: var(--hover-bg); }

/* ---------- Slate (default) variables ---------- */
:root{
  /* accents / inks */
  --active: rgb(59,130,246);                      /* sky-500 */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(100,116,139);                /* slate-500 */
  --footer-fg: rgb(100,116,139);                  /* slate-500 */

  /* surfaces */
  --border: rgb(226,232,240);                     /* slate-200 */
  --hover-bg: rgb(248,250,252);                   /* slate-50 */
  --btn-border: rgb(203,213,225);                 /* slate-300 */
  --btn-hover-bg: rgb(248,250,252);               /* slate-50 */
  --input-border: rgba(203,213,225,0.7);          /* slate-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* hero base & gradient (light) */
  --hero-base: transparent;                       /* keep light header airy */
  --hero-r1: rgba(49,46,129,.12);                 /* indigo-700 */
  --hero-r2: rgba(234,88,12,.12);                 /* orange-600 hint */
  --hero-wash: rgba(14,165,233,.08);              /* sky-500 wash */
}
.dark{
  --subtitle-fg: rgb(203,213,225);                /* slate-300 */
  --timeline-fg: rgb(148,163,184);                /* slate-400 */
  --footer-fg: rgb(148,163,184);                  /* slate-400 */

  --border: rgb(30,41,59);                        /* slate-800 */
  --hover-bg: rgb(15,23,42);                      /* slate-900 */
  --btn-border: rgb(51,65,85);                    /* slate-700 */
  --btn-hover-bg: rgb(15,23,42);                  /* slate-900 */
  --input-border: rgba(51,65,85,0.7);             /* slate-700/70 */
  --input-bg: rgba(2,6,23,0.6);                   /* slate-950/60 */

  /* hero base & gradient (dark) */
  --hero-base: rgb(2,6,23);                       /* slate-950 */
  --hero-r1: rgba(49,46,129,.12);
  --hero-r2: rgba(234,88,12,.12);
  --hero-wash: rgba(14,165,233,.08);
}

/* ---------- Emerald theme overrides (light & dark) ---------- */
.theme-emerald{
  --active: #10b981;                              /* emerald-500 */

  --border: rgb(187,247,208);                     /* emerald-200 */
  --hover-bg: rgb(240,253,244);                   /* emerald-50 */
  --btn-border: rgb(187,247,208);                 /* emerald-200 */
  --btn-hover-bg: rgb(240,253,244);               /* emerald-50 */
  --input-border: rgba(110,231,183,0.7);          /* emerald-300/70 */
  --input-bg: rgba(255,255,255,0.7);              /* white/70 */

  /* keep subtitles/timeline neutral for readability over hero */
  --subtitle-fg: rgb(71,85,105);                  /* slate-600 */
  --timeline-fg: rgb(71,85,105);                  /* slate-600 */
  --footer-fg: rgb(16,185,129);                   /* emerald-500 */

  /* hero base & gradient (emerald light) */
  --hero-base: transparent;
  --hero-r1: rgba(16,185,129,.14);                /* emerald-500 */
  --hero-r2: rgba(163,230,53,.12);                /* lime-400 */
  --hero-wash: rgba(5,150,105,.10);               /* emerald-600 wash */
}
.dark.theme-emerald{
  /* ↑ Give borders enough contrast on dark emerald surfaces */
  --border: rgba(110,231,183,0.55);                /* emerald-300 @ 55% */
  --hover-bg: rgb(6,78,59);                        /* emerald-900 */
  --btn-border: rgba(110,231,183,0.45);            /* slightly softer than borders */
  --btn-hover-bg: rgb(6,78,59);                    /* emerald-900 */
  --input-border: rgba(110,231,183,0.55);          /* match border contrast */
  --input-bg: rgba(6,95,70,0.60);                  /* emerald-900/60 */

  /* text accents for readability */
  --footer-fg: rgb(110,231,183);                   /* emerald-300/400 */
  --subtitle-fg: rgb(226,252,236);                 /* emerald-100 */
  --timeline-fg: rgb(187,247,208);                 /* emerald-200 */

  /* hero base & gradient (unchanged, stays emerald) */
  --hero-base: rgb(2,44,34);                       /* emerald-950 (#022c22) */
  --hero-r1: rgba(16,185,129,.14);
  --hero-r2: rgba(163,230,53,.12);
  --hero-wash: rgba(5,150,105,.10);
}

/* ===== Mobile FAB quick settings ===== */
#fabPanel.show { display:block; animation: fadeUp .14s ease-out; }
@keyframes fadeUp { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
  </style>

</head>

<body class="bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]">

  <!-- Header -->
  <header id="top" class="hero border-b border-var">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between gap-4">
      <div>
        <h1 id="docTitle" class="text-2xl sm:text-3xl font-bold font-newspaper tracking-tight">Loading...</h1>
        <p id="docSubtitle" class="subtitle text-sm sm:text-base"></p>
      </div>
      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search…" class="hidden md:block w-56 rounded-xl input-surface px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <button id="clearSearch" type="button" class="hidden md:inline-flex text-xs px-2 py-2 rounded-lg btn-surface">Clear</button>

        <!-- Header controls: hidden on small screens -->
        <button id="colorSchemeToggle" type="button" class="hidden sm:inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Change color scheme">
          <span class="inline md:hidden">Colors</span>
          <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
            <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
            <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
            <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 7.012 17.461 2 12 2z"/>
          </svg>
        </button>
        <button id="themeToggle" type="button" class="hidden sm:inline-flex items-center justify-center rounded-xl btn-surface px-3 py-2 text-sm" title="Toggle dark mode" aria-pressed="false">
          <span class="inline md:hidden">Theme</span>
          <svg aria-hidden="true" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg aria-hidden="true" class="w-5 h-5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </div>

    <!-- Timeline -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6" id="timelineWrap" hidden>
      <nav aria-label="Journey timeline" id="timelineNav" class="timeline-fg">
        <ol id="timeline" class="grid grid-cols-3 sm:grid-cols-6 items-center gap-x-2 gap-y-1 text-[11px] sm:text-sm"></ol>
        <div id="timelineCoda" class="mt-2 text-[11px] sm:text-xs"></div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)] gap-8">
    <!-- Sidebar -->
    <aside class="lg:sticky lg:top-4 h-max">
      <nav aria-label="On this page" class="rounded-2xl surface p-4">
        <h2 class="text-sm font-semibold mb-2">Sections</h2>
        <ol id="toc" class="space-y-1 text-sm"></ol>
        <hr class="my-4 hr-var" />
        <button id="expandAll" type="button" class="w-full text-xs px-3 py-2 rounded-lg btn-surface">Expand All</button>
        <button id="collapseAll" type="button" class="mt-2 w-full text-xs px-3 py-2 rounded-lg btn-surface">Collapse All</button>
      </nav>
    </aside>

    <section id="content" class="prose prose-slate dark:prose-invert max-w-none">
      <!-- Content is generated by script from JSON -->
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 text-xs footer-note">
    Threaded Reader — a single-file template
  </footer>

  <!-- Mobile quick settings FAB + Panel -->
  <button id="fab" class="fixed z-40 top-4 right-4 sm:hidden rounded-full shadow-lg px-4 py-3 text-sm btn-surface backdrop-blur">
    ⚙️
  </button>
  <div id="fabPanel" class="bg-white dark:bg-slate-800 sm:hidden fixed z-40 top-20 right-4 w-56 rounded-xl surface p-3 hidden">
    <div class="text-xs mb-2 opacity-80">Quick settings</div>
    <button id="fabTheme" class="w-full text-sm px-3 py-2 rounded-lg btn-surface mb-2">Toggle Theme</button>
    <button id="fabColor" class="w-full text-sm px-3 py-2 rounded-lg btn-surface">Cycle Colors</button>
  </div>

  <script id="embedded-json" type="application/json">
    {
      "title": "The Scriptural Canvas",
      "description": "Exploring the key Old Testament stories, symbols, and prophecies that provide the theological vocabulary for the cross.",
      "articles": [
        {
          "title": "The Passover Lamb",
          "introduction": "The story of the Passover, recounted in Exodus 12, is the foundational act of redemption in the Old Testament. It is a dramatic event of divine judgment and miraculous deliverance, where the blood of a perfect lamb becomes the dividing line between death and life. This powerful narrative provides the primary symbolic language for the New Testament's understanding of Christ's sacrifice.",
          "threads": [
            {
              "title": "Judgment and Deliverance",
              "content": "<p>The context for the Passover is the final plague God brings upon Egypt: the death of the firstborn. This is an act of divine judgment against the hardness of Pharaoh's heart and the injustice of slavery. Yet, within this terrifying judgment, God provides a way of escape for his people. The event is therefore two-sided: it is a story of a holy God confronting evil, and a merciful God delivering his chosen people. It establishes a core principle: <mark>salvation happens in the midst of judgment.</mark></p>"
            },
            {
              "title": "The Blood on the Doorpost",
              "content": "<p>The specific instruction for deliverance is precise. Each Israelite household is to take a lamb 'without blemish' and apply its blood to the two doorposts and the lintel of their house. God declares, 'When I see the blood, I will pass over you.' The blood does not ward off evil in a magical sense; it serves as a sign of obedience and faith, marking the inhabitants as those who have taken refuge under God's provision. It is a clear act of <mark>substitution</mark>: the life of the lamb is given so that the life of the firstborn within the house may be spared.</p>"
            },
            {
              "title": "A Blemishless Sacrifice",
              "content": "<p>The requirement that the lamb be 'without blemish' is crucial. It establishes the principle that the substitute must be perfect and valuable. This was not to be a throwaway offering; it was a cost. The family had to select a prime, year-old male from their flock, signifying that deliverance is not cheap. This theme of a perfect, spotless sacrifice echoes throughout the entire sacrificial system and finds its ultimate fulfillment in the person of Christ, described by Peter as a 'lamb without blemish or spot' (1 Peter 1:19).</p>"
            },
            {
              "title": "A Communal Meal",
              "content": "<p>The Passover was not just about the act of sacrifice; it was also a sacred, communal meal. The people were to roast and eat the lamb together, with unleavened bread and bitter herbs. This meal, eaten in haste with sandals on their feet and staffs in their hands, was a meal of remembrance and readiness. It forged a collective identity for Israel as a redeemed people, and it was to be re-enacted annually to recall and re-live this foundational moment of their salvation. It was the meal that created the community.</p>"
            },
            {
              "title": "Christ, Our Passover Lamb",
              "content": "<p>The New Testament writers explicitly connect Jesus's death to the Passover. John the Baptist introduces Jesus as 'the Lamb of God, who takes away the sin of the world' (John 1:29). The Gospel of John carefully times Jesus's crucifixion to the very moment the Passover lambs were being sacrificed in the Temple. And the Apostle Paul states it most directly: 'For Christ, <mark>our Passover lamb</mark>, has been sacrificed' (1 Corinthians 5:7). For the early church, the Passover was not just a backstory; it was the divine pattern that gave Jesus's death its deepest meaning as a substitutionary sacrifice that delivers God's people from death and slavery to sin.</p>"
            }
          ]
        },
        {
          "title": "The Day of Atonement (Yom Kippur)",
          "introduction": "Described in detail in Leviticus 16, the Day of Atonement, or Yom Kippur, was the most sacred and solemn day in ancient Israel's religious calendar. It was the one day a year the High Priest entered the Holy of Holies, the very presence of God, to perform a complex set of rituals designed to cleanse the entire nation and the sanctuary itself from sin. This ceremony provides a rich, multi-faceted picture of how atonement works.",
          "threads": [
            {
              "title": "The High Priest as Mediator",
              "content": "<p>The central figure of the ceremony is the High Priest. He alone can enter the innermost sanctuary, and only after undergoing meticulous rituals of personal purification. He acts as the sole <mark>mediator</mark> between a holy God and a sinful people. He bears the weight and responsibility of the entire community, first making atonement for his own sins, and then for the sins of the nation. This highlights the seriousness of approaching God and the need for a divinely appointed representative to stand in the gap.</p>"
            },
            {
              "title": "The Sin Offering: Cleansing the Sanctuary",
              "content": "<p>The blood of the first goat, the sin offering, is carried by the High Priest into the Holy of Holies and sprinkled on the 'mercy seat' of the Ark of the Covenant. The primary purpose of this act is to <mark>cleanse the sacred space</mark> itself. The accumulated sins of the people have polluted the sanctuary, jeopardizing God's continued presence among them. The blood of the sacrifice purges this defilement, satisfying God's holiness (propitiation) and making communion possible for another year. It shows that sin is not just a personal failing, but a cosmic pollutant.</p>"
            },
            {
              "title": "The Scapegoat: Removing the Sin",
              "content": "<p>In one of the most powerful visual aids in the Bible, the High Priest then lays his hands on the head of a second, live goat—the 'scapegoat.' As he does this, he confesses all the iniquities and transgressions of Israel, symbolically transferring the nation's guilt onto the animal. This goat is then led away into the barren wilderness, physically carrying their sins away 'to a remote place.' This ritual, known as <mark>expiation</mark>, provided the people with tangible assurance that their confessed sins were not just forgiven, but truly removed from their midst, never to be seen again.</p>"
            },
            {
              "title": "Two Goats, One Atonement",
              "content": "<p>The ritual requires two goats because no single action can capture the full meaning of atonement. The two goats represent two essential dimensions of the same saving act. The sacrificed goat deals with the vertical problem: the offense to God's holiness is dealt with, and the sanctuary is purified. The scapegoat deals with the horizontal problem: the burden of guilt is lifted from the community and removed completely. Together, they show that God's solution to sin is comprehensive, addressing both our need for cleansing and our need for release.</p>"
            },
            {
              "title": "The Fulfillment in Hebrews",
              "content": "<p>The New Testament book of Hebrews interprets the Day of Atonement as a magnificent foreshadowing of Christ's work. It presents Jesus as both the ultimate High Priest and the perfect, once-for-all sacrifice. Unlike the earthly priest, he did not need to offer a sacrifice for his own sin. And he entered not a man-made sanctuary, but the true heavenly sanctuary, with his own blood, securing an 'eternal redemption' (Hebrews 9:11-12). He fulfilled both roles: his sacrificial death <mark>cleansed us from a guilty conscience</mark>, and he has <mark>removed our transgressions</mark> as far as the east is from the west.</p>"
            }
          ]
        },
        {
          "title": "The Suffering Servant",
          "introduction": "The 'Servant Songs' in the book of Isaiah reach their stunning climax in chapter 53. This passage paints a prophetic portrait of a mysterious individual who is despised, rejected, and ultimately killed. Yet, his suffering is not for his own wrongdoing. In a profound reversal, his vicarious and substitutionary death becomes the very means by which God brings healing, forgiveness, and justification to 'the many.' This text became the primary interpretive key for the early church to understand the meaning of the cross.",
          "threads": [
            {
              "title": "The Servant's Identity",
              "content": "<p>Throughout Isaiah, the identity of the 'Servant' is complex. Sometimes the Servant is clearly the nation of Israel, called to be a light to the nations but often failing in that mission. At other times, the Servant is portrayed as an ideal individual, a prophet or king who will fulfill that calling perfectly. This creates a prophetic tension: Is the Servant the flawed nation or the ideal individual? The New Testament resolves this by identifying <mark>Jesus as the true and perfect Servant</mark> who fulfills Israel's destiny on behalf of the world.</p>"
            },
            {
              "title": "'Pierced for Our Transgressions'",
              "content": "<p>The heart of the passage lies in its powerful substitutionary language. The prophet declares, 'Surely he has borne our griefs and carried our sorrows... he was pierced for our transgressions; he was crushed for our iniquities' (Isaiah 53:4-5). The pronouns shift dramatically: his suffering is for *us*. It is a vicarious suffering, meaning it is endured *on behalf of* others. The punishment that brought *us* peace was upon him, and by his wounds, *we* are healed. This is one of the clearest expressions of substitutionary atonement in all of Scripture.</p>"
            },
            {
              "title": "A Guilt Offering ('Asham')",
              "content": "<p>Isaiah 53:10 uses a specific, technical term from Israel's sacrificial system. It says the Lord makes the Servant's life a 'guilt offering' (*asham*). In the law of Moses, a guilt offering was required in cases of sacrilege or desecration—when holy things were violated. It involved not only sacrifice but also restitution. By using this term, the prophet indicates that the Servant's death is not just a generic sacrifice, but a specific, reparative act that <mark>makes amends for humanity's violation of God's holiness</mark> and restores what was broken.</p>"
            },
            {
              "title": "Vindication and Exaltation",
              "content": "<p>Crucially, the Servant's story does not end in a tragic death. After his suffering, the prophecy states that he will 'see his offspring' and 'prolong his days.' He will be exalted and highly lifted up. This points beyond death to vindication and resurrection. His death is not a defeat but a fruitful, life-giving victory that accomplishes God's purpose. It is because he 'poured out his soul to death' that he is able to 'make many to be accounted righteous' (Isaiah 53:11-12). His exaltation is the proof of his successful atoning work.</p>"
            },
            {
              "title": "The New Testament Witness",
              "content": "<p>The early Christians immediately recognized Isaiah 53 as the divine script for Jesus's passion. When Philip meets the Ethiopian eunuch in Acts 8, the eunuch is reading this very chapter, and Philip 'told him the good news about Jesus' starting from that passage. The apostles Peter and Paul both quote it extensively to explain how Christ's death fulfills God's plan. For them, Isaiah 53 was not a puzzle; it was a <mark>revelation that unlocked the deepest meaning of the cross</mark> as God's predetermined plan to save the world through the suffering of his righteous Servant.</p>"
            }
          ]
        }
      ]
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const slug = s => s.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');

      // ===== Read Metadata from JSON =====
      let jsonData = {};
      try {
        jsonData = JSON.parse(document.getElementById('embedded-json').textContent);
      } catch (e) {
        console.error("Error parsing embedded JSON:", e);
        document.getElementById('docTitle').textContent = 'Error Loading Content';
        return;
      }
      const docTitle = jsonData.title || 'Untitled Document';
      const docSubtitle = jsonData.description || '';
      const timelineStepsData = jsonData.timeline_steps;
      const timelineLabelsData = jsonData.timeline_labels;
      
      // ===== Populate Header from Metadata =====
      document.getElementById('docTitle').textContent = docTitle;
      document.getElementById('docSubtitle').textContent = docSubtitle;
      document.title = docTitle;

      // ===== Build Content from JSON =====
      const contentSection = document.getElementById('content');
      let contentHtml = '';
      if (jsonData.articles) {
        jsonData.articles.forEach(article => {
          contentHtml += `<article id="${slug(article.title)}">`;
          contentHtml += `<h2>${article.title}</h2>`;
          if (article.introduction) {
            contentHtml += `<p class="lead">${article.introduction}</p>`;
          }
          if (article.threads) {
            article.threads.forEach(thread => {
              contentHtml += `<details open>`;
              contentHtml += `<summary><h3>${thread.title}</h3></summary>`;
              if (thread.content) {
                contentHtml += `<div class="pl-4 border-l-2 border-var">${thread.content}</div>`;
              }
              contentHtml += `</details>`;
            });
          }
          contentHtml += `</article>`;
        });
      }
      contentSection.innerHTML = contentHtml;

      // ===== Theme packs =====
      const THEME_PACKS = {
        slate: {
          proseClass: 'prose-slate',
          bodyClass: 'bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100 pb-[env(safe-area-inset-bottom)]'
        },
        emerald: {
          proseClass: 'prose-emerald',
          bodyClass: 'bg-white text-emerald-900 dark:bg-emerald-950 dark:text-emerald-100 pb-[env(safe-area-inset-bottom)]'
        }
      };
      const availableThemes = Object.keys(THEME_PACKS);

      function applyTheme(themeKey){
        const root = document.documentElement;
        const isDark = root.classList.contains('dark');
        const pack = THEME_PACKS[themeKey] || THEME_PACKS.slate;
        root.classList.toggle('theme-emerald', isDark && themeKey === 'emerald');
        document.body.className = isDark ? pack.bodyClass : THEME_PACKS.slate.bodyClass;
        contentSection.className = `prose ${pack.proseClass} dark:prose-invert max-w-none`;
        try { localStorage.setItem('colorScheme', themeKey); } catch(_){}
      }

      let currentThemeIndex = 0;
      try {
        const saved = localStorage.getItem('colorScheme');
        if (saved && THEME_PACKS[saved]) currentThemeIndex = availableThemes.indexOf(saved);
      } catch(_) {}
      
      const colorBtn = document.getElementById('colorSchemeToggle');
      colorBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        if (!root.classList.contains('dark')) {
          root.classList.add('dark');
          try { localStorage.setItem('theme','dark'); } catch(_){}
          document.getElementById('themeToggle')?.setAttribute('aria-pressed','true');
          applyTheme(availableThemes[currentThemeIndex]); // apply color when switching to dark
          return;
        }
        currentThemeIndex = (currentThemeIndex + 1) % availableThemes.length;
        const newTheme = availableThemes[currentThemeIndex];
        applyTheme(newTheme);
        buildTOC();
      });

      const themeBtn = document.getElementById('themeToggle');
      if (themeBtn) {
        themeBtn.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')));
      }
      themeBtn?.addEventListener('click', () => {
        const root = document.documentElement;
        const isDark = root.classList.toggle('dark');
        try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_){}
        themeBtn.setAttribute('aria-pressed', String(isDark));

        if (!isDark) {
          root.classList.remove('theme-emerald');
          applyTheme('slate');
        } else {
          let saved = 'slate';
          try { const s = localStorage.getItem('colorScheme'); if (s) saved = s; } catch(_){}
          applyTheme(saved);
        }
        buildTOC();
      });

      // ===== Expand/Collapse, TOC, Timeline, Search =====
      const getDetails = () => document.querySelectorAll('#content details');
      const expandBtn = document.getElementById('expandAll');
      const collapseBtn = document.getElementById('collapseAll');

      if (getDetails().length === 0) {
        if(expandBtn) expandBtn.hidden = true;
        if(collapseBtn) collapseBtn.hidden = true;
      } else {
        expandBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = true); });
        collapseBtn?.addEventListener('click', () => { getDetails().forEach(d => d.open = false); });
      }

      (function addBackToTopLinks(){
        $$('#content > article').forEach((article, index, arr) => {
          if (index === arr.length - 1) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'mt-6 flex justify-end';
          wrapper.innerHTML = `<a href="#top" class="text-sm underline decoration-dotted">Back to top</a>`;
          article.appendChild(wrapper);
        });
      })();

      function buildTOC(){
        const toc = document.getElementById('toc');
        if (!toc) return;
        const headings = $$('#content h2, #content h3');
        const items = headings.map(h => {
          const parentArticle = h.closest('article');
          const parentSlug = parentArticle ? parentArticle.id : '';
          if (!h.id) h.id = parentSlug + '-' + slug(h.textContent);
          return { id: h.id, text: h.textContent.trim(), level: h.tagName.toLowerCase() };
        });

        toc.innerHTML = items.map(({id, text, level}) => {
          const pad = level === 'h3' ? ' pl-4' : '';
          return `<li><a href="#${id}" class="toc-link block px-2 py-1.5 rounded${pad}">${text}</a></li>`;
        }).join('');

        const links = $$('#toc a');
        const sections = items.map(i => document.getElementById(i.id));
        const obs = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              links.forEach(a => a.classList.remove('active-link'));
              const id = '#' + e.target.id;
              const active = links.find(a => a.getAttribute('href') === id);
              active?.classList.add('active-link');
            }
          });
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
        sections.forEach(sec => sec && obs.observe(sec));
      }
      
      (function buildTimeline(){
        const wrap = document.getElementById('timelineWrap');
        const list = document.getElementById('timeline');
        const coda = document.getElementById('timelineCoda');

        if (!timelineStepsData || !wrap || !list) { if(wrap) wrap.hidden = true; return; }
        const steps = timelineStepsData.split(',').map(s => s.trim());
        const labels = timelineLabelsData ? timelineLabelsData.split(',').map(s => s.trim()) : [];
        if (!steps.length) { wrap.hidden = true; return; }
        wrap.hidden = false;

        const mkStep = (id, label) => (
          `<li class="flex items-center gap-2"><span class="inline-block w-[14px] h-[14px] rounded-full border-2 border-current bg-current"></span><a href="#${id}" class="hover:underline">${label}</a></li>`
        );
        const segments = [];
        steps.forEach((id, idx) => {
          const el = $$('#content h2, #content h3').find(h => slug(h.textContent) === id);
          if (el && !el.id) el.id = id;
          const label = labels[idx] || (el?.textContent || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
          segments.push(mkStep(id, label));
          if (idx !== steps.length - 1) segments.push('<li class="h-[2px] bg-current opacity-35"></li>');
        });
        list.innerHTML = segments.join('');
      })();

      (function searchHL(){
        const input = document.getElementById('search');
        const clearBtn = document.getElementById('clearSearch');
        if (!input || !contentSection) return;
        let originalHTML = '';
        function restore(){ 
          if (originalHTML) {
            contentSection.innerHTML = originalHTML; 
            buildTOC(); // Rebuild TOC to reattach observers
          }
        }
        function highlight(term){
          if (!originalHTML) originalHTML = contentSection.innerHTML;
          restore();
          if (!term) return;
          const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${esc})(?![^<]*>)`, 'gi');
          contentSection.innerHTML = contentSection.innerHTML.replace(re, '<mark>$1</mark>');
          buildTOC();
        }
        let t; 
        input.addEventListener('input', (e) => { 
          clearTimeout(t); 
          t = setTimeout(() => highlight(e.target.value.trim()), 120); 
        });
        clearBtn?.addEventListener('click', () => { 
          if (input) input.value=''; 
          restore(); 
        });
      })();

      buildTOC();
      try {
        const saved = localStorage.getItem('colorScheme');
        applyTheme(saved && THEME_PACKS[saved] ? saved : 'slate');
      } catch(_){
        applyTheme('slate');
      }

      // ===== Mobile FAB wiring =====
      const fab = document.getElementById('fab');
      const fabPanel = document.getElementById('fabPanel');
      const fabTheme = document.getElementById('fabTheme');
      const fabColor = document.getElementById('fabColor');

      fab?.addEventListener('click', () => fabPanel.classList.toggle('show'));
      document.addEventListener('click', (e)=>{
        if (fabPanel && !fabPanel.contains(e.target) && fab && !fab.contains(e.target)) fabPanel.classList.remove('show');
      });
      fabTheme?.addEventListener('click', () => document.getElementById('themeToggle')?.click());
      fabColor?.addEventListener('click', () => document.getElementById('colorSchemeToggle')?.click());
    });
  </script>
</body>
</html>
