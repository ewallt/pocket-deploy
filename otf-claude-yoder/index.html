<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Politics of the Lamb - Interactive Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);
            --accent-1: #2563eb;
            --accent-2: #1d4ed8;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --ui-background: #ffffff;
            --ui-background-accent: #f1f5f9;
            --btn-gradient: linear-gradient(45deg,#2563eb,#1d4ed8);
        }
        .theme-navy {
            --bg-gradient: linear-gradient(135deg,#0a0a23 0%,#1a1a3a 50%,#2e2e5e 100%);
            --accent-1: #60a5fa;
            --accent-2: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --ui-background: #1e293b;
            --ui-background-accent: #334155;
            --btn-gradient: linear-gradient(45deg,#3b82f6,#1e40af);
        }
        .theme-emerald {
            --bg-gradient: linear-gradient(135deg,#022c22 0%,#064e3b 60%,#065f46 100%);
            --accent-1: #f0c475;
            --accent-2: #d4a24c;
            --text-primary: #ecfdf5;
            --text-secondary: #a7f3d0;
            --ui-background: #064e3b;
            --ui-background-accent: #065f46;
            --btn-gradient: linear-gradient(45deg,#10b981,#065f46);
        }
        body { background: var(--bg-gradient); color: var(--text-primary); min-height: 100vh; }
        .ui-bg { background-color: var(--ui-background); }
        .ui-bg-accent { background-color: var(--ui-background-accent); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .accent-1 { color: var(--accent-1); }
        .accent-2 { color: var(--accent-2); }
        .btn-gradient { background: var(--btn-gradient); }
        .border-accent { border-color: var(--accent-1); }
        *:focus-visible { outline: 3px solid var(--accent-1); outline-offset: 2px; }
        .tab-active { border-bottom: 3px solid var(--accent-1); color: var(--accent-1); }
        .accordion-content {
            display: grid;
            grid-template-rows: 0fr;
            opacity: 0.5;
            transition: grid-template-rows 0.4s ease-out, opacity 0.3s ease-out;
        }
        .accordion-content > div { overflow: hidden; }
        .accordion-content.active {
            grid-template-rows: 1fr;
            opacity: 1;
            transition: grid-template-rows 0.5s ease-in, opacity 0.5s ease-in;
        }
        .search-highlight { background-color: #fef08a; color: #713f12; }
        .theme-navy .search-highlight { background-color: #fde047; color: #1e293b; }
        .theme-emerald .search-highlight { background-color: #a7f3d0; color: #064e3b; }
        .chart-container { position: relative; width: 100%; max-width: 48rem; margin: 0 auto; height: 20rem; max-height: 450px; }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header: Dynamically rendered -->
        <header id="app-header" class="ui-bg rounded-lg shadow-lg p-6 mb-6"></header>
        
        <!-- Search Bar -->
        <div class="ui-bg rounded-lg shadow-lg p-4 mb-6">
            <input type="search" id="searchInput" placeholder="Search concepts, people, or events..." 
                   class="w-full px-4 py-2 rounded-lg ui-bg-accent text-primary placeholder-gray-500 focus:ring-2">
        </div>
        
        <!-- Tab Navigation: Dynamically rendered -->
        <nav id="app-tabs" class="ui-bg rounded-lg shadow-lg mb-6" role="tablist" aria-label="Main navigation"></nav>
        
        <!-- Tab Panels: Dynamically rendered -->
        <main id="app-panels" class="ui-bg rounded-lg shadow-lg p-6"></main>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settings-title">
            <div class="ui-bg rounded-lg p-6 max-w-md w-full">
                <h2 id="settings-title" class="text-xl font-bold accent-1 mb-4">Display Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="themeSelect" class="block text-primary font-semibold mb-2">Theme</label>
                        <select id="themeSelect" class="w-full px-3 py-2 rounded ui-bg-accent text-primary">
                            <option value="default">Light (Default)</option>
                            <option value="theme-navy">Navy Blue</option>
                            <option value="theme-emerald">Green + Gold</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancelSettings" class="px-4 py-2 rounded ui-bg-accent text-primary hover:opacity-80">Cancel</button>
                    <button id="saveSettings" class="px-4 py-2 rounded btn-gradient text-white hover:opacity-80">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Island -->
    <script type="application/json" id="report-data">
    {
      "meta": {
        "title": "The Politics of the Lamb",
        "subtitle": "John Howard Yoder's Revolutionary Vision of Divine Non-Violence",
        "provenance": [
          { "label": "Title", "detail": "The Politics of the Lamb: John Howard Yoder on Why God's Kingdom Rejects the Sword" },
          { "label": "Subtitle", "detail": "How a Mennonite theologian showed that Jesus's non-violence wasn't practical compromise but the revelation of how God governs" },
          { "label": "Type", "detail": "Long-form theological and historical analysis" }
        ]
      },
      "sections": [
        {
          "id": "overview", "title": "Overview",
          "intro": "John Howard Yoder revolutionized Christian political theology by arguing that Jesus's non-violence wasn't impractical idealism but the revelation of how God actually exercises sovereignty—through suffering love rather than coercive force.",
          "bullets": [
            "Yoder's 1969 work challenged 1,600 years of Constantinian Christianity that had embraced coercive power",
            "Drawing from Anabaptist tradition, he argued the cross reveals God's permanent method of governance",
            "His personal failures complicate but don't negate his theological insights about divine non-coercion"
          ],
          "items": [
            { "id": "overview-1", "label": "The Anabaptist Foundation", "summary": "The Anabaptists emerged in the 1520s with a radical claim: if Jesus commanded love of enemies, Christians couldn't kill. This conviction cost thousands their lives, documented in the 1,100-page Martyrs' Mirror.", "detail": "Felix Manz, the first Anabaptist martyr, was drowned in 1527 for refusing infant baptism and the sword. His last words—\"Into thy hands, Lord, I commend my spirit\"—exemplified the tradition's commitment to following Christ even unto death." },
            { "id": "overview-2", "label": "The Constantinian Shift", "summary": "Yoder identified the fourth-century \"Constantinian shift\" as Christianity's great catastrophe—when the church traded the way of the cross for the way of the sword.", "detail": "Before Constantine, Christians expected persecution and changed the world through witness. After Constantine, Christianity became the empire's religion, blessed its wars, and began reading Jesus's commands through elaborate interpretations that justified violence." },
            { "id": "overview-3", "label": "Revolutionary Impact", "summary": "\"The Politics of Jesus\" sold over 100,000 copies and was named one of the 20th century's most important religious books, fundamentally challenging how Christians understand power.", "detail": "Yoder's work continues inspiring peace movements worldwide—from Colombian Christian Peacemaker Teams to Rwandan reconciliation villages to urban restorative justice programs—demonstrating alternatives to coercive power." }
          ]
        },
        {
          "id": "concepts", "title": "Concepts",
          "intro": "Yoder developed revolutionary theological concepts that reframed traditional Christian understandings of power, politics, and discipleship through the lens of Jesus's non-violent approach.",
          "bullets": [
            "Jesus wasn't apolitical but demonstrated a completely different kind of politics based on service",
            "\"Revolutionary subordination\" subverts hierarchy by voluntarily accepting subordinate positions",
            "The church functions as an alternative society demonstrating non-coercive community"
          ],
          "items": [
            { "id": "concepts-1", "label": "The Politics of Jesus", "summary": "Core theological argument", "detail": "Jesus's non-violence isn't temporary strategy or interim ethic but the permanent revelation of divine sovereignty. God governs through suffering love, not coercive force." },
            { "id": "concepts-2", "label": "Revolutionary Subordination", "summary": "Subversive resistance strategy", "detail": "By voluntarily accepting subordinate positions, Christians rob hierarchy of its power. Serving without being servile reveals true power flows from love, not domination." },
            { "id": "concepts-3", "label": "Body Politics", "summary": "Five church practices", "detail": "Binding/loosing, breaking bread, baptism, gifts of the Spirit, and open dialogue create non-coercive counter-society demonstrating alternative human community." },
            { "id": "concepts-4", "label": "The Constantinian Shift", "summary": "Historical catastrophe", "detail": "Fourth-century transformation when Christianity became empire's religion, trading suffering witness for coercive power and reinterpreting Jesus's commands to justify violence." },
            { "id": "concepts-5", "label": "Politics of the Lamb", "summary": "Revelation's vision", "detail": "The slaughtered Lamb conquers as a Lamb—through suffering love, not force. This isn't temporary weakness but eternal reality of divine government." },
            { "id": "concepts-6", "label": "Hermeneutical Revolution", "summary": "Biblical interpretation", "detail": "Jesus meant what He said to all disciples for immediate practice. No levels of counsel vs. command, no personal vs. public distinctions." }
          ]
        },
        {
          "id": "evidence", "title": "Evidence",
          "intro": "Yoder supported his theological arguments with biblical exegesis, historical analysis, and contemporary examples demonstrating non-violence's effectiveness.",
          "bullets": [
            "Jesus's temptations, triumphal entry, and crucifixion reveal thoroughly political non-violent kingship",
            "Historical evidence shows non-violent movements often more effective than violent ones",
            "Contemporary peace movements continue demonstrating viable alternatives to coercion"
          ],
          "items": [
            { "id": "evidence-1", "label": "Biblical Evidence", "summary": "Satan offers Jesus political power... Jesus refuses—not from disinterest in kingdoms but to establish a different kind of kingdom without Satan's means.", "detail": "The Triumphal Entry deliberately fulfills Zechariah's prophecy, claiming kingship through service. The Crucifixion reveals the bankruptcy of political powers while demonstrating divine non-coercive government." },
            { "id": "evidence-2", "label": "Historical Effectiveness", "summary": "Non-violent movements like the Civil Rights Movement, Gandhi's campaign in India, and the fall of Communism in Eastern Europe often prove more effective than armed struggle.", "detail": "The Anabaptist witness itself, through centuries of martyrdom, testified to the power of non-violent conviction against overwhelming state force." },
            { "id": "evidence-3", "label": "Contemporary Applications", "summary": "Christian Peacemaker Teams in Colombia protect communities by absorbing violence. Reconciliation villages in Rwanda bring together survivors and perpetrators' families.", "detail": "In urban America, former gang members use restorative justice principles to interrupt cycles of retaliation, demonstrating practical alternatives to coercive justice systems." }
          ]
        },
        {
          "id": "timeline", "title": "Timeline",
          "intro": "The development of Anabaptist non-violent theology spans five centuries, from Reformation-era martyrdom through Yoder's theological systematization to contemporary peace movements.",
          "bullets": [
             "1520s Radical Reformation birthed Anabaptist commitment to non-violence despite persecution",
             "Yoder's 1969 work provided theological framework for centuries of peace church practice",
             "Contemporary movements continue demonstrating viability of non-coercive alternatives"
          ],
          "items": [
            { "id": "timeline-1", "label": "1520s", "detail": "Radical Reformation begins; Anabaptist movement emerges." },
            { "id": "timeline-2", "label": "1527", "detail": "Felix Manz martyred, the first Anabaptist execution." },
            { "id": "timeline-3", "label": "1660", "detail": "Martyrs' Mirror published, documenting thousands of martyrs." },
            { "id": "timeline-4", "label": "1969", "detail": "Politics of Jesus manuscript circulated, providing a new theological framework." },
            { "id": "timeline-5", "label": "1972", "detail": "Book officially published, eventually selling over 100,000 copies." },
            { "id": "timeline-6", "label": "1992", "detail": "Allegations of sexual misconduct against Yoder surface, revealing his personal failures." },
            { "id": "timeline-7", "label": "Present", "detail": "Global peace movements continue the witness worldwide." }
          ]
        },
        {
            "id": "critiques", "title": "Critiques",
            "intro": "Yoder's theology faces significant critiques regarding practicality, sectarianism, and the tragic contradiction between his teachings and personal conduct.",
            "bullets": [
                "Critics argue non-violence is impractical for maintaining social order and restraining evil",
                "Yoder's sexual misconduct created devastating contradiction with his non-coercive theology",
                "Questions persist about whether his insights survive his personal failures"
            ],
            "items": [
                { "id": "critiques-1", "label": "Practical Critiques", "summary": "How can society function without coercive institutions like police and military? Critics argue non-violence enables oppression and amounts to a sectarian retreat from social responsibility.", "detail": "The core tension lies in whether this ethic is a viable model for governing a pluralistic society or a specific calling for a minority Christian community." },
                { "id": "critiques-2", "label": "Personal Failure", "summary": "In 1992, allegations revealed Yoder had sexually harassed and assaulted multiple women over decades—a devastating contradiction of his non-coercive theology.", "detail": "The tragedy forces hard questions: Did his theology enable abuse? Can his insights survive his sins? Perhaps the failure itself testifies to the corruption of all forms of power." },
                { "id": "critiques-3", "label": "Theological Tensions", "summary": "Is the goal effectiveness or faithfulness? Is the ethic for the church or the world? Yoder seems to argue both ways, creating unresolved tensions in his work.", "detail": "Critics also point to a potential utopianism in his vision, questioning how much of God's kingdom can be realized before Christ's final return." }
            ]
        },
        { "id": "glossary", "title": "Glossary", "intro": "Key terms and concepts essential for understanding Yoder's theological framework and the Anabaptist tradition he articulated.", "bullets": ["Technical theological terms carry specific meanings in Yoder's framework.", "Historical references require understanding of Anabaptist persecution and witness."], "items": [] },
        { "id": "source", "title": "Source", "intro": "This analysis draws from a comprehensive article exploring Yoder's theological contributions, historical context, and complicated legacy.", "bullets": ["Source provides balanced treatment of both Yoder's insights and personal failures.", "Contemporary applications demonstrate ongoing relevance of non-violent theology."], "items": [] }
      ],
      "glossary": [
        { "term": "Anabaptists", "definition": "16th-century Radical Reformation Christians who rejected infant baptism and violence. Ancestors of Mennonites, Hutterites, and Brethren." },
        { "term": "Constantinian Shift", "definition": "4th-century transformation when Christianity became Rome's official religion, embracing coercive power." },
        { "term": "Revolutionary Subordination", "definition": "Voluntarily accepting subordinate positions to rob hierarchy of power, revealing authority flows from love not domination." },
        { "term": "Politics of the Lamb", "definition": "The slaughtered Lamb of Revelation conquers through suffering love, not force—God's permanent method of sovereignty." },
        { "term": "Body Politics", "definition": "Five church practices (e.g., Eucharist, baptism) creating a non-coercive counter-society." },
        { "term": "Martyrs' Mirror", "definition": "1,100-page Anabaptist martyrology documenting thousands who chose death over violence." },
        { "term": "Restorative Justice", "definition": "Conflict resolution focusing on healing and reconciliation rather than punishment." },
        { "term": "Christian Peacemaker Teams", "definition": "Organization placing teams in conflict zones to protect communities through non-violent presence." }
      ],
      "quotes": [
        { "text": "Jesus's non-violence is how God runs the real world. Every other form of power is the illusion.", "ref": "On Yoder's central thesis" },
        { "text": "When the church accepted Constantine's sword, it lost Jesus's cross.", "ref": "On the Constantinian shift" },
        { "text": "The slaughtered Lamb in Revelation isn't waiting to become a Lion... The Lamb conquers as a Lamb—through suffering love.", "ref": "On the politics of the Lamb" }
      ],
      "timelineChart": {
        "title": "Key Events in Anabaptist History",
        "labels": ["1520s", "1527", "1660", "1969", "1972", "1992", "Present"],
        "values": [1, 2, 1.5, 3, 4, 2.5, 3.5]
      }
    }
    </script>

    <script defer>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ------------------
        // DOM Element Refs
        // ------------------
        const app = {
            header: document.getElementById('app-header'),
            tabs: document.getElementById('app-tabs'),
            panels: document.getElementById('app-panels'),
            searchInput: document.getElementById('searchInput'),
            settings: {
                modal: document.getElementById('settingsModal'),
                btn: document.getElementById('settingsBtn'), // Will be rendered into header
                saveBtn: document.getElementById('saveSettings'),
                cancelBtn: document.getElementById('cancelSettings'),
                themeSelect: document.getElementById('themeSelect')
            }
        };

        // ------------------
        // State Management
        // ------------------
        const state = {
            activeTab: 'overview',
            theme: 'default',
            chartInstance: null
        };

        const loadState = () => {
            const storedTab = localStorage.getItem('activeTab');
            const storedTheme = localStorage.getItem('theme');
            const hashTab = location.hash.substring(1);

            state.theme = storedTheme || 'default';
            state.activeTab = hashTab || storedTab || 'overview';
            
            applyTheme(state.theme);
        };

        const saveState = () => {
            localStorage.setItem('activeTab', state.activeTab);
            localStorage.setItem('theme', state.theme);
        };

        const applyTheme = (theme) => {
            document.documentElement.className = theme === 'default' ? '' : theme;
            if (app.settings.themeSelect) app.settings.themeSelect.value = theme;
            state.theme = theme;
            // If chart exists, update its colors
            if (state.chartInstance) {
                updateChartColors();
            }
        };

        // ------------------
        // Data Loading
        // ------------------
        const loadData = () => {
            try {
                const dataNode = document.getElementById('report-data');
                if (!dataNode) throw new Error('Data script tag not found');
                return JSON.parse(dataNode.textContent);
            } catch (e) {
                console.error("Failed to load or parse report data:", e);
                app.panels.innerHTML = `<p class="text-red-500">Error: Could not load report data.</p>`;
                return null;
            }
        };
        
        const data = loadData();
        if (!data) return; // Stop execution if data fails to load

        // ------------------
        // Render Functions
        // ------------------
        const renderHeader = () => {
            const { meta } = data;
            app.header.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold accent-1 mb-2">${meta.title || 'Report'}</h1>
                        <p class="text-secondary text-lg">${meta.subtitle || ''}</p>
                    </div>
                    <button id="settingsBtn" class="p-3 rounded-lg ui-bg-accent hover:opacity-80 transition-opacity" aria-label="Display Settings">
                        <span class="text-2xl">⚙️</span>
                    </button>
                </div>`;
        };
        
        const renderTabs = () => {
            const { sections } = data;
            const tabsHTML = sections.map(section => `
                <button role="tab" aria-selected="false" aria-controls="${section.id}-panel" id="${section.id}-tab"
                        class="px-6 py-3 font-semibold text-secondary hover:accent-1 transition-colors">
                    ${section.title}
                </button>
            `).join('');
            app.tabs.innerHTML = `<div class="flex flex-wrap">${tabsHTML}</div>`;
        };

        const renderPanels = () => {
            const { sections, glossary, quotes, timelineChart, meta } = data;
            const panelsHTML = sections.map(section => {
                const contextBlock = `
                    <div class="ui-bg-accent rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-bold accent-1 mb-3">Context & Takeaways</h2>
                        <p class="text-primary mb-4">${section.intro || ''}</p>
                        ${section.bullets && section.bullets.length > 0 ? `
                        <ul class="list-disc list-inside space-y-2 text-secondary">
                            ${section.bullets.map(bullet => `<li>${bullet}</li>`).join('')}
                        </ul>` : ''}
                    </div>`;

                let content = '';
                switch(section.id) {
                    case 'overview':
                    case 'critiques':
                    case 'evidence':
                        content = `<div class="space-y-4">
                            ${(section.items || []).map(item => `
                            <div class="accordion" data-searchable="${item.label} ${item.summary} ${item.detail}">
                                <button class="accordion-trigger w-full text-left px-4 py-3 ui-bg-accent rounded-lg font-semibold text-primary hover:opacity-90 transition-opacity" aria-expanded="false">
                                    ${item.label}
                                </button>
                                <div class="accordion-content">
                                  <div>
                                    <div class="mt-2 p-4 ui-bg-accent rounded-lg">
                                        <p class="text-primary mb-3">${item.summary}</p>
                                        <p class="text-secondary">${item.detail}</p>
                                    </div>
                                  </div>
                                </div>
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'concepts':
                         content = `<div class="grid md:grid-cols-2 gap-4">
                            ${(section.items || []).map(item => `
                            <div class="ui-bg-accent rounded-lg p-4" data-searchable="${item.label} ${item.summary} ${item.detail}">
                                <h3 class="font-bold accent-1 mb-2">${item.label}</h3>
                                <p class="text-secondary text-sm mb-3">${item.summary}</p>
                                <p class="text-primary">${item.detail}</p>
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'timeline':
                        content = `
                            <div class="mb-6 chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>
                            <div class="ui-bg-accent rounded-lg p-4 mb-6">
                                <h3 class="font-bold accent-1 mb-3">Historical Data Table</h3>
                                <table class="w-full text-sm">
                                    <thead><tr class="border-b"><th class="text-left py-2">Period</th><th class="text-left py-2">Event</th></tr></thead>
                                    <tbody class="text-primary">
                                        ${(section.items || []).map(item => `<tr class="border-b" data-searchable="${item.label} ${item.detail}"><td class="py-2">${item.label}</td><td class="py-2">${item.detail}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                        break;
                    case 'glossary':
                        content = `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${(glossary || []).map(item => `
                            <div class="ui-bg-accent rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer glossary-card" data-searchable="${item.term} ${item.definition}">
                                <h3 class="font-bold accent-1 mb-2">${item.term}</h3>
                                <p class="text-primary text-sm">${item.definition}</p>
                            </div>`).join('')}
                        </div>`;
                        break;
                    case 'source':
                        content = `<div class="space-y-6">
                            <div class="ui-bg-accent rounded-lg p-4">
                                <h3 class="font-bold accent-1 mb-3">Source Information</h3>
                                <div class="space-y-2">${(meta.provenance || []).map(p => `<p class="text-primary"><strong>${p.label}:</strong> ${p.detail}</p>`).join('')}</div>
                            </div>
                            <div class="ui-bg-accent rounded-lg p-4">
                                <h3 class="font-bold accent-1 mb-3">Key Quotes</h3>
                                <div class="space-y-4">${(quotes || []).map(q => `<div class="pl-4 border-l-4 border-accent"><p class="text-primary italic mb-2">"${q.text}"</p><p class="text-secondary text-sm">${q.ref}</p></div>`).join('')}</div>
                            </div>
                        </div>`;
                        break;
                }
                
                return `<div role="tabpanel" id="${section.id}-panel" aria-labelledby="${section.id}-tab" hidden>
                    ${contextBlock}
                    ${content || '<p class="text-secondary">No items yet.</p>'}
                </div>`;
            }).join('');
            app.panels.innerHTML = panelsHTML;
        };

        // ------------------
        // Interactivity
        // ------------------
        const switchTab = (tabId) => {
            const allTabs = app.tabs.querySelectorAll('[role="tab"]');
            const allPanels = app.panels.querySelectorAll('[role="tabpanel"]');
            
            allTabs.forEach((tab, index) => {
                const isActive = tab.id === `${tabId}-tab`;
                tab.setAttribute('aria-selected', isActive);
                tab.setAttribute('tabindex', isActive ? '0' : '-1');
                tab.classList.toggle('tab-active', isActive);
                tab.classList.toggle('text-secondary', !isActive);
            });

            allPanels.forEach(panel => {
                panel.hidden = panel.id !== `${tabId}-panel`;
            });
            
            if (tabId === 'timeline' && !state.chartInstance) {
                setupChart();
            }

            state.activeTab = tabId;
            location.hash = tabId;
            saveState();
        };

        const setupEventListeners = () => {
            // Tabs
            app.tabs.addEventListener('click', e => {
                const tab = e.target.closest('[role="tab"]');
                if (tab) switchTab(tab.id.replace('-tab', ''));
            });
            app.tabs.addEventListener('keydown', e => {
                const tabs = Array.from(app.tabs.querySelectorAll('[role="tab"]'));
                const currentIndex = tabs.findIndex(t => t.id === `${state.activeTab}-tab`);
                let newIndex = currentIndex;

                if (e.key === 'ArrowRight') newIndex = (currentIndex + 1) % tabs.length;
                else if (e.key === 'ArrowLeft') newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                else if (e.key === 'Home') newIndex = 0;
                else if (e.key === 'End') newIndex = tabs.length - 1;
                else return;

                e.preventDefault();
                tabs[newIndex].focus();
                switchTab(tabs[newIndex].id.replace('-tab', ''));
            });

            // Accordions
            app.panels.addEventListener('click', e => {
                const trigger = e.target.closest('.accordion-trigger');
                if (trigger) {
                    const content = trigger.nextElementSibling;
                    const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
                    trigger.setAttribute('aria-expanded', !isExpanded);
                    content.classList.toggle('active');
                }
            });

            // Modal
            const settingsBtn = document.getElementById('settingsBtn'); // Re-query after render
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    app.settings.modal.classList.remove('hidden');
                    app.settings.themeSelect.focus();
                });
            }

            const closeModal = () => {
                app.settings.modal.classList.add('hidden');
                document.getElementById('settingsBtn')?.focus();
            };
            app.settings.saveBtn.addEventListener('click', () => {
                applyTheme(app.settings.themeSelect.value);
                saveState();
                closeModal();
            });
            app.settings.cancelBtn.addEventListener('click', closeModal);
            app.settings.modal.addEventListener('keydown', e => {
                if (e.key === 'Escape') closeModal();
            });

            // Search
            app.searchInput.addEventListener('input', handleSearch);
        };
        
        const handleSearch = (e) => {
            const query = e.target.value.toLowerCase().trim();
            const searchables = document.querySelectorAll('[data-searchable]');
            
            // Clear previous highlights
            searchables.forEach(el => {
                 el.style.display = '';
                 el.innerHTML = el.getAttribute('data-searchable-original');
            });
            
            if (query.length < 3) return;

            let firstHit = null;

            searchables.forEach(el => {
                if (!el.hasAttribute('data-searchable-original')) {
                    el.setAttribute('data-searchable-original', el.innerHTML);
                }
                const text = el.dataset.searchable.toLowerCase();
                if (text.includes(query)) {
                    if (!firstHit) firstHit = el;
                    el.style.display = '';
                    const regex = new RegExp(`(${query})`, 'gi');
                    el.innerHTML = el.getAttribute('data-searchable-original').replace(regex, `<mark class="search-highlight">$1</mark>`);
                } else {
                    el.style.display = 'none';
                }
            });

            if (firstHit) {
                const panel = firstHit.closest('[role="tabpanel"]');
                if (panel && panel.hidden) {
                    switchTab(panel.id.replace('-panel', ''));
                }
                setTimeout(() => {
                    firstHit.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstHit.focus({ preventScroll: true });
                }, 200);
            }
        };

        // ------------------
        // Chart.js Setup
        // ------------------
        const setupChart = () => {
            const { timelineChart } = data;
            if (!timelineChart) return;
            const ctx = document.getElementById('timelineChart')?.getContext('2d');
            if (!ctx) return;

            const chartData = {
                type: 'line',
                data: {
                    labels: timelineChart.labels,
                    datasets: [{
                        label: timelineChart.title,
                        data: timelineChart.values,
                        tension: 0.3,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { display: false } } }
                }
            };

            state.chartInstance = new Chart(ctx, chartData);
            updateChartColors();

            const container = document.querySelector('.chart-container');
            if (container) {
                new ResizeObserver(() => {
                    state.chartInstance.resize();
                }).observe(container);
            }
        };

        const updateChartColors = () => {
            if (!state.chartInstance) return;
            const style = getComputedStyle(document.documentElement);
            state.chartInstance.data.datasets[0].borderColor = style.getPropertyValue('--accent-1');
            state.chartInstance.data.datasets[0].backgroundColor = style.getPropertyValue('--accent-2');
            state.chartInstance.options.plugins.legend.labels.color = style.getPropertyValue('--text-primary');
            state.chartInstance.options.scales.x.ticks.color = style.getPropertyValue('--text-secondary');
            state.chartInstance.update();
        };

        // ------------------
        // Initialization
        // ------------------
        const init = () => {
            loadState();
            renderHeader();
            renderTabs();
            renderPanels();
            setupEventListeners();
            switchTab(state.activeTab);

            window.addEventListener('hashchange', () => {
                const hashTab = location.hash.substring(1);
                if (hashTab && hashTab !== state.activeTab) {
                    switchTab(hashTab);
                }
            });
        };

        init();
    });
    </script>
</body>
</html>
